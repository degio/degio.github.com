JS2.OO.createClass("Sci.ResizableTitle");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','LEFT',145);K.oo('member','EXT_WIDTH',81);K.oo('method',"initialize",function(){this.initHTML();this.registerEvents();this.resize();});K.oo('method',"initHTML",function(){this.$header=$('#page-header');this.$title=this.$header.first('.titleWrapper');this.$titleContent=this.$title.first('h1');this.$menu=this.$header.first('.menu');});K.oo('method',"registerEvents",function(){$(window).resize((function(self){return function(){self.resize();}})(this));});K.oo('method',"resize",function(){var width=this.$titleContent.width()+this.EXT_WIDTH;var maxWidth=this.$header.width()-this.LEFT-this.$menu.width();if(width>maxWidth)width=maxWidth;this.$title.width(width);});})(Sci.ResizableTitle,Sci);$(function(){if(!sci)sci={};sci.resizableTitle=new Sci.ResizableTitle();});JS2.OO.createClass("Grid0.Main");Grid0.Main.oo('extends',JS2.Main);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','components',['Schema','Dimension','Data','Util','Selected','Messenger','Header','ColumnMenu','ColumnNavigator','Sorter','QuickFilter','DataFormat','Body','Scroller','Resizer','MainHeader','MainFooter','MainLeft','Actions','BodyEventHandler','GridMenu','ToggleFields','AddRow','DataImprover','Filter','Aggregation','AddField','DeleteField','Paging','BulkImport','Clone','SearchDatasets','DownCSV','ApiQuery','ExplorerPayload','ExplorerHelper','ExpandedCell','CellOptions','CellForm','FactExplorer','SubjectExplorer','InitiateJoin','JoinDetails','HideColumn','VotePresentation','Merger','Admin','CellClipboard','SaveGridState','Tooltip','Search','Authentication','BigTableGuide','Caution','FieldEditor','JsapiPreview','ReorderFields','TablePermissions','TableDetails','RemoveTable']);K.oo('member','core',['Schema','Dimension','Data','Util','Actions']);K.oo('member','dependencies',"notifier schema messenger");K.oo('method',"classList",function(){return _super(this);});K.oo('method',"e_start",function(){this.view.initHTML();this.assign('dim',this.dimension);this.assign('jqMain',this.view.jqMain);this.assign('jqUniverse',this.view.jqUniverse);this.assign('jqGrid',this.view.jqGrid);this.assign('jqGridLoading',this.view.jqGridLoading);this.assign('auth',sci.auth);this.messenger.initHTML();this.notify('loadData');});K.oo('method',"clearAllFilters",function(){this.notify('clearAllFilters')
this.actions.clearAllFilters();});K.oo('method',"applyFilters",function(summaryFilters,voteFilters,options){summaryFilters=summaryFilters||[];voteFilters=voteFilters||[];this.actions.setFilters(summaryFilters,voteFilters,options);});K.oo('method',"applySearchQueries",function(queries){queries=queries||[];this.actions.setSearchQueries(queries);});K.oo('method',"initGeoFunction",function(geoFunction){this.actions.initGeoFunction(geoFunction);});K.oo('method',"applyGeoFunction",function(geoFunction){this.actions.setGeoFunction(geoFunction);});K.oo('method',"setReference",function(reference){this.actions.setReference(reference);});K.oo('method',"columns",function(){return this.data.columns();});K.oo('method',"column",function(idx){return this.data.column(idx);});K.oo('method',"columnIdxById",function(id){return this.schema.columnIdxById(id);});K.oo('method',"rowFilters",function(){return this.actions.rowFilters();});K.oo('method',"voteFilters",function(){return this.actions.voteFilters();});K.oo('method',"exclusions",function(){return this.actions.exclusions();});K.oo('method',"searchQueries",function(){return this.actions.searchQueries();});K.oo('method',"geoFunction",function(){return this.actions.geoFunction();});K.oo('method',"isGeoStateReady",function(){return this.data.isGeoStateReady();});K.oo('method',"openCell",function(colIdx,rowIdx){this.notify('openCell',colIdx,rowIdx);});K.oo('method',"focusCell",function(colIdx,rowIdx){this.notify('focusCell',{colIdx:colIdx,rowIdx:rowIdx});});K.oo('method',"state",function(){return this.data.state();});K.oo('method',"isSimple",function(){return this.actions.isSimple();});K.oo('method',"refresh",function(url,params){this.data.refresh(url,params);});K.oo('method',"editField",function(fieldId){this.notify('editField',fieldId);});K.oo('method',"resize",function(dim){if(dim.width&&dim.height){this.notify('resize',dim);}else if(dim.height){this.notify('resizeHeight',dim.height);}else if(dim.width){this.notify('resizeWidth',dim.width);}});K.oo('method',"autoResize",function(){this.notify('autoResize');});K.oo('method',"e_autoResize",function(){this.resize({width:this.dim.getPageWidth(),height:this.dim.getPageHeight()});});K.oo('method',"refreshData",function(){this.notify('loadData');});K.oo('method',"refreshColumns",function(cols){this.notify('initCols',cols);});K.oo('method',"addClass",function(className){this.view.jqMain.addClass(className);});K.oo('method',"registerObserver",function(obj){this.register(obj);});K.oo('method',"registerOutsideCallBacks",function(eventType,func){this.notifier.registerOutside(eventType,func);});K.oo('method',"reloadScroll",function(){this.notify('reloadScroll');});K.oo('method',"e_bigData",function(bigData,unlisted){this.bigData=bigData;this.assign('bigData',bigData);this.assign('unlisted',unlisted);});K.oo('method',"clearSearchContent",function(){this.notify('clearSearchContent');});K.oo('method',"setSearchContainer",function($container){this.notify('setSearchContainer',$container);});})(Grid0.Main,Grid0);JS2.OO.createClass("Grid0.MainView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){this.addClassName=options.addClassName;});K.oo('method',"e_loadData",function(){this.jqMain.hide();this.notify('alert','Data Loading...');});K.oo('method',"e_dataLoaded",function(){this.notify('alert');});K.oo('method',"e_tableUnCached",function(cacheState){this.jqMain.first('tr').siblings().css('visibility','hidden');});K.oo('method',"initHTML",function(){this.jqParent=this.seed.jq;this.jqParent.append(this.htmlCache.container());this.jqUniverse=this.jqParent.find('>.universe');this.jqMain=this.jqUniverse.find('>.mainGrid');this.jqGridLoading=this.jqUniverse.find('>.gridLoading');this.jqGrid=this.jqMain.first('td>.grid');this.jqMainFooter=this.jqMain.first('td>.mainFooter');this.jqMainHeader=this.jqMain.first('td>.mainHeader');this.jqMain.addClass('mainGrid0');});K.oo('method',"e_resized",function(){this.jqGrid.css(this.dim.grid);this.jqMain.css({height:this.dim.height,width:this.dim.width});});})(Grid0.MainView,Grid0);Grid0.dialogs={};Grid0.MainView.oo('setHTMLCache',{"container":function(){return"<div class='universe'><table class='mainGrid'><tr><td colspan='2'><div class='mainHeader'><div class='gridMenu'><\/div><\/div><\/td><\/tr><tr><td><div class='mainLeft'><\/div><\/td><td><div class='grid'><div class='scroller'><div class='filler'><\/div><\/div><div class='bMask'><div class='body'><\/div><\/div><div class='hMask'><a class='columnNavigatorIcon'><\/a><div class='header'><\/div><\/div><div class='resizerLine'><\/div><div class='cellOptions'><\/div><div class='expandedCell'><\/div><div class='bodyEventHandler'><div class='highlights'><div class='col'><\/div><div class='row'><\/div><div class='cell'><\/div><div class='input'><\/div><\/div><div class='cellForm'><\/div><\/div><div class='showFields' title='Show or Hide Fields'><\/div><\/div><\/td><td><div class='mainRight'><\/div><\/td><\/tr><tr><td colspan='2'><div class='mainFooter'><\/div><\/td><\/tr><\/table><div class='filterLayer'><\/div><div class='gridLoading'><div class='message'><\/div><div class='error'><\/div><\/div><\/div>"}});JS2.OO.createClass("Grid0.MainFooter");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth body');K.oo('method',"e_initHTML",function(){this.jq=this.jqMain.first('td>.mainFooter').html('');this.add(this.htmlCache.main());this.baseUrl=this.data.baseUrl();this.jqContent=this.addControl(this.htmlCache.controls());this.jqListContainer=this.jqContent.find('ul.mainFooterContainer');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"maincontainer",this.jqListContainer,null);this.jqTotalRows=this.jq.find('.totalRows').hide();this.jqRowCount=this.jqTotalRows.first('.rowCount');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Total Rows",this.jqRowCount,null);this.jqCalRowCount=this.jqTotalRows.first('.calRowCount');this.jqSortsInfo=this.jq.find('.sortsInfo');this.jqSortsFields=this.jqSortsInfo.find('.fieldNames');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"sortfield",this.jqSortsFields,null);this.addRowButton=this.jq.find('.addRowButton');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"addrow",this.addRowButton,null);this.registerEvents();this.controlList=new Sci.JqList(this.jqListContainer,{alreadyBuilt:true});});K.oo('method',"e_dataLoaded",function(){var p=this.actions.pagination();this.showRowCount(p.totalRows,this.actions.summary['row-count-estimated']);this.showSorts();});K.oo('method',"e_rowCount",function(rowCount,isEstimated){this.showRowCount(rowCount,isEstimated);});K.oo('method',"showSorts",function(){var fieldNames=this.actions.sortedFieldNames();if(fieldNames.length>0){this.jqSortsFields.html(fieldNames.join(', '));}else{this.jqSortsFields.html(this.schema.column(0).name);}});K.oo('method',"e_totalPagesLoaded",function(p){this.showRowCount(parseInt(p[0]),p[1]);});K.oo('method',"e_loadingTotalPages",function(){this.jqCalRowCount.addClass('disabled');});K.oo('method',"showRowCount",function(rowCount,isEstimated){if(rowCount>-1){var rs=rowCount==1?'row':'rows';var message='';if(isEstimated){message+='Around ';message+=sci.common.humanizeNumber(rowCount)+' '+rs;}else{message+=rowCount+' '+rs;}
this.jqRowCount.html(message).show();this.jqCalRowCount.hide();}else{this.jqRowCount.hide();this.jqCalRowCount.show().removeClass('disabled');}
this.jqTotalRows.show();});K.oo('method',"e_bigData",function(bigData,unlisted){this.bigData=bigData;this.unlisted=unlisted;});K.oo('method',"add",function(html){var jq=$(this.jq.append(html)[0].lastChild);return jq;});K.oo('method',"addMenuItem",function(name,html){this.controlList.add(name,html);return this.controlList.get(name);});K.oo('method',"registerEvents",function(){var self=this;this.jqCalRowCount.click((function(self){return function(){if($(this).hasClass('disabled'))return;self.data.getTotalPages();}})(this));});K.oo('method',"addControl",function(html){this.jqContainer=this.jq.find('.mainFooterContent');var jq=this.jqContainer.append(html);return jq;});})(Grid0.MainFooter,Grid0);Grid0.MainFooter.oo('setHTMLCache',{"controls":function(){return"<ul class='mainFooterContainer'><li class='addRowButton'><span class='fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Add Row      <\/a>    <\/span>  <\/span><\/span><\/li><li class='totalRows'><a class='calRowCount'>Calculate row count<\/a><span class='rowCount'><\/span><span class='sortsInfo'>, sorted by<span class='fieldNames'><\/span><\/span><\/li><\/ul>"},"main":function(){return"<div class='lowerControls'><div class='mainFooterContent'><\/div><\/div>"}});JS2.OO.createClass("Grid0.MainHeader");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.jqParent=this.jqMain.first('td>.mainHeader');this.jq=this.jqMain.first('td>.mainHeader .gridMenu').html('');this.auth.isAdmin()?this.jq.addClass('admin'):this.jq.removeClass('admin');});K.oo('method',"addFilterMenu",function(html){var jq=$(this.jqParent.append(html)[0].lastChild);return jq;});K.oo('method',"add",function(html){var jq=$(this.jq.append(html)[0].lastChild);return jq;});K.oo('method',"prepend",function(html){var jq=$(this.jq.prepend(html)[0].firstChild);return jq;});K.oo('method',"addJoinHeader",function(html){this.joinHeading=this.jqParent.append(html).children(':last-child');return this.joinHeading;});K.oo('method',"getJoinHeaderHeight",function(){return this.joinHeading.height();});K.oo('method',"e_tableUnCached",function(){this.jqParent.addClass('tableUnCached');});K.oo('method',"e_showStop",function(){this.jqParent.addClass('quartzError');});K.oo('method',"e_userLoggedIn",function(){this.auth.isAdmin()?this.jq.addClass('admin'):this.jq.removeClass('admin');});})(Grid0.MainHeader,Grid0);JS2.OO.createClass("Grid0.MainLeft");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.jq=this.jqMain.first('td>.mainLeft').html('');this.mode=new Sci.JqMode(this.jq);this.show();});K.oo('method',"e_resizing",function(){this.setDimensions();});K.oo('method',"show",function(){this.jq.show();});K.oo('method',"setDimensions",function(){if(this.jq)this.jq.css(this.dim.main.left);});})(Grid0.MainLeft,Grid0);JS2.OO.createClass("Grid0.Selected");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('accessor',['columnParams']);K.oo('accessor',['rowParams']);K.oo('accessor',['headerColumnParams']);K.oo('accessor',['dblClkCell']);K.oo('accessor',['clkCell']);})(Grid0.Selected,Grid0);JS2.OO.createClass("Grid0.Data");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('accessor',['unsaved']);K.oo('accessor',['payload']);K.oo('accessor',['columns']);K.oo('method',"initialize",function(options){this.options=options;this.dataset=options.dataset;this.payload(options.payload);this.columns(options.columns);this.payloadCallBacks={};this.firstTime=true;this.buildPayloadCallBacks();this.payload().registerCallBacks(this.payloadCallBacks);});K.oo('method',"e_sortAscending",function(params){this.notify('alert','Sorting (ascending)...');this.actions.sort('asc',params.modifier,params.colIdx);this.dim.resetRowOffset();this.loadData();});K.oo('method',"e_sortDescending",function(params){this.notify('alert','Sorting (descending)...');this.actions.sort('desc',params.modifier,params.colIdx);this.dim.resetRowOffset();this.loadData();});K.oo('method',"e_setExclusions",function(exclusions){var exs=[];for(var it49=0,ex,it49__arr=exclusions,it49__len=it49__arr.length;(ex=it49__arr[it49])||it49<it49__len;it49++){var exc={};exc.type='table';exc.fieldId=0;exc.attribute=ex.attribute;exc.operator=ex.operator;exc.value=ex.value;exc.disabled=ex.disabled;exc.scope=ex.scope;exs.push(exc);}
this.payload().setExclusions(exs);this.loadData();});K.oo('method',"e_consensusChange",function(){this.notify('alert','Loading...');this.loadData();});K.oo('method',"editable",function(){return this.options.editable();});K.oo('method',"reorderable",function(){return(this.options.isOwner()||this.options.isAdmin());});K.oo('method',"downloadable",function(){if(this.auth.isAdmin())return'FULLY';var count=0;var size=0;var datasets=this.schema.datasets();for(var dsId in datasets){size++;var d=datasets[dsId];if(this.auth.userId()==d.ownerId||d.isDownloadable)count++;}
if(count==size)return'FULLY';if(count==0)return'FALSE';return'PARTLY';});K.oo('method',"ownerId",function(){return this.options.ownerId();});K.oo('method',"ownerName",function(){return this.options.ownerName();});K.oo('method',"isOwner",function(){return this.options.isOwner();});K.oo('method',"datasetCountdown",function(){return this.options.datasetCountdown();});K.oo('method',"deletable",function(){return this.options.deletable();});K.oo('method',"primarySortField",function(){return this.actions.primarySortField();});K.oo('method',"ast",function(){return this.payload().ast;});K.oo('method',"primaryDatasetId",function(){return this.actions.primaryDatasetId();});K.oo('method',"state",function(){return this.payload().state();});K.oo('method',"richState",function(){return this.payload().richGridJson();});K.oo('method',"leftColumns",function(){var cols=this.columns();var datasetId=cols[0].field.datasetId;var leftColumns=[];for(var it50=0,col,it50__arr=cols,it50__len=it50__arr.length;(col=it50__arr[it50])||it50<it50__len;it50++){if(col.field.datasetId==datasetId)leftColumns.push(col);}
return leftColumns;});K.oo('method',"baseColumns",function(){var baseColumns=[];var cols=this.columns();var baseDatasetId=this.dataset.id;for(var it51=0,col,it51__arr=cols,it51__len=it51__arr.length;(col=it51__arr[it51])||it51<it51__len;it51++){if(col.field.datasetId==baseDatasetId)baseColumns.push(col);}
return baseColumns;});K.oo('method',"isEmptyCell",function(context){if(context.col.isPrimary)return false;var colIdx=context.colIdx;var absRowIdx=context.absRowIdx;var cell=this.getCell(colIdx,absRowIdx)
var val=cell.val;var numVotes=cell.numVotes;return((val===null&&numVotes<1)||val===undefined||((val instanceof Array)&&val.length==0&&numVotes<1));});K.oo('method',"isPksCompound",function(){return(this.pks().length>1);});K.oo('method',"pks",function(){if(!this._realPks){var pks=[];var cols=this.columns();for(var it52=0,col,it52__arr=cols,it52__len=it52__arr.length;(col=it52__arr[it52])||it52<it52__len;it52++){if(col.field.datasetId!=this.primaryDatasetId())break;if(col.field.isPrimary){pks.push(col);}}
this._realPks=pks;}
return this._realPks;});K.oo('method',"datasetPkColIds",function(colIdx){var cols=this.columns();var datasetId=cols[colIdx].field.datasetId;if(!this._dsPkColIds)this._dsPkColIds={};if(!this._dsPkColIds[datasetId]){this._dsPkColIds[datasetId]=[];for(var i=0,col;col=cols[i];i++){if(col.field.datasetId!=datasetId)continue;if(col.field.isPrimary)this._dsPkColIds[datasetId].push(i);}}
if(this._dsPkColIds[datasetId].length==0){for(var i=0,col;col=cols[i];i++){if(!col.field.isPrimary)return this._dsPkColIds[datasetId];this._dsPkColIds[datasetId].push(i);}}
return this._dsPkColIds[datasetId];});K.oo('method',"datasetPkIds",function(){if(!this._pkIds){var pkIds=[];var cols=this.columns();for(var it53=0,col,it53__arr=cols,it53__len=it53__arr.length;(col=it53__arr[it53])||it53<it53__len;it53++){if(col.field.datasetId!=this.primaryDatasetId())break;if(col.field.isPrimary){pkIds.push(col.field.id);}}
this._pkIds=pkIds;}
return this._pkIds;});K.oo('method',"datasetPkPairs",function(colIdx,absRowIdx){var ids=this.datasetPkColIds(colIdx);var cols=this.columns();var row=this.getRow(absRowIdx);var pairs=[];for(var it54=0,id,it54__arr=ids,it54__len=it54__arr.length;(id=it54__arr[it54])||it54<it54__len;it54++){pairs.push([cols[id].name,row[id].val,cols[id].datatype]);}
return pairs;});K.oo('method',"addRow",function(datasetId,pkeys,values,sharedProps){var self=this;sharedProps['field_ids[]']=this.datasetPkIds();var callBack=function(){self.notify('subjectAdded');self.dataLoaded();}
this.payload().addRow(datasetId,pkeys,values,sharedProps,callBack);this.notify('rowAdding');});K.oo('method',"addField",function(field_hash){this.notify('alert','Adding Field...');var callBack=(function(self){return function(){self.dataLoaded();self.notify('viewModified');self.notify('jumpToLastColumn');}})(this);var onError=(function(self){return function(){self.notify('alert');}})(this);this.payload().addField(field_hash,callBack,onError);});K.oo('method',"jumpToRow",function(rowHash,callback){if(this.bigData){this.loadData();}else{this.loadData({jumpToRow:rowHash},callback);}});K.oo('method',"reorderFields",function(orders){this.notify('alert','Reordering Fields...');var callBack=(function(self){return function(){self.dataLoaded();self.notify('viewModified');}})(this)
this.payload().reorderFields(orders,callBack);});K.oo('method',"submitTableDetails",function(params,callBack){this.payload().submitTableDetails(params,callBack);});K.oo('method',"removeTable",function(){this.payload().removeTable();});K.oo('method',"advSearchFields",function(search_dataset_id){var self=this;this.payload().advSearchFields(search_dataset_id,function(data){self.notify('searchFieldResultsLoaded',data);});});K.oo('method',"searchFields",function(params){var self=this;this.payload().searchFields(params,function(data){self.notify('searchFieldResultsLoaded',data);});});K.oo('method',"loadImportPreview",function(){var self=this;this.payload().loadImportPreview(function(data){self.notify('importPreviewLoaded',data);});});K.oo('method',"submitImport",function(params){var self=this;this.payload().submitImport(params,function(data){self.notify('importSubmitted',data);});});K.oo('method',"publish",function(params){this.payload().publish(params);});K.oo('method',"saveView",function(params){this.payload().saveView(params);});K.oo('method',"saveMerge",function(params){this.payload().saveMerge(params);});K.oo('method',"submitClone",function(params){var self=this;this.payload().submitClone(params,function(data){self.notify('cloneSubmitted',data);});});K.oo('method',"setPermissions",function(permissions){this.payload().setPermissions(permissions);});K.oo('method',"share_state",function(fun){return this.payload().share_state(fun);});K.oo('method',"saveGridState",function(fun,onError){return this.payload().saveGridState(fun,onError);});K.oo('method',"setCacheTtl",function(ttl,fun){this.notify('alert','Updating API TTL ...');return this.payload().setCacheTtl(ttl,(function(self,fun){return function(p){self.notify('alert');self.dataset.cacheTtl=parseInt(p);fun(p);}})(this,fun));});K.oo('method',"getTotalPages",function(){this.notify('loadingTotalPages');return this.payload().getTotalPages((function(self){return function(p){self.notify('totalPagesLoaded',p);}})(this));});K.oo('method',"loadData",function(options,callback){options=options||{};var self=this;if(!this.payload().actions){this.payload().actions=this.actions;this.payload().schema=this.schema;}
var callBack=function(){self.dataLoaded();if(callback)callback();};options.onError=function(obj){self.notify('appErrorOccurred');}
this.payload().loadData(callBack,options);});K.oo('method',"pagination",function(){return this.payload().pagination();});K.oo('method',"paginate",function(page,limit){this.notify('alert','Paginating...');this.payload().paginate(page,limit);this.dim.resetRowOffset();this.loadData();});K.oo('method',"setAggregation",function(fieldId,aggregationMethod){this.notify('alert','Changing Aggregation...');this.payload().setAggregation(fieldId,aggregationMethod);var options={};options._event='SetFieldConsensus';options._event_params=JSON.stringify({field_id:fieldId,aggregation_method:aggregationMethod});if(grid.bigData){this.notify('saveGridState',(function(self,options){return function(){self.loadData(options);}})(this,options));}else{this.loadData(options);}
this.notify('actionsModified');});K.oo('method',"clearFunction",function(){this.notify('alert','Clearing Last Function...');var callBack=(function(self){return function(){self.dataLoaded();}})(this);this.payload().clearFunction(callBack);});K.oo('method',"buildPayloadCallBacks",function(){var self=this;this.payloadCallBacks.loadData=function(){self.dataLoaded();}
this.payloadCallBacks.paginateAlert=function(){self.notify('alert','Loading...');}
this.payloadCallBacks.rescueLoadData=function(error){self.notify('alert',null);}});K.oo('method',"toggleGarbage",function(state){var message=(state)?'Showing':'Hiding';message+=" rows flagged as 'garbage'...";this.notify('alert',message);var self=this;var callBack=function(){self.dataLoaded();}
this.payload().toggleGarbage(state,callBack);this.notify('actionsModified');});K.oo('method',"getRowIdx",function(rowHash){var rowHashes=this.data.rowHashes();for(var i=0,rh;rh=rowHashes[i];i++){if(rh==rowHash)return i;}
return-1;});K.oo('method',"getHash",function(absRowIdx){return this.data.rowHashes()[absRowIdx];});K.oo('method',"markGarbage",function(absRowIds){var params={};var rows=[];for(var absRowId in absRowIds){rows.push({hash:this.payload().getHash(absRowId),values:this.getPkValHash(absRowId)});}
var self=this;params['rows']=rows;params['field_ids[]']=this.datasetPkIds();var callBack=function(){self.dataLoaded();}
this.payload().markGarbage(params,callBack);this.notify('garbageVoting');});K.oo('method',"suggestAlternative",function(rowIdx,voteHash){var self=this;voteHash['field_ids[]']=this.datasetPkIds();var callBack=function(){self.dataLoaded();}
this.payload().suggestAlternative(rowIdx,voteHash,callBack);this.notify('subjectVoting');});K.oo('method',"vote",function(colIdx,rowIdx,voteHash){var callBack={};var self=this;callBack.checkBigData=function(){self.checkBigData();};callBack.paginate=function(){self.paginate();};callBack.loadData=function(){self.dataLoaded();};callBack.refreshCell=function(absRowIdx,colIdx){self.notify('cellRefreshed',absRowIdx,colIdx);};this.payload().vote(colIdx,rowIdx,voteHash,callBack);this.notify('factVoting');});K.oo('method',"checkBigData",function(){if(this.bigData){WEBSITE.appendMessage("You may not see it immediately, but you can always find it by double clicking on the cell and examining the cell's history.");}});K.oo('method',"join",function(joinOn,fields,datasetsHash){this.notify('alert','Joining...');var joins=this.actions.join(joinOn,fields,datasetsHash);var self=this;var callBack=function(){self.unSaved=true;self.dataLoaded();};var onError=function(){self.notify('alert');}
this.payload().join(joins,callBack,onError);});K.oo('method',"refresh",function(url,params){var self=this;params=params||{};var callBack=function(){self.unSaved=true;self.dataLoaded();};this.payload().refresh(url,params,callBack);});K.oo('method',"isShowingDelta",function(){return this.actions.usingDelta();});K.oo('method',"merge",function(params){var self=this;var controls=params.controls;var callBack=function(){self.unSaved=true;self.dataLoaded();controls.merged();};this.payload().merge(params,callBack);});K.oo('method',"removeRowFilter",function(filter){this.notify('alert','Removing Filter...');var ret=this.payload().removeRowFilter(filter);this.loadData();return ret;});K.oo('method',"columnById",function(id){return this.schema.columnById(id);});K.oo('method',"reportAbuser",function(userId){this.payload().reportAbuser(userId);});K.oo('method',"addToWhiteList",function(userId){this.payload().addToWhiteList(userId);});K.oo('method',"addToBlackList",function(userId,reason){var self=this;this.payload().addToBlackList(userId,reason,function(){self.loadData();});});K.oo('method',"saveDefaultReference",function(reference,callback){this.payload().saveDefaultReference(reference,callback);});K.oo('method',"guessColumnWidths",function(){this.payload().guessColumnWidths();this.notify('resizeWidth');this.notify('viewModified');});K.oo('method',"dataLoaded",function(){var columns=this.schema.columns();if(this.firstTime||this.resetting){if(this.firstTime)this.notify('initHTML');if(columns)this.notify('initCols');this.resetting=false;}
if(this.tempNRows!=this.rows().length){this.notify('initRows');this.tempNRows=this.rows().length;}
this.jqMain.show();this.bigData=this.payload().isBigData();this.cacheState=this.payload().getCacheState();this.notify('bigData',this.bigData,this.payload().isUnlisted());this.notify('dataLoaded',this.firstTime);this.firstTime=false;this.notify('resize');if(this.bigData)this.notify('cacheStateLoaded',this.cacheState);controller.resizeMainPage();if(this.needDisableGeoFunction)this.disableGeoFunction();var quartzError=this.payload().quartzError();if(quartzError){this.notify('quartzErrorOccurred',quartzError);}});K.oo('method',"isBigData",function(){return this.payload().isBigData();});K.oo('method',"getCacheState",function(){return this.payload().getCacheState();});K.oo('method',"isFirstLoad",function(){return this.firstTime;});K.oo('method',"grid",function(){return this.payload().grid;});K.oo('method',"gridType",function(){return this.grid().gridType;});K.oo('method',"gridJson",function(){return this.payload().gridJson();});K.oo('method',"getPkHash",function(absRowIdx){var pks=this.pks();var hash={};for(var i=0,p;p=pks[i];i++){var value=this.getCell(i,absRowIdx).val;if(value==null)value="";hash[p.field.id]=value;}
return hash;});K.oo('method',"getPkValHash",function(absRowIdx){var hash={};var pks=this.pks();for(var i=0,p;p=pks[i];i++){var value=this.getCell(i,absRowIdx).val;if(p.field.datatype=='Date')value=DISPLAY.datatype('Date',value);if(value==null)value="";hash[p.field.id]=value;}
return hash;});K.oo('method',"isLeftCol",function(colIdx){return(this.datasetPkColIds(colIdx)[0]==0);});K.oo('method',"getPkVals",function(colIdx,absRowIdx){var pkVals=[];var row=this.getRow(absRowIdx);var pkColIds=this.datasetPkColIds(colIdx);for(var it55=0,i,it55__arr=pkColIds,it55__len=it55__arr.length;(i=it55__arr[it55])||it55<it55__len;it55++){pkVals.push(row[i].val);}
return pkVals;});K.oo('method',"tableVotable",function(){var col=this.columns()[0];var field=col.field;return(field.isVotable&&col.editable());});K.oo('method',"rowHash",function(rowIdx){return this.payload().rowHash[rowIdx];});K.oo('method',"rowHashes",function(){return this._payload.rowHashes();});K.oo('method',"columns",function(){return this._payload.columns();});K.oo('method',"workbenchUrl",function(){var workbenchPath=window.location.pathname;return workbenchPath.split('/').subarr(0,3).join('/');});K.oo('method',"baseUrl",function(){return this.payload().url;});K.oo('method',"getUserAction",function(colIdx,rowIdx){return this._payload.getUserAction(colIdx,rowIdx);});K.oo('method',"noUserAction",function(ua){return(!ua||ua==USER_ACTION.NOT_VOTE||ua==USER_ACTION.NO_USER)});K.oo('method',"hasUserValue",function(uv){return(uv||uv===0);});K.oo('method',"includeGarbage",function(){return this.payload().includeGarbage();});K.oo('method',"getUrl",function(){return this.payload.url;});K.oo('method',"e_applyFqr",function(apply){this.notify('alert',(apply?'Apply':'Removing')+' FQR Filter...');this.notify('viewModified');this.actions.setUseFqr(apply);this.loadData();});K.oo('method',"e_loadData",function(){this.loadData();});K.oo('method',"reloadGrid",function(){this.notify('alert','Reloading...');var callBack=(function(self){return function(){self.dataLoaded();self.notify('viewModified');}})(this);this.payload().reloadGrid(callBack);});K.oo('method',"column",function(colIdx){return this.columns()[colIdx];});K.oo('method',"datatype",function(colIdx){var dtName=this.column(colIdx).datatype;return sci.constants.datatypes[dtName];});K.oo('method',"nRows",function(){if(this.firstTime==true)return 0;return this.payload().rows().length;});K.oo('method',"getCell",function(colIdx,absRowIdx){return this.payload().getCell(colIdx,absRowIdx);});K.oo('method',"getRow",function(absRowIdx){return this.rows()[absRowIdx];});K.oo('method',"rows",function(){return this._payload.rows();});K.oo('method',"sortByColumn",function(colIdx,desc){this.payload().sort(colIdx,desc);});K.oo('method',"changeVotePresentMode",function(mode){this.actions.changeVotePresentMode(mode);this.dataLoaded();});K.oo('method',"votePresentMode",function(){return this.actions.votePresentMode();});K.oo('method',"isShowOriginal",function(){return this.dataset.defaultReference=='ORIGINAL';});K.oo('method',"isGeoStateReady",function(){return(this.cacheState=='CACHED'||this.cacheState=='CACHED_MISMATCHED'||this.cacheState=='CACHED_BUFFERING')&&this.actions.verifyGeoFunction();});K.oo('method',"quickFilter",function(operator,fieldId,value){this.notify('alert','Applying Quick Filter...');var callBack=(function(self){return function(){self.notify('actionsModified');self.dataLoaded();}})(this);var onError=(function(self){return function(obj){self.notify('appErrorOccurred');}})(this)
this.payload().quickFilter(operator,fieldId,value,callBack,onError);});K.oo('method',"e_requestForceCache",function(){sci.common.postToUrl('/contact',{description:'Dear Factual. Please cache the Big Table - '+
this.data.dataset.key+', '+
this.data.dataset.name+' for me. Thank you!'});});K.oo('method',"confirmForDBCache",function(){if(this.bigData){return confirm("The change you are making will require re-caching the table.");}else{return true;}});K.oo('method',"confirmForDisableGeoFunction",function(){if(!this.actions.verifyGeoFunction())return true;if(confirm("This change will require disabling geo features on this table. Are you sure you want to do this?")){this.needDisableGeoFunction=true;return true;}else{return false;}});K.oo('method',"disableGeoFunction",function(){this.needDisableGeoFunction=false;this.actions.disableGeoFunction();this.notify('alert','Setting...');this.notify('forceCache');});K.oo('method',"isShowFieldName",function(){return this.actions.isShowFieldName();});K.oo('method',"setShowFieldName",function(show){this.actions.setShowFieldName(!!show);this.notify('viewModified');this.notify('toggleFieldName');});})(Grid0.Data,Grid0);JS2.OO.createClass("Grid0.Schema");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('accessor',['columns']);K.oo('accessor',['datasets']);K.oo('method',"initialize",function(options){this.options=options;this._columns=[];});K.oo('method',"pkFieldIds",function(){var pkIds=[];var pks=this.primaryDataset.pks();for(var it62=0,col,it62__arr=pks,it62__len=it62__arr.length;(col=it62__arr[it62])||it62<it62__len;it62++){var pk=col.field;pkIds.push(pk.id);for(var it63=0,mField,it63__arr=pk.mergeFields,it63__len=it63__arr.length;(mField=it63__arr[it63])||it63<it63__len;it63++){pkIds.push(mField.id);}}
return pkIds;});K.oo('method',"columnById",function(id){id=parseInt(id);for(var i=0,c;c=this._columns[i];i++){if(c.id==id){return c;}}});K.oo('method',"joinedColumnIdxs",function(){var ret=[];for(var i=0,c;c=this._columns[i];i++){if(c.field.isJoin){ret.push(i);}}
return ret;});K.oo('method',"getFieldIdByName",function(name){if(!this.fieldNameLookup){this.fieldNameLookup={};for(var it64=0,c,it64__arr=this._columns,it64__len=it64__arr.length;(c=it64__arr[it64])||it64<it64__len;it64++){if(!this.fieldNameLookup[c.name])this.fieldNameLookup[c.name]=c;}}
if(this.fieldNameLookup[name])return this.fieldNameLookup[name].id;return null;});K.oo('method',"columnIdxById",function(id){id=parseInt(id);for(var i=0,c;c=this._columns[i];i++){if(c.id==id){return i;}}});K.oo('method',"isNumericCol",function(col){return col.datatype=='Double'||col.datatype=='Numeric'||col.datatype=='Integer';});K.oo('method',"getFieldInfo",function(fieldId){return this.fieldLookup[fieldId];});K.oo('method',"getDatasetInfo",function(datasetId){return this.datasetLookup[datasetId];});K.oo('method',"dataset",function(dsId){return this._datasets[dsId];});K.oo('method',"column",function(colIdx){return this._columns[colIdx];});K.oo('method',"viewDatasets",function(){if(!this.viewDss){this.viewDss={};var dss=this._datasets;for(var id in dss){var ds=dss[id];if(ds.viewColumns().length>0)this.viewDss[id]=ds;}}
return this.viewDss;});K.oo('method',"setSchema",function(immutable,view){this.view=view;this.immutable=immutable;this.generateLookups();this.data.resetting=true;});K.oo('method',"columnIdxById",function(id){id=parseInt(id);var cols=this.columns();for(var i=0,c;c=cols[i];i++){if(c.id==id){return i;}}});K.oo('method',"field",function(id){return this._fields[id];});K.oo('method',"generateLookups",function(){this._columns=[];this.fieldRefsLookup={};var datasets=this.immutable.datasets;this.datasetLookup={};for(var it65=0,dataset,it65__arr=datasets,it65__len=it65__arr.length;(dataset=it65__arr[it65])||it65<it65__len;it65++)this.datasetLookup[dataset.id]=dataset;var fields=this.immutable.fields;this.fieldLookup={};for(var it66=0,field,it66__arr=fields,it66__len=it66__arr.length;(field=it66__arr[it66])||it66<it66__len;it66++)this.fieldLookup[field.id]=field;var cols=this.view.columns;this.colLookup={};for(var it67=0,col,it67__arr=cols,it67__len=it67__arr.length;(col=it67__arr[it67])||it67<it67__len;it67++){this.colLookup[col.id]=col;col.field=this.fieldLookup[col.id];col.name=col.field.name;col.reference=this.getFieldRef(col.id,col.field.datasetId);col.datatype=col.field.datatype;col.qid=col.field.qfield_id;col.datasetId=col.field.datasetId;col.isPrimary=col.field.isPrimary;col.aggregation=col.aggregationMethod||col.field.aggregation;var datasetOwnerId=this.datasetLookup[col.datasetId].ownerId;col.editable=(function(self,col,datasetOwnerId){return function(){return(!col.field.isStatic||(datasetOwnerId==self.options.userId())||self.options.isAdmin());}})(this,col,datasetOwnerId);this._columns.push(col);}
this.processColumns();this._fields={};for(var it68=0,f,it68__arr=this.immutable.fields,it68__len=it68__arr.length;(f=it68__arr[it68])||it68<it68__len;it68++){this.processField(f);}
this.viewDss=null;});K.oo('method',"getFieldRef",function(field_id,ds_id){var ref_name=this.datasetLookup[ds_id].fieldRefs[field_id];if(this.fieldRefsLookup[ref_name]){ref_name=ref_name.replace(/\d+$/);var i=1;while(this.fieldRefsLookup[ref_name+''+i]){i++;}
ref_name=ref_name+''+i;}
this.fieldRefsLookup[ref_name]=true;return ref_name;});K.oo('method',"processColumns",function(){var datasets={};var order=[];var isLeft=true;var col_lookup={};var allFields=[];for(var i=0,c;c=this._columns[i];i++){c.colIdx=i;var field=c.field;col_lookup[field.id]=c;field.colIdx=i;allFields.push(field);for(var it69=0,f,it69__arr=field.mergeFields,it69__len=it69__arr.length;(f=it69__arr[it69])||it69<it69__len;it69++){f.colIdx=i;if(f.id!=field.id)f.inMerge=true;allFields.push(f);col_lookup[f.id]=c;}}
for(var it70=0,f,it70__arr=allFields,it70__len=it70__arr.length;(f=it70__arr[it70])||it70<it70__len;it70++){var ds=datasets[f.datasetId];if(!ds){var info=this.datasetLookup[f.datasetId];ds=new Grid0.Dataset(f.datasetId,this.data,isLeft);datasets[f.datasetId]=ds;ds.name=info.name;ds.id=info.id;ds.ownerId=info.ownerId;ds.isDownloadable=info.isDownloadable;ds.showOriginal=info.showOriginal;isLeft=false;order.push(ds);}
if(!f.inMerge)ds.viewColumns().push(col_lookup[f.id]);if(f.isPrimary)ds.pks().push(col_lookup[f.id]);ds.columns().push(col_lookup[f.id]);}
var primaryDataset=null;for(var it71=0,ds,it71__arr=order,it71__len=it71__arr.length;(ds=it71__arr[it71])||it71<it71__len;it71++){if(!primaryDataset)primaryDataset=ds;if(ds.pks().length==0){ds.pks(primaryDataset.pks());}}
this._datasets=datasets;this.primaryDataset=primaryDataset;});K.oo('method',"processField",function(f){this._fields[f.id]=f;for(var it72=0,child,it72__arr=f.mergeFields,it72__len=it72__arr.length;(child=it72__arr[it72])||it72<it72__len;it72++){this.processField(child);}});K.oo('method',"currentDataset",function(){return this._datasets[this.data.dataset.id];});K.oo('method',"getPkDefaultValues",function(){var pkDefaultValues={};var defaultValues=this.immutable.fieldDefaultValues;for(var i=0,f;f=this.immutable.fields[i];i++){var fieldId=f.id;if(defaultValues[fieldId]!=undefined&&defaultValues[fieldId]!=null){pkDefaultValues[fieldId]=defaultValues[fieldId];}}
return pkDefaultValues;});K.oo('method',"fqrAvailable",function(){for(var it73=0,action,it73__arr=this.actions.collection,it73__len=it73__arr.length;(action=it73__arr[it73])||it73<it73__len;it73++){if(!action._rclass.match(/Qlisp::Action::(Summary|Join|PersistPkpk)/))return false;}
var columnsCount=0;for(var it74=0,c,it74__arr=this._columns,it74__len=it74__arr.length;(c=it74__arr[it74])||it74<it74__len;it74++){if(c.datatype=='Lat'||c.datatype=='Lng'||c.datatype=='Double'){columnsCount++;}}
if(columnsCount<2)return false;return true;});})(Grid0.Schema,Grid0);JS2.OO.createClass("Grid0.Dataset");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('accessor',['pks']);K.oo('accessor',['columns']);K.oo('accessor',['viewColumns']);K.oo('method',"initialize",function(dsId,data,isLeft){this.datasetId=dsId;this.data=data;this._pks=[];this._columns=[];this._viewColumns=[];this.isLeft=isLeft;});K.oo('method',"pkTable",function(absRowIdx){var table=[];for(var it5=0,pk,it5__arr=this._pks,it5__len=it5__arr.length;(pk=it5__arr[it5])||it5<it5__len;it5++){var val=this.data.getCell(pk.colIdx,absRowIdx).val;val=DISPLAY.datatype(pk.datatype,val);var name=pk.name;table.push([name,val]);}
return table;});K.oo('method',"pkVals",function(absRowIdx){var ret=[];for(var it6=0,pk,it6__arr=this._pks,it6__len=it6__arr.length;(pk=it6__arr[it6])||it6<it6__len;it6++){var val=this.data.getCell(pk.colIdx,absRowIdx).val;ret.push(val);}
return ret;});K.oo('method',"rowHash",function(absRowIdx){if(this.isLeft)return this.data.payload().getHash(absRowIdx);return this.pkVals(absRowIdx);});})(Grid0.Dataset,Grid0);var USER_ACTION={NOT_VOTE:0,AGREE:1,DISAGREE:-1,NO_USER:2};JS2.OO.createClass("Grid0.Payload");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('accessor',['columns']);K.oo('accessor',['rows']);K.oo('method',"initialize",function(options){this.datasetKey=options.dataset.key;this.datasetId=options.dataset.id;this.url='/tables/'+this.datasetKey;this.mainUrl='/tables/main/'+this.datasetKey;this.voteUrl='/tables/vote/'+this.datasetKey;this.metaUrl='/tables/metadata/'+this.datasetKey;this.gridStateId=options.grid.gridStateId;this.apiMode=options.grid.apiMode;this.unsubscribe=options.grid.unsubscribe;this.grid={};this.view={};this.view.columns=[];this.immutable={};this.immutable.fields=[];this.first=true;});K.oo('method',"share_state",function(fun){var url='/tables/main/share_state';var grid=this.richGridJson();var params={grid:grid};sci.ajax.post(url,params,function(p){var key=p.key;var name=p.name;fun(key,name);});});K.oo('method',"saveGridState",function(fun,onError){var url='/tables/main/create_state';var grid=this.richGridJson();var params={grid:grid};if(onError)params.onError=onError;sci.ajax.post(url,params,function(id){fun(id);});});K.oo('method',"setCacheTtl",function(ttl,fun){var url=this.metaUrl+'/update_cache_ttl';var params={cacheTtl:ttl};sci.ajax.post(url,params,function(p){fun(p);});});K.oo('method',"getTotalPages",function(fun){var url='/tables/main/get_row_count';var params={grid:this.gridJson()};sci.ajax.post(url,params,function(p){fun(p);});});K.oo('method',"setExclusions",function(exs){this.exclusions=exs;this.inUpdateExclusions=true});K.oo('method',"isBigData",function(){return this.grid.summary['big-data'];});K.oo('method',"quartzError",function(){return this.grid.summary['quartz-error'];});K.oo('method',"isUnlisted",function(){return this.grid.summary['unlisted'];});K.oo('method',"getCacheState",function(){return this.grid.summary['cache-state'];});K.oo('method',"loadData",function(callBack,options){if(options==null)options={};var self=this;var params={};var url=this.url+'/summary.js';var urlParams=[];if(this.unsubscribe)urlParams.push("unsubscribe=true");if(this.apiMode)urlParams.push('api_mode=true');if(urlParams.length)url+='?'+urlParams.join('&');if(this.first){if(this.gridStateId){params.grid_state_id=this.gridStateId;}else{var grid=$('#gridState').text();if(grid)params.grid=grid;}
this.first=false;sci.ajax.get(url,params,function(p){self._loadedData(p,callBack);});}else{params.grid=this.richGridJson();var changesSince=$('#changesSince').val();if(changesSince){if(this.isBigData())params.api_mode=true;params.filter_changes_since=changesSince;}
this.actions.setConsensusDelta(!!changesSince);if(this.inUpdateExclusions){params.exclusions=JSON.stringify(this.exclusions);this.inUpdateExclusions=false;}
params.onError=options.onError;if(options.jumpToRow){params.jumpToRow=options.jumpToRow;}
if(options.force_cache){params.force_cache=true}
if(options._event){params._event=options._event;params._event_params=options._event_params;}else{params._event='SummaryRequest';params._event_params=JSON.stringify({page_size:this.actions.pageSize(),page_number:this.actions.pageNumber()});}
sci.ajax.post(url,params,function(p){self._loadedData(p,callBack)});}});K.oo('method',"reloadGrid",function(callBack){this.first=true;this.loadData(callBack);});K.oo('method',"state",function(){return this.gridJson();});K.oo('method',"richGridJson",function(){var grid={};grid.actions=this.actions.raw();grid.view=this.view;var ret=JSON.stringify(grid);return ret;});K.oo('method',"gridJson",function(){var grid={};grid.actions=this.actions.raw();var fields=[];for(var i=0,c;c=this.view.columns[i++];){fields.push(c.field);c.field=null;}
var ret=JSON.stringify(grid);for(var i=0,c;c=this.view.columns[i];i++){c.field=fields[i];}
return ret;});K.oo('method',"loadRowSummary",function(colIdx,rowIdx,callBack){var params={};var rowHash=this.getHash(rowIdx);var column=this.columns()[colIdx];var field=this.schema.getFieldInfo(column.id);params.row_hash=rowHash;params.field_qid=field.qfieldId;params.field_id=column.id;params.column_dataset_id=column.datasetId;params.grid=this.gridJson(field.id);var url=this.url+'/row_summary.js';var self=this;sci.ajax.post(url,params,function(p){self._loadRowSummary(p,callBack)});});K.oo('method',"_loadRowSummary",function(s,callBack){var summary=new Grid0.SummaryParser(s,this.columns());if(callBack){callBack(summary);}});K.oo('method',"advSearchFields",function(search_dataset_or_id,callBack){var self=this;var params={};params.dataset_id=this.datasetId;params.search_dataset_or_id=search_dataset_or_id;var url='/search/advanced_find_fields.js';sci.ajax.post(url,params,function(p){callBack(p);});});K.oo('method',"searchFields",function(params,callBack){var self=this;switch(params.join_on){case'pk_pk':params.dataset_id=this.datasetId;case'pk_fk':params.dataset_id=this.datasetId;case'fk_pk':params.dataset_id=this.datasetId;}
params._event='JoinabilitySearch';params._event_params=JSON.stringify({table_id:params.dataset_id,field_id:parseInt(params.field_id)});var url='/search/find_fields.js';sci.ajax.post(url,params,function(p){callBack(p);});});K.oo('method',"_loadedData",function(grid,callBack){if(grid){this.grid=grid;this.qlisp=grid.qlisp;this.actions.setActions(grid.actions,grid.summary);if(grid.immutable){if(grid.immutable.fields.length<1||grid.view.columns.length<1){sci.website.error('No data to show in this table');return;}
this.immutable=grid.immutable;this.view=grid.view;this.schema.setSchema(this.immutable,this.view);}
this.restoreFieldWidths();this.summary=new Grid0.SummaryParser('dataset',grid.summary,this.schema.columns());}
if(callBack)callBack();});K.oo('method',"addRow",function(datasetId,pkeys,values,sharedProps,callBack){var params=sharedProps;var payload={pkeys:pkeys,values:values,datasetId:datasetId};params.payload=JSON.stringify(payload);params.column_dataset_id=payload.datasetId;params.grid=this.richGridJson();params._event='AddNewRow';var pk_values=$.map(values,function(v){return v.value;});var values_csv=JSON.stringify(pk_values);values_csv=values_csv.substr(1,values_csv.length-2);params._event_params=JSON.stringify({values:values_csv,comment:params.comments,source:params.source,weight:params.weight,confidence:params.confidence});var url=this.voteUrl+'/add_row.js';var self=this;sci.ajax.post(url,params,function(p){self._loadedData(p,callBack);});});K.oo('method',"refresh",function(url,params,callBack){var self=this;if(params.includState)params.grid=this.gridJson();sci.ajax.post(url,params,function(p){self._loadedData(p,callBack);});});K.oo('method',"join",function(joins,callBack,onError){var self=this;var url=this.improveUrl('join')+'/join';var params={};params.joins=JSON.stringify(joins);params.grid=this.richGridJson();var firstJoin=joins[0];params._event='JoinTables';params._event_params=JSON.stringify({field_id1:firstJoin.left_field_id,field_id2:firstJoin.right_field_id,table_id1:this.datasetId,table_id2:firstJoin.right_dataset_id});params.onError=onError;sci.ajax.post(url,params,function(p){self._loadedData(p,callBack);});});K.oo('method',"merge",function(params,callBack){var par={};var url=this.improveUrl('merge')+'/merge';par['field_mapping']=JSON.stringify(params.mapping);par['add_columns']=JSON.stringify(params.addColumns);par['from_dataset_id']=params.datasetId;par['add_rows']=params.addRows;par.grid=this.richGridJson();par._event='MergeTables';par._event_params=JSON.stringify({merge_target_table_id:this.actions.primaryDatasetId(),merge_source_table_id:par.from_dataset_id});var self=this;sci.ajax.post(url,par,function(p){self._loadedData(p,callBack);});});K.oo('method',"addField",function(field_hash,callBack,onError){var self=this;var url=this.mainUrl+'/add_field';var params={};params.field=JSON.stringify(field_hash);params.grid=this.gridJson();params._event='AddField';params._event_params=JSON.stringify({table_id:this.datasetId,field_name:field_hash['name'],datatype:field_hash['datatype']});params.onError=onError;this.fieldWidths=this.getFieldWidths();sci.ajax.post(url,params,function(p){self._loadedData(p,callBack);});});K.oo('method',"reorderFields",function(orders,callBack){var url='/tables/fields/'+this.datasetKey+'/reorder.js';var params={fieldsOrder:JSON.stringify(orders),onError:function(){}};params.grid=this.richGridJson();sci.ajax.post(url,params,(function(self){return function(p){self._loadedData(p,callBack);}})(this));});K.oo('method',"submitTableDetails",function(params,callBack){var url=this.metaUrl+'/details.js';sci.ajax.post(url,params,callBack);});K.oo('method',"removeTable",function(){var url=this.mainUrl+'/delete';sci.ajax.post(url,{});});K.oo('method',"getFieldWidths",function(){var cols=this.columns();var widths={};for(var it56=0,c,it56__arr=cols,it56__len=it56__arr.length;(c=it56__arr[it56])||it56<it56__len;it56++){widths[c.id]=c.width;}
return widths;});K.oo('method',"restoreFieldWidths",function(){if(!this.fieldWidths)return;var cols=this.columns();for(var it57=0,c,it57__arr=cols,it57__len=it57__arr.length;(c=it57__arr[it57])||it57<it57__len;it57++){if(this.fieldWidths[c.id])c.width=this.fieldWidths[c.id];}
this.fieldWidths=null;});K.oo('method',"vote",function(colIdx,absRowIdx,voteHash,callBack){var params=voteHash;var column=this.columns()[colIdx];var field=this.field(colIdx);params.row_hash=this.getHash(absRowIdx);params.pk=[];params.field_qid=field.qfieldId;params.field_id=column.id;params.column_dataset_id=column.datasetId;params['field_ids[]']=[field.id];params.grid=this.richGridJson();params._event='SubmitVote';params._event_params=JSON.stringify({value:params.value,field_id:params.field_id,row_hash:params.row_hash,comment:params.comments,source:params.source,weight:params.weight,confidence:params.confidence});var url=this.voteUrl+'/vote.js';if(this.unsubscribe)url+="?unsubscribe=true";var self=this;sci.ajax.post(url,params,function(p){self._vote(p,absRowIdx,colIdx,callBack)});});K.oo('method',"_vote",function(p,absRowIdx,colIdx,callBack){callBack.checkBigData();var cardinality=p["row-count-set"];if(cardinality==0){if((p["row-count-limited"]-1)%this.pagination.limit==0){callBack.paginate();}else{this.summary.removeRow(absRowIdx);callBack.loadData();}}else{var rowSummary=new Grid0.SummaryParser('row',p,this.columns());this.summary.rows[absRowIdx][colIdx]=rowSummary.rows[0][colIdx];callBack.refreshCell(absRowIdx,colIdx);}});K.oo('method',"suggestAlternative",function(absRowIdx,voteHash,callBack){var column=this.columns()[0];var params=voteHash;params.row_hash=this.getHash(absRowIdx);params.pk=[];params.column_dataset_id=column.field.datasetId;params._event=(params.weight<0)?'MarkRowGarbage':'SuggestAlternativeRow';var values_csv=JSON.stringify(params.pk_values);values_csv=values_csv.substr(1,values_csv.length-2);params._event_params=JSON.stringify({row_hash:params.row_hash,values:values_csv,comment:params.comments,source:params.source,weight:params.weight,confidence:params.confidence});var url=this.voteUrl+'/suggest_alternative.js';var self=this;sci.ajax.post(url,params,function(p){self.loadData(callBack);});});K.oo('method',"guessColumnWidths",function(){if(!this.summary)return;this.summary.guessColumnWidths();});K.oo('method',"getCell",function(colIdx,absRowIdx){return this.summary.get(colIdx,absRowIdx);});K.oo('method',"getHash",function(absRowIdx){return this.summary.getHash(absRowIdx);});K.oo('method',"col",function(colIdx){return this.view.columns[colIdx];});K.oo('method',"rowHashes",function(){return this.summary.rowHashes;});K.oo('method',"rowHash",function(rowIdx){return this.summary.rowHashes[rowIdx];});K.oo('method',"columns",function(){return this.view.columns;});K.oo('method',"field",function(colIdx){return this.schema.getFieldInfo(this.view.columns[colIdx].id);});K.oo('method',"datasets",function(){return this.immutable.datasets;});K.oo('method',"dataset",function(id){return this.datasetLookup[id];});K.oo('method',"rows",function(){return this.summary.rows;});K.oo('method',"pagination",function(){var ret=this.ast.pagination();var rowCount=this.grid.summary['row-count-limited'];var totalPages=(rowCount<0)?-1:Math.ceil(rowCount/ret.limit);totalPages=(totalPages==0)?1:totalPages;ret['totalPages']=totalPages;return ret;});K.oo('method',"paginate",function(page,limit){this.actions.paginate(page,limit);});K.oo('method',"setAggregation",function(colIdx,agg){this.columns()[colIdx].aggregationMethod=agg;});K.oo('method',"markGarbage",function(params,callBack){var params=params;var column=this.columns()[0];params.rows=JSON.stringify(params.rows);params.column_dataset_id=column.field.datasetId;params._event='MarkRowGarbage';params._event_params=JSON.stringify({row_hash:params.row_hash});var url=this.voteUrl+'/mark_garbage.js';var self=this;sci.ajax.post(url,params,function(p){self.loadData(callBack);});});K.oo('method',"toggleGarbage",function(state,callBack){this.actions.garbage(state);var options={};options._event='SetGarbageRowVisibility';options._event_params=JSON.stringify({should_show_garbage_rows:state});this.loadData(callBack,options);});K.oo('method',"includeGarbage",function(){return this.actions.getGarbageState();});K.oo('method',"registerCallBacks",function(functHash){});K.oo('method',"submitImport",function(params,callback){var url=this.improveUrl('import')+'/submit';var self=this;sci.ajax.post(url,params,function(p){self._submitImport(p,callback);});});K.oo('method',"_submitImport",function(data,callback){callback(data);});K.oo('method',"submitClone",function(params,callback){var url=this.mainUrl+'/clone_dataset';var self=this;params.grid=this.gridJson();sci.ajax.post(url,params,function(p){self._submitClone(p,callback);});});K.oo('method',"_submitClone",function(data,callback){callback(data);});K.oo('method',"setPermissions",function(permissions,callBack){var url=this.metaUrl+'/sharing';sci.ajax.post(url,permissions,(function(self){return function(p){self.refreshCurrentPage();}})(this))});K.oo('method',"refreshCurrentPage",function(){window.location.href=window.location.href;});K.oo('method',"loadDatasetTitle",function(permissions){var jqDsTitle=$('.dsType');jqDsTitle.attr('class','dsType '+permissions.datasetClass);jqDsTitle.attr('title',permissions.datasetDesc);});K.oo('method',"loadPermissions",function(permissions,callBack){this.data=grid.data;this.data.dataset.isStatic=permissions.isStatic;this.data.dataset.subscribe=permissions.subscribe;this.data.dataset.unlisted=permissions.unlisted;this.data.dataset.isPrivate=permissions.isPrivate;if(callBack)callBack();});K.oo('method',"publish",function(params){params.grid=this.richGridJson();var url=this.mainUrl+'/publish';sci.ajax.post(url,params);});K.oo('method',"saveView",function(params){params.grid=this.richGridJson();var url=this.mainUrl+'/save_view';sci.ajax.post(url,params,function(){});});K.oo('method',"saveMerge",function(params){params.grid=this.richGridJson();var url=this.mainUrl+'/save_merge';sci.ajax.post(url,params,function(){});});K.oo('method',"getUserAction",function(colIdx,rowIdx){return this.summary.rows[rowIdx][colIdx].userAction;});K.oo('method',"sort",function(colIdx,desc){if(this._rows.length<2)return;var operator=desc?'>=':'<=';var func=function(a,b){function chunkify(row){eval("var v = row["+colIdx+"].val;");var t=(v)?v.toString().toLowerCase():'';var tz=new Array();var x=0,y=-1,n=0,i,j;while(i=(j=t.charAt(x++)).charCodeAt(0)){var m=(i==46||(i>=48&&i<=57));if(m!==n){tz[++y]="";n=m;}
tz[y]+=j;}
return tz;}
function direction(ret){eval("if ("+desc+") ret = -ret;");return ret;}
var aa=chunkify(a);var bb=chunkify(b);for(x=0;aa[x]&&bb[x];x++){if(aa[x]!==bb[x]){var c=Number(aa[x]),d=Number(bb[x]);if(c==aa[x]&&d==bb[x]){return direction(c-d);}else return direction((aa[x]>bb[x])?1:-1);}}
return direction(aa.length-bb.length);}
this._rows.sort(func);this.callBacks.loadData();});K.oo('method',"improveUrl",function(action){return'/tables/'+action+'/'+this.datasetKey;});K.oo('method',"reportAbuser",function(userId){var url='/spam/report_abuser'
AJAX.post(url,{userId:userId});});K.oo('method',"addToWhiteList",function(userId){var url='/spam/add_to_whitelist'
AJAX.post(url,{userId:userId});});K.oo('method',"addToBlackList",function(userId,reason,callback){var url='/spam/add_to_blacklist'
AJAX.post(url,{userId:userId,reason:reason},callback);});K.oo('method',"saveDefaultReference",function(reference,callback){var url=this.mainUrl+'/save_default_reference';AJAX.post(url,{reference:reference},callback);});K.oo('method',"quickFilter",function(operator,fieldId,value,callBack,onError){var url=this.url+'/quick_filter';var params={};params.grid=this.richGridJson();params.operator=operator;params.fieldId=fieldId;params.value=value;params.onError=onError;AJAX.post(url,params,(function(self,callBack){return function(p){self._loadedData(p,callBack);}})(this,callBack));});K.oo('method',"clearFunction",function(callBack){var url=this.mainUrl+'/clear_function';sci.ajax.post(url,{},(function(self,callBack){return function(p){self._loadedData(p,callBack);}})(this,callBack));});})(Grid0.Payload,Grid0);JS2.OO.createClass("Grid0.SummaryParser");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','maxWidth',350);K.oo('member','minWidth',80);K.oo('member','defWidth',120);K.oo('member','padding',15);K.oo('method',"initialize",function(summaryType,payload,columns){this.summaryType=summaryType;this.rowHashes=[];this._processPayload(payload,columns);});K.oo('method',"getCellById",function(colId,absRowIdx){var row=this.rows[absRowIdx];if(row){for(var it77=0,cell,it77__arr=row,it77__len=it77__arr.length;(cell=it77__arr[it77])||it77<it77__len;it77++){if(cell.colId==colId)return cell;}}
return{};});K.oo('method',"get",function(colIdx,absRowIdx){return this.rows[absRowIdx]?this.rows[absRowIdx][colIdx]:{}});K.oo('method',"removeRow",function(absRowIdx){this.rows.splice(absRowIdx,1);this.rowHashes.splice(absRowIdx,1);});K.oo('method',"getHash",function(absRowIdx){return this.rows[absRowIdx].rowHash;});K.oo('method',"_processPayload",function(payload,columns){this.header=payload.header;this.columns=columns;var rows=payload.rows;this.rows=[];var columnWidths=[];var isDataset=this.summaryType=='dataset'?true:false;var autoWidth=true;for(var i=0,c;c=this.columns[i];i++){if(c.width!=this.defWidth){autoWidth=false;break;}}
for(var i=0,r;r=rows[i];i++){if(typeof(r)=="string")r=JSON.parse(JSON.stringify('['+r+']'));var row=[];for(var cIdx=0,c;c=this.columns[cIdx];cIdx++){var lookup=this.header[c.id];var cell={};if(lookup){var vals=(r[lookup.consensus_val]instanceof Array)?$.map(r[lookup.consensus_val],function(v){return v.val}):r[lookup.consensus_val];cell.colId=c.id;cell.val=vals;cell.valList=r[lookup.consensus_val];cell.userVal=r[lookup.user_vote];cell.consensus=r[lookup.strength];cell.userAction=r[lookup.user_action];cell.numVotes=r[lookup.unique_votes];cell.oldVal=r[lookup.consensus_val_old];cell.valChanged=r[lookup.consensus_val_changed]=="true"?true:false;if(autoWidth||c.width==0){if(!columnWidths[cIdx])columnWidths[cIdx]=[];if(isDataset&&cell.val)columnWidths[cIdx].push([i,cell.val.toString().length]);}}
row.push(cell);}
row.rowHash=r[0];this.rowHashes.push(row.rowHash);this.rows.push(row);}
if(isDataset&&rows.length>0&&columnWidths.length>0){for(var i=0,len=this.columns.length;i<len;i++){if(!columnWidths[i])continue;var hasValueCellSize=columnWidths[i].length;if(hasValueCellSize){var widthIndex=Math.ceil(hasValueCellSize*0.9)-1;columnWidths[i].sort(function(a,b){return a[1]>b[1]?1:-1;});this.columns[i].width=this._getWidth(columnWidths[i][widthIndex][0],i);}}}
for(var i=0,c;c=this.columns[i];i++){if(!c.width)c.width=this.minWidth;}});K.oo('method',"guessColumnWidths",function(){var columnWidths=[];for(var i=0,r;r=this.rows[i];i++){for(var cIdx=0,len=this.columns.length;cIdx<len;cIdx++){if(!columnWidths[cIdx])columnWidths[cIdx]=[];if(r[cIdx].val)columnWidths[cIdx].push([i,r[cIdx].val.toString().length]);}}
for(var i=0,c;c=this.columns[i];i++){var hasValueCellSize=columnWidths[i].length;if(hasValueCellSize){var widthIndex=Math.ceil(hasValueCellSize*0.9)-1;columnWidths[i].sort(function(a,b){return a[1]>b[1]?1:-1;});c.width=this._getWidth(columnWidths[i][widthIndex][0],i);}}});K.oo('method',"_getWidth",function(rowIdx,colIdx){var len=DISPLAY.getCharWidth(this.rows[rowIdx][colIdx].val)+this.padding;if(len<this.minWidth)len=this.minWidth;if(len>this.maxWidth)len=this.maxWidth;return len;});})(Grid0.SummaryParser,Grid0);JS2.OO.createClass("Grid0.SuggestionsParser");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(payload){this._parse(payload);});K.oo('method',"_parse",function(payload){this.list=[];for(var it78=0,p,it78__arr=payload,it78__len=it78__arr.length;(p=it78__arr[it78])||it78<it78__len;it78++){this.list.push({value:p[0],count:p[1]});}});})(Grid0.SuggestionsParser,Grid0);JS2.OO.createClass("Grid0.BallotParser");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(payload){this._parse(payload);});K.oo('method',"_parse",function(payload){var metaData=payload.shift();this.voteCount=metaData[0];this.totalWeight=metaData[1];var list=[];for(var it79=0,p,it79__arr=payload,it79__len=it79__arr.length;(p=it79__arr[it79])||it79<it79__len;it79++){list.push(p);}
this.list=list;});})(Grid0.BallotParser,Grid0);JS2.OO.createClass("Grid0.VotesParser");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(payload){this.votes=[];this._parse(payload);});K.oo('method',"_parse",function(payload){this.voteCount=payload.shift();var payloadVotes=payload;for(var it80=0,vote,it80__arr=payloadVotes,it80__len=it80__arr.length;(vote=it80__arr[it80])||it80<it80__len;it80++){this.votes.push(new Grid0.VoteParser(vote));}});})(Grid0.VotesParser,Grid0);JS2.OO.createClass("Grid0.VoteParser");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(payload){this._parse(payload);});K.oo('method',"_parse",function(payload){if(!payload||payload.length==0)return;this.weight=payload[1];this.voterName=payload[12];this.value=payload[2];this.rawValue=payload[3];this.comment=payload[9];this.source=payload[5];this.sourceDataset=payload[6];this.voterId=payload[0];this.counted=payload[11];this.submitted=payload[7];});})(Grid0.VoteParser,Grid0);JS2.OO.createClass("Grid0.Actions");(function(K,Package){var self=K;var _super=JS2.OO['super'];MAX_NUM_SORTS=1;K.oo('method',"raw",function(){return this.actions;});K.oo('method',"pageSize",function(){return this.actions.limit||200;});K.oo('method',"pageNumber",function(){return this.actions.page||1;});K.oo('method',"isSimple",function(){return this.actions.collection.length==1;});K.oo('method',"sort",function(type,modifier,colIdx){var col=this.schema.column(colIdx);var field=col.field;var sort={};sort.fieldId=field.id;sort.offset=field.offset;sort.asc=type=='asc';sort.attribute=modifier=='consensus-value'?'consensus-val':modifier;this.actions.rowSorts.unshift(sort);if(this.actions.rowSorts.length>1&&this.actions.rowSorts[0].fieldId==this.actions.rowSorts[1].fieldId){this.actions.rowSorts.splice(1,1);}
this.actions.rowSorts=this.actions.rowSorts.slice(0,2);});K.oo('method',"sortedFieldNames",function(){var fieldNames=[];for(var it26=0,sort,it26__arr=this.actions.rowSorts,it26__len=it26__arr.length;(sort=it26__arr[it26])||it26<it26__len;it26++){var f=this.schema.getFieldInfo(sort.fieldId);if(f)fieldNames.push(f.name);}
return fieldNames.slice(0,MAX_NUM_SORTS);});K.oo('method',"primarySortField",function(){return this.actions.rowSorts[0];});K.oo('method',"clearAllFilters",function(){this.actions.rowFilters=[];this.actions.voteFilters=[];this.actions.search.queries=[];this.actions.page=1;if(this.actions.geoFunction){this.actions.geoFunction.geoFilters=[];}
this.dim.resetRowOffset();this.data.loadData();});K.oo('method',"setFilters",function(rowFilters,voteFilters,options){this.setRowFilters(rowFilters);this.setVoteFilters(voteFilters);this.actions.page=1;this.dim.resetRowOffset();this.data.loadData(options);});K.oo('method',"setSearchQueries",function(queries){this.actions.search.queries=queries;this.actions.page=1;this.dim.resetRowOffset();this.data.loadData();});K.oo('method',"verifyGeoFunction",function(){if(this.actions.geoFunction&&this.actions.geoFunction.latFieldId&&this.actions.geoFunction.lngFieldId){return true;}else{return false;}});K.oo('method',"initGeoFunction",function(lat,lng){this.actions.geoFunction={_rclass:"Qlisp::Action::GeoFunction",latFieldId:lat,lngFieldId:lng,geoSort:null,geoFilters:[]};});K.oo('method',"disableGeoFunction",function(){this.actions.geoFunction=null;});K.oo('method',"setGeoFunction",function(geoFunction){this.actions.geoFunction=geoFunction;this.actions.page=1;this.dim.resetRowOffset();this.data.loadData();});K.oo('method',"isGeoUseField",function(id){return this.actions.geoFunction&&(this.actions.geoFunction.latFieldId==id||this.actions.geoFunction.lngFieldId==id);});K.oo('method',"hasGeoFilter",function(){return this.actions.geoFunction&&this.actions.geoFunction.geoFilters.length>0;});K.oo('method',"getFqrRequirementSets",function(){return this.actions.fqrRequirementSets;});K.oo('method',"setFqrRequirementSets",function(fqrRequirementSets){this.actions.fqrRequirementSets=fqrRequirementSets;});K.oo('method',"getUseFqr",function(){return this.actions.useFqr;});K.oo('method',"setUseFqr",function(use){this.actions.useFqr=!!use;});K.oo('method',"isFqrRequirementSetsNotEmpty",function(){return!!this.getFqrRequirementSets().length;});K.oo('method',"setActions",function(actions,summary){this.summary=summary;if(actions){this.actions=actions;this.actions.jumpToRow='';this.collection=this.actions.collection;this.last=this.collection[0];}});K.oo('method',"setConsensusDelta",function(useDelta){this.consensusDelta=useDelta;});K.oo('method',"usingDelta",function(){return this.consensusDelta;});K.oo('method',"paginate",function(page,limit){if(page)this.actions.page=parseInt(page);if(limit)this.actions.limit=parseInt(limit);});K.oo('method',"primaryDatasetId",function(){for(var i=this.collection.length;i>=0;i--){var action=this.collection;if(action.datasetId){return action.datasetId;}}
return 0;});K.oo('method',"getJoinFieldsInfo",function(){var infos=[];for(var i=this.collection.length-1;i>=0;i--){var action=this.collection[i];if(action._rclass.match(/Qlisp::Action::Join/)){var rightSummary=action.rightActions.collection[0];var datasetInfo={};datasetInfo.datasetId=rightSummary.datasetId;datasetInfo.joinType=action.joinType;datasetInfo.leftFieldId=action.leftFieldId;datasetInfo.rightFieldId=action.rightFieldId;for(var it27=0,fId,it27__arr=rightSummary.fieldIds,it27__len=it27__arr.length;(fId=it27__arr[it27])||it27<it27__len;it27++){if(fId==0)continue;var field={};field.datasetId=rightSummary.datasetId;field.datasetName=this.schema.dataset(field.datasetId).name;field.fieldId=fId;field.fieldName=this.schema.field(fId).name;field.rightFieldId=action.rightFieldId;var info={};info.field=field;info.datasetInfo=datasetInfo;infos.push(info);}}}
return infos;});K.oo('method',"join",function(joinOn,fields,datasetsHash){for(var it28=0,f,it28__arr=fields,it28__len=it28__arr.length;(f=it28__arr[it28])||it28<it28__len;it28++){datasetInfo=datasetsHash[f.datasetId];if(datasetInfo.fieldIds==null)datasetInfo.fieldIds=[];datasetInfo.fieldIds.push(f.qfieldId);}
var joins=[];for(var datasetId in datasetsHash){var datasetInfo=datasetsHash[datasetId];var join={right_dataset_id:datasetId,join_type:datasetInfo.joinType,field_ids:datasetInfo.fieldIds};join.right_field_id=datasetInfo.rightFieldId;join.left_field_id=datasetInfo.leftFieldId;joins.push(join);}
return joins;});K.oo('method',"isPkFkJoin",function(){for(var i=this.collection.length-1;i>=0;i--){var action=this.collection[i];if(action._rclass.match(/Qlisp::Action::Join/)){var leftPrimary=false;var rightPrimary=false;if(action.leftFieldId===null){leftPrimary=true;}
if(action.rightFieldId===null){rightPrimary=true;}
return!(leftPrimary&&rightPrimary);}}
return false});K.oo('method',"topAction",function(){return this.collection[this.collection.length-1];});K.oo('method',"containsJoin",function(){for(var it29=0,action,it29__arr=this.collection,it29__len=it29__arr.length;(action=it29__arr[it29])||it29<it29__len;it29++){if(action._rclass.match(/Qlisp::Action::Join/))return true;}
return false;});K.oo('method',"containsMerge",function(){for(var it30=0,action,it30__arr=this.collection,it30__len=it30__arr.length;(action=it30__arr[it30])||it30<it30__len;it30++){if(action._rclass.match(/Qlisp::Action::Merge/))return true;}
return false;});K.oo('method',"isTempJoin",function(){return(this.topAction()._rclass.match(/Qlisp::Action::Join/));});K.oo('method',"isTempMerge",function(){return(this.topAction()._rclass.match(/Qlisp::Action::Merge/));});K.oo('method',"isChainedJoin",function(){return(this.collection.length>2);});K.oo('method',"getGarbageState",function(){return!!this.actions.includeGarbage;});K.oo('method',"garbage",function(state){this.actions.includeGarbage=state;});K.oo('method',"getJoinFieldIds",function(){if(!this.isPkFkJoin())return[];});K.oo('method',"pagination",function(){if(this.summary['row-count-dbcache']!=null)this.summary['row-count-limited']=this.summary['row-count-dbcache'];if(this.summary['row-count-limited']==null)this.summary['row-count-limited']=this.summary['row-count-total'];var rowCount=this.summary['row-count-limited'];var total=(rowCount<0)?-1:Math.ceil(rowCount/this.actions.limit);total=(total==0)?1:total;return{limit:this.pageSize(),page:this.getRowOffset()>=0?this.summary['page-offset']+1:this.pageNumber(),totalPages:total,totalRows:rowCount};});K.oo('method',"getRowOffset",function(){return this.summary['row-offset'];});K.oo('method',"isLimited",function(){if(!this.summary['row-count-limited'])return false;return this.summary['row-count-limited']==this.summary['row-count-total'];});K.oo('method',"primaryDatasetId",function(){for(var i=(this.collection.length-1);i>=0;i--){var action=this.collection[i];if(action.datasetId){return action.datasetId;}}});K.oo('method',"changeVotePresentMode",function(m){this.consensusDelta=false;this.actions.votePresentation=m;});K.oo('method',"votePresentMode",function(){return this.actions.votePresentation;});K.oo('method',"setRowFilters",function(filters){this.actions.rowFilters=filters;});K.oo('method',"setVoteFilters",function(filters){this.actions.voteFilters=filters;});K.oo('method',"rowFilters",function(){return this.actions.rowFilters;});K.oo('method',"voteFilters",function(){return this.actions.voteFilters;});K.oo('method',"exclusions",function(){return this.actions.exclusions;});K.oo('method',"searchQueries",function(){return this.actions.search.queries;});K.oo('method',"geoFunction",function(){return this.actions.geoFunction;});K.oo('method',"setTableVoteFilters",function(filters){this.actions.voteFilters=filters;});K.oo('method',"nRowFilters",function(){return this.rowFilters().length;});K.oo('method',"nVoteFilters",function(){return this.voteFilters().length;});K.oo('method',"nFilters",function(){return this.nRowFilters()+this.nVoteFilters();});K.oo('method',"getReference",function(){return this.actions.reference;});K.oo('method',"setReference",function(reference){this.actions.reference=reference;if(this.data.bigData){this.data.saveGridState((function(self){return function(){self.data.loadData();}})(this));}else{this.data.loadData();}});K.oo('method',"hasFilterOnField",function(id){for(var it31=0,f,it31__arr=this.actions.rowFilters,it31__len=it31__arr.length;(f=it31__arr[it31])||it31<it31__len;it31++){if(f.fieldId==id)return true}
for(var it32=0,f,it32__arr=this.actions.voteFilters,it32__len=it32__arr.length;(f=it32__arr[it32])||it32<it32__len;it32++){if(f.fieldId==id)return true}
return false;});K.oo('method',"clearAllFiltersOnField",function(id){var rowFilters=[],voteFilters=[];for(var it33=0,f,it33__arr=this.actions.rowFilters,it33__len=it33__arr.length;(f=it33__arr[it33])||it33<it33__len;it33++){if(f.fieldId!=id)rowFilters.push(f);}
for(var it34=0,f,it34__arr=this.actions.voteFilters,it34__len=it34__arr.length;(f=it34__arr[it34])||it34<it34__len;it34++){if(f.fieldId!=id)voteFilters.push(f);}
this.actions.rowFilters=rowFilters;this.actions.voteFilters=voteFilters;});K.oo('method',"isShowFieldName",function(show){return!!this.actions.showFieldName;});K.oo('method',"setShowFieldName",function(show){this.actions.showFieldName=!!show;});K.oo('method',"setDedeupSetting",function(dedupeSetting){this.actions.dedupeSetting=dedupeSetting;});K.oo('method',"getDedupeSetting",function(){return this.actions.dedupeSetting||{minDisplay:0.75,minAutoFold:0.85,fieldSettings:[]};});K.oo('method',"setFulltextSetting",function(fulltextSetting){this.actions.fulltextSetting=fulltextSetting;});K.oo('method',"getFulltextSetting",function(){return this.actions.fulltextSetting;});K.oo('method',"isFulltextSearchEnabled",function(){return!!this.actions.fulltextEnabled;});K.oo('method',"isDedupeEnabled",function(){return!!this.actions.dedupeEnabled;});K.oo('method',"setFulltextSearchEnabled",function(enable){this.actions.fulltextEnabled=enable;});K.oo('method',"setDedupeEnabled",function(enable){this.actions.dedupeEnabled=enable;});OPERATOR_LOOKUP={"on":"$eq","not-on":"$neq","before":"$lt","after":"$gt","contains":"$has","containsp":"$has","eq":"$eq","eqp":"$eq","neq":"$neq","neqp":"$neq","eq-in":"$in","eqp-in":"$in","starts":"$bw","ends":"$ew","<":"$lt",">":"$gt"}
K.oo('method',"getApiParams",function(){var filtersHash=$.extend(this.getRowFilterParams(),this.getSearchParams(),this.getGeoFilterParams());var sortHash=this.getSortParams();filterParams=($.isEmptyObject(filtersHash))?null:"&filters="+JSON.stringify(filtersHash);sortParams=($.isEmptyObject(sortHash))?null:"&sort="+JSON.stringify(sortHash);var paramsUrl=[filterParams,sortParams].join('');return paramsUrl;});K.oo('method',"getSortParams",function(){var sort=this.primarySortField();if(sort){var d=this.schema.getDatasetInfo(this.primaryDatasetId());var fieldRef=d.fieldRefs[sort.fieldId];var hash={};hash[fieldRef]=(sort.asc)?1:-1;return hash;}else{return{};}});K.oo('method',"escapeFilterValue",function(v){return $.trim(encodeURIComponent(v));});K.oo('method',"getRowFilterParams",function(){var rowFilters=this.rowFilters();if(rowFilters.length>0){var hash={};var d=this.schema.getDatasetInfo(this.primaryDatasetId());var fieldRefs=d.fieldRefs;var self=this;$.map(rowFilters,(function(fieldRefs){return function(f){if(f.type=='field'){var fieldRef=fieldRefs[f.fieldId];var mongo_operator=OPERATOR_LOOKUP[f.operator];var api_filter={};if(f.operator=="blank"){api_filter["$blank"]=true;}else if(f.operator=="nblank"){api_filter["$blank"]=false;}else if(mongo_operator=="$lt"||mongo_operator=="$gt"){if(f.inclusive)mongo_operator+="e";api_filter[mongo_operator]=self.escapeFilterValue(f.value);}else if(mongo_operator=="$in"){api_filter[mongo_operator]=$.map(f.value.split(","),function(item){return self.escapeFilterValue(item);});}else if(mongo_operator){api_filter[mongo_operator]=self.escapeFilterValue(f.value);}
hash[fieldRef]=$.extend(hash[fieldRef]||{},api_filter);}}})(fieldRefs));return hash;}else{return{};}});K.oo('method',"getSearchParams",function(){var queries=this.searchQueries();var self=this;if(queries.length>0){var array=$.map(queries,function(q){return self.escapeFilterValue(q.value);});return{"$search":array};}else{return{};}});K.oo('method',"getGeoFilterParams",function(){if(this.hasGeoFilter()){var geoFilters=this.actions.geoFunction.geoFilters;var hash={};$.map(geoFilters,function(f){if(f._rclass=="Qlisp::Action::GeoFilterDistance"){hash["$within_dist"]=[f.lat,f.lng,f.distance]}else if(f._rclass=="Qlisp::Action::GeoFilterBounding"){hash["$within_box"]=[f.lat,f.lng,f.lat1,f.lng1]}});return{"$loc":hash};}else{return{};}});})(Grid0.Actions,Grid0);JS2.OO.createClass("Grid0.Dimension");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"data");K.oo('member','explorerOffsetLeft',100);K.oo('method',"initialize",function(options){this.virtual={};this.visual={};this.actual={};this.main={};this.orig={};this.orig.width=options.width?options.width:900;this.orig.height=options.height?options.height:300;this.hScrollOffset=0;this.hExtendScrollOffset=0;this.rowOffset=0;this.minRowsNum=2;this.headerHeight=19;this.rowHeight=24;this.extendWidth=0;this.columnMinWidth=10;this.mainLeftWidth=0;this.row={height:this.rowHeight};this.scrollBar={width:16,height:15};this.firstTime=true;this.extendWidth=0;});K.oo('method',"e_resizeWidth",function(width){if(width)this.orig.width=width;this.resize();});K.oo('method',"e_resizeHeight",function(height){this.orig.height=height;this.resize();});K.oo('method',"e_resize",function(dim){if(dim){this.orig.height=dim.height;this.orig.width=dim.width;}
this.resize();});K.oo('method',"resize",function(){if(this.firstTime){this.doResize();return;}
if(this.resizeTimeout)clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout((function(self){return function(){self.doResize();}})(this),300);});K.oo('method',"doResize",function(){this.reset();this.notify('resizing',this);this.notify('resized',this);this.jqBodyOffset=this.jqGrid.first('.bMask').offset();this.jqBodyOffset.top=this.jqMain.offset().top+this.jqMain.first('.mainHeader').height()+this.jqGrid.first('.hMask').height();});K.oo('method',"e_vScroll",function(params){var y=params.top;this.rowOffset=Math.floor(y/this.row.height);});K.oo('method',"e_hScroll",function(params){this.hScrollOffset=0-params.left;});K.oo('method',"e_extendHScroll",function(left){this.hScrollOffset+=left;});K.oo('method',"e_showCell",function(context){if(context)this.showCell(context);});K.oo('method',"getContextFromEvent",function(e,matrix,oldCo){oldCo=oldCo||[];var pageX=e.pageX?e.pageX:e.clientX+document.documentElement.scrollLeft;var pageY=e.pageY?e.pageY:e.clientY+document.documentElement.scrollTop;return this.getContext(pageX,pageY,matrix,oldCo)});K.oo('method',"setGridOffset",function(){var uOffset=this.jqUniverse.offset();this.grid.offset={left:uOffset.left+this.main.left.width,top:uOffset.top+this.main.header.height};if(this.grid.offset.left<this.grid.left)this.grid.offset.left+=this.grid.left;});K.oo('method',"getContextFromCell",function(colIdx,rowIdx,matrix,oldCo){if(!matrix)return false;oldCo=oldCo||[];var total=this.hScrollOffset;var cols=this.schema.columns();if(colIdx==oldCo[0]&&rowIdx==oldCo[1])return false;var col=cols[colIdx];for(var i=0,c;c=cols[i];i++){if(c.hidden)continue;total+=c.width;if(i>colIdx)break;}
var colEle=matrix[colIdx];if(!colEle)return false;var ele=colEle[rowIdx];if(!ele)return false;var context={};context.colIdx=colIdx;context.rowIdx=rowIdx;context.absRowIdx=this.absRowIdx(rowIdx);var offset=$(ele).offset();context.pageX=offset.left;context.pageY=offset.top;context.col=col;context.ele=ele;context.cell=context.ele;context.rowTop=this.rowHeight*rowIdx;context.cellLeft=total-col.width+1;return context;});K.oo('method',"getContext",function(pageX,pageY,matrix,oldCo){if(!matrix)return false;oldCo=oldCo||[];var total=this.hScrollOffset;var colIdx=0;var col=false;var cols=this.schema.columns();var offset=this.jqBodyOffset;var x=pageX-offset.left;var y=pageY-offset.top;var rowIdx=Math.floor(y/this.rowHeight);for(var i=0,c;c=cols[i];i++){if(c.hidden)continue;col=c;colIdx=i;total+=c.width;if(total>x)break;}
if(!col)return false;if(colIdx==oldCo[0]&&rowIdx==oldCo[1])return false;var colEle=matrix[colIdx];if(!colEle)return false;var ele=colEle[rowIdx];if(!ele)return false;var context={};context.colIdx=colIdx;context.rowIdx=rowIdx;context.absRowIdx=this.absRowIdx(rowIdx);context.pageX=pageX;context.pageY=pageY;context.col=col;context.ele=ele;context.cell=context.ele;context.rowTop=this.rowHeight*rowIdx;context.cellLeft=total-col.width+1;return context;});K.oo('method',"changeContext",function(oldContext,matrix,direction){if(!matrix)return false;var total=this.hScrollOffset;var cols=this.schema.columns();var colIdx=oldContext.colIdx+direction.x;for(var i=colIdx,col;col=cols[i];){if(col.hidden){i+=direction.x;continue;}
colIdx=i;break;}
var rowIdx=oldContext.rowIdx+direction.y;var col=cols[colIdx];var colEle=matrix[colIdx];if(!colEle)return false;var ele=colEle[rowIdx];if(!ele)return false;var context={};context.colIdx=colIdx;context.rowIdx=rowIdx;context.absRowIdx=this.absRowIdx(rowIdx);context.col=col;context.ele=ele;context.cell=context.ele;context.rowTop=this.rowHeight*rowIdx-1;for(var i=0,c;c=cols[i];i++){if(c.hidden)continue;if(i>=context.colIdx)break;total+=c.width;}
context.cellLeft=total+1;return context;});K.oo('method',"reset",function(){if(this.firstTime){this.main={};this.main.jqHeader=this.jqMain.first('.mainHeader');this.main.jqFooter=this.jqMain.first('.mainFooter');this.main.jqLeft=this.jqMain.first('.mainLeft');this.main.jqRight=this.jqMain.first('.mainRight');this.firstTime=false;}
this.main.header={height:this.main.jqHeader.height()};this.main.footer={height:this.main.jqFooter.height()};this.main.left={left:0,width:this.mainLeftWidth};this.main.right={width:0};this.setPageOffset();var mainHeightDiff=this.main.header.height+this.main.footer.height;var bodyHeight=this.orig.height-mainHeightDiff-this.scrollBar.height-this.headerHeight;var minBodyHeight=this.minRowsNum*this.rowHeight;if(bodyHeight<minBodyHeight){this.orig.height=mainHeightDiff+this.scrollBar.height+this.headerHeight+minBodyHeight;bodyHeight=minBodyHeight;}
var nRowsFromView=Math.ceil(bodyHeight/this.rowHeight);this.virtual.nRows=nRowsFromView;this.visual.nRows=Math.min(nRowsFromView,this.data.nRows());this.height=(this.virtual.nRows*this.rowHeight)+mainHeightDiff+this.scrollBar.height+this.headerHeight;this.width=this.orig.width-2;var gridWidth=this.width-this.main.left.width-this.main.right.width;this.grid={left:0,height:this.height-mainHeightDiff,width:gridWidth};this.setGridOffset();this.main.left.height=this.grid.height;this.header={top:0,left:0,width:this.grid.width,height:this.headerHeight};this.scroller={top:this.header.top+this.header.height,left:0,width:gridWidth,height:this.grid.height-this.header.height};this.body={top:this.header.top+this.header.height,left:0,height:this.scroller.height-this.scrollBar.height,width:this.scroller.width-this.scrollBar.width}
this.resetVirtualDim();this.filler={top:0,left:0,height:this.virtual.height,width:this.virtual.width};this.widget={top:0,left:0,height:this.height,width:this.width};this.resizerLine={top:this.header.top,height:this.grid.height-this.scrollBar.height};this.mainContainer={left:0,top:0};this.filter={};this.filter.layer={left:0,top:0,width:this.width,height:this.height};this.filter.menu={top:0,left:0,width:this.filter.layer.width,height:this.main.header.height};this.filter.footer={top:this.height-this.main.footer.height,left:0,width:this.filter.layer.width,height:this.main.footer.height};this.filter.baffle={top:this.filter.menu.height,left:0,width:this.main.left.width,height:this.scroller.height+this.header.height};this.filter.tray={top:this.filter.menu.height+this.header.height,left:this.main.left.width,height:this.scroller.height,width:this.scroller.width};this.filter.voteFilterTray={height:this.rowHeight,width:this.filter.tray.width};this.filter.rowFilterTray={height:this.filter.tray.height-this.filter.voteFilterTray.height,width:this.filter.tray.width};this.filter.rowFilterHeader={top:this.filter.voteFilterTray.height-2,left:0,height:this.rowHeight,width:this.filter.tray.width};this.filter.rowFilterScroller={top:this.filter.voteFilterTray.height+this.filter.rowFilterHeader.height,left:0,height:this.filter.rowFilterTray.height-this.rowHeight,width:this.scroller.width};});K.oo('method',"getRowFilterDialogPosition",function(colIdx,jqDialog,offsets){offsets=offsets||{vert:0,horz:0};var t=this.filter.tray.top+this.filter.voteFilterTray.height+this.filter.rowFilterHeader.height+this.rowHeight;var w=jqDialog.width();var l=this.dim.leftOfColumn(colIdx)+this.dim.hScrollOffset+this.schema.columns()[colIdx].width/2-w/2;l=Math.max(this.main.left.width,l);l=Math.min(this.body.width+this.main.left.width-w,l);return{top:t+offsets.vert,left:l+offsets.horz};});K.oo('method',"getVoteFilterDialogPosition",function(jqDialog){return{left:(this.body.width-jqDialog.width())/2+this.grid.left,top:this.filter.tray.top+this.filter.voteFilterTray.height-2};});K.oo('method',"isCellVisible",function(context,lPadding){var rowIdx=context.absRowIdx;if(rowIdx<this.rowOffset||rowIdx>=this.rowOffset+this.visual.nRows)return false;var left=-this.hScrollOffset;var right=left+this.body.width;var cols=this.schema.columns();var colIdx=context.colIdx;var cellLeft=0;var cellWidth=0;for(var i=0;i<=colIdx;i++){var col=cols[i];if(col.hidden)continue;if(i==colIdx){cellWidth=col.width;}else{cellLeft+=col.width;}}
cellLeft-=lPadding;if(cellLeft+cellWidth<left||cellLeft>right)return false;return true;});K.oo('method',"isCellLeftHidden",function(context){var rowIdx=context.absRowIdx;if(rowIdx<this.rowOffset||rowIdx>=this.rowOffset+this.visual.nRows)return true;var left=this.hScrollOffset;var colIdx=context.colIdx;var cols=this.schema.columns();var h=0;for(var i=0;i<colIdx;i++){var col=cols[i];if(col.hidden)continue;h+=col.width;}
left+=h;if(left<0||left>this.body.width-this.scrollBar.width)return true;return false;});K.oo('method',"getCellPosition",function(context){var top=(context.absRowIdx-this.rowOffset)*this.rowHeight;var left=0;var cols=this.schema.columns();var colIdx=context.colIdx;for(var i=0;i<colIdx;i++){var col=cols[i];if(col.hidden)continue;left+=col.width;}
left+=this.hScrollOffset;return{top:top,left:left};});K.oo('method',"getCellAbsolutePosition",function(context){var top=context.absRowIdx*this.rowHeight;var left=0;var cols=this.schema.columns();var colIdx=context.colIdx;for(var i=0;i<colIdx;i++){var col=cols[i];if(col.hidden)continue;left+=col.width;}
return{top:top,left:left};});K.oo('method',"getFirstRunTipPosition",function(){var rowCount=this.actions.summary['row-count-total'];if(rowCount==0)return false;var firstFactColIdx=-1;var left=0;var columns=this.schema.columns();for(var i=0,c;c=columns[i];i++){if(!c.hidden){if(!c.isPrimary){firstFactColIdx=i;break;}
left+=c.width;}}
if(firstFactColIdx==-1)return false;var top=this.main.header.height+this.header.height;return{top:top,left:left};});K.oo('method',"absRowIdx",function(rowIdx){return this.rowOffset+parseInt(rowIdx);});K.oo('method',"rowIdx",function(absRowIdx){return absRowIdx-this.rowOffset;});K.oo('method',"setPageOffset",function(){this.pageOffset=this.jqMain.offset();});K.oo('method',"resetVirtualDim",function(){var cols=this.schema.columns();this.virtual.width=0;var total=0
for(var it24=0,c,it24__arr=cols,it24__len=it24__arr.length;(c=it24__arr[it24])||it24<it24__len;it24++){if(!c.hidden)total+=c.width;}
this.virtual.width=total+this.extendWidth;this.virtual.height=this.data.nRows()*this.row.height;});K.oo('method',"showCell",function(context){var left=context.cellLeft;var width=context.col.width;var gridWidth=this.dim.body.width+1;if(left<0){this.hScrollOffset-=left;this.notify('factInputHScroll',0-this.hScrollOffset);}else if((left+width)>gridWidth){var l=context.cellLeft;if(width<gridWidth){l=0-this.hScrollOffset+left+width-gridWidth;}
this.hScrollOffset=0-l;this.notify('factInputHScroll',l);}});K.oo('method',"getScrollTopOffset",function(){var nRows=this.data.nRows();if(this.rowOffset+this.virtual.nRows>nRows)this.rowOffset=nRows-this.virtual.nRows;if(this.rowOffset<0)this.rowOffset=0;return this.rowOffset*this.rowHeight;});K.oo('method',"resetRowOffset",function(){this.rowOffset=0;});K.oo('method',"leftOfColumn",function(colIdx){var cols=this.schema.columns();var left=this.grid.left;for(var i=0;i<colIdx;i++){var c=cols[i];if(!c)break;if(c.hidden)continue;left+=c.width;}
return left;});K.oo('method',"topOfRow",function(rowIdx){var top=this.grid.offset.top+this.headerHeight;top+=rowIdx*this.rowHeight;return top;});K.oo('method',"getPageWidth",function(){var ele=$('#page-width');var paddingLeft=parseInt(ele.css("paddingLeft").match(/\d*/));var paddingRight=parseInt(ele.css("paddingLeft").match(/\d*/));var width=ele.innerWidth()-(paddingLeft+paddingRight);return width;});K.oo('method',"getPageHeight",function(){var eles=['#page-header'];var occupiedHeight=0;for(var it25=0,ele,it25__arr=eles,it25__len=it25__arr.length;(ele=it25__arr[it25])||it25<it25__len;it25++){occupiedHeight+=$(ele).height();}
occupiedHeight+=36;occupiedHeight+=80;return $(window).height()-occupiedHeight;});})(Grid0.Dimension,Grid0);JS2.OO.createClass("Grid0.Sorter");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','columnMenu header');K.oo('method',"e_initHTML",function(){var listHtml=this.htmlCache.listItem();var secondMenuHtml=this.htmlCache.menu();this.columnMenu.addItem('basic:','title');this.jqMenu=this.columnMenu.addItem(listHtml,'sortByItem',{secondaryMenu:secondMenuHtml});this.jqSecondaryMenuContainer=this.jqMenu.first('.dialogShadow');this.jqSecondaryMenu=this.jqSecondaryMenuContainer.first('ul');this.jqItems=this.jqSecondaryMenu.find('>li');this.registerEvents();});K.oo('method',"registerEvents",function(){var self=this;this.jqMenu.hover(function(){self.showSecondaryMenu();},function(){self.hideSecondaryMenu();});this.jqItems.click(function(){self.sort(this);});});K.oo('method',"showSecondaryMenu",function(){this.jqSecondaryMenuContainer.show();});K.oo('method',"hideSecondaryMenu",function(){this.jqSecondaryMenuContainer.hide();});K.oo('method',"e_showColumnMenu",function(){var context=this.header.contexts.click;var col=context.col;var dtName=col.datatype;var datatype=sci.constants.datatypes[dtName];var smin=datatype.sortDescMin;var smax=datatype.sortDescMax;(function(self,min,max){return function(){self.jqItems.find('span.sortDescMin').html(min);self.jqItems.find('span.sortDescMax').html(max);};})(this,smin,smax)();if(col.isPrimary){this.jqSecondaryMenu.find('li.unique-votes').hide();this.jqSecondaryMenu.find('li.strength').hide();}else{this.jqSecondaryMenu.find('li.unique-votes').show();this.jqSecondaryMenu.find('li.strength').show();}
this.highlightSelect();});K.oo('method',"sort",function(e){var jq=$(e);var colIdx=this.header.contexts.click.colIdx;this.notify(jq.attr('sort'),{modifier:jq.attr('modifier'),colIdx:colIdx});this.notify('viewModified');});K.oo('method',"highlightSelect",function(){var primarySortField=this.actions.primarySortField();this.jqItems.removeClass('checked');if(!primarySortField){var cols=this.schema.columns();var pkColId=cols[0].field.id;var colId=this.header.contexts.click.col.id;if(pkColId==colId){var queryString='.consensus-val.ascending';var checkedItem=this.jqSecondaryMenu.find(queryString);checkedItem.addClass('checked')}}else{var sortFieldId=primarySortField.fieldId;var sortName=primarySortField.attribute;var sortType=primarySortField.asc?'ascending':'descending';var colId=this.header.contexts.click.col.id;if(sortFieldId==colId){var queryString='.'+sortName+'.'+sortType;var checkedItem=this.jqSecondaryMenu.find(queryString);checkedItem.addClass('checked')}}});})(Grid0.Sorter,Grid0);Grid0.Sorter.oo('setHTMLCache',{"menu":function(){return"<div class='dialogShadow'><div class='content'><ul class='sortByList'><li class='consensus-val ascending' modifier='consensus-val' sort='sortAscending'><strong>Displayed value&nbsp;<\/strong>(<span class='sortDescMin'>A<\/span> -> <span class='sortDescMax'>Z<\/span>)<\/li><li class='consensus-val descending' modifier='consensus-val' sort='sortDescending'><strong>Displayed value&nbsp;<\/strong>(<span class='sortDescMax'>Z<\/span> -> <span class='sortDescMin'>A<\/span>)<\/li><li class='unique-votes descending' modifier='unique-votes' sort='sortDescending'><strong>Counted inputs&nbsp;<\/strong>(most -> least)<\/li><li class='unique-votes ascending' modifier='unique-votes' sort='sortAscending'><strong>Counted inputs&nbsp;<\/strong>(least -> most)<\/li><li class='strength ascending' modifier='strength' sort='sortAscending'><strong>Debated&nbsp;<\/strong>(most -> least)<\/li><li class='strength descending' modifier='strength' sort='sortDescending'><strong>Debated&nbsp;<\/strong>(least -> most)<\/li><\/ul><\/div><\/div>"},"listItem":function(){return"Sort by:<span class='rightArrow'><\/span>"}});JS2.OO.createClass("Grid0.ScrollerController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();var self=this;var scrollFunc=function(evt){self.scroll(evt);return false;};sci.domEvent.add(this.view.jq,'scroll',scrollFunc,true);this.sTop=0;this.sLeft=0;this.wheelRows=3;});K.oo('method',"e_dataLoaded",function(firstTime){this.view.jq[0].scrollTop=this.dim.getScrollTopOffset();});K.oo('method',"e_gotoRow",function(absRowIdx){this.dim.rowOffset=absRowIdx;this.view.jq[0].scrollTop=this.dim.getScrollTopOffset();});K.oo('method',"e_resizing",function(){this.view.setDimensions();});K.oo('method',"e_filterHScroll",function(sLeft){this.hScroll(sLeft);});K.oo('method',"e_factInputHScroll",function(sLeft){this.hScroll(sLeft);});K.oo('method',"e_columnNavigatorHScroll",function(sLeft){this.hScroll(sLeft);});K.oo('method',"e_deltaScroll",function(delta){if(delta.left)this.view.jq[0].scrollLeft+=delta.left;if(delta.top)this.view.jq[0].scrollTop+=delta.top;this.scroll();});K.oo('method',"hScroll",function(sLeft){this.view.jq[0].scrollLeft=sLeft;});K.oo('method',"e_reloadScroll",function(){this.scroll();});K.oo('method',"scroll",function(evt){var sTop=this.view.jq[0].scrollTop;var sLeft=this.view.jq[0].scrollLeft;if(this.sTop!=sTop){this.sTop=sTop;this.notify('beforeScroll','vScroll');this.notify('vScroll',{top:sTop});}else if(this.sLeft!=sLeft){this.sLeft=sLeft;this.notify('hScroll',{left:sLeft});}});K.oo('method',"e_extendHScroll",function(left){this.view.jq[0].scrollLeft+=left;this.hExtendScrollOffset=left;});K.oo('method',"e_cancelExtendHScroll",function(){if(this.hExtendScrollOffset)this.view.jq[0].scrollLeft-=this.hExtendScrollOffset;this.hExtendScrollOffset=0;});K.oo('method',"vScroll",function(moved){var y=this.view.jq[0].scrollTop;var delta=this.wheelRows*this.dim.row.height;if(moved<0){y+=delta}else{y-=delta}
if(y<0){this.view.jq[0].scrollTop=0;}else{var h=this.view.jqFiller.height();this.view.jq[0].scrollTop=y>h?h:y;}});K.oo('method',"vScrollByDiff",function(diff){var y=this.view.jq[0].scrollTop;var rowHeight=this.dim.row.height;y+=diff;if(y<0){this.view.jq[0].scrollTop=0;}else{var h=this.view.jq[0].scrollHeight;this.view.jq[0].scrollTop=y>h?h:y;}});K.oo('method',"e_resizeScroller",function(w,h){this.view.jqFiller.css({width:Math.max(w,this.dim.filler.width),height:Math.max(h,this.dim.filler.height)});this.scroll();});})(Grid0.ScrollerController,Grid0);JS2.OO.createClass("Grid0.ScrollerView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"bodyView");K.oo('method',"initHTML",function(){this.jq=this.jqGrid.find('>.scroller');this.jqFiller=this.jq.find('>.filler');});K.oo('method',"setDimensions",function(){if(!this.jq)return;this.jq.css(this.dim.scroller);this.jqFiller.css(this.dim.filler);if($.browser.msie&&this.jq[0].scrollLeft>0)this.jq[0].scrollLeft-=1;});})(Grid0.ScrollerView,Grid0);JS2.OO.createClass("Grid0.Resizer");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"headerController");K.oo('method',"e_initCols",function(){this.initHTML();});K.oo('method',"e_resizing",function(){this.setResizeLineHeight();});K.oo('method',"initHTML",function(){this.jqResizers=this.headerController.jqResizers();this.jqResizerLine=this.jqGrid.find('>.resizerLine');this.jqContent=this.headerController.jqContent();this.mouseDowned=false;this.colParams=false;this.jqResizers.mousedown((function(self){return function(e){$(this).disableSelection()
self.colParams=self.util.getColumnParams(e.target.parentNode.parentNode);self.mouseDowned=true;self.mouseDown(e);}})(this));this.headerController.view.jq.mousemove((function(self){return function(e){if(self.mouseDowned){self.mouseMove(e);}}})(this));$(document).mouseup((function(self){return function(e){if(self.mouseDowned){self.jqResizers.enableSelection();self.mouseDowned=false;self.mouseUp(e);}}})(this));});K.oo('method',"setResizeLineHeight",function(){if(this.jqResizerLine&&this.jqResizerLine[0])this.jqResizerLine.css(this.dim.resizerLine);});K.oo('method',"mouseMove",function(e){document.body.style.cursor=e.pageX-this.startPageX>=0?'e-resize':'w-resize';this.jqResizerLine[0].style.left=(e.pageX-this.dim.grid.offset.left)+'px';});K.oo('method',"mouseDown",function(e){document.body.style.cursor='e-resize';this.startPageX=e.pageX;this.dim.setPageOffset();this.jqResizerLine[0].style.left=(e.pageX-this.dim.grid.offset.left)+'px';this.jqResizerLine.show();});K.oo('method',"mouseUp",function(e){document.body.style.cursor='auto';var delta=e.pageX-this.startPageX;this.jqResizerLine.hide();var col=this.colParams.col;if(col.width+delta>this.dim.columnMinWidth){col.width+=delta;}else{col.width=this.dim.columnMinWidth;}
this.notify('resizeWidth');this.notify('viewModified');});})(Grid0.Resizer,Grid0);JS2.OO.createClass("Grid0.HeaderController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(){this.contexts={};this.contexts.click={};this.contexts.dClick={};this.contexts.hover={};this.colClicked=[];this.initialized=false;});K.oo('method',"initHTML",function(){this.view.initHTML();this.registerEvents();});K.oo('method',"e_dataLoaded",function(firstTime){this.view.adjustColumns();this.view.adjustWidths();this.view.showSorts();this.view.showSearchs();this.view.toggleFieldName();});K.oo('method',"e_toggleFieldName",function(){this.view.toggleFieldName();});K.oo('method',"registerEvents",function(){var self=this;this.view.jqColumns.dblclick(function(evt){self.dblClickHeader(this);});this.view.jqHide.click(function(evt){self.hideColumn(evt);});this.view.jqCells.hover(function(evt){self.hoverOverContent(evt);},function(evt){self.hoverOutContent(evt);});this.view.jqContent.click(function(evt){setTimeout(function(){self.clickDropDown(evt);},10);});});K.oo('method',"hideColumn",function(evt){this.setContext(evt);this.contexts.click.col.hidden=true;this.notify('resizeWidth');this.notify('viewModified');});K.oo('method',"clickDropDown",function(evt){this.view.highlightColumn($(evt.target).parents('.column:first'),'selected');this.setContext(evt);this.notify('showColumnMenu');this.notify('columnMenuShown');});K.oo('method',"e_columnMenuHidden",function(){this.view.highlightColumn(null,'selected');});K.oo('method',"setContext",function(evt,type){type=type||'click';var ele=$(evt.target).parents('.column:first')[0];var context=this.contexts[type];context.colIdx=parseInt(ele.getAttribute('colIdx'));context.ele=ele;context.jqEle=$(ele);context.target=evt.target;context.col=this.schema.column(context.colIdx);});K.oo('method',"hoverOverContent",function(evt){this.view.highlightColumn($(evt.target).parents('.column:first'));this.tooltipTimeout=setTimeout((function(self,evt){return function(){self.setContext(evt,'hover');self.notify('showTooltip');}})(this,evt),1500);});K.oo('method',"hoverOutContent",function(evt){clearTimeout(this.tooltipTimeout);this.view.highlightColumn();this.notify('hideTooltip');});K.oo('method',"disableDropDown",function(yes){yes?this.view.jq.addClass('disabled'):this.view.jq.removeClass('disabled');});K.oo('method',"e_initCols",function(){this.initHTML();this.initialized=true;});K.oo('method',"e_resizing",function(){if(!this.initialized)return;this.view.adjustWidths();this.view.setDimensions();});K.oo('method',"getColumnEle",function(colIdx){return this.view.getColumnEle(colIdx);});K.oo('method',"dblClickHeader",function(ele){this.view.toggleColumnWidth(parseInt(ele.getAttribute('colIdx')));});K.oo('method',"e_hScroll",function(params){this.view.hScroll(params.left);});K.oo('method',"jqResizers",function(){return this.view.jqResizers;});K.oo('method',"jqContent",function(){return this.view.jqContent;});})(Grid0.HeaderController,Grid0);JS2.OO.createClass("Grid0.HeaderView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','gridMenu');K.oo('method',"initHTML",function(){this.jqMask=this.jqGrid.find(">.hMask");this.jq=this.jqMask.find(">.header");var cols=this.schema.columns();this.buildColumns(cols);this.jqResizers=this.jqColumns.find('.resizer');this.jqContent=this.jqColumns.find('.content');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"content",this.jqContent,null);this.jqHide=this.jqColumns.find('.hide');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"hide",this.jqHide,null);});K.oo('method',"markJoinKey",function(){var colIdxs=this.schema.joinedColumnIdxs();for(var it75=0,idx,it75__arr=colIdxs,it75__len=it75__arr.length;(idx=it75__arr[it75])||it75<it75__len;it75++){var jqContent=this.jqColumns.eq(idx).find('.content');jqContent.html(DISPLAY.html(jqContent.text()));jqContent.wrapInner('<span class="joinKeyText" />');}});K.oo('method',"toggleFieldName",function(){var showFieldName=this.data.isShowFieldName();for(var i=0,col,i__arr=this.schema.columns(),i__len=i__arr.length;(col=i__arr[i])||i<i__len;i++){var colName='';colName=sci.common.htmlDisplay(showFieldName?col.name:col.reference);this.jqContent.eq(i).html(colName);}
this.markJoinKey();});K.oo('method',"setDimensions",function(){this.jqMask.css(this.dim.header);});K.oo('method',"getColumnEle",function(colIdx){return this.jqColumns[colIdx];});K.oo('method',"toggleColumnWidth",function(colIdx){var maxWidth=this.dim.body.width;var column=this.schema.column(colIdx);column.width=column.width>=maxWidth?this.defaultWidths[colIdx]:maxWidth;this.notify('resizeWidth');});K.oo('method',"buildColumns",function(cols){this.notify('buildColumns',cols);this.defaultWidths=[];var html='';for(var i=0,col;col=cols[i];i++){html+=this.columnHTML(col,i);this.defaultWidths.push(col.width);}
this.jq.html(html);this.jqColumns=this.jq.find('>.column');this.jqCells=this.jqColumns.find('>.cell');});K.oo('method',"columnHTML",function(col,idx){var pkClass='';if(col.isPrimary){pkClass='primaryColumn';if(col.datasetId!=this.data.primaryDatasetId())pkClass+=' joinedPK';}
var colName=sci.common.htmlDisplay(col.name);return this.htmlCache.column(pkClass,idx,'Votes',colName);});K.oo('method',"adjustColumns",function(){var cols=this.schema.columns();if(cols.length!=this.jqColumns.length){this.buildColumns(cols);}});K.oo('method',"showSorts",function(){var sortField=this.data.primarySortField();var cols=this.schema.columns();for(var i=0,len=cols.length;i<len;i++){var sort='noSort';if(sortField&&cols[i].field.id==sortField.fieldId){sort=sortField.asc?'sortAsc':'sortDesc';}else if(!sortField&&i==0){sort='sortAsc';}
this.jqCells[i].className='cell '+sort;}});K.oo('method',"showSearchs",function(){var fulltextSetting=[];var fulltextFieldIds=[];if(this.actions.isFulltextSearchEnabled()){fulltextSetting=this.actions.getFulltextSetting();}
for(var it76=0,f,it76__arr=fulltextSetting,it76__len=it76__arr.length;(f=it76__arr[it76])||it76<it76__len;it76++){fulltextFieldIds.push(f.fieldId);}
var cols=this.schema.columns();for(var i=0,c,i__arr=cols,i__len=i__arr.length;(c=i__arr[i])||i<i__len;i++){if($.inArray(c.field.id,fulltextFieldIds)>-1){this.jqCells.eq(i).addClass('fulltextSearchEnabled');}else{this.jqCells.eq(i).removeClass('fulltextSearchEnabled');}}});K.oo('method',"adjustWidths",function(){var cols=this.schema.columns();var total=0;for(var i=0,c;c=cols[i];i++){var ele=this.jqColumns[i];if(c.hidden){ele.style.display='none'}else{ele.style.display='block'
ele.style.width=c.width+'px';total+=c.width;}}
this.jq.css('width',total);});K.oo('method',"hScroll",function(left){this.jq[0].style.left='-'+left+'px';});K.oo('method',"highlightColumn",function($column,type){type=type||'hover';this.jqColumns.removeClass(type);if($column)$column.addClass(type);});})(Grid0.HeaderView,Grid0);Grid0.HeaderView.oo('setHTMLCache',{"column":function(){return"<div class='"+arguments[0]+" column' colIdx='"+arguments[1]+"'><div class='cell'><div class='sortIndicator'><\/div><div class='resizer'><\/div><div class='searchIndicator' title='This field is indexed for full text searches.'><\/div><div class='content'>"+arguments[2]+"<\/div><div class='hide'><\/div><\/div><\/div>"}});JS2.OO.createClass("Grid0.BodyController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"scrollerController factExplorerView subjectExplorerView");K.oo('method',"initialize",function(){this.contexts={};});K.oo('method',"e_dataLoaded",function(firstTime){this.initHTML();if(firstTime){this.initCallbacks();this.bindKeyEvents();}});K.oo('method',"e_resized",function(){this.gotoRow();});K.oo('method',"gotoRow",function(){var absRowIdx=this.actions.getRowOffset();if(absRowIdx&&absRowIdx>=0){this.notify('gotoRow',absRowIdx);var context=this.dim.getContextFromCell(0,absRowIdx-this.dim.rowOffset,this.view.matrix);this.notify('highlightCell',context);}});K.oo('method',"initHTML",function(){this.view.initHTML();});K.oo('method',"bindKeyEvents",function(){var self=this;var funcKey=function(e){self.handleKeyDown(e);}
var funcMouse=function(e){self.handleClick(e);}
sci.domEvent.add(document,'keydown',funcKey,true);sci.domEvent.add(document,'click',funcMouse,true);});K.oo('method',"handleKeyDown",function(e){if(this.keyEventValid()){var key=e.keyCode;if(KEYCODE.isDirectionKey(key)){this.moveCellHighLight(key);}else if(key==KEYCODE.ENTER&&!this.isFocusOnLink()){this.notify('dblClkCell',this.contexts.click);}else if(KEYCODE.isCharacterKey(key)&&!e.ctrlKey){this.notify('showCellInput',this.contexts.click);}else if(key==KEYCODE.ESC){this.notify('highlightCell');this.notify('blurCell');}}});K.oo('method',"handleClick",function(e){if(this.keyEventValid()){var tar=e.target||e.srcElement;var skipJqEles=0;skipJqEles+=$(tar).parents('.bodyEventHandler').length;skipJqEles+=$(tar).parents('.ui-dialog').length;skipJqEles+=$(tar).parents('.cellForm').length;skipJqEles+=$(tar).parents('.cellOptions').length;skipJqEles+=$(tar).parents('.expandedCell').length;skipJqEles+=this.isGridBydyScroll(tar)?1:0;if(skipJqEles==0){this.notify('highlightCell');this.notify('blurCell');}}});K.oo('method',"isGridBydyScroll",function(target){var tar=$(target);return tar.is('div#grid.Grid0 div.universe table.mainGrid div.grid div.scroller')?true:false;});K.oo('method',"moveCellHighLight",function(key){var context=false;var maxRowIdx=this.dim.virtual.nRows-1;switch(key){case KEYCODE.LEFT:context=this.dim.changeContext(this.contexts.click,this.view.matrix,{x:-1,y:0});break;case KEYCODE.UP:context=this.dim.changeContext(this.contexts.click,this.view.matrix,{x:0,y:-1});if(this.contexts.click.rowIdx==0){this.scrollerController.vScrollByDiff(0-this.dim.rowHeight);context=this.contexts.click;context.absRowIdx-=1;context.rowIdx=0;context.cell=this.view.matrix[context.colIdx][0];}
if(context.absRowIdx<0)context=false;break;case KEYCODE.RIGHT:context=this.dim.changeContext(this.contexts.click,this.view.matrix,{x:1,y:0});break;case KEYCODE.DOWN:context=this.dim.changeContext(this.contexts.click,this.view.matrix,{x:0,y:1});if(this.contexts.click.rowIdx==maxRowIdx){this.scrollerController.vScrollByDiff(this.dim.rowHeight);context=this.contexts.click;context.absRowIdx+=1;context.rowIdx=maxRowIdx;context.cell=this.view.matrix[context.colIdx][maxRowIdx];}
if(context.absRowIdx>=this.data.nRows())context=false;break;}
if(context){this.notify('showCell',context);this.notify('highlightCell',context);this.notify('changeRow',context);}});K.oo('method',"e_vScroll",function(){this.view.populate();if(this.contexts.click){this.view.unHighLightCell(this.contexts.click);var newRowIdx=this.contexts.click.absRowIdx-this.dim.rowOffset;this.contexts.click.rowTop=newRowIdx*this.dim.rowHeight;if(newRowIdx>=0&&newRowIdx<this.dim.virtual.nRows){this.contexts.click.rowIdx=newRowIdx;this.contexts.click.cell=this.view.matrix[this.contexts.click.colIdx][newRowIdx];this.notify('highlightCell',this.contexts.click);}
this.notify('changeRow',this.contexts.click);}});K.oo('method',"e_dblClkCell",function(context){if(this.contexts.dblClick){$(this.contexts.dblClick.cell).removeClass('dblClicked');}
$(context.cell).addClass('dblClicked');this.contexts.dblClick=context;});K.oo('method',"e_highlightCell",function(context){if(this.contexts.click){this.view.unHighLightCell(this.contexts.click);}
if(context){this.view.highLightCell(context);}
this.contexts.click=context;});K.oo('method',"e_initRows",function(){if(this.data.isFirstLoad())return;this.initHTML();});K.oo('method',"e_resizing",function(){this.view.initHTML();this.view.adjustWidths();this.view.setDimensions();this.view.populate();});K.oo('method',"e_hScroll",function(params){this.view.hScroll(params.left);});K.oo('method',"e_factInputHScroll",function(sLeft){this.view.hScroll(sLeft);});K.oo('method',"e_initCols",function(){if(this.data.isFirstLoad())return;this.initHTML();});K.oo('method',"e_refreshCells",function(){this.initHTML();this.view.populate();});K.oo('method',"handleWheel",function(delta,e){var target=e.target||e.srcElement;if(this.view.inBody(target)){this.scrollerController.vScroll(delta);return true;}
return false;});K.oo('method',"e_rowRefreshed",function(absRowIdx){var rowIdx=this.dim.rowIdx(absRowIdx);if(this.view.matrix[0][rowIdx]){this.view.populateRow(rowIdx);}});K.oo('method',"e_cellRefreshed",function(absRowIdx,colIdx){var rowIdx=this.dim.rowIdx(absRowIdx);if(this.view.matrix[0][rowIdx]){var col=this.schema.columns()[colIdx];var cell=this.view.matrix[colIdx][rowIdx];var data=this.data.getCell(colIdx,absRowIdx);this.view.populateCell(col,cell,data);}});K.oo('method',"keyEventValid",function(){if(!this.contexts.click)return false;if(this.jqGridLoading.css('display')!='none')return false;if(this.isFocusOnFormElement())return false;if(this.isLoginMaskShown())return false;return true;});K.oo('method',"isLoginMaskShown",function(){return this.auth.isShown();});K.oo('method',"isFocusOnFormElement",function(){var jqActiveElement=$(document.activeElement);if(!jqActiveElement.is(':visible'))return false;if(jqActiveElement.is('#clipboardTextarea'))return false;if(jqActiveElement.is('input[type=text]')||jqActiveElement.is('textarea')||jqActiveElement.is('select')){return true;}else{return false;}});K.oo('method',"isFocusOnLink",function(){var jqActiveElement=$(document.activeElement);if(jqActiveElement.is('a')){return true;}else{return false;}});K.oo('method',"isCellOverflow",function(colIdx,absRowIdx,datatype){if(this.data.column(colIdx).width<=this.dim.columnMinWidth){return true;}
var rowIdx=this.dim.rowIdx(absRowIdx);var domCell=this.view.matrix[colIdx][rowIdx];var jqData=$(domCell).first('.data');var extWidth=0;if(datatype=='Integer'||datatype=='Double'){extWidth=10;}
return(jqData.width()+extWidth<jqData[0].scrollWidth)||(jqData.height()>23);});K.oo('method',"initCallbacks",function(){sci.inputHandler.wheel(this);});})(Grid0.BodyController,Grid0);JS2.OO.createClass("Grid0.BodyView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"data");K.oo('member','BLANK_CELL_HTML',"<em>[blank]</em>");K.oo('method',"initialize",function(){});K.oo('method',"initHTML",function(){this.jqMask=this.jqGrid.find('>.bMask');this.jq=this.jqMask.find('>.body');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"body",this.jq,null);this.hOffset=0;var html=[];this.matrix=[];var rows=this.dim.visual.nRows;var cols=this.schema.columns();for(var i=0,c;c=cols[i];i++){var cells=[];for(var j=0;j<rows;j++){cells.push(this.htmlCache.cell());}
var primaryCol=c.isPrimary?'primaryCol':''
html.push(this.htmlCache.column(primaryCol,cells.join('')));}
this.jq[0].innerHTML=html.join('');this.jqMain.attr('factoryId',this.main.factoryId);this.jqCols=this.jq.find('>.column');for(var i=0,ele;ele=this.jqCols[i];i++){var col=cols[i];var jqElem=$(ele);jqElem.addClass(col.datatype);this.matrix[i]=jqElem.find('.cell');for(var j=0,cell;cell=this.matrix[i][j];j++){cell.setAttribute('rowIdx',j);cell.setAttribute('colIdx',i);}}
this.adjustWidths();this.jqDatasetPane=this.jq.parents('.dataset');});K.oo('method',"populate",function(){if(!this.matrix[0])return;this.calculateViewableCols();this.votePresent=this.actions.votePresentMode();var nRows=this.matrix[0].length;for(var i=0;i<nRows;i++){this.populateRow(i);}});K.oo('method',"calculateViewableCols",function(){var cols=this.schema.columns();this.viewableColumnIdxs=[];var onGoingWidth=0;var viewableStart=this.hOffset||0;var viewableEnd=viewableStart+this.dim.body.width;for(var i=0,col,i__arr=cols,i__len=i__arr.length;(col=i__arr[i])||i<i__len;i++){this.viewableColumnIdxs.push(i);}});K.oo('method',"populateCell",function(col,cell,data){cell.childNodes[0].innerHTML=this.presentVote(col,data);});K.oo('method',"setConsensus",function(cell,data){var consensusNum=(!data.numVotes||data.numVotes<2)?0:data.consensus;if(consensusNum<0.7&&consensusNum>0){if(!cell.className.match(/contentious/))cell.className+=' contentious';}else{cell.className=cell.className.replace(' contentious','');}});K.oo('method',"populatePkCell",function(col,cell,data,absRowIdx){cell.childNodes[0].innerHTML=this.presentVote(col,data);if(this.data.includeGarbage()){this.markGarbage(col,cell,absRowIdx);}});K.oo('method',"getUserValue",function(data,datatype,col){if(data.userVal==null){if(!this.data.noUserAction(data.userAction)){return this.BLANK_CELL_HTML;}else{return'';}}else if(data.userVal===''){return this.BLANK_CELL_HTML;}else{return sci.common.getDisplay(datatype,data.userVal,col.displayMethod);}});K.oo('method',"getConsensusValue",function(data,datatype,col){if(data.val==null||((data.val instanceof Array)&&data.val.length==0)){return data.numVotes>0?this.BLANK_CELL_HTML:'';}else if(data.val===''){return this.BLANK_CELL_HTML;}else{return sci.common.getDisplay(datatype,data.val,col.displayMethod);}});K.oo('method',"presentVote",function(col,data){var html='';var datatype=sci.constants.datatypes[col.datatype];if(col.aggregation=="top-values"&&(data.valList instanceof Array)){var noNumericComma=this.schema.isNumericCol(col)?true:false;return $.map(data.valList,function(v){var value=v["matches_user_vote"]?"<strong>"+sci.common.getDisplay(datatype,v.val,col.displayMethod)+"</strong>":sci.common.getDisplay(datatype,v.val,col.displayMethod);return noNumericComma?value.toString().replace(/,/g,''):value;}).join(', ');}
var uv=this.getUserValue(data,datatype,col);var cv=this.getConsensusValue(data,datatype,col);if(this.data.isShowingDelta()){var cvo=(data.oldVal||data.oldVal===0)?sci.common.getDisplay(datatype,data.oldVal,col.displayMethod):''
return data.valChanged?cv+' ('+cvo+')':cv;}
if(this.votePresent=='uvo'){html=this.data.noUserAction(data.userAction)?cv:'<strong>'+uv+'</strong>';}else if(this.votePresent=='cvo'){html=cv;}else if(this.votePresent=='uvf'){html=(this.data.hasUserValue(uv)&&data.userVal!==data.val)?'<strong>'+uv+'</strong>'+(cv?' ('+cv+')':''):uv?'<strong>'+uv+'</strong>':cv;}else{html=(this.data.hasUserValue(uv)&&data.userVal!==data.val)?cv+'<strong> ('+uv+') </strong>':((this.data.hasUserValue(uv)&&data.userVal===data.val)?'<strong>'+uv+'</strong>':cv);}
return html;});K.oo('method',"markGarbage",function(col,cell,absRowIdx){if(col.field.offset>0)return;var pkCell=this.data.rows()[absRowIdx][0];var isDisagreeRow=(pkCell.userAction==-1);var isLowStrenghRow=(pkCell.consensus<0.3);var isGarbageRow=(isDisagreeRow||isLowStrenghRow);if(isGarbageRow){if(!cell.className.match(/garbageIcon/))
cell.className=cell.className+' garbageIcon';}else{cell.className=cell.className.replace(/\s*garbageIcon/,'');}});K.oo('method',"activateSubColumn",function(colIdx){var cells=this.matrix[colIdx];for(var i=0,cell;cell=cells[i];i++){cell.childNodes[2].style.display='block';}});K.oo('method',"blankCell",function(ele){ele.childNodes[0].innerHTML='';});K.oo('method',"highLightCell",function(context){if(context.col.isPrimary){this.highLightPks(context.colIdx,context.rowIdx);}else{$(context.cell).parent().addClass('CellSelected');}});K.oo('method',"unHighLightCell",function(context){if(context.col.isPrimary){this.unHighLightPks(context.colIdx,context.rowIdx);}else{$(context.cell).parent().removeClass('CellSelected');}});K.oo('method',"highLightPks",function(colIdx,rowIdx){var pkCells=this.getPkCells(colIdx,rowIdx);var len=pkCells.length;for(var i=0;i<len;i++){var jq=$(pkCells[i]);if(i==0){jq.addClass('pkHighLightLeft');}
if(i==len-1){jq.addClass('pkHighLightRight');}
jq.addClass('pkHighLight');}});K.oo('method',"unHighLightPks",function(colIdx,rowIdx){var pkCells=this.getPkCells(colIdx,rowIdx);var len=pkCells.length;for(var i=0;i<len;i++){var jq=$(pkCells[i]);if(i==0){jq.removeClass('pkHighLightLeft');}
if(i==len-1){jq.removeClass('pkHighLightRight');}
jq.removeClass('pkHighLight');}});K.oo('method',"getPkCells",function(colIdx,rowIdx){var pkIds=this.data.datasetPkColIds(colIdx);var columns=this.data.columns();var cells=[];for(var i=0,len=pkIds.length;i<len;i++){if(columns[pkIds[i]].hidden)continue;cells.push(this.matrix[pkIds[i]][rowIdx]);}
return cells;});K.oo('method',"adjustWidths",function(){var cols=this.schema.columns();var total=0;for(var i=0,c;c=cols[i];i++){var ele=this.jqCols[i];if(c.hidden){ele.style.display='none';}else{ele.style.display='block';this.jqCols[i].style.width=c.width+'px';total+=c.width;}}
this.jq.width(total);});K.oo('method',"setDimensions",function(){this.jqMask.css(this.dim.body);});K.oo('method',"populateRow",function(rowIdx){var cols=this.schema.columns();var nRows=this.data.nRows();var absRowIdx=this.dim.absRowIdx(rowIdx);for(var it83=0,i,it83__arr=this.viewableColumnIdxs,it83__len=it83__arr.length;(i=it83__arr[it83])||it83<it83__len;it83++){var col=cols[i];var cell=this.matrix[i][rowIdx];if(col.hidden)continue;if(absRowIdx>=nRows){cell.style.display="none";this.blankCell(cell);}else{cell.style.display="block";var data=this.data.getCell(i,absRowIdx);if(col.isPrimary){this.populatePkCell(col,cell,data,absRowIdx);}else{this.populateCell(col,cell,data);}}}});K.oo('method',"hScroll",function(left){this.jq[0].style.left='-'+left+'px';this.hOffset=left;this.populate();});K.oo('method',"inBody",function(ele){var threshold=10;var body=ele;var factoryId=this.main.factoryId.toString();for(var i=0;i<threshold;i++){if(body&&(body.getAttribute&&body.getAttribute('factoryId')==factoryId)){return true;}
if(body==null)return false;body=body.parentNode;}
return false;});K.oo('method',"styleSelectedRow",function(ele){var selectedRowStyle='border-top: 1px dashed #666;'+'border-bottom: 1px dashed #666;'
ele.setAttribute('style',selectedRowStyle);});K.oo('method',"styleSelectedCell",function(ele){var selectedCellStyle='border: 1px solid #2291c8;'+'background-image: url(/images/grid0/cell_plus.gif);'+'background-repeat: no-repeat;'+'background-position: top right;';ele.setAttribute('style',selectedCellStyle);});K.oo('method',"getRow",function(rowIdx){var row=[];for(var it84=0,col,it84__arr=this.matrix,it84__len=it84__arr.length;(col=it84__arr[it84])||it84<it84__len;it84++){var ele=col[rowIdx];row.push(ele);}
return row;});K.oo('method',"isCell",function(a,b){return(a.getAttribute('colIdx')==b.getAttribute('colIdx')&&a.getAttribute('rowIdx')==b.getAttribute('rowIdx'));});K.oo('method',"getCellHTML",function(context){return this.matrix[context.colIdx][context.rowIdx].childNodes[0].innerHTML;});})(Grid0.BodyView,Grid0);Grid0.BodyView.oo('setHTMLCache',{"cell":function(){return"<div class='cell' colIdx='' rowIdx=''><div class='data'><\/div><div class='consensus'><\/div><\/div>"},"column":function(){return"<div class='"+arguments[0]+" column'>"+arguments[1]+"<\/div>"}});JS2.OO.createClass("Grid0.BodyEventHandler");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"bodyView cellForm");K.oo('method',"initialize",function(){this.viewOffset={left:0};});K.oo('method',"e_initHTML",function(){this.jq=this.jqGrid.find('>.bodyEventHandler');this.jqHighlights=this.jq.find('>.highlights');this.cell=this.jqHighlights.first('.cell');this.row=this.jqHighlights.first('.row');this.row.hide();this.registerEvents();});K.oo('method',"e_resizing",function(){if(!this.jq)return;this.hideCol();this.setDimensions();});K.oo('method',"e_hScroll",function(params){this.hideCol();});K.oo('method',"e_extendHScroll",function(params){this.hideCol();});K.oo('method',"e_vScroll",function(params){this.hideCol();});K.oo('method',"hideCol",function(){if(this.cell)this.cell.hide();this.oldCo=null;});K.oo('method',"mouseOver",function(context){var width=context.col.width;var left=context.cellLeft;if(context.col.isPrimary){var ids=this.data.datasetPkColIds(context.colIdx);var cols=this.data.columns();for(var it41=0,id,it41__arr=ids,it41__len=it41__arr.length;(id=it41__arr[it41])||it41<it41__len;it41++){if(cols[id].hidden)continue;if(id!=context.colIdx)width+=cols[id].width;if(id<context.colIdx)left-=cols[id].width;}}
var cellStyle=this.cell[0].style;cellStyle.top=context.rowTop+'px';cellStyle.left=left+'px';cellStyle.width=(width-2)+'px';});K.oo('method',"mouseMove",function(e){var pl=e.pageX?e.pageX:e.clientX+document.documentElement.scrollLeft;var pr=e.pageY?e.pageY:e.clientY+document.documentElement.scrollTop;var context=this.dim.getContext(pl,pr,this.bodyView.matrix,this.oldCo);if(!context)return;this.currentContext=context;this.mouseOver(this.currentContext);if(!this.oldCo){this.cell.show();this.jqHighlights.show();}
this.oldCo=[context.colIdx,context.rowIdx];});K.oo('method',"focusCell",function(e){if(e.rowIdx||e.rowIdx==0){var params=e;var matrix=this.bodyView.matrix;var ele=matrix[params.colIdx][params.rowIdx];var context=this.dim.getContextFromCell(params.colIdx,params.rowIdx,matrix);this.currentContext=context;this.click();}else{this.mouseMove(e);}});K.oo('method',"e_focusCell",function(e){this.focusCell(e);});K.oo('method',"e_blurCell",function(e){if(this.row)this.row.hide();});K.oo('method',"e_changeRow",function(e){this.row[0].style.top=e.rowTop+'px';});K.oo('method',"registerEvents",function(){var self=this;sci.inputHandler.wheel(self.bodyView);this.oldCo=null;sci.domEvent.add(this.jq,'mousemove',function(e){self.mouseMove(e);},true);this.jqHighlights.click((function(self){return function(){var context=self.currentContext
this.clickTimeout=setTimeout(function(){self.click(context);},300);}})(this));this.jqHighlights.dblclick(function(){self.dblClick();});if($.browser.msie){this.jq.scroll(function(e){this.scrollLeft=0;});}});K.oo('method',"e_openCell",function(colIdx,rowIdx){this.focusCell({colIdx:colIdx,rowIdx:rowIdx});this.dblClick();});K.oo('method',"dblClick",function(){if(this.clickTimeout)clearTimeout(this.clickTimeout);if(this.currentContext){this.notify('dblClkCell',this.currentContext);if($.browser.msie)this.jq[0].scrollLeft=0;}});K.oo('method',"click",function(context){context=context||this.currentContext;if(context){this.notify('highlightCell',context);this.row[0].style.top=context.rowTop+'px';this.row.show();}});K.oo('method',"setDimensions",function(){this.hideCol();this.row.hide();this.cell.css({height:this.dim.rowHeight-1});this.row.css({height:this.dim.rowHeight-1,left:0,width:'100%'});this.jq.css(this.dim.body);});})(Grid0.BodyEventHandler,Grid0);JS2.OO.createClass("Grid0.Messenger");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initHTML",function(){this.jqMessage=this.jqGridLoading.find('>.message');this.jqError=this.jqGridLoading.find('>.error');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"workbencherror",this.jqError,null);this.jqGridLoading.hide();this.jqMessage.hide();this.jqError.hide();});K.oo('method',"e_loadData",function(){this.show('Loading Data');});K.oo('method',"e_dataLoaded",function(){this.show();});K.oo('method',"e_alert",function(msg){this.show(msg);});K.oo('method',"e_resizing",function(){this.setDimensions();});K.oo('method',"e_appErrorOccurred",function(){this.showStop();this.jqError.html(this.htmlCache.runtimeError()).show();var closeButton=this.jqError.find('.closeBtn');if(sci.auth.isAdmin()){closeButton.show().click((function(self){return function(){self.jqGridLoading.hide();}})(this));}else{closeButton.hide();}});K.oo('method',"e_quartzErrorOccurred",function(message){this.showStop();this.jqError.html(this.htmlCache.quartzError(message)).show();});K.oo('method',"e_tableUnCached",function(cacheState){this.showStop();this.jqError.html(cacheState).show();this.jqError.first('.here').click((function(self){return function(){self.notify('requestForceCache');}})(this));});K.oo('method',"showStop",function(){WEBSITE.hideErrorsImmediately();this.jqMessage.hide();this.jqGridLoading.show();try{this.notify('showStop');}catch(e){}});K.oo('method',"show",function(msg){if(!this.jqMessage)return
if(msg){this.jqError.hide();this.jqMessage.html(msg).show();this.jqGridLoading.show();}else{this.jqError.hide();this.jqMessage.hide();this.jqGridLoading.hide();}});K.oo('method',"setDimensions",function(){this.jqGridLoading.css(this.dim.widget);});})(Grid0.Messenger,Grid0);Grid0.Messenger.oo('setHTMLCache',{"quartzError":function(msg){return"<div class='appError'>There was an error retrieving your data...<br \/>The factual development team has been notified.<br \/>Sorry for the inconvenience.<br \/>You can also try&nbsp;<a onClick='window.location.reload()'>reloading the page<\/a>.<br \/>Error Details: "+msg+"<\/div>"},"runtimeError":function(){return"<div class='appError'>There was an error retrieving your data...<br \/>The factual development team has been notified.<br \/>Sorry for the inconvenience.<br \/>You can also try&nbsp;<a onClick='window.location.reload()'>reloading the page<\/a>.<span class='closeBtn'><\/span><\/div>"}});JS2.OO.createClass("Grid0.Util");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"mainHeader");K.oo('method',"getColumnParams",function(ele){var colIdx=parseInt(ele.getAttribute('colIdx'));return{ele:ele,colIdx:colIdx,col:this.schema.columns()[colIdx]};});K.oo('method',"styleTab",function(jq){jq.removeClass('ui-widget-content');var list=jq.find('>ul:first,>ol:first');list.removeClass('ui-widget-header');list.addClass('ui-inner-tabs');});K.oo('method',"addDialogHeaderClass",function(jqDialog,className){jqDialog.parents('>.ui-dialog').find('>.ui-dialog-titlebar').addClass(className);});K.oo('method',"buildDialog",function(name,html,options){var dialog=Grid0.dialogs[name];if(!dialog){this.jqGrid.append(html);var jq=$(this.jqGrid[0].lastChild);jq.dialog(options);Grid0.dialogs[name]=jq;dialog=jq;}
return dialog;});K.oo('method',"addHeaderButton",function(html){return this.mainHeader.add(html);});})(Grid0.Util,Grid0);JS2.OO.createClass("Grid0.ColumnMenu");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"header");K.oo('method',"e_initHTML",function(){this.initHTML();this.secondaryMenus=[];});K.oo('method',"initHTML",function(){this.jq=$(this.htmlCache.main()).hide().appendTo(this.jqGrid);;var self=this;this.jq.clickoff(function(){self.hide();});this.jqList=this.jq.find('ul');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"menu",this.jqList,null);this.jqList.click(function(){self.hide();});var jqAsc=this.jqList.find('li.ascending');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"asc",jqAsc,null);});K.oo('method',"hide",function(){this.jq.hide();this.notify('columnMenuHidden');});K.oo('method',"addItem",function(html,klass,options){options=options||{};options.submenu=options.submenu||':first'
jqUL=this.jq.find('ul'+options.submenu).append(this.htmlCache.item(klass,html));jqItem=jqUL.find('.'+klass);if(options.secondaryMenu){this.createSecondaryMenu(options.secondaryMenu,jqItem);}
return jqItem;});K.oo('method',"addLabel",function(html){this.addItem(html,'label');});K.oo('method',"addSeperator",function(){this.jq.first('ul').append('<hr/>')});K.oo('method',"createSecondaryMenu",function(html,jqItem){var secondMenu=jqItem.append(html).children(':last-child');secondMenu.hide();this.secondaryMenus.push(secondMenu);});K.oo('method',"e_showColumnMenu",function(){this.context=this.header.contexts.click;if(this.context.col.isPrimary){this.jq.addClass('primaryMenu');}else{this.jq.removeClass('primaryMenu');}
this.jq.show();this.positionWidget();});K.oo('method',"e_columnMenuShown",function(){this.positionSecondMenu();});K.oo('method',"positionWidget",function(){var gridLeftMargin=3;if(this.context){var jqColMenu=this.context.jqEle;var colWidth=jqColMenu.width();var colOffset=jqColMenu.offset();this.left=colOffset.left-gridLeftMargin;this.colMenuWidth=this.jq.width();var bodyWidth=this.dim.body.width;var right=this.left+this.colMenuWidth;if(this.left>=bodyWidth-this.colMenuWidth){this.left=bodyWidth-this.colMenuWidth;}
this.jq[0].style.left=this.left+2+'px';}
this.jq[0].style.top=this.dim.scroller.top-1+'px';});K.oo('method',"positionSecondMenu",function(){var left=this.jqList.width();var bodyWidth=this.dim.body.width;for(var it35=0,smenu,it35__arr=this.secondaryMenus,it35__len=it35__arr.length;(smenu=it35__arr[it35])||it35<it35__len;it35++){var computedLeft=left;if(this.left+left+smenu.width()>=bodyWidth){computedLeft=-(smenu.width()+5)+'px';}else{computedLeft-=1}
smenu.css({position:'absolute',left:computedLeft,top:'0px'});}});K.oo('method',"column",function(){return this.schema.column(this.header.contexts.click.colIdx);});K.oo('method',"e_hScroll",function(){this.hide();});K.oo('method',"e_vScroll",function(){this.hide();});})(Grid0.ColumnMenu,Grid0);Grid0.ColumnMenu.oo('setHTMLCache',{"main":function(){return"<div class='columnMenu'><div class='dialogShadow'><div class='content'><ul class='menu'><\/ul><\/div><\/div><\/div>"},"item":function(){return"<li class='"+arguments[0]+"'><span class='icon'><\/span>"+arguments[1]+"<\/li>"}});JS2.OO.createClass("Grid0.GridMenuController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){this.menus={};this.options=options;});K.oo('method',"addMenu",function(className,html){var li=this.view.addMenu(className,html);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.appendVal(TMP_SEL_MARKER.getRealClassScope(this),"Menu Item",li,null);this.menus[className]=li;return li;});K.oo('method',"getMenu",function(menuName){return this.view.lookup[menuName];});K.oo('method',"addMenuItem",function(menu,html){var menuItem=this.view.lookup[menu];var subMenu=menuItem.submenu;if(subMenu.length==0){subMenu=$('<ul class="subMenu"></ul>');menuItem.jq.append(subMenu);}
subMenu.append('<li>'+html+'</li>');});K.oo('method',"showMenu",function(menuName){this.view.lookup[menuName].jq.show();});K.oo('method',"hideMenu",function(menuName){this.view.lookup[menuName].jq.hide();});K.oo('method',"hideSubMenu",function(path){this.view.hideSubMenu(path);});K.oo('method',"disableMenuItem",function(path){this.modifyMenuItem(path,'disable');});K.oo('method',"enableMenuItem",function(path){this.modifyMenuItem(path,'enable');});K.oo('method',"showMenuItem",function(path){this.modifyMenuItem(path,'show');});K.oo('method',"hideMenuItem",function(path){this.modifyMenuItem(path,'hide');});K.oo('method',"getMenuItem",function(path){var paths=$.map(path.split('>'),$.trim);var menu=this.view.lookup[paths[0]];var submenu=menu.submenu;return submenu.find("a[name='"+paths[1]+"']");});K.oo('method',"appendToMenuBar",function(html){return $(html).appendTo(this.view.jq);});K.oo('method',"modifyMenuItem",function(path,action){this.view.modifyMenuItem(path,action);});})(Grid0.GridMenuController,Grid0);JS2.OO.createClass("Grid0.GridMenuView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"auth mainHeader");K.oo('method',"initHTML",function(){this.jq=this.mainHeader.add(this.htmlCache.main());var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Menu",this.jq,null);this.lookup={};this.jqMagic=this.jq.first('.magic');this.menu=new Sci.JqList(this.jq,{alreadyBuilt:true});this.jqMenuHeaders=this.jq.find('>li');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Menu Headers",this.jqMenuHeaders,null);this.initJqObjects();this.processMenus();this.registerEvents();this.checkLogin();});K.oo('method',"initJqObjects",function(){this.jqObjects={};this.jqObjects.display={};this.jqObjects.display.cellValueFormatSetting=this.jq.first('li.display li.cellValueFormatSetting');this.jqObjects.display.fieldRefs=this.jq.first('li.display li.fieldRefs');this.jqObjects.display.fqr=this.jq.first('li.display li.fqr');this.jqObjects.file={};this.jqObjects.file.saveAs=this.jq.first('li.file li.saveAs');this.jqObjects.file.download=this.jq.first('li.file li.download a:first');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"download csv",this.jqObjects.file.download,null);this.jqObjects.file.downloadDev=this.jq.first('li.file li.downloadDev a:first');this.jqObjects.file.downloadVotes=this.jq.first('li.file li.downloadVotes');this.downloadVotes=this.jq.first('a[name=downloadVotes]');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"download votes",this.downloadVotes,null);});K.oo('method',"checkLogin",function(){this.auth.isAdmin()?this.jqMagic.show():this.jqMagic.hide();if(this.auth.loggedIn()&&!this.bigData){this.jqObjects.display.cellValueFormatSetting.show();}else{this.jqObjects.display.cellValueFormatSetting.hide();}
if(this.auth.isAdmin()||this.auth.userId()==this.data.ownerId()){this.lookup.file.jq.show();var action=this.auth.isAdmin()?'show':'hide';this.modifyMenuItem('file > download',action);this.modifyMenuItem('file > downloadDev',action);this.modifyMenuItem('file > downloadVotes',action);}else{this.lookup.file.jq.hide();}
if(this.auth.isAdmin()){this.lookup.display.jq.show();this.lookup.improve.jq.show();}else{this.lookup.display.jq.hide();this.lookup.improve.jq.hide();}});K.oo('method',"processMenus",function(){var lis=this.jq.find('>li');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Menu Toggles",lis,null);var className='';for(var i=0,li;li=lis[i];i++){className=li.className||i.toString();className=className.split(' ')[0];this.lookup[className]={jq:$(li),submenu:$(li).find('.subMenu:first'),link:$(li).find('a:first')}}});K.oo('method',"getSubMenus",function(){return this.jq.find('.subMenu');});K.oo('method',"hideSubMenu",function(name){this.hide(this.lookup[name].jq);});K.oo('method',"registerEvents",function(){var self=this;var menus=this.lookup;$.each(menus,function(className,menu){menu.jq.clickoff(function(){self.hide(menu.jq);});menu.jq.click(function(e){self.toggle($(this),$(e.target));});self.clickEvents(className,menu);});});K.oo('method',"toggle",function(jqEle,jqTarget){if(jqEle.hasClass('selected')&&jqTarget.is('a')){this.hide($(jqEle));}else{jqEle.addClass('selected');}});K.oo('method',"hide",function(jqEle){jqEle.removeClass('selected');});K.oo('method',"addMenu",function(className,html){return this.menu.add(className,html);});K.oo('method',"clickEvents",function(className,menu){var self=this;var submenu=menu.submenu;var clickables=submenu.find('a, :checkbox').click(function(){var jq=$(this);self.notify(className+'MenuClicked',className+' > '+jq.attr('name'),jq);});clickables;var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.appendVal(TMP_SEL_MARKER.getRealClassScope(this),"Sub Menus",clickables,null);submenu.find(':radio').click(function(){var jq=$(this);self.notify(className+'MenuClicked',className+' > '+jq.val(),jq);});});K.oo('method',"modifyMenuItem",function(path,action){var paths=$.map(path.split('>'),$.trim);var menu=this.lookup[paths[0]];var submenu=menu.submenu;var modifyFunc=function(){var jq=$(this);if(jq.attr('name')==paths[1]){switch(action){case'disable':jq.parent().addClass('disabled');break;case'enable':jq.parent().removeClass('disabled');break;case'hide':jq.parent().hide();break;case'show':jq.parent().show();break;}}};submenu.find('a').each(modifyFunc);submenu.find('input').each(modifyFunc);});K.oo('method',"e_fileMenuClicked",function(name){this.checkLogin();});K.oo('method',"e_displayMenuClicked",function(name,jqObject){switch(name){case'display > garbageDisplay':this.data.toggleGarbage(!jqObject.is(":checked"));break;case'display > fqrEnable':this.notify('applyFqr',jqObject.is(':checked'));break;case'display > fqrExplain':this.notify('showFqrExplain');break;case'display > fieldRefs':this.data.setShowFieldName(!jqObject.is(':checked'));break;}});K.oo('method',"e_fieldsMenuClicked",function(name,jqObject){if(name=='fields > guessColumnWidths'){this.data.guessColumnWidths();}});K.oo('method',"setBigData",function(bigData){this.bigData=bigData;this.checkLogin();});K.oo('method',"showFqrExplain",function(){if(!this.fqrExplain){this.fqrExplain=$(this.htmlCache.fqrExplain()).dialog({autoOpen:false,title:'Explanation',modal:true,resizable:false,width:400,height:240});}
this.fqrExplain.dialog('open');});K.oo('method',"toggleFieldRefs",function(){this.jqObjects.display.fieldRefs.first('input:checkbox').prop('checked',!this.data.isShowFieldName());});K.oo('method',"toggleFqr",function(){this.jqObjects.display.fqr.first('input:checkbox').prop('checked',this.actions.getUseFqr());});})(Grid0.GridMenuView,Grid0);JS2.OO.createClass("Grid0.GridMenuEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();});K.oo('method',"e_userLoggedIn",function(){this.view.checkLogin();});K.oo('method',"e_bigData",function(bigData){this.view.setBigData(bigData);});K.oo('method',"e_showFqrExplain",function(){this.view.showFqrExplain();});K.oo('method',"e_dataLoaded",function(){this.view.toggleFieldRefs();this.view.toggleFqr();});})(Grid0.GridMenuEvents,Grid0);Grid0.GridMenuView.oo('setHTMLCache',{"subMenu":function(){return"<ul class='subMenu'><\/ul>"},"fqrExplain":function(){return"<div class='fqrExplain'>The<strong> Factual Qualified Row (FQR) filter <\/strong>is applied to all Local datasets with inputs sourced by FactualBot. It requires that in order for a row to be displayed and API accesible there must be at least two inputs from FactualBot in the important fields. FactualBot is aggregating millions of inputs, some of which may not be as accurate as others. This filter helps maintain a level of data quality. Note that FQR only applies to FactualBot inputs, so rows will be displayed with one input if they are non-FactualBot sourced.<\/div>"},"main":function(){return"<ul class='menu'><li class='file'><a href='javascript:void(0);'>File<span class='smallDownArrow'><\/span><\/a><ul class='subMenu'><li class='disabled save'><a href='javascript:void(0);' name='saveGridState'>Save<\/a><div>save current view state as the default for this grid<\/div><\/li><!--<li class='disabled saveAs'><a href='javascript:void(0);' name='saveAs'>Save as...<\/a><div>save what you see as a new table<\/div><\/li>--><li class='download'><a href='javascript:void(0);' name='download'>Download as CSV<\/a><span class='openSquareLink'>&nbsp;-&nbsp;<a>Why can't I download this?<\/a><\/span><\/li><li class='downloadDev'><a href='javascript:void(0);' name='downloadDev'>Download Developer CSV<\/a><\/li><li class='downloadVotes'><a href='javascript:void(0);' name='downloadVotes'>Download Votes CSV<\/a><\/li><li><a href='javascript:void(0);' name='tablePermissions'>Permissions<\/a><\/li><li><a href='javascript:void(0);' name='removeTable'>Remove this Table<\/a><\/li><\/ul><\/li><li class='display'><a href='javascript:void(0);'>Display<span class='smallDownArrow'><\/span><\/a><ul class='subMenu'><li class='garbageSetting'><label><input checked='checked' class='checkBox' name='garbageDisplay' type='checkbox' value='hideGarbageRows' \/><strong>Hide<\/strong>&nbsp;all rows Factual has deemed to be&nbsp;<strong>\"garbage\"<\/strong><\/label><\/li><li class='fqr'><label><input checked='checked' class='checkBox' name='fqrEnable' type='checkbox' \/><strong>Hide<\/strong>&nbsp;all&nbsp;<strong>\"non-FQR\"<\/strong>&nbsp;rows&nbsp;<\/label><a class='right' href='javascript:void(0);' name='fqrExplain'>[?]<\/a><\/li><li class='expandCell'><label><input checked='checked' class='checkBox' name='expandCell' type='checkbox' \/>Auto&nbsp;<strong>expand<\/strong>&nbsp;any clicked on cell to show any clipped data<\/label><\/li><li class='fieldRefs'><label><input checked='checked' class='checkBox' name='fieldRefs' type='checkbox' \/>Show field API&nbsp;<strong>reference names<\/strong>&nbsp;instead of&nbsp;<strong>names<\/strong><\/label><\/li><li class='cellValueFormatSetting'><label>When your value differs from the current consensus value, show:<\/label><label><input class='radioButton' name='defaultView' type='radio' value='uvo' \/><strong>your value only!<\/strong><\/label><label><input class='radioButton' name='defaultView' type='radio' value='cvo' \/>Consensus value only<\/label><label><input class='radioButton' name='defaultView' type='radio' value='uvf' \/><strong>Your value<\/strong>&nbsp;(Consensus Value)<\/label><label><input checked='checked' class='radioButton' name='defaultView' type='radio' value='cvf' \/>Consensus Value<strong>(Your value)<\/strong><\/label><\/li><li class='showHideFieldsSetting'><a href='javascript:void(0)' name='showFields'>Show or Hide Fields<\/a>(<em>will not permanently affect table<\/em>)<\/li><\/ul><\/li><li class='fields'><a href='javascript:void(0);'>Fields<span class='smallDownArrow'><\/span><\/a><ul class='subMenu'><li><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='addField'>Add New Field<\/a><\/li><li><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='showFields'>Show or Hide Fields<\/a><\/li><li><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='reorderFields'>Reorder Fields<\/a><\/li><li class='autoColumnWidth'><span class='smallIndicator'><\/span><a href='javascript:void(0)' name='guessColumnWidths'>Best guess column widths<\/a><\/li><\/ul><\/li><li class='improve'><a href='javascript:void(0);'>Improve<span class='smallDownArrow'><\/span><\/a><ul class='subMenu'><li><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='joinDataset'>Join other tables to this table<\/a><\/li><li><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='bulkImport'>Import data from files or other tables<\/a><\/li><li><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='merge'>Merge other tables into this table<\/a><\/li><li class='magic'><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='improve'>Attempt to fill in empty cells with data from Factual or the Internet<\/a><span class='magicIcon'><\/span><\/li><\/ul><\/li><li class='admin'><a href='javascript:void(0);'>Admin<span class='smallDownArrow'><\/span><\/a><ul class='subMenu'><li class='alwaysShow setApiTtl'><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='setApiTtl'>Set API TTL<\/a><\/li><li class='alwaysShow apiTtl state bottomSpliter'><label>API TTL:<span><\/span><\/label><\/li><li class='alwaysShow forceCache'><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='forceCache'>Force Cache<\/a><\/li><li class='alwaysShow cache state'><label>Cache State:<span><\/span><\/label><\/li><li class='alwaysShow bigData state'><label>Big Data:<span><\/span><\/label><\/li><li class='alwaysShow cacheSettings'><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='cacheSettings'>Cache settings<\/a><\/li><li class='alwaysShow geo state'><label>Geo State:<span><\/span><\/label><\/li><li class='alwaysShow fulltextSearch state'><label>Full-text search:<span><\/span><\/label><\/li><li class='alwaysShow identityFields state'><label>Identity Fields:<span><\/span><\/label><\/li><li class='alwaysShow fqr state bottomSpliter'><label>FQR:<span><\/span><\/label><\/li><li class='alwaysShow clearLastPresummaryFunction'><span class='smallIndicator'><\/span><a href='javascript:void(0);' name='clearLastPresummaryFunction'>Clear out the last presummary function<\/a><\/li><\/ul><\/li><\/ul>"}});JS2.OO.createClass("Grid0.DataImproverController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"registerEvents",function(){var view=this.view;var self=this;view.jqStart.click(function(){self.improve();});view.jqCancel.click(function(){self.cancel();});view.jqApply.click(function(){self.apply();});view.jqStop.click(function(){self.stop();});});K.oo('method',"cancel",function(){this.view.cancel();this.cancelPoll();this.cancelTask();});K.oo('method',"apply",function(){var url='/tables/improver/goto/'+this.taskId;var params={add_columns:this.view.jqAddColumns[0].checked,add_rows:this.view.jqAddRows[0].checked};this.cancelPoll();this.data.refresh(url,params,function(){});});K.oo('method',"stop",function(){var url='/tables/improver/stop/'+this.taskId;sci.ajax.post(url,{});this.toApply=true;});K.oo('method',"cancelPoll",function(){if(this.pollInterval)clearInterval(this.pollInterval);this.pollInterval=null;});K.oo('method',"cancelTask",function(){if(this.taskId)sci.ajax.post('/tables/improver/cancel/'+this.taskId,{});this.taskId=null;});K.oo('method',"improve",function(){var self=this;this.found=0;this.view.start();var url='/tables/improver/initiate';var params={grid:this.data.state(),ext_search:this.view.jqExtSearch[0].checked};sci.ajax.post(url,params,function(obj){self._improve(obj);});});K.oo('method',"poll",function(){var self=this;var url='/tables/improver/poll';var params={task_id:this.taskId};sci.ajax.post(url,params,function(obj){self._poll(obj)});});K.oo('method',"_improve",function(id){var self=this;this.taskId=id;this.poll();this.pollInterval=setInterval(function(){self.poll()},5000);});K.oo('method',"_poll",function(obj){this.view.setStatus(obj);if(obj.status=='Completed'||obj.status=='Failed'||obj.status=='Stopped'){if(this.toApply){this.apply();this.toApply=null;this.view.jqStop.hide();this.view.jqApply.hide();}else{if(this.found>0)this.view.jqApply.show();}
this.cancelPoll();}
if(obj.status=='Stopping'){this.view.jqStop.hide();this.view.jqCancel.show();}
if(obj.status=='Completed'){this.view.jqStop.hide();this.view.jqCancel.hide();}
if(obj.status=='Failed'){this.view.jqStop.hide();if(this.found>0)this.view.jqApply.show();WEBSITE.error('This process has failed');}});})(Grid0.DataImproverController,Grid0);JS2.OO.createClass("Grid0.DataImproverView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"gridMenu");K.oo('member','gridMenuName','improve > improve');K.oo('method',"initHTML",function(){this.buildDialog();this.initJqObjects();});K.oo('method',"buildDialog",function(){var self=this;var dialogOptions={title:'Improve this Dataset',modal:true,autoOpen:false,resizable:'se',width:400,close:function(){self.controller.cancel();}};this.jqDialog=this.util.buildDialog('dataImprover',this.htmlCache.main(),dialogOptions);});K.oo('method',"initJqObjects",function(){this.jqStatusInfo=this.jqDialog.first('.statusInfo');this.jqTablesSearched=this.jqStatusInfo.first('.tablesSearched');this.jqTablesFound=this.jqStatusInfo.first('.tablesFound');this.jqStatus=this.jqStatusInfo.first('.statusText');this.jqIntro=this.jqDialog.first('.intro');var jqControls=this.jqDialog.first('.controls');this.jqAddColumns=jqControls.first('.addColumns');this.jqAddColumnsLi=this.jqAddColumns.parent();this.jqAddRows=jqControls.first('.addRows');this.jqAddRowsLi=this.jqAddRows.parent();this.jqExtSearch=jqControls.first('.extSearch');this.jqExtSearchLi=this.jqExtSearch.parent();this.jqExtDesc=jqControls.first('.description');this.jqStart=this.jqDialog.first('.start');this.jqStop=this.jqDialog.first('.stopAndApply');this.jqCancel=this.jqDialog.first('.cancel');this.jqApply=this.jqDialog.first('.apply');});K.oo('method',"toggleMenuButton",function(){if(this.actions.isSimple()){this.gridMenu.enableMenuItem(this.gridMenuName);}else{this.gridMenu.disableMenuItem(this.gridMenuName);}});K.oo('method',"open",function(){this.jqDialog.dialog('open');this.jqStart.show();this.jqStop.hide();this.jqStatusInfo.hide();this.jqIntro.show();this.jqAddColumnsLi.hide();this.jqAddRowsLi.hide();this.jqExtSearchLi.show();this.jqExtDesc.show();this.jqStatus.show();this.jqStop.hide();this.jqCancel.hide();this.jqApply.hide();});K.oo('method',"setStatus",function(params){var status=params.status;var searched=params.tables_examined;var found=params.tables_found;this.jqStatus.html(status);this.jqTablesSearched.html(searched);this.jqTablesFound.html(found);if(found>0){this.controller.found=found;this.jqStop.show();}});K.oo('method',"start",function(){if(this.auth.requireLogin(this))return;this.jqStatusInfo.show();this.jqIntro.hide();this.jqAddColumnsLi.show();this.jqAddRowsLi.show();this.jqExtSearchLi.hide();this.jqExtDesc.hide();this.jqStart.hide();this.jqCancel.show();this.jqStatus.html('Pending...');this.jqTablesSearched.html(0);this.jqTablesFound.html(0);});K.oo('method',"cancel",function(){this.jqStatusInfo.hide();this.jqIntro.show();this.jqAddColumnsLi.hide();this.jqAddRowsLi.hide();this.jqExtSearchLi.show();this.jqExtDesc.show();this.jqStart.show();this.jqApply.hide();this.jqCancel.hide();});})(Grid0.DataImproverView,Grid0);JS2.OO.createClass("Grid0.DataImproverEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.controller.registerEvents();});K.oo('method',"e_dataLoaded",function(){this.view.toggleMenuButton();});K.oo('method',"e_improveMenuClicked",function(name,jqObject){if(name=='improve > improve'&&!jqObject.parent().hasClass('disabled')){this.view.open();}});})(Grid0.DataImproverEvents,Grid0);Grid0.DataImproverView.oo('setHTMLCache',{"main":function(){return"<div class='dataImprover'><div class='statusInfo'><p>Factual is searching through its data repository and out on the web to find more data to add to this table.<\/p><p>Status:&nbsp;<span class='statusText'><\/span><\/p><p>Searched through&nbsp;<span class='tablesSearched'>0<\/span>&nbsp;data sources<\/p><p style='margin-bottom: 8px'>Found&nbsp;<span class='tablesFound'>0<\/span>&nbsp;matches for your table<\/p><\/div><p class='intro'>The data finder searches for tables containing data that can be added to your table.  The longer you wait, the better your results may be.<\/p><div class='controls'><ul><li><input checked='true' class='addColumns checkBox' type='checkbox' value='add_columns' \/>Include newly discovered columns?<\/li><li><input checked='true' class='addRows checkBox' type='checkbox' value='add_rows' \/>Include newly discovered rows?<\/li><li><input class='extSearch checkBox' type='checkbox' value='extended_search' \/>* Do an extended search?<\/li><\/ul><div class='description'>* An extended search might take a very long time. Go grab a coffee!<\/div><\/div><div class='buttons'><span class='start fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Start      <\/a>    <\/span>  <\/span><\/span><span class='stopAndApply fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Stop and Apply      <\/a>    <\/span>  <\/span><\/span><span class='apply fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Apply      <\/a>    <\/span>  <\/span><\/span><span class='cancel fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Cancel      <\/a>    <\/span>  <\/span><\/span><\/div><\/div>"}});JS2.OO.createClass("Grid0.ColumnNavigatorController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"registerEvents",function(){var self=this;var view=this.view;view.jqIcon.click(function(){view.show();return false;});view.jqColumns.click(function(e){self.handleClick(e);});});K.oo('method',"handleClick",function(e){var jqTarget=$(e.target);if(jqTarget.is('.column')){var colIdx=jqTarget.attr('colIdx');this.view.scrollToColumn(colIdx);}});K.oo('method',"jumpToLastColumn",function(){var colIdx=this.data.columns().length-1;this.view.scrollToColumn(colIdx);});})(Grid0.ColumnNavigatorController,Grid0);JS2.OO.createClass("Grid0.ColumnNavigatorView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initHTML",function(){this.jqIcon=this.jqGrid.first('>.hMask>.columnNavigatorIcon');this.jq=$(this.htmlCache.main()).hide();this.jqGrid.append(this.jq);var self=this;this.jq.clickoff(function(){self.hide();});this.jqColumns=this.jq.first('ul.columns');});K.oo('method',"buildColumns",function(){var htmlColumns='';var columns=this.data.columns();for(var i=0,c;c=columns[i];i++){htmlColumns+=this.htmlCache.column({colIdx:i,name:DISPLAY.html(c.name)});}
this.jqColumns.html(htmlColumns);this.builded=true;});K.oo('method',"toggleIcon",function(){if(!this.jqIcon)return;var diff=this.dim.filler.width-this.dim.body.width;if(diff>0){this.jqIcon.show();}else{this.jqIcon.hide();}});K.oo('method',"show",function(){if(!this.builded)this.buildColumns();this.jq.show();this.setMaxHeight();});K.oo('method',"hide",function(){this.jq.hide();});K.oo('method',"scrollToColumn",function(colIdx){var scrollLeft=0;var column=this.data.column(colIdx);if(column.hidden){var show=confirm(this.htmlCache.hiddenMessage());if(show){column.hidden=false;this.notify('resizeWidth');this.notify('viewModified');}else{this.hide();return;}}
for(var i=0;i<colIdx;i++){var col=this.data.column(i);if(col.hidden)continue;scrollLeft+=col.width;}
this.hide();this.notify('columnNavigatorHScroll',scrollLeft);});K.oo('method',"setMaxHeight",function(){if(this.jqColumns){var maxHeight=this.dim.body.height-22;this.jqColumns.css('max-height',maxHeight);}});})(Grid0.ColumnNavigatorView,Grid0);JS2.OO.createClass("Grid0.ColumnNavigatorEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.controller.registerEvents();});K.oo('method',"e_resizing",function(){this.view.setMaxHeight();this.view.toggleIcon();});K.oo('method',"e_jumpToLastColumn",function(){this.controller.jumpToLastColumn();});})(Grid0.ColumnNavigatorEvents,Grid0);Grid0.ColumnNavigatorView.oo('setHTMLCache',{"hiddenMessage":function(){return"You have chosen to jump to a column that is currently hidden. Do you want to make this column visible and jump to it?"},"column":function(col){return"<li class='column' colIdx='"+col.colIdx+"' title='"+col.name+"'>"+col.name+"<\/li>"},"main":function(){return"<div class='columnNavigator'><div class='content'><div class='header'><strong>Jump to Column:<\/strong><\/div><ul class='columns'><\/ul><\/div><\/div>"}});JS2.OO.createClass("Grid0.BigTableGuide");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"mainHeader auth");K.oo('method',"initialize",function(){this.KEY_MAPPING={UNCACHED:'uncached',WRITING:'caching',CACHED:'cached',CACHED_MISMATCHED:'cached',CACHED_BUFFERING:'cached'};});K.oo('method',"initHTML",function(){this.jq=this.mainHeader.add(this.htmlCache.main());});K.oo('method',"change",function(isBigData){if(isBigData){this.buildCachedGuide();this.jq.show();}else{this.jq.hide();}});K.oo('method',"buildCachedGuide",function(){this.buildCachedDialog();this.buildCachedLink();});K.oo('method',"buildCachedDialog",function(){var name='cachedBigTableGuide';var html='<div class="'+name+'">'+
this.htmlCache.cachedMessage()+'</div>';var options={title:this.htmlCache.cachedTitle(),width:700,autoOpen:false,resizable:false,modal:true};this.jqDialog=this.util.buildDialog(name,html,options);});K.oo('method',"buildCachedLink",function(){var self=this;this.jq.html(this.htmlCache.cachedLink());this.jq.find('a').click(function(){self.jqDialog.dialog('open');});});K.oo('method',"cacheStateLoaded",function(cacheState){if(!cacheState)return;var key=this.KEY_MAPPING[cacheState];this.handleMismatch(cacheState);this.handleOutbounded(cacheState);if(key=='cached')return;this.notify('tableUnCached',this.htmlCache[key+'Message']({key:this.data.dataset.key,title:this.data.dataset.name}));});K.oo('method',"handleOutbounded",function(cacheState){var hasNoRow=(this.data.rows().length==0);var isFirstPage=(this.actions.pageNumber()==1);if(cacheState=='CACHED'&&hasNoRow&&!isFirstPage){WEBSITE.message(this.htmlCache.cachedOutbounded());}});K.oo('method',"handleMismatch",function(cacheState){if(cacheState=='CACHED_MISMATCHED'&&this.auth.isAdmin()){WEBSITE.message(this.htmlCache.cachedMismatched());}});})(Grid0.BigTableGuide,Grid0);JS2.OO.createClass("Grid0.BigTableGuideEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();});K.oo('method',"e_bigData",function(isBigData){this.controller.change(isBigData);});K.oo('method',"e_cacheStateLoaded",function(cacheState){this.controller.cacheStateLoaded(cacheState);});})(Grid0.BigTableGuideEvents,Grid0);Grid0.BigTableGuide.oo('setHTMLCache',{"uncachedMessage":function(){return"<div class='uncachedTable'><p>This is a<strong> very large table <\/strong>and requires being cached on our servers before it can be accessed.<\/p><p>It is currently off-line.<\/p><br \/><p><strong>Click <\/strong><a class='here'>here<\/a>&nbsp;if you would like<strong> to request that this data be brought on-line.<\/strong><\/p><\/div>"},"cachedMismatched":function(){return"this table is cached so some functions like adding vote filters and changing the aggregation function may have unexpected results."},"cachedTitle":function(){return"Feature restrictions on very large tables"},"cachedMessage":function(){return"<p>While we are making every attempt to make working with Factual tables easy and flexible, we still have some growing pains on some of the very largest tables.<\/p><p>In particular,<strong> the following features are currently disabled:<\/strong><ul><li>searching across the entire table (you can still filter as many fields as you'd like)<\/li><li>creating filters that use the<em>&nbsp;contains&nbsp;<\/em>clause<\/li><li>using more than one column to sort your data<\/li><\/ul><\/p><p>We hope to have all of these features working soon in the future!<\/p>"},"main":function(){return"<div class='bigTableGuide'><\/div>"},"cachedOutbounded":function(){return"You have navigated to a page that contains no data. You may want to try using sorts or filters to get at the data you are looking for."},"cachingMessage":function(){return"<div class='uncachedTable'><p>This is a<strong> very large table <\/strong>and requires being cached on our servers before it can be accessed.<\/p><p>We are currently in the process of doing so.<\/p><\/div>"},"cachedLink":function(){return}});JS2.OO.createClass("Grid0.Caution");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth');K.oo('method',"initHTML",function(){this.jq=$('.caution');});K.oo('method',"registerEvents",function(){this.jq.delegate('a','click',(function(self){return function(){self.handleClick();}})(this));});K.oo('method',"handleClick",function(){if(!this.data.isBigData())return;if(this.auth.isAdmin()){this.notify('forceCache');}else{this.notify('requestForceCache');}});K.oo('method',"populate",function(){this.jq.show();if(this.data.isBigData()&&this.data.getCacheState()=='CACHED_MISMATCHED'){if(this.auth.isAdmin()){this.jq.html(this.htmlCache.cachedMismatchedAdmin());}else{this.jq.html(this.htmlCache.cachedMismatchedNormal());}}else if(this.data.isBigData()&&this.data.getCacheState()=='CACHED_BUFFERING'){this.jq.html(this.htmlCache.cachedBuffering());}else if(this.auth.isAdmin()){this.jq.html(this.htmlCache.admin());}else{this.jq.hide();}});})(Grid0.Caution,Grid0);JS2.OO.createClass("Grid0.CautionEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();this.controller.registerEvents();});K.oo('method',"e_dataLoaded",function(){this.controller.populate();});K.oo('method',"e_userLoggedIn",function(){this.controller.populate();});})(Grid0.CautionEvents,Grid0);Grid0.Caution.oo('setHTMLCache',{"cachedMismatchedNormal":function(){return"<span class='icon'><\/span>Recent changes will be integrated upon next caching run."},"cachedBuffering":function(){return"<span class='icon'><\/span>There is a newer version of this table, which is currently being cached, please check back later..."},"cachedMismatchedAdmin":function(){return"<span class='icon'><\/span>Quartz has returned a cache mismatch on this table. Click [<a>here<\/a>] to update the cache."},"admin":function(){return"<span class='icon'><\/span>You are logged in as an<strong> administrator. <\/strong>Please use<strong> caution!<\/strong>"}});JS2.OO.createClass("Grid0.FieldEditorController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth');K.oo('method',"isEditable",function(){if(!this.field)return false;var fieldOwner=this.col.creatorId==this.auth.userId()&&this.col.deletableBy=='CREATOR';var isVirtual=(this.col.datasetId!=this.data.dataset.id);return((this.data.isOwner()||fieldOwner||this.auth.isAdmin())&&!isVirtual);});K.oo('method',"e_editField",function(fieldId){this.col=this.data.columnById(fieldId);this.field=this.col.field;this.loadDialog('edit');});K.oo('method',"registerEvents",function(){this.view.jqEditMenu.click((function(self){return function(){self.loadDialog('edit');}})(this));this.view.jqViewMenu.click((function(self){return function(){self.loadDialog('view');}})(this));this.view.dialog.onSubmit((function(self){return function(){self.submit()}})(this));this.view.dialog.jqForm.find('.datatype').change((function(self){return function(){self.datatypeChanged();}})(this));});K.oo('method',"datatypeChanged",function(){if(!this.data.confirmForDBCache()){this.view.dialog.f.datatype.control.setValue(this.field.datatype);}
if(this.actions.isGeoUseField(this.field.id)&&!this.data.confirmForDisableGeoFunction()){this.view.dialog.f.datatype.control.setValue(this.field.datatype);return;}});K.oo('method',"submit",function(){var url='/tables/'+this.data.dataset.key+'/fields/'+this.field.id+'/edit.js';var params=this.loadParams();sci.ajax.post(url,params,(function(self){return function(p){self._submit(p);}})(this));this.notify('alert','Updating...');});K.oo('method',"_submit",function(p){if(p.summary){this.data.payload()._loadedData(p);this.data.dataLoaded();this.notify('fieldEdited',this.field.id);}else{this.field.presummaryFunction=this.fieldHash.presummary;this.field.computedFunction=this.fieldHash.computed;this.loadDialog('edit');alert(p.error);}});K.oo('method',"isDatatypeChanged",function(){return this.view.dialog.f.datatype.control.getValue()!=this.field.datatype;});K.oo('method',"loadParams",function(){this.fieldHash=this.view.dialog.save();var params={fieldInfo:JSON.stringify(this.fieldHash),grid:this.data.richState()};eventParams={table_id:this.data.dataset.id,field_id:this.field.id,agg_function:this.fieldHash.agg,hidden:this.fieldHash.visible=='hidden',name:this.fieldHash.name,default_value:this.fieldHash['default']};params._event='UpdateFieldMetadata';params._event_params=JSON.stringify(eventParams);return params;});K.oo('method',"loadDialog",function(mode){this.view.dialog.setup(mode,this.field.isPrimary,this.auth);var data=$.extend(false,{},this.field);data.aggregation=this.field.aggregation||this.col.aggregation;data.defaultValue=this.schema.immutable.fieldDefaultValues[this.field.id];data.fieldId=this.field.id;data.creatorId=this.col.creatorId||this.data.ownerId();data.creator=this.col.creatorName||this.data.ownerName();data.createdAt=this.col.dateCreated;data.fieldRefs=this.schema.getDatasetInfo(this.data.dataset.id).fieldRefs[this.field.id];data.sourceTables=new Array();for(var it7=0,f,it7__arr=data.mergeFields,it7__len=it7__arr.length;(f=it7__arr[it7])||it7<it7__len;it7++){var dataset=this.schema.getDatasetInfo(f.datasetId);data.sourceTables.push([dataset.id,dataset.name,dataset.urlName]);}
this.view.dialog.load(data);});})(Grid0.FieldEditorController,Grid0);JS2.OO.createClass("Grid0.FieldEditorView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','columnMenu');K.oo('method',"initHTML",function(){this.jqEditMenu=this.columnMenu.addItem('Edit this Field','fieldEditor');this.jqViewMenu=this.columnMenu.addItem('View Field Details','fieldViewer');this.dialog=new Sci.FieldDialog();});})(Grid0.FieldEditorView,Grid0);JS2.OO.createClass("Grid0.FieldEditorEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','header');K.oo('method',"e_initHTML",function(){this.view.initHTML();this.controller.registerEvents();});K.oo('method',"e_showColumnMenu",function(){this.controller.col=this.header.contexts.click.col;this.controller.field=this.controller.col.field;this.view.jqViewMenu.hide();if(this.controller.isEditable()){this.view.jqEditMenu.show();}else{this.view.jqEditMenu.hide();}});})(Grid0.FieldEditorEvents,Grid0);Grid0.FieldEditorController.oo('setHTMLCache',{"removeFilterConfirmMessage":function(){return"The change required removing filters formerly applied to the field you modified."}});JS2.OO.createClass("Grid0.QuickFilter");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','columnMenu header');K.oo('method',"initHTML",function(){this.$item=this.columnMenu.addItem(this.htmlCache.listItem(),'quickFilter',{secondaryMenu:this.htmlCache.menu()});this.$menu=this.$item.first('.dialogShadow');this.$list=this.$menu.first('.enumerationList');this.$up=this.$menu.first('.up');this.$down=this.$menu.first('.down');this.buildDialog();sci.inputHandler.wheel(this);});K.oo('method',"buildDialog",function(){this.$dialog=$(this.htmlCache.dialog()).dialog({autoOpen:false,title:'Quick Filter',resizable:false,modal:true});var finddialog=this.$dialog;var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"quickfind",finddialog,null);this.$fieldName=this.$dialog.first('.fieldName');this.$value=this.$dialog.first('input');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"input",this.$value,null);this.$submit=this.$dialog.first('.submit');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"submit",this.$submit,null);this.validator=Sci.validate(this.$value,'String',{notNull:true,trimValue:true,callback:(function(self){return function(valid){if(valid){self.$submit.removeClass('disabled');}else{self.$submit.addClass('disabled');}}})(this)});});K.oo('method',"registerEvents",function(){this.$item.hover((function(self){return function(){self.showMenu();}})(this),(function(self){return function(){self.hideMenu();}})(this));this.$item.click((function(self){return function(){self.openDialog();}})(this));this.$list.delegate('li','click',(function(self){return function(){self.findIn($(this));}})(this));this.$up.click((function(self){return function(e){self.smartUp($(e.target));return false;}})(this));this.$down.click((function(self){return function(e){self.smartDown($(e.target));return false;}})(this));this.$value.keydown((function(self){return function(e){if(e.keyCode==KEYCODE.ENTER)self.find();}})(this));this.$submit.click((function(self){return function(){self.find();}})(this));});K.oo('method',"openDialog",function(){if(this.field.isEnumerated)return;this.populateDialog();this.$dialog.dialog('open');this.$value.focus();});K.oo('method',"closeDialog",function(){this.$dialog.dialog('close');});K.oo('method',"showMenu",function(){if(this.field.isEnumerated)this.$menu.show();});K.oo('method',"hideMenu",function(){this.$menu.hide();});K.oo('method',"showColumnMenu",function(){this.field=this.header.contexts.click.col.field;if(this.field.isEnumerated){this.$item.addClass('isEnumerated');this.orderEnumList=$.extend([],this.field.enumerationList).sort();this.populateMenu();}else{this.$item.removeClass('isEnumerated');this.orderEnumList=null;}});K.oo('method',"populateDialog",function(){this.$fieldName.html(DISPLAY.html(this.field.name));this.$value.val('');var datatype=this.field.datatype;if($.inArray(datatype,['Link','PhoneNumber','ZipCode','UUID'])>-1)datatype='String';this.validator.setDatatype(datatype);this.validator.validate();});K.oo('method',"populateMenu",function(){var html=[];for(var it85=0,v,it85__arr=this.orderEnumList,it85__len=it85__arr.length;(v=it85__arr[it85])||it85<it85__len;it85++){html.push(this.htmlCache.menuItem(DISPLAY.html(v)));}
this.$list.html(html.join(''));if(this.orderEnumList.length>10){this.$up.show();this.$down.show();}else{this.$up.hide();this.$down.hide();}});K.oo('method',"getOperator",function(datatype,defaultOperator){datatype=datatype.toLowerCase();if(datatype=='date'){return'on';}else if(datatype=='double'||datatype=='integer'||datatype=='lat'||datatype=='lng'){return'eq';}else{return defaultOperator;}});K.oo('method',"find",function(){if(this.$submit.is('.disabled'))return;this.data.quickFilter(this.getOperator(this.field.datatype,'starts'),this.field.id,this.$value.val());this.closeDialog();});K.oo('method',"findIn",function($li){var index=$li.prevAll().length;var value=this.orderEnumList[index];this.data.quickFilter(this.getOperator(this.field.datatype,'eqp'),this.field.id,value);});K.oo('method',"handleWheel",function(delta,e){if(!this.field||!this.field.isEnumerated)return;var $target=$(e.target||e.srcElement);if($target.closest('.quickFilter').length==0)return;this.$list[0].scrollTop-=delta*22;});K.oo('method',"smartUp",function($target){if($target.is('.arrow'))$target=$target.parent();if(!$target.is('li'))return;if($target.is('.one')){this.$list[0].scrollTop-=22;}else{if(this.orderEnumList.length>100){var length=parseInt(this.orderEnumList.length/10);this.$list[0].scrollTop-=length*22;}else{this.$list[0].scrollTop=0;}}});K.oo('method',"smartDown",function($target){if($target.is('.arrow'))$target=$target.parent();if(!$target.is('li'))return;if($target.is('.one')){this.$list[0].scrollTop+=22;}else{if(this.orderEnumList.length>100){var length=parseInt(this.orderEnumList.length/10);this.$list[0].scrollTop+=length*22;}else{this.$list[0].scrollTop=this.$list[0].scrollHeight;}}});})(Grid0.QuickFilter,Grid0);JS2.OO.createClass("Grid0.QuickFilterEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();this.controller.registerEvents();});K.oo('method',"e_showColumnMenu",function(){this.controller.showColumnMenu();});})(Grid0.QuickFilterEvents,Grid0);Grid0.QuickFilter.oo('setHTMLCache',{"menuItem":function(value){return"<li title='"+value+"'>"+value+"<\/li>"},"menu":function(){return"<div class='dialogShadow'><div class='content'><ul class='up'><li class='smart'><div class='arrow'><\/div><\/li><li class='one'><div class='arrow'><\/div><\/li><\/ul><ul class='enumerationList'><\/ul><ul class='down'><li class='one'><div class='arrow'><\/div><\/li><li class='smart'><div class='arrow'><\/div><\/li><\/ul><\/div><\/div>"},"dialog":function(){return"<div class='quickFilterDialog'><span class='field'>Find<strong class='fieldName'><\/strong>:<!-- starts with --><\/span><input class='textField' \/><div class='buttons'><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Find      <\/a>    <\/span>  <\/span><\/span><\/div><\/div>"},"listItem":function(){return"Find<span class='rightArrow'><\/span>"}});JS2.OO.createClass("Grid0.TablePermissionsController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth gridMenu');K.oo('member','dialogName','Permissions');K.oo('method',"e_initHTML",function(){this.buildDialog();this.registerEvents();});K.oo('method',"e_fileMenuClicked",function(name){if(name=='file > tablePermissions')
this.showDialog();});K.oo('method',"showDialog",function(){if(this.auth.loggedIn()){this.jq.dialog('open');this.prepareDialog();}});K.oo('method',"hideDialog",function(){this.jq.dialog('close');});K.oo('method',"buildDialog",function(){var options={modal:true,autoOpen:false,width:580,minWidth:500,title:this.dialogName,resizable:false};this.jq=this.util.buildDialog(this.dialogName,this.htmlCache.main(),options);this.jqDialog=this.jq.parent();var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"permission",this.jqDialog,null);var close=this.jqDialog.find('span.ui-icon-closethick')
var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"close",close,null);var jqSubscriptions=this.jqDialog.find('input[name=subscribe]');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"subscribe",jqSubscriptions,null);this.whiteListLink=this.jqDialog.find('.whiteListLink');this.jqDownloadable=this.jqDialog.find('.accessibility');this.toggleDownloadable();this.jqDownloadableCheckbox=this.jqDialog.find('input[name=isDownloadable]');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"downloadable",this.jqDownloadableCheckbox,null);});K.oo('method',"toggleDownloadable",function(){this.jqDownloadable.toggle(sci.auth.isAdmin());});K.oo('method',"updateFormFieldUI",function(name,value){if(!name)return;if(name.charAt(0)=='!'){value=!value;}
jQuery("input[name='"+name+"'], select[name='"+name+"']").each(function(){switch(this.nodeName.toLowerCase()){case"input":switch(this.type){case"radio":this.checked=(this.value==value);break;case"checkbox":this.checked=value;break;default:jQuery(this).val(value);break;}
break;case"select":jQuery("option",this).each(function(){if(this.value==value){this.selected=true;}});break;};});});K.oo('method',"submitData",function(name,value){if(name.charAt(0)=='!'){name=name.substring(1);value=!value;}
this.data.dataset[name]=value;sci.ajax.post(this.data._payload.metaUrl+"/post",{attribute:name,value:value});});K.oo('method',"getFormFieldValue",function(fieldElement){var target=fieldElement;var value=target.value;if($(target).is(":checkbox"))value=target.checked;return value;});K.oo('method',"registerEvents",function(){var self=this;this.jqDialog.click(function(event){var name=event.target.name;if(name){var value=self.getFormFieldValue(event.target);self.submitData(name,value);}});});K.oo('method',"prepareDialog",function(){this.toggleDownloadable();var fields="subscribe,!unlisted";if(sci.auth.isAdmin())fields+=',isDownloadable';var fields=fields.split(",");for(var i=0;i<fields.length;i++){var formFieldName=fields[i];var dataFieldName=formFieldName;if(dataFieldName.charAt(0)=='!'){dataFieldName=dataFieldName.substring(1);}
this.updateFormFieldUI(formFieldName,this.data.dataset[dataFieldName]);}
var whitelist=this.isShowWhiteListLink()?this.htmlCache.whiteListLink():'white list';this.whiteListLink.html(whitelist);});K.oo('method',"setPermissions",function(){var permissions={subscription:this.jqDialog.find('.subscription:checked').val(),unlisted:!this.jqUnlisted[0].checked};this.data.setPermissions(permissions);});K.oo('method',"isShowWhiteListLink",function(){return(this.auth.isDev()||this.auth.isAdmin());});K.oo('method',"e_dataLoaded",function(){this.toggleMenu();});K.oo('method',"e_userLoggedIn",function(){this.toggleMenu();});K.oo('method',"toggleMenu",function(){if(this.data.isOwner()||this.auth.isAdmin()){this.gridMenu.showMenuItem('file > tablePermissions');this.prepareDialog();}else{this.gridMenu.hideMenuItem('file > tablePermissions');}});})(Grid0.TablePermissionsController,Grid0);Grid0.TablePermissionsController.oo('setHTMLCache',{"whiteListLink":function(){return"<a href='\/account\/data?tab=2'>white list<\/a>"},"main":function(){return"<div class='tablePermissionDialog'><ul><li><div class='key accessibility hidden'>Accessibility<\/div><div class='input accessibility hidden'><ul><li><label><input name='isDownloadable' type='checkbox' \/>Downloadable<\/label><\/li><\/ul><\/div><div class='key'>Abuse\/Spam<\/div><div class='input'><ul><li><label><input name='subscribe' type='radio' value='BLACKLIST' \/>This table removes data from known spammers<\/label><\/li><li><label><input id='sub_whitelist' name='subscribe' type='radio' value='WHITELIST' \/>This table only contains data from myself and users on my approved&nbsp;<span class='whiteListLink'>white list<\/span><\/label><\/li><li><label><input name='subscribe' type='radio' value='NONE' \/>This table accepts corrections and new rows from anyone<\/label><\/li><\/ul><\/div><\/li><li><div class='key'>Show this table in search results?<\/div><div class='input'><ul><li><label><input name='!unlisted' type='checkbox' \/>this table will be shown in search results.<\/label><\/li><\/ul><\/div><\/li><\/ul><\/div>"}});JS2.OO.createClass("Grid0.RemoveTableController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth gridMenu');K.oo('method',"showCountdown",function(){var countdown=this.data.datasetCountdown();if(!countdown)return;if(this.data.isOwner()){sci.website.message(this.htmlCache.deletable(countdown));$('.messages #showOwnerHelp').click((function(self){return function(){self.showHelpDialog();}})(this));}else{sci.website.message(this.htmlCache.countdown(countdown));}});K.oo('method',"showHelpDialog",function(){if(!this.helpDialog){var options={modal:true};this.helpDialog=this.util.buildDialog('ownerHelp',this.htmlCache.help(),options);}
this.helpDialog.dialog('open');});K.oo('method',"e_initHTML",function(){this.showCountdown();this.buildDialog();});K.oo('method',"buildDialog",function(){var options={title:'Remove this Table?',modal:true,autoOpen:false,width:300,minWidth:250,resizable:false,buttons:{'Cancel':(function(self){return function(){self.hideDialog();}})(this),'Ok':(function(self){return function(){self.removeTable();self.hideDialog();}})(this)}};this.jq=this.util.buildDialog(this.dialogName,this.htmlCache.main(),options);});K.oo('method',"showDialog",function(){this.jq.dialog('open');});K.oo('method',"hideDialog",function(){this.jq.dialog('close');});K.oo('method',"e_fileMenuClicked",function(name){if(!this.data.deletable())return;if((name=='file > removeTable')){this.showDialog();}});K.oo('method',"removeTable",function(){this.data.removeTable();});K.oo('method',"e_dataLoaded",function(){this.toggleMenu();});K.oo('method',"toggleMenu",function(){if(this.data.deletable()){this.gridMenu.showMenuItem('file > removeTable');}else{this.gridMenu.hideMenuItem('file > removeTable');}});K.oo('method',"e_userLoggedIn",function(){this.showCountdown();this.toggleMenu();});})(Grid0.RemoveTableController,Grid0);Grid0.RemoveTableController.oo('setHTMLCache',{"help":function(){return"<div>* To remove this table, use&nbsp;<i>File -> Remove this Table<\/i><br \/>* To change the licensing terms of this table, use&nbsp;<i>File -> License\/Permissions<\/i><\/div>"},"deletable":function(countdown){return"You may<strong>&nbsp;remove this table&nbsp;<\/strong>or<strong>&nbsp;change its licensing terms&nbsp;<\/strong>within the next&nbsp;<span class='countdown'>"+countdown+"<\/span>.&nbsp;<a id='showOwnerHelp'>How do I do this?<\/a>"},"main":function(){return"<div class='removeTable-dialogAre'>You sure you want to delete this table? This action cannot be undone.<\/div>"},"countdown":function(countdown){return"This is a new table. The owner of this table has the right to<strong>&nbsp;delete&nbsp;<\/strong>or<strong>&nbsp;change the licensing terms&nbsp;<\/strong>for this table for next&nbsp;<span class='countdown'>"+countdown+"<\/span>"}});JS2.OO.createClass("Grid0.AddField");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth gridMenu');K.oo('method',"e_initHTML",function(){this.dialog=new Sci.FieldDialog();this.dialog.onSubmit((function(self){return function(data){self.submit(data);}})(this));});K.oo('method',"submit",function(data){if(this.data.confirmForDBCache())this.data.addField(data);});K.oo('method',"e_fieldsMenuClicked",function(name){if(name=='fields > addField'){this.loadForm();}});K.oo('method',"loadForm",function(){if(this.auth.requireLogin(this))return;var defaultData={datatype:'string',agg:'mode',isHidden:!this.isEditable()};this.dialog.setup('create',false,this.auth);this.dialog.load(defaultData);if(!this.isEditable()){this.dialog.f.visible.control.jqRadios.prop('disabled',true);}});K.oo('method',"isEditable",function(){return(this.data.isOwner()||this.auth.isAdmin());});K.oo('method',"e_dataLoaded",function(){this.toggleMenu();});K.oo('method',"e_userLoggedIn",function(){this.toggleMenu();});K.oo('method',"toggleMenu",function(){if(this.bigData){if(this.isEditable()){this.gridMenu.showMenuItem('fields > addField');}else{this.gridMenu.hideMenuItem('fields > addField');}}else{if(!this.actions.isPkFkJoin()){this.gridMenu.showMenuItem('fields > addField');}else{this.gridMenu.hideMenuItem('fields > addField');}}});})(Grid0.AddField,Grid0);JS2.OO.createClass("Grid0.DeleteField");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','columnMenu header');K.oo('method',"initHTML",function(){this.jqDeleteButton=this.columnMenu.addItem('Delete field','deleteFieldButton');this.jqRemoveButton=this.columnMenu.addItem('Remove field from view','removeFieldFromViewButton');});K.oo('method',"registerEvents",function(){var self=this;this.jqDeleteButton.click(function(){self.deleteField();});this.jqRemoveButton.click(function(){self.removeField();});});K.oo('method',"showColumnMenu",function(){this.col=this.header.contexts.click.col;var deletable=this.fieldsDeletable[this.col.field.id];if(this.col.isPrimary){this.jqRemoveButton.hide();this.jqDeleteButton.hide();return;}
if(this.isView()){this.jqRemoveButton.show();this.jqDeleteButton.hide();}else{if(deletable){this.jqDeleteButton.show();}else{this.jqDeleteButton.hide();}
this.jqRemoveButton.hide();}});K.oo('method',"deleteField",function(){if(!confirm('Are you sure you want to delete "'+this.col.name+'"? This action cannot be undone.'))return;if(!this.data.confirmForDBCache())return;if(this.actions.isGeoUseField(this.col.field.id)&&!this.data.confirmForDisableGeoFunction())return;this.notify('alert','Deleting Field...');var self=this;var url='/tables/main/'+this.col.datasetKey+'/delete_field';var params={'field_id':this.col.id};params._event='DeleteField';params._event_params=JSON.stringify({table_id:this.col.datasetId,field_id:this.col.id});sci.ajax.post(url,params,function(res){self._deleteField(res)});});K.oo('method',"_deleteField",function(res){if(res=='success'){this.notify('deleteField',this.col.id);this.data.reloadGrid();}});K.oo('method',"removeField",function(){if(!confirm('Are you sure you want to delete "'+this.col.name+'"? This action cannot be undone.'))return;if(!this.data.confirmForDBCache())return;if(this.actions.isGeoUseField(this.col.field.id)&&!this.data.confirmForDisableGeoFunction())return;var self=this;var url='/tables/main/'+this.data.dataset.key+'/delete_field_from_view';var params={'field_id':this.col.id};sci.ajax.post(url,params,function(res){self._deleteField(res)});});K.oo('method',"buildColumns",function(cols){this.fieldsDeletable={};for(var i=0,c;c=cols[i];i++){this.fieldsDeletable[c.id]=c.field.isDeletable;}});K.oo('method',"isView",function(){if(this.col.datasetId!=this.data.dataset.id){return true;}else{return false;}});})(Grid0.DeleteField,Grid0);JS2.OO.createClass("Grid0.DeleteFieldEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();this.controller.registerEvents();});K.oo('method',"e_showColumnMenu",function(){this.controller.showColumnMenu()});K.oo('method',"e_buildColumns",function(cols){this.controller.buildColumns(cols);});})(Grid0.DeleteFieldEvents,Grid0);JS2.OO.createClass("Grid0.ReorderFieldsController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth gridMenu');K.oo('member','dialogName','Reorder Fields');K.oo('method',"e_initHTML",function(){this.buildDialog();this.registerEvents();});K.oo('method',"buildDialog",function(){var options={title:'Reorder Field from this Table',modal:true,autoOpen:false,width:320,height:240,minWidth:320,minHeight:240,resizeStop:(function(self){return function(){self.sizeDragSpace();}})(this)};this.jq=this.util.buildDialog(this.dialogName,this.htmlCache.main(),options);this.jqMsg=this.jq.first('.message');this.jqFields=this.jq.first('ul.reorderableFields');this.jqButtons=this.jq.first('.buttons');this.jqApply=this.jqButtons.first('.apply');this.jqCancel=this.jqButtons.first('.cancel');});K.oo('method',"sizeDragSpace",function(){this.jqFields.height(this.jq.height()-this.jqMsg.height()-this.jqButtons.height()-20);});K.oo('method',"buildReorderableFields",function(){this.jqFields.html('');var fields=this.getReorderFields();if(fields.length>1){for(var i=0,f,i__arr=fields,i__len=i__arr.length;(f=i__arr[i])||i<i__len;i++){var field=$(this.htmlCache.field(f.id,DISPLAY.html(f.name)));this.jqFields.append(field);}
this.jqFields.sortable();}else{var msg='Currently, there are not enough fields to reorder.';this.jqFields.html(msg);}});K.oo('method',"getReorderFields",function(){var fields=[];var columns=this.schema.immutable.fields;for(var it42=0,f,it42__arr=columns,it42__len=it42__arr.length;(f=it42__arr[it42])||it42<it42__len;it42++){if(!f.isPrimary&&!this.isVirtual(f))fields.push(f);}
return fields;});K.oo('method',"isVirtual",function(field){var col=this.data.columnById(field.id);return col.datasetId!=this.data.dataset.id;});K.oo('method',"registerEvents",function(){this.jqApply.click((function(self){return function(){self.applyReorder();self.jq.dialog('close');}})(this));this.jqCancel.click((function(self){return function(){self.jq.dialog('close');}})(this));});K.oo('method',"applyReorder",function(){var orders={};this.jqFields.children().each(function(i,o){orders[$(o).attr("fid")]=i;});this.data.reorderFields(orders);});K.oo('method',"showDialog",function(){this.buildReorderableFields();this.jq.dialog('open');});K.oo('method',"e_fieldsMenuClicked",function(name){if(name=='fields > reorderFields'){if(this.auth.loggedIn()){this.showDialog();}else{location.href='/tables/'+this.data.dataset.key+'/fields/add';}}});K.oo('method',"e_dataLoaded",function(){this.toggleMenu();});K.oo('method',"e_userLoggedIn",function(){this.toggleMenu();});K.oo('method',"toggleMenu",function(){if(this.data.reorderable()&&this.getReorderFields().length>1){this.gridMenu.showMenuItem('fields > reorderFields');}else{this.gridMenu.hideMenuItem('fields > reorderFields');}});})(Grid0.ReorderFieldsController,Grid0);Grid0.ReorderFieldsController.oo('setHTMLCache',{"field":function(id,fieldName){return"<li fid='"+id+"'><span class='reorder-icon'><\/span>"+fieldName+"<\/li>"},"main":function(){return"<div class='reorder-dialog'><p class='message'>Drag the fields into the order that you'd like them to appear in the table.<\/p><div class='reorder-container'><ul class='reorderableFields'><\/ul><\/div><div class='buttons'><span class='apply fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Apply      <\/a>    <\/span>  <\/span><\/span><span class='cancel fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Cancel      <\/a>    <\/span>  <\/span><\/span><\/div><\/div>"}});JS2.OO.createClass("Grid0.Filter");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"mainHeader columnMenu");K.oo('method',"initHTML",function(){this.columnMenu.addItem('advanced:','title');this.$addFilter=this.columnMenu.addItem('Filter this field','filter')
this.initFilterApp();});K.oo('method',"initFilterApp",function(){var $seed=this.mainHeader.addFilterMenu(this.htmlCache.main());this.filterApp=APP(Grid0Filter,{seed:$seed,grid0:this.main});this.filterApp.start();});K.oo('method',"registerEvents",function(){this.$addFilter.click((function(self){return function(){self.newColumnFilterFromColumnMenu();}})(this));});K.oo('method',"newColumnFilterFromColumnMenu",function(){var columnId=this.columnMenu.context.col.id;this.filterApp.newColumnFilterFromColumnMenu(columnId);});K.oo('method',"addSearchQuery",function(query){if(this.actions.isFulltextSearchEnabled()){this.filterApp.addFulltextSearchQuery(query);}else{this.filterApp.addSearchQuery(query);}});K.oo('method',"setBigData",function(bigData){this.filterApp.setBigData(bigData);});K.oo('method',"dataLoaded",function(){this.filterApp.dataLoaded();});K.oo('method',"userLoggedIn",function(){this.filterApp.userLoggedIn();});K.oo('method',"resizing",function(){if(this.filterApp)this.filterApp.resize();});K.oo('method',"highlightCell",function(context){if(context)this.columnIdx=context.col.id;});})(Grid0.Filter,Grid0);JS2.OO.createClass("Grid0.FilterEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();this.controller.registerEvents();});K.oo('method',"e_addSearchQuery",function(query){this.controller.addSearchQuery(query);});K.oo('method',"e_bigData",function(bigData){this.controller.setBigData(bigData);});K.oo('method',"e_dataLoaded",function(){this.controller.dataLoaded();});K.oo('method',"e_userLoggedIn",function(){this.controller.userLoggedIn();});K.oo('method',"e_resizing",function(){this.controller.resizing();});K.oo('method',"e_highlightCell",function(context){this.controller.highlightCell(context);});})(Grid0.FilterEvents,Grid0);Grid0.Filter.oo('setHTMLCache',{"main":function(){return"<div class='filterUniverse'><\/div>"}});JS2.OO.createClass("Grid0Filter.Main");Grid0Filter.Main.oo('extends',JS2.Main);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','components',['Data','Tray','FilterForm','GeoForm','GeoFunctionDialog','QueryForm']);K.oo('member','core',['Data']);K.oo('member','dependencies','tray');K.oo('method',"initialize",function(options){this.grid0=options.grid0;_super(this);});K.oo('method',"e_start",function(){var dict=new Grid0Filter.Dict();this.assign('dict',dict);this.assign('grid0',this.grid0);this.notify('initHTML');});K.oo('method',"e_initHTML",function(){this.initHTML();this.registerEvents();});K.oo('method',"initHTML",function(){this.jq=$(this.htmlCache.main());this.seed.jq.prepend(this.jq);this.seed.setSeed(this.jq);});K.oo('method',"registerEvents",function(){$(window).keyup((function(self){return function(e){if(e.keyCode==KEYCODE.ESC){self.notify('hideAllFilterForm');}}})(this));});K.oo('method',"newColumnFilterFromColumnMenu",function(columnId){this.notify('newColumnFilterFromColumnMenu',columnId);});K.oo('method',"addSearchQuery",function(query){this.data.addSearchQuery(query);});K.oo('method',"addFulltextSearchQuery",function(query){this.data.addFulltextSearchQuery(query);});K.oo('method',"dataLoaded",function(){this.notify('dataLoaded');});K.oo('method',"resize",function(){this.notify('resize');});K.oo('method',"setBigData",function(bigData){this.assign('bigData',bigData);});K.oo('method',"userLoggedIn",function(){this.notify('userLoggedIn');});})(Grid0Filter.Main,Grid0Filter);Grid0Filter.Main.oo('setHTMLCache',{"main":function(){return"<div class='filterTrayContainer'><ol class='filterTray'><\/ol><div class='clear'><\/div><\/div>"}});JS2.OO.createClass("Grid0Filter.Data");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){this.schema=options.grid0.schema;this.datatypes=sci.constants.datatypes;this.filterAttrs={summary:sci.constants.rowFilterAttributes,vote:sci.constants.voteFilterAttributes}
this.FILTER_TYPE={"Qlisp::Action::RowFilter":'summary',"Qlisp::Action::VoteFilter":'vote'};this.summaryFilters=[];this.voteFilters=[];this.searchQueries=[];this.geoFunction=null;});K.oo('method',"e_dataLoaded",function(){this.summaryFilters=this.grid0.rowFilters();this.voteFilters=this.grid0.voteFilters();this.searchQueries=this.grid0.searchQueries();this.geoFunction=this.grid0.geoFunction();this.geoSort=null;this.geoFilters=[];if(this.geoFunction){this.geoSort=this.geoFunction.geoSort;this.geoFilters=this.geoFunction.geoFilters||[];}});K.oo('method',"e_alert",function(message){this.grid0.notify('alert',message);});K.oo('method',"hasFilters",function(){return!(this.summaryFilters.length==0&&this.voteFilters.length==0&&this.searchQueries.length==0&&!this.geoSort&&this.geoFilters.length==0);});K.oo('method',"applyFilters",function(options){this.grid0.applyFilters(this.summaryFilters,this.voteFilters,options);this.grid0.notify('actionsModified');});K.oo('method',"applySearchQueries",function(){this.grid0.applySearchQueries(this.searchQueries);this.grid0.notify('actionsModified');});K.oo('method',"applyGeoFunction",function(){this.geoFunction.geoSort=this.geoSort;this.geoFunction.geoFilters=this.geoFilters;this.grid0.applyGeoFunction(this.geoFunction);this.grid0.notify('actionsModified');});K.oo('method',"modifyFilter",function(){this.notify('alert','Applying Filter...');this.applyFilters();});K.oo('method',"addSearchQuery",function(query){this.searchQueries.push(query);this.notify('alert','Searching...');this.applySearchQueries();});K.oo('method',"addFulltextSearchQuery",function(query){this.searchQueries=[query];this.notify('alert','Searching...');this.applySearchQueries();});K.oo('method',"addFilter",function(filterType,filter){var options={};var filterDescription=this.filterDescription(filter);switch(filterType){case'summary':options._event='AddRowFilter';options._event_params=JSON.stringify({filter_description:filterDescription});this.summaryFilters.push(filter);break;case'vote':options._event='AddInputFilter';options._event_params=JSON.stringify({filter_description:filterDescription});this.voteFilters.push(filter);break;default:};this.notify('alert','Applying Filter...');this.applyFilters(options);});K.oo('method',"deleteFqrFilter",function(){this.grid0.notify('applyFqr',false);});K.oo('method',"deleteFilter",function(filterType,idx){var options={};switch(filterType){case'summary':var filter=this.summaryFilters.splice(idx,1)[0];var filterDescription=this.filterDescription(filter);options._event='RemoveRowFilter';options._event_params=JSON.stringify({filter_description:filterDescription});break;case'vote':var filter=this.voteFilters.splice(idx,1)[0];var filterDescription=this.filterDescription(filter);options._event='RemoveInputFilter';options._event_params=JSON.stringify({filter_description:filterDescription});break;default:};if(this.hasFilters()){this.notify('alert','Removing Filter...');}else{this.notify('alert','Clearing Filter...');}
this.applyFilters(options);});K.oo('method',"deleteSearchQuery",function(idx){this.searchQueries.splice(idx,1);this.applySearchQueries();this.grid0.clearSearchContent();this.notify('alert','Clearing Search...');});K.oo('method',"deleteGeoSort",function(){this.geoSort=null;this.applyGeoFunction();this.notify('alert','Clearing Geo Filter...');});K.oo('method',"deleteGeoFilter",function(idx){this.geoFilters.splice(idx,1);this.applyGeoFunction();this.notify('alert','Clearing Geo Filter...');});K.oo('method',"filterDescription",function(filter){var options=this.descOptions(filter);var tagRe=new RegExp("<[a-z/]+>","g");var subject=options.name.replace(tagRe,'');var operator=options.operator.replace(tagRe,'');var attribute=options.attribute.replace(tagRe,'');var value=options.value;return subject+' '+attribute+' '+operator+' '+value;});K.oo('method',"descOptions",function(filter,index){var descHash={};var dt=this.getDatatype(filter);var filterType=filter.filterType||this.FILTER_TYPE[filter._rclass];descHash.filterType=filterType;if(filter.type=='field'){var colIdx=this.schema.columnIdxById(filter.fieldId);descHash.name=this.schema.column(colIdx).name;}else{descHash.name=this.dict[filterType].cols[filter.type];}
var attrs=this.dict[filterType].attrs[filter.type];descHash.attribute=attrs[this.getAttributeVerbiage(filter)];var operator=this.getOperator(filter,dt);if(operator){descHash.operator=this.dict.datatypes[dt.name][operator.verbiage];}else{descHash.operator=this.dict.allOperatorDescs[filter.operator];}
descHash.value=DISPLAY.html(this.getFilterValue(filter,operator));if(index!==undefined){descHash.head=index?'and':'Where';}
return descHash;});K.oo('method',"getDatatype",function(filter){var filterType=filter.filterType||this.FILTER_TYPE[filter._rclass];var attrs=this.filterAttrs[filterType][filter.type];for(var i=0,attr;attr=attrs[i];i++){if(attr.id==filter.attribute){var datatype=attr.datatype;if(!datatype&&filter.type=='subject'){var pks=this.grid0.data.pks();if(pks.length==1)datatype=pks[0].datatype;}
if(!datatype){var colIdx=this.grid0.columnIdxById(filter.fieldId);var column=this.grid0.column(colIdx);datatype=column?column.datatype:'String';}
return this.datatypes[datatype];}}});K.oo('method',"getAttributeVerbiage",function(filter){return filter.attribute.replace(/[\-\_]+(.)?/g,function(match,c){return(c||'').toUpperCase()});});K.oo('method',"getOperator",function(filter,dt){for(var i=0,o;o=dt.operatorOptions[i];i++){if(o.id==filter.operator||o.verbiage==filter.operator)return o;}});K.oo('method',"getFilterValue",function(filter,operator){var value='';if(operator&&(operator.value||operator.value==0)){if(operator.value instanceof Array){for(var i=0,v;v=operator.value[i];i++){if(v.id==filter.value){value=v.viewName.toLowerCase();break;}}}}else{value=filter.value;}
return DISPLAY.trim(value);});K.oo('method',"initGeoFunction",function(lat,lng){this.geoFunction={_rclass:"Qlisp::Action::GeoFunction",latFieldId:lat,lngFieldId:lng,geoSort:null,geoFilters:[]};this.grid0.initGeoFunction(this.geoFunction);});K.oo('method',"setGeoSort",function(geoSort){this.geoSort=geoSort
this.notify('alert','Applying Geo Filter...');this.notify('geoSortSet',geoSort);this.applyGeoFunction();});K.oo('method',"addGeoFilter",function(geoFilter){this.geoFilters.push(geoFilter);this.notify('alert','Applying Geo Filter...');this.notify('geoFilterAdded',geoFilter);this.applyGeoFunction();});K.oo('method',"clearAllFilters",function(){this.notify('alert','Removing All Filters...');this.grid0.clearAllFilters();});K.oo('method',"updateGeoFilter",function(index,geoFilter){this.geoFilters[index]=geoFilter;this.notify('alert','Updating Geo Filter...');this.applyGeoFunction();});K.oo('method',"confirmForDBCache",function(){return this.grid0.data.confirmForDBCache();});K.oo('method',"updateQuery",function(index,value){this.searchQueries[index].value=value;this.applySearchQueries();this.notify('alert','Updating Search...');});})(Grid0Filter.Data,Grid0Filter);JS2.OO.createClass("Grid0Filter.Dict");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(){this.buildDatatypesDict();this.buildSummaryDict();this.buildVoteDict();});K.oo('method',"buildDatatypesDict",function(){this.datatypes={Date:{'is-on':'is <strong>on</strong>','is-not-on':'is <strong>not on</strong>','before':'<strong>before</strong>','after':'<strong>after</strong>'},String:{'contains':'<strong>contains</strong>','contains-in':'<strong>contains any of</strong>','eqp':'<strong>equal</strong> to','eqp-in':'<strong>equal</strong> to <strong>any of</strong>','not-equals':'<strong>not equal</strong> to','starts-with':'<strong>starts with</strong>','starts-within':'<strong>starts with any of</strong>','ends-with':'<strong>ends with</strong>','ends-within':'<strong>ends with any of</strong>','blank':'is <strong>blank</strong>','not-blank':'is <strong>not blank</strong>'},Integer:{'equals':'<strong>equal</strong> to','equals-in':'<strong>equal</strong> to <strong>any of</strong>','not-equals':'<strong>not equal</strong> to','smaller-than':'<strong>less</strong> than','bigger-than':'<strong>greater</strong> than'},Numeric:{'equals':'<strong>equal</strong> to','equals-in':'<strong>equal</strong> to <strong>any of</strong>','not-equals':'<strong>not equal</strong> to','smaller-than':'<strong>less</strong> than','bigger-than':'<strong>greater</strong> than','blank':'is <strong>blank</strong>','not-blank':'is <strong>not blank</strong>'},Strength:{'debated':'is <b>debated.</b>','ndebated':'is <b>not debated.</b>','eq':'<strong>equal</strong> to','neq':'<strong>not equal</strong> to','smaller':'<strong>less</strong> than','bigger':'<strong>greater</strong> than'},GarbageCount:{'more':'by more than','less':'by less than'},IsGarbage:{'eq':'was flagged as Garbage','neq':'was not flagged as Garbage'},Table:{'eq':'<strong>with</strong> the <strong>table ID</strong>','neq':'<strong>without</strong> the <strong>table ID</strong>','from':'came from <strong>this table</strong>','notFrom':'<strong>not</strong> came from <strong>this table</strong>'},Text:{'contains':'<strong>contains</strong>','notContains':'<strong>not contains</strong>','blank':'is <strong>blank</strong>','notBlank':'is <strong>not blank</strong>'},VotingUser:{'contains':'<strong>contains</strong>','eq':'<strong>equal</strong> to','neq':'<strong>not equal</strong> to','starts':'<strong>starts with</strong>','ends':'<strong>ends with</strong>','me':'is <strong>me</strong>','notMe':'is <strong>not me</strong>','active':'is an <strong>active user</strong>','notActive':'is <strong>no longer an active user</strong>'},Time:{'before':'before timestamp'}};this.datatypes['Link']=this.datatypes['String'];this.datatypes['PhoneNumber']=this.datatypes['String'];this.datatypes['ZipCode']=this.datatypes['String'];this.datatypes['UUID']=this.datatypes['String'];this.datatypes['Lat']=this.datatypes['Numeric'];this.datatypes['Lng']=this.datatypes['Numeric'];this.allOperatorDescs={'on':'is <strong>on</strong>','not-on':'is <strong>not on</strong>','before':'<strong>before</strong>','after':'<strong>after</strong>','eq':'<strong>equal</strong> to','eq-in':'<strong>equal</strong> to <strong>any of</strong>','neq':'<strong>equal</strong> to <strong>any of</strong>','<':'<strong>less</strong> than','>':'<strong>greater</strong> than','blank':'is <strong>blank</strong>','nblank':'is <strong>not blank</strong>','contains':'<strong>contains</strong>','contains-in':'<strong>contains any of</strong>','eqp':'<strong>equal</strong> to','eqp-in':'<strong>equal</strong> to <strong>any of</strong>','neqp':'<strong>equal</strong> to <strong>any of</strong>','starts':'<strong>starts with</strong>','starts-in':'<strong>starts with any of</strong>','ends':'<strong>ends with</strong>','ends-in':'<strong>ends with any of</strong>'}});K.oo('method',"buildSummaryDict",function(){this.summary={cols:{fact:"any <strong>fact</strong>",subject:"any <strong>subject</strong>",table:"any <strong>subject</strong> or <strong>fact</strong>",geo:"<strong>geographic location</strong>"},attrs:{fact:{consensusValue:"has a <strong>consensus value</strong>",strength:"has a <strong>level of consensus</strong>",voteCount:"has a <strong>total number of inputs</strong>","!voteCount":"",uniqueVotes:"has a <strong>number of counted inputs</strong>"},subject:{consensusValue:"has a <strong>label</strong>",garbageCount:"was flagged as <strong>garbage</strong>"},table:{consensusValue:"has a <strong>label</strong> or <strong>consensus</strong> value",strength:"has a <strong>level of consensus</strong>",voteCount:"has a <strong>total number of inputs</strong>","!voteCount":"",uniqueVotes:"has a <strong>number of counted inputs</strong>"},field:{consensusValue:"has a <strong>consensus value</strong>",strength:"has a <strong>level of consensus</strong>",voteCount:"has a <strong>total number of inputs</strong>","!voteCount":"",uniqueVotes:"has a <strong>number of counted inputs</strong>"}}};});K.oo('method',"buildVoteDict",function(){var voteBaseAttrs={value:"<strong>input value</strong>",userId:"contributing <strong>username</strong>",comments:"<strong>comment</strong>",source:"source <strong>citation</strong>",date:"<strong>input date</strong>",sourceDataset:"came from <strong>table</strong>",subject:"<strong>input value</strong>",timestamp:"timestamp"};this.vote={cols:{fact:"any <strong>input</strong> to a <strong>fact's</strong>"},attrs:{fact:voteBaseAttrs,field:voteBaseAttrs}};});})(Grid0Filter.Dict,Grid0Filter);JS2.OO.createClass("Grid0Filter.Tray");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','PLACE_HOLDER_WIDTH',218);K.oo('method',"initHTML",function(){this.$root=this.seed.first('.filterTray');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"filtertray",this.$root,null);this.$root.html(this.htmlCache.main());this.$menuSearch=this.$root.first('.menuItem.search');var searchinput=this.$menuSearch.first('input');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"searchinput",searchinput,null);this.$menuGeo=this.$root.first('.menuItem.geo');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"geofilter",this.$menuGeo,null);this.$menuColumn=this.$root.first('.menuItem.column');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"rowfilter",this.$menuColumn,null);this.$menuVote=this.$root.first('.menuItem.vote');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"votefilter",this.$menuVote,null);this.$menuClearAll=this.$root.first('.menuItem.clearAll');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"clearall",this.$menuClearAll,null);this.grid0.setSearchContainer(this.$menuSearch);});K.oo('method',"registerEvents",function(){this.$menuGeo.click((function(self){return function(){self.newGeoFilter();}})(this));this.$menuColumn.click((function(self){return function(){self.newColumnFilter();}})(this));this.$menuVote.click((function(self){return function(){self.newVoteFilter();}})(this));this.$menuClearAll.click((function(self){return function(){self.clearAllFilters();}})(this));this.$root.delegate('li.filter .edit','click',(function(self){return function(){self.editFilter(this);}})(this));this.$root.delegate('li.filter .delete','click',(function(self){return function(){self.deleteFilter(this);}})(this));});K.oo('method',"newGeoFilter",function(){this.showPlaceHolderBefore(this.$menuGeo);this.notify('newFilter','geo',this.getPlaceHolderPosition());this.notify('populateGeoForm');});K.oo('method',"newColumnFilter",function(){this.showPlaceHolderBefore(this.$menuColumn);this.notify('newFilter','summary',this.getPlaceHolderPosition());this.notify('showColumnSb',false);});K.oo('method',"newColumnFilterFromColumnMenu",function(columnId){this.newColumnFilter();this.notify('showColumnSb',true);this.notify('selectColumnSb',columnId);});K.oo('method',"newVoteFilter",function(){this.showPlaceHolderBefore(this.$menuVote);this.notify('newFilter','vote',this.getPlaceHolderPosition());this.notify('showColumnSb',false);});K.oo('method',"clearAllFilters",function(){this.data.clearAllFilters();});K.oo('method',"editFilter",function(ele){var $filter=$(ele).closest('li');var filterInfo=this.getFilterInfo($filter);this.notify('editFilter',filterInfo,$filter);});K.oo('method',"deleteFilter",function(ele){var $filter=$(ele).closest('li');var filterInfo=this.getFilterInfo($filter);if(filterInfo.filterType=='query'){this.data.deleteSearchQuery(filterInfo.index);}else if(filterInfo.filterType=='geoSort'){this.data.deleteGeoSort();}else if(filterInfo.filterType=='geoFilter'){this.data.deleteGeoFilter(filterInfo.index);}else{this.data.deleteFilter(filterInfo.filterType,filterInfo.index);}});K.oo('method',"getFilterInfo",function($filter){var filterType,selector;if($filter.hasClass('search')){filterType='query';selector='.filter.search';}else if($filter.hasClass('geo')){filterType='geoFilter';selector='.filter.geo';}else if($filter.hasClass('column')){filterType='summary';selector='.filter.column';}else if($filter.hasClass('vote')){filterType='vote';selector='.filter.vote';}
var index=$filter.prevAll(selector).size();return{filterType:filterType,index:index};});K.oo('method',"dataLoaded",function(){this.removeAllFiltersInTray();for(var it81=0,q,it81__arr=this.data.searchQueries,it81__len=it81__arr.length;(q=it81__arr[it81])||it81<it81__len;it81++){this.addSearchFilter(q);}
for(var it82=0,f,it82__arr=this.data.geoFilters,it82__len=it82__arr.length;(f=it82__arr[it82])||it82<it82__len;it82++){this.addGeoFilter(f);}
for(var i=0,f,i__arr=this.data.summaryFilters,i__len=i__arr.length;(f=i__arr[i])||i<i__len;i++){this.addColumnFilter(f,i);}
for(var i=0,f,i__arr=this.data.voteFilters,i__len=i__arr.length;(f=i__arr[i])||i<i__len;i++){this.addVoteFilter(f,i);}
this.toggleMenus();});K.oo('method',"removeAllFiltersInTray",function(){this.$root.find('>li.filter').remove();});K.oo('method',"addSearchFilter",function(search){var $filter=$(this.htmlCache.search({operator:search.operator,value:DISPLAY.html(search.value)}));$filter.insertBefore(this.$menuSearch);});K.oo('method',"addGeoFilter",function(filter){var $filter=$(this.htmlCache.geoFilter());$filter.insertBefore(this.$menuGeo);this.$menuGeo.hide();});K.oo('method',"addColumnFilter",function(filter,index){var params=this.data.descOptions(filter,index)
var $filter=$(this.htmlCache.columnFilter(params));$filter.insertBefore(this.$menuColumn);});K.oo('method',"addVoteFilter",function(filter,index){var params=this.data.descOptions(filter,index)
var $filter=$(this.htmlCache.voteFilter(params));$filter.insertBefore(this.$menuVote);});K.oo('method',"toggleMenus",function(){var auth=this.grid0.auth;var isAdmin=auth.isAdmin();var bigData=this.grid0.bigData;var data=this.grid0.data;var actions=this.grid0.actions;var isFulltextSearchEnabled=actions.isFulltextSearchEnabled();var isGeoStateReady=data.isGeoStateReady();var hasGeoFilter=actions.hasGeoFilter();if(bigData&&!isAdmin&&!isFulltextSearchEnabled){this.$menuSearch.hide();}else{if(this.data.searchQueries.length){this.$menuSearch.hide();}else{this.$menuSearch.show();}}
if(!isGeoStateReady){this.$menuGeo.hide();}else{if(this.data.geoFilters.length){this.$menuGeo.hide();}else{this.$menuGeo.show();}}
if(isAdmin){this.$menuVote.show();}else{this.$menuVote.hide();}
if(this.data.hasFilters()){this.$menuClearAll.show();}else{this.$menuClearAll.hide();}});K.oo('method',"isVoteFilter",function(filter){return filter.filterType=="vote"||filter._rclass=="Qlisp::Action::VoteFilter";});K.oo('method',"getPlaceHolder",function(){if(!this.$placeHolder){this.$placeHolder=$(this.htmlCache.placeHolder())
this.$placeHolder.width(this.PLACE_HOLDER_WIDTH);}
return this.$placeHolder;});K.oo('method',"showPlaceHolderBefore",function($target){var $placeHolder=this.getPlaceHolder();$placeHolder.insertBefore($target)
$placeHolder.show();});K.oo('method',"hidePlaceHolder",function(){var $placeHolder=this.getPlaceHolder();$placeHolder.hide();});K.oo('method',"getPlaceHolderPosition",function(){return this.getPlaceHolder().position();});K.oo('method',"getTrayContainer",function(type){return this.jq.first("ol."+type+"FilterTrayContainer");});})(Grid0Filter.Tray,Grid0Filter);JS2.OO.createClass("Grid0Filter.TrayEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();this.controller.registerEvents();});K.oo('method',"e_setFilters",function(filters){this.controller.setFilters(filters);});K.oo('method',"e_dataLoaded",function(){this.controller.dataLoaded();});K.oo('method',"e_filterFormClosed",function(){this.controller.hidePlaceHolder();});K.oo('method',"e_editFilter",function(){this.controller.hidePlaceHolder();});K.oo('method',"e_newColumnFilterFromColumnMenu",function(columnId){this.controller.newColumnFilterFromColumnMenu(columnId);});K.oo('method',"e_userLoggedIn",function(){this.controller.toggleMenus();});})(Grid0Filter.TrayEvents,Grid0Filter);Grid0Filter.Tray.oo('setHTMLCache',{"geoFilter":function(){return"<li class='filter geo'><span class='delete'><\/span><label>Near<\/label><a class='edit'>Location<\/a><\/li>"},"columnFilter":function(filter){return"<li class='filter column'><span class='delete'><\/span><span>"+filter.head+" <\/span><a class='edit'><span class='name'>"+filter.name+" <\/span><span class='operator'>"+filter.operator+" <\/span><span class='value'>"+filter.value+"<\/span><\/a><\/li>"},"voteFilter":function(filter){return"<li class='filter vote'><span class='delete'><\/span><span class='name'>"+filter.name+" <\/span><span class='value'>"+filter.attribute+" <\/span><a class='edit'><span class='operator'>"+filter.operator+" <\/span><span class='value'>"+filter.value+"<\/span><\/a><\/li>"},"main":function(){return"<li class='menuItem search'><\/li><li class='menuItem geo'><span class='icon'><\/span><a>Show Data Near<\/a><\/li><li class='menuItem column'><span class='icon'><\/span><a>Filter by Column<\/a><\/li><li class='menuItem vote'><span class='icon'><\/span><a>Filter by Vote<\/a><\/li><li class='menuItem clearAll'><span class='icon'><\/span><a>Clear all<\/a><\/li>"},"placeHolder":function(){return"<li class='filter placeHolder'><\/li>"},"search":function(search){return"<li class='filter search'><span class='delete'><\/span><label>Find<\/label><a class='edit'>"+search.value+"<\/a><\/li>"}});JS2.OO.createClass("Grid0Filter.FilterFormController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"registerEvents",function(){var self=this;this.view.jqForm.cancel.click(function(){self.hide();});this.view.jqForm.submit.click(function(){self.submit();});this.view.jqForm.value.keydown(function(e){if(e.keyCode==KEYCODE.ENTER){self.submit();}});});K.oo('method',"newFilter",function(type,position){this.showFilterForm(type,null,position);});K.oo('method',"showGeoFilterForm",function(filterType,index,jq){var geo=null;if(filterType=='geoFilter'){geo=this.data.geoFilters[index];}else{geo=this.data.geoSort;}
this.showFilterForm('geo',null,jq);this.notify('populateGeoForm',geo,index);});K.oo('method',"showQueryForm",function(index,jq){var query=this.data.searchQueries[index];this.showFilterForm('summary',null,jq);this.view.jqQuery.show();this.view.jqNormal.hide();this.view.jqGeo.hide();this.notify('populateQueryForm',query,index);});K.oo('method',"showFilterForm",function(filterType,index,jq){if(filterType=='geo'){this.setFilterType('summary');}else{this.setFilterType(filterType);try{this.filter=this.data[filterType+'Filters'][index];}catch(err){this.filter=null;}
this.view.populateForm(this.filter,filterType);}
this.view.show(jq);});K.oo('method',"setFilterType",function(filterType){this.filterType=filterType;this.view.filterType=filterType;});K.oo('method',"submit",function(){if(!this.view.validate()){alert('filter value invalid!');return;}
if(this.filterType=='vote'&&!this.data.confirmForDBCache())return;if(this.filter){this.view.populateFilter(this.filter);this.data.modifyFilter();}else{var filter={filterType:this.filterType}
this.view.populateFilter(filter);this.data.addFilter(this.filterType,filter);}
this.hide();});K.oo('method',"hide",function(){this.view.hide();});K.oo('method',"editFilter",function(filterInfo,jq){var filterType=filterInfo.filterType;var index=filterInfo.index;if(filterType.match(/^geo.*$/)){this.showGeoFilterForm(filterType,index,jq);}else if(filterType.match(/^query$/)){this.showQueryForm(index,jq)}else{this.showFilterForm(filterType,index,jq);}
this.view.showColumnSb(true);});})(Grid0Filter.FilterFormController,Grid0Filter);JS2.OO.createClass("Grid0Filter.FilterFormView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','tray');K.oo('member','FILTER_FORM_MARGIN_RIGHT',32);K.oo('member','FILTER_HEADERS',{summary:'Include ONLY data where:',vote:'Include ONLY inputs where:',geo:'Only show rows within:'});K.oo('method',"initHTML",function(){this.jq=$(this.htmlCache.main()).hide();var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"form",this.jq,null);this.seed.append(this.jq);this.jqNormal=this.jq.first('.normal');this.jqGeo=this.jq.first('.geo').hide();this.jqQuery=this.jq.first('.query').hide();this.jqForm={column:this.jq.first('.column'),attribute:this.jqNormal.first('.attribute'),operator:this.jqNormal.first('.operator'),value:this.jqNormal.first('.value>input').toggleInput(),enums:this.jqNormal.first('.enums'),inclusiveDiv:this.jqNormal.first('.inclusive'),inclusive:this.jqNormal.first('.inclusive>input'),cancel:this.jqNormal.first('.cancel'),submit:this.jqNormal.first('.submit')};var jqFormTitle=this.jq.first('h5');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"title",jqFormTitle,null);var jqFormValue=this.jqForm.value;var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"value",jqFormValue,null);var jqFormSubmit=this.jqForm.submit;var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"submit",jqFormSubmit,null);this.jqForm['column'];var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"column",this.jqForm['column'],null);this.jqForm['attribute'];var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"attribute",this.jqForm['attribute'],null);this.jqForm['operator'];var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"operator",this.jqForm['operator'],null);this.jqForm['value'];var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"value",this.jqForm['value'],null);this.jqForm['submit'];var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"submit",this.jqForm['submit'],null);this.buildSelectBoxs();var jqSelectBox=this.jqForm['inclusive'].find('input.inclusive')
var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"inclusive",jqSelectBox,null);this.jqHeader=this.jq.first('h5');});K.oo('method',"buildSelectBoxs",function(){var self=this;this.columnSb=new Sci.SelectBox(this.jqForm.column,{selChangeCallBack:function(){self.columnSbChanged();}});this.attributeSb=new Sci.SelectBox(this.jqForm.attribute,{selChangeCallBack:function(){self.populateOperator();}});this.operatorSb=new Sci.SelectBox(this.jqForm.operator,{selChangeCallBack:function(){self.toggleInclusive();self.toggleValue(this.value());}});this.jqColumn=$('<div class="filterColumn" />')
this.jqForm.column.append(this.jqColumn);});K.oo('method',"columnSbChanged",function(){var colIdx=this.grid0.columnIdxById(this.columnSb.value());this.currentColumn=this.grid0.column(colIdx);this.populateAttribute(this.columnSb.value());this.populateSimpleForm(this.columnSb.value());});K.oo('method',"show",function(jq){if(jq){if(jq.jquery){this.jq.css(jq.position());}else{this.jq.css(jq);}}else{this.jq.css({top:0,left:0});}
if(this.filterType=='summary'){this.jq.removeClass('vote');this.jq.addClass('summary');}else{this.jq.removeClass('summary');this.jq.addClass('vote');}
this.jq.show();this.jqGeo.hide();this.jqQuery.hide();this.fixFilterFormPosition();setTimeout((function(self){return function(){self.jqForm.value.focus();}})(this),0);});K.oo('method',"fixFilterFormPosition",function(){var formWidth=this.jq.width()+this.FILTER_FORM_MARGIN_RIGHT;var rightBoundary=formWidth+this.jq.position().left;var gridWidth=this.grid0.dim.grid.width;if(rightBoundary>gridWidth){this.jq.css('left',gridWidth-formWidth);}});K.oo('method',"hide",function(){if(this.jq.is(':hidden'))return;this.jq.hide();this.notify('filterFormClosed');});K.oo('method',"populateForm",function(filter,filterType){this.populateColumnSelectBox();this.jqHeader.html(this.FILTER_HEADERS[filterType]);if(filter){if(filter.type=='field'){this.columnSb.selectValue(filter.fieldId);}else{if(this.bigData){this.selectFirstInColumnSb();this.jqQuery.hide();this.jqNormal.show();return;}else{this.columnSb.selectValue(filter.type);}}
this.attributeSb.selectValue(filter.attribute);this.operatorSb.selectValue(filter.operator);this.jqForm.value.toggleInput('val',filter.value);this.jqForm.submit.first('a').html('Done');}else{this.selectFirstInColumnSb();this.jqForm.value.toggleInput('val','');this.jqForm.submit.first('a').html('Add');}
this.jqQuery.hide();this.jqNormal.show();});K.oo('method',"getDatatype",function(){var attrs=this.data.filterAttrs[this.filterType][this.getFilterSubType()];var idx=this.filterType=='vote'?this.attributeSb.selectedIndex()+1:this.attributeSb.selectedIndex();var datatype=attrs[idx].datatype;if(!datatype&&this.getFilterSubType()=='subject'){var pks=this.grid0.data.pks();if(pks.length==1)datatype=pks[0].datatype;}
if(!datatype){datatype=this.currentColumn?this.currentColumn.datatype:'String';}
return this.data.datatypes[datatype];});K.oo('method',"getFilterSubType",function(){var value=this.columnSb.value();if(value=='fact'||value=='subject'||value=='table'){return value;}
return'field';});K.oo('method',"getItemClass",function(item){if(item.viewName&&item.viewName.match(/^!.*/)){return'hidden';}
if(item.id.match(/^!.*/)){return'disabled';}});K.oo('method',"populateColumnSelectBox",function(){this.columnSb.clear();var columns=this.grid0.columns();for(var i=0,col;col=columns[i];i++){if(col.hidden)continue;if(col.isPrimary&&this.filterType=='vote')continue;this.columnSb.addItem(col.id,col.name);}});K.oo('method',"selectFirstInColumnSb",function(){var firstIndex=0;var columns=this.grid0.columns();for(var i=0,column,i__arr=columns,i__len=i__arr.length;(column=i__arr[i])||i<i__len;i++){if(column.datatype=='UUID'){firstIndex++;}else{break;}}
this.columnSb.selectIndex(firstIndex);});K.oo('method',"populateAttribute",function(){var attrs=this.data.filterAttrs[this.filterType][this.getFilterSubType()];this.attributeSb.clear();for(var i=0,attr;attr=attrs[i];i++){if(attr.id!='value'){var html=this.dict[this.filterType]['attrs'][this.getFilterSubType()][attr.viewName];var style=this.getItemClass(attr);this.attributeSb.addItem(attr.id,html,style);}}
this.attributeSb.selectIndex(0);});K.oo('method',"populateOperator",function(){var dt=this.getDatatype();var operators=dt.operatorOptions;var noIncludeMe=this.noIncludeMe(dt);this.operatorsHash={};this.operatorSb.clear();for(var i=0,len=operators.length;i<len;i++){var op=operators[i];if(noIncludeMe&&op.value=='me')continue;if(this.bigData&&!this.grid0.auth.isAdmin()){if(op.verbiage=='is-on'||op.verbiage=='is-not-on'||op.verbiage=='ends-with'||op.verbiage=='ends-within'||op.verbiage=='contains'||op.verbiage=='contains-in'){continue;}}
if(!this.grid0.auth.isAdmin()){if(op.verbiage=='contains-in'||op.verbiage=='starts-within'||op.verbiage=='ends-within'){continue;}}
if(this.isValueOnVoteFilter()){if(op.id=='blank'||op.id=='nblank'){continue;}}
if(this.continueByStrength(dt,op))continue;var html=this.dict.datatypes[dt.name][op.verbiage];var style=this.getItemClass(op);if(style=='disabled')continue;this.operatorSb.addItem(operators[i].id,html,style);this.operatorsHash[op.id]=op;}
if(noIncludeMe){this.operatorSb.selectIndex(1);}else{this.operatorSb.selectIndex(0);}
if('starts'in this.operatorsHash)this.operatorSb.selectValue('starts');var thisOp=this.operatorSb.value();if(this.operatorsHash[thisOp].inclusive){this.jqForm.inclusive.show();}else{this.jqForm.inclusive.prop('checked',true);this.jqForm.inclusiveDiv.hide();}});K.oo('method',"continueByStrength",function(datatype,operator){if(datatype.name=='Strength'){var isAdmin=this.grid0.auth.isAdmin();var isDev=this.grid0.auth.isDev();if(!(isAdmin||isDev)&&!(operator.id=='debated'||operator.id=='ndebated')){return true;}}
return false;});K.oo('method',"isValueOnVoteFilter",function(){return this.filterType=='vote'&&this.attributeSb.value()=='value';});K.oo('method',"toggleInclusive",function(){var thisOp=this.operatorSb.value();if(this.operatorsHash[thisOp].inclusive){this.jqForm.inclusiveDiv.show();}else{this.jqForm.inclusiveDiv.hide();}});K.oo('method',"noIncludeMe",function(dt){return!this.grid0.auth.loggedIn()&&dt.name=='VotingUser';});K.oo('method',"getOperator",function(dt,operatorName){for(var i=0,op;op=dt.operatorOptions[i];i++){if(op.id==operatorName)return op;}});K.oo('method',"toggleValue",function(operatorName){var dt=this.getDatatype();var dtName=this.getRealDatatype(dt);var operator=this.getOperator(dt,operatorName);var message=this.getToggleMessage(dtName);this.jqForm.value.toggleInput();this.jqForm.value.toggleInput('resetDefaultValue',message);if(dtName=='Date'){this.enableDatePicker();}else{this.disableDatePicker();}
this.jqForm.enums.hide();if(operator.value||operator.value==0){this.jqForm.value.toggleInput('val',operator.value);this.valueValidator=Sci.validate(this.jqForm.value,'String');this.jqForm.value.hide();}else{this.jqForm.value.show();this.jqForm.value.toggleInput('val','');if($.inArray(dtName,['ZipCode','PhoneNumber','Link','UUID'])>-1&&$.inArray(operatorName,['contains','starts','ends'])>-1)dtName='String';if($.inArray(operatorName,['contains-in','eqp-in','eq-in','starts-in','ends-in'])>-1)dtName='String';this.valueValidator=Sci.validate(this.jqForm.value,dtName,{'notNull':true});}});K.oo('method',"getToggleMessage",function(datatype){var defaultMessages={'String':'Can be any text.','Numeric':'Can be any numeric.','Integer':'Can be any numeric.','Date':'Click for date picker.','ZipCode':'Can be zip code.','PhoneNumber':'Can be phone number','Link':'Can be a web link.','UUID':'Can be uuid.'};if(defaultMessages[datatype]){return defaultMessages[datatype];}else{return defaultMessages['String'];}});K.oo('method',"getRealDatatype",function(datatype){var dt=datatype.name;switch(dt){case'Table':dt='Integer';break;case'Text':dt='String';break;case'GarbageCount':dt='Integer';break;case'VotingUser':dt='String';break;case'Strength':dt='Integer';break;default:break;}
return dt;});K.oo('method',"populateFilter",function(filter){filter.type=this.getFilterSubType();filter.attribute=this.attributeSb.value();filter.caseSensitive=false;filter.fieldId=this.columnSb.value();filter.operator=this.operatorSb.value();filter.value=DISPLAY.trim(this.jqForm.value.toggleInput('val'));if(filter.operator=='is-me'){filter.operator='is-user';filter.value=this.grid0.auth.username();}else if(filter.operator=='not-me'){filter.operator='is-not-user';filter.value=this.grid0.auth.username();}
if(this.jqForm.inclusiveDiv.is(':visible')){filter.inclusive=this.jqForm.inclusive.is(':checked');}});K.oo('method',"selectColumnSb",function(value){if(this.bigData){if(value=='fact'||value=='subject'||value=='table'){this.selectFirstInColumnSb();return;}}
if(value)this.columnSb.selectValue(value);});K.oo('method',"disableDatePicker",function(){this.jqForm.value.datepicker('destroy');});K.oo('method',"enableDatePicker",function(){var self=this;this.jqForm.value.datepicker({dateFormat:'yy-mm-dd',onSelect:function(datetext){self.jqForm.value.toggleInput('val',datetext);}});});K.oo('method',"validate",function(){return this.valueValidator.validate();});K.oo('method',"resetPosition",function(){if(this.jq.is(':hidden'))return;var jqLastFilter=this.tray.view.jqList.find('>li:last');var jqTray=this.tray.view.jq;var position;if(jqLastFilter.length==0){position={top:0,left:0};}else{position=jqLastFilter.position();position.left+=jqLastFilter.width()+10;if(position.left+jqLastFilter.width()>jqTray.width()){position.left=0;position.top+=jqLastFilter.height()+4;}}
this.jq.css(position);});K.oo('method',"showColumnSb",function(fromColumnMeun){if(fromColumnMeun){this.jqColumn.show();this.columnSb.hide();this.attributeSb.hide();}else{this.jqColumn.hide();this.columnSb.show();this.attributeSb.show();}
if(this.filterType=='summary'&&!this.grid0.auth.isAdmin()){this.attributeSb.hide();}else{this.attributeSb.show();}});K.oo('method',"populateSimpleForm",function(columnId){if(isNaN(columnId))return;var colIdx=this.grid0.columnIdxById(columnId);var column=this.grid0.column(colIdx);this.jqColumn.html(DISPLAY.html(column.name,25));this.jqColumn.attr('title',column.name);});K.oo('method',"populateGeoForm",function(){this.jqHeader.html(this.FILTER_HEADERS['geo']);this.jqGeo.show();this.jqNormal.hide();this.jqQuery.hide();this.disableDatePicker();});K.oo('method',"isSummaryFilterFormShown",function(){return this.jq.is(':visible')&&this.jqNormal.is(':visible');});K.oo('method',"isGeoFilterFormShown",function(){return this.jq.is(':visible')&&this.jqGeo.is(':visible');});})(Grid0Filter.FilterFormView,Grid0Filter);JS2.OO.createClass("Grid0Filter.FilterFormEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.controller.registerEvents();});K.oo('method',"e_newGeoFilter",function(position){this.controller.showFilterForm('geo',null,position);this.notify('populateGeoForm');});K.oo('method',"e_newFilter",function(type,position){this.controller.newFilter(type,position);});K.oo('method',"e_selectColumnSb",function(fieldId){this.view.selectColumnSb(fieldId);});K.oo('method',"e_editFilter",function(filterInfo,jq){this.controller.editFilter(filterInfo,jq);});K.oo('method',"e_dataLoaded",function(){this.view.hide();});K.oo('method',"e_populateGeoForm",function(geo,index){this.view.populateGeoForm();});K.oo('method',"e_hideAllFilterForm",function(){this.controller.hide();});K.oo('method',"e_showColumnSb",function(show){this.view.showColumnSb(show);});})(Grid0Filter.FilterFormEvents,Grid0Filter);Grid0Filter.FilterFormView.oo('setHTMLCache',{"main":function(){return"<div class='filterForm'><h5><\/h5><div class='normal'><div class='column'><\/div><div class='attribute'><\/div><div class='operator'><\/div><div class='value'><input class='textField f' \/><div class='enums'><\/div><div class='clear'><\/div><\/div><div class='inclusive'><input type='checkbox' \/>Inclusive?<\/div><div class='buttons'><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Add      <\/a>    <\/span>  <\/span><\/span><span class='cancel fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Cancel      <\/a>    <\/span>  <\/span><\/span><\/div><\/div><div class='geo'><div class='operator'><\/div><div class='actions'><div class='distance'><input class='distance textField'>meters from<\/input><br \/><input class='lat textField'>latitude<\/input><br \/><input class='lng textField'>longitude<\/input><\/div><div class='bounding'><input class='lat'>latitude 1<\/input><br \/><input class='lng'>longitude 1<\/input><br \/><input class='lat1'>latitude 2<\/input><br \/><input class='lng1'>longitude 2<\/input><\/div><div class='sort'><input class='quantity'>rows<\/input><br \/><input class='lat'>latitude<\/input><br \/><input class='lng'>longitude<\/input><\/div><\/div><div class='buttons'><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Add      <\/a>    <\/span>  <\/span><\/span><span class='cancel fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Cancel      <\/a>    <\/span>  <\/span><\/span><\/div><\/div><div class='query'><label>Search for:<\/label><br \/><input \/><div class='buttons'><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Done      <\/a>    <\/span>  <\/span><\/span><span class='cancel fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Cancel      <\/a>    <\/span>  <\/span><\/span><\/div><\/div><\/div>"}});JS2.OO.createClass("Grid0Filter.GeoFormController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','filterFormView');K.oo('method',"registerEvents",function(){this.view.jqSubmit.click((function(self){return function(){self.submit();}})(this));this.view.jqCancel.click((function(self){return function(){self.hide();}})(this));this.view.jq.find('input').keydown((function(self){return function(e){if(e.keyCode==KEYCODE.ENTER){self.submit();}}})(this));});K.oo('method',"hide",function(){this.filterFormView.hide();});K.oo('method',"submit",function(){if(!this.view.validate()){alert('filter value invalid!');return;}
switch(this.view.getOperator()){case"distance":this.applyGeoFilterDistance();break;case"bounding":this.applyGeoFilterBounding();break;case"sortAsc":this.applyGeoSort('asc');break;case"sortDesc":this.applyGeoSort(!'asc');break;}
this.hide();});K.oo('method',"setGeo",function(geo,index){this.geo=geo;this.index=index;this.changeMode();});K.oo('method',"applyGeoSort",function(asc){this.data.setGeoSort(this.view.getGeoSort(asc));});K.oo('method',"applyGeoFilterDistance",function(){if(this.geo){this.data.updateGeoFilter(this.index,this.view.getGeoFilterDistance());}else{this.data.addGeoFilter(this.view.getGeoFilterDistance());}});K.oo('method',"applyGeoFilterBounding",function(){if(this.geo){this.data.updateGeoFilter(this.index,this.view.getGeoFilterBounding());}else{this.data.addGeoFilter(this.view.getGeoFilterBounding());}});K.oo('method',"populateForm",function(geo,index){if(!geo){this.view.reset();return;}
this.setGeo(geo,index);switch(geo._rclass){case"Qlisp::Action::GeoSort":this.view.setGeoSort(geo);break;case"Qlisp::Action::GeoFilterBounding":this.view.setGeoFilterBounding(geo);break;case"Qlisp::Action::GeoFilterDistance":this.view.setGeoFilterDistance(geo);break;}
this.view.disableOperatorSb();});K.oo('method',"changeMode",function(){if(this.geo){this.view.jqSubmit.first('a').html('edit');}else{this.view.jqSubmit.first('a').html('add');}});})(Grid0Filter.GeoFormController,Grid0Filter);JS2.OO.createClass("Grid0Filter.GeoFormView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','filterFormView');K.oo('method',"initHTML",function(){this.jq=this.filterFormView.jqGeo;var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"geofilterform",this.jq,null);this.jqOperator=this.jq.first('.operator');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"operator",this.jqOperator,null);this.jqDistance=this.jq.first('.distance');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"distance",this.jqDistance,null);this.jqBounding=this.jq.first('.bounding');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"bounding",this.jqBounding,null);this.jqSort=this.jq.first('.sort');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"sort",this.jqSort,null);this.jqSubmit=this.jq.first('.submit');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"submit",this.jqSubmit,null);this.jqCancel=this.jq.first('.cancel');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"cancel",this.jqCancel,null);this.geoActions={distance:{jq:this.jqDistance,jqDistance:this.jqDistance.first('.distance'),jqLat:this.jqDistance.first('.lat'),jqLng:this.jqDistance.first('.lng')},bounding:{jq:this.jqBounding,jqLat:this.jqBounding.first('.lat'),jqLng:this.jqBounding.first('.lng'),jqLat1:this.jqBounding.first('.lat1'),jqLng1:this.jqBounding.first('.lng1')},sort:{jq:this.jqSort,jqQuantity:this.jqSort.first('.quantity'),jqLat:this.jqSort.first('.lat'),jqLng:this.jqSort.first('.lng')}};var options={notNull:true,trimValue:true};this.geoValidators={distance:{distance:Sci.validate(this.geoActions.distance.jqDistance,'Double',options),lat:Sci.validate(this.geoActions.distance.jqLat,'Lat',options),lng:Sci.validate(this.geoActions.distance.jqLng,'Lng',options)},bounding:{lat:Sci.validate(this.geoActions.bounding.jqLat,'Lat',options),lng:Sci.validate(this.geoActions.bounding.jqLng,'Lng',options),lat1:Sci.validate(this.geoActions.bounding.jqLat1,'Lat',options),lng1:Sci.validate(this.geoActions.bounding.jqLng1,'Lng',options)},sort:{quantity:Sci.validate(this.geoActions.sort.jqQuantity,'Integer',options),lat:Sci.validate(this.geoActions.sort.jqLat,'Lat',options),lng:Sci.validate(this.geoActions.sort.jqLng,'Lng',options)}};this.operatorSb=new Sci.SelectBox(this.jqOperator,{selChangeCallBack:(function(self){return function(){self.operatorChanged();}})(this)});this.operatorSb.addItem('distance','is within');this.operatorSb.addItem('bounding','is bound by');this.operatorSb.hide();this.reset();});K.oo('method',"validate",function(){var validators={};for(var key in this.geoValidators){if(this.operator.indexOf(key)>-1){validators=this.geoValidators[key];break;}}
for(var key in validators){if(!validators[key].valid())return false;if(key=='distance'){if(parseFloat(this.geoActions.distance.jqDistance.val())<=0)return false;}}
return true;});K.oo('method',"hide",function(){this.jq.hide();});K.oo('method',"operatorChanged",function(){this.operator=this.getOperator();for(var key in this.geoActions){if(this.operator.indexOf(key)>-1){this.geoActions[key].jq.show();for(var subKey in this.geoActions[key]){if(subKey=='jq')continue;this.geoActions[key][subKey].val('');}}else{this.geoActions[key].jq.hide();}}});K.oo('method',"getGeoFilterDistance",function(){return{_rclass:"Qlisp::Action::GeoFilterDistance",distance:parseFloat(this.geoActions.distance.jqDistance.val()),lat:parseFloat(this.geoActions.distance.jqLat.val()),lng:parseFloat(this.geoActions.distance.jqLng.val())};});K.oo('method',"getGeoFilterBounding",function(){return{_rclass:"Qlisp::Action::GeoFilterBounding",lat:parseFloat(this.geoActions.bounding.jqLat.val()),lng:parseFloat(this.geoActions.bounding.jqLng.val()),lat1:parseFloat(this.geoActions.bounding.jqLat1.val()),lng1:parseFloat(this.geoActions.bounding.jqLng1.val())};});K.oo('method',"getGeoSort",function(asc){return{_rclass:"Qlisp::Action::GeoSort",asc:!!asc,quantity:parseInt(this.geoActions.sort.jqQuantity.val()),lat:parseFloat(this.geoActions.sort.jqLat.val()),lng:parseFloat(this.geoActions.sort.jqLng.val())};});K.oo('method',"getOperator",function(){return this.operatorSb.value();});K.oo('method',"setGeoFilterDistance",function(filter){this.operatorSb.selectValue('distance');this.geoActions.distance.jqDistance.val(filter.distance);this.geoActions.distance.jqLat.val(filter.lat);this.geoActions.distance.jqLng.val(filter.lng);});K.oo('method',"setGeoFilterBounding",function(filter){this.operatorSb.selectValue('bounding');this.geoActions.bounding.jqLat.val(filter.lat);this.geoActions.bounding.jqLng.val(filter.lng);this.geoActions.bounding.jqLat1.val(filter.lat1);this.geoActions.bounding.jqLng1.val(filter.lng1);});K.oo('method',"setGeoSort",function(sort){this.operatorSb.selectValue(sort.asc?'sortAsc':'sortDesc');this.geoActions.sort.jqQuantity.val(sort.quantity);this.geoActions.sort.jqLat.val(sort.lat);this.geoActions.sort.jqLng.val(sort.lng);});K.oo('method',"reset",function(){this.operatorSb.selectIndex(0);for(var key in this.geoActions.distance){this.geoActions.distance[key].val('');}
this.enableOperatorSb();});K.oo('method',"enableOperatorSb",function(){this.operatorSb.setEnable(true);});K.oo('method',"disableOperatorSb",function(){this.operatorSb.setEnable(false);});})(Grid0Filter.GeoFormView,Grid0Filter);JS2.OO.createClass("Grid0Filter.GeoFormEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.controller.registerEvents();});K.oo('method',"e_populateGeoForm",function(geo,index){this.controller.populateForm(geo,index);});K.oo('method',"e_geoFormShown",function(){this.view.reset();this.controller.setGeo(null);});K.oo('method',"e_hideAllFilterForm",function(){this.controller.hide();});})(Grid0Filter.GeoFormEvents,Grid0Filter);JS2.OO.createClass("Grid0Filter.QueryForm");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','filterFormView');K.oo('method',"initHTML",function(){this.jq=this.filterFormView.jqQuery;this.jqQuery=this.jq.first('input');this.jqSubmit=this.jq.first('.submit');this.jqCancel=this.jq.first('.cancel');});K.oo('method',"registerEvents",function(){this.jqQuery.keyup((function(self){return function(e){if(e.keyCode==KEYCODE.ENTER){self.submit();}}})(this));this.jqSubmit.click((function(self){return function(){self.submit();}})(this));this.jqCancel.click((function(self){return function(){self.cancel();}})(this));});K.oo('method',"submit",function(){this.data.updateQuery(this.index,this.jqQuery.val());});K.oo('method',"cancel",function(){this.filterFormView.hide();});K.oo('method',"setQuery",function(query,index){this.query=query;this.index=index;this.populate();this.jqQuery.focus();});K.oo('method',"populate",function(){this.jqQuery.val(this.query.value);});})(Grid0Filter.QueryForm,Grid0Filter);JS2.OO.createClass("Grid0Filter.QueryFormEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();this.controller.registerEvents();});K.oo('method',"e_populateQueryForm",function(query,index){this.controller.setQuery(query,index);});K.oo('method',"e_hideAllFilterForm",function(){this.controller.cancel();});})(Grid0Filter.QueryFormEvents,Grid0Filter);JS2.OO.createClass("Grid0.TableDetails");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth gridMenu');K.oo('method',"e_initHTML",function(){this.initHTML();this.populate();this.registerEvents();});K.oo('method',"e_bigData",function(){if(this.data.isGeoStateReady()){this.jqContent.find('.geoState>.value').text('Yes');}else{this.jqContent.find('.geoState>.value').text('No');}});K.oo('method',"e_userLoggedIn",function(){this.checkLogin();});K.oo('method',"initHTML",function(){this.jqDetailsLink=$('.dsDetailsLink');this.jqDialog=$('.dsDetailsDialog');this.jqDialog.dialog({title:"About This Table",autoOpen:false,width:600,modal:true,resizable:false});this.jq=this.jqDialog.find('.dsDetailsContainer');this.jqClose=this.jq.find('.close');this.jqContent=this.jq.find('.dsDetailsContent');this.jqEditLink=this.jq.find('.editLink');this.jqForm=this.jq.find('.dsDetailsForm');this.jqName=this.jqForm.find('input[name=name]');this.jqDescription=this.jqForm.find('textarea[name=description]');this.jqSource=this.jqForm.find('input[name=source]');this.jqTags=this.jqForm.find('.tags');this.jqTagText=this.jqForm.find('input[name=tags]');this.jqTopics=this.jqForm.find('.topics');this.jqTopicText=this.jqForm.find('input[name=topics]');this.jqShowcasePos=this.jqForm.find('input[name=showcasePos]');this.jqSubmit=this.jqForm.find('.submit');this.jqCancel=this.jqForm.find('.cancel');this.checkLogin();});K.oo('method',"checkLogin",function(){if(this.data.isOwner()||this.auth.isAdmin()){this.jqEditLink.show();this.jqTags.show();this.jqTopics.show();}else{this.jqEditLink.hide();this.jqTags.hide();this.jqTopics.hide();}});K.oo('method',"registerEvents",function(){this.jqDetailsLink.click((function(self){return function(){self.toggleDialog();}})(this));this.jqDetailsLink.parent().clickoff((function(self){return function(){}})(this));this.jqClose.click((function(self){return function(){self.toggleDialog();}})(this));this.jqEditLink.click((function(self){return function(){self.jqContent.hide();self.jqEditLink.hide();self.jqForm.show();}})(this));this.jqCancel.click((function(self){return function(){self.jqContent.show();self.jqEditLink.show();self.jqForm.hide();}})(this));this.jqSubmit.click((function(self){return function(){self.submit();}})(this));});K.oo('method',"toggleDialog",function(){if(this.jqDialog.dialog("isOpen")){this.jqDialog.dialog("close");}else{this.jqDialog.dialog("open");}});K.oo('method',"populate",function(){var name=$.trim(this.jqContent.find('.name>.value').text());var desc=$.trim(this.jqContent.find('.desc>.value>p').text());var source=$.trim(this.jqContent.find('.source>.value').text());var tagLinks=$.trim(this.jqContent.find('.tags .tagLinks').html());var tagText=$.trim(this.jqContent.find('.tags .tagText').text());var topicLinks=$.trim(this.jqContent.find('.topics .topicLinks').html());var topicText=$.trim(this.jqContent.find('.topics .topicText').text());var showcasePos=$.trim(this.jqContent.find('.showcasePos>.value').text());this.jqName.val(name);this.jqDescription.val(desc);this.jqSource.val(source);this.jqTagText.val(tagText);this.jqTopicText.val(topicText);this.jqShowcasePos.val(showcasePos);this.toggleSourceAndDesc(source,desc);});K.oo('method',"toggleSourceAndDesc",function(source,desc){if($.isEmpty(source)){this.jqContent.find('.source').hide();}else{this.jqContent.find('.source>.value').html(DISPLAY.link(source));this.jqContent.find('.source').show();}
if($.isEmpty(desc)){this.jqContent.find('.desc').hide();}else{this.jqContent.find('.desc>.value>p').text(desc);this.jqContent.find('.desc').show();}});K.oo('method',"submit",function(){var params={name:this.jqName.val(),description:this.jqDescription.val(),source:this.jqSource.val(),tagText:this.jqTagText.val(),topicText:this.jqTopicText.val(),showcasePos:this.jqShowcasePos.val()};var callBack=(function(self){return function(p){self.submited(p);self.jqContent.show();self.jqEditLink.show();self.jqForm.hide();}})(this)
this.data.submitTableDetails(params,callBack);});K.oo('method',"submited",function(params){var name=params.name;var desc=params.description;var source=params.source;var tagLinks=params.tagLinks;var tagText=params.tagText;var topicLinks=params.topicLinks;var topicText=params.topicText;var showcasePos=params.showcasePos;this.jqName.val(name);this.jqDescription.val(desc);this.jqSource.val(source);this.jqTagText.val(tagText);this.jqTopicText.val(topicText);this.jqShowcasePos.val(showcasePos);var noneValue='<span class="noneValue">[none]</span>';tagLinks=$.isEmpty(tagLinks)?noneValue:tagLinks;topicLinks=$.isEmpty(topicLinks)?noneValue:topicLinks;this.jqContent.find('.name>.value').text(name);this.jqContent.find('.tags .tagLinks').html(tagLinks);this.jqContent.find('.tags .tagText').html(tagText);this.jqContent.find('.topics .topicLinks').html(topicLinks);this.jqContent.find('.topics .topicText').html(topicText);this.jqContent.find('.showcasePos>.value').html(showcasePos);this.toggleSourceAndDesc(source,desc);});K.oo('method',"hide",function(){this.jqDialog.hide();});K.oo('method',"isTagEditable",function(){return this.auth.isDev();});})(Grid0.TableDetails,Grid0);JS2.OO.createClass("Grid0.Merger");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){});K.oo('method',"open",function(){this.view.openDialog();});K.oo('method',"submit",function(params){this.data.merge(params);this.notify('actionsModified');});})(Grid0.Merger,Grid0);JS2.OO.createClass("Grid0.MergerView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dialogName','mergeData');K.oo('member','dependencies','gridMenu');K.oo('method',"initDialog",function(){this.dialogInitiated=true;var dialogOptions={title:'Merge or Append Data to this Table',width:800,height:500,modal:true}
this.jq=this.util.buildDialog(this.dialogName,this.htmlCache.main(),dialogOptions);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Dialog",this.jq,null);this.jqPreviews=this.jq.first('ul.previews');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Preview",this.jqPreviews,null);this.jqSuggests=this.jq.first('.suggests').hide();this.jqMergibilities=this.jq.first('ul.mergibilities');this.jqSearchButton=this.jq.first('.search');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Search submit",this.jqSearchButton,null);this.jqSearchInput=this.jq.first('input[type=text]');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Search input",this.jqSearchInput,null);this.jqMessage=this.jq.first('.error');this.jqSpinner=this.jq.first('.fact-spinner').hide();var self=this;self.jqSearchButton.click(function(){self.searchByInput();});onEnterKey(self.jqSearchInput,function(){self.searchByInput();});checkLoadable(this.jqSearchInput,this.jqSearchButton);this.prepopulate();});K.oo('method',"prepopulate",function(){var self=this;var datasetKey=this.data.dataset.key;this.jqSpinner.html('Retrieving realtime mergeability data...').show();var params={_event:'MergeabilitySearch'};AJAX.post('/tables/merge/'+datasetKey+'/initiate',params,function(data){self.populateMergibility(data);});});K.oo('method',"populateMergibility",function(data){var self=this;this.jqSpinner.hide().html('');this.mergibilities=data;this.jqMergibilities.html('');for(var i=0,d;d=data[i];i++){var params={length:d.mappings_length,name:d.dataset_name,idx:i}
var jqMergible=$(this.htmlCache.mergibility(params));jqMergible.first('.fact-spinner').hide();this.jqMergibilities.append(jqMergible);jqMergible.first('a').click(function(){self.searchByMergibility(this);});if(i==0)this.jqSuggests.show();}});K.oo('method',"searchByInput",function(){if(!this.jqSearchButton.is('.disabled')){this.search(this.jqSearchInput.val());}});K.oo('method',"searchByMergibility",function(link){var jqMergible=$(link.parentNode.parentNode);var idx=parseInt(jqMergible.attr('idx'));jqMergible.first('.info').hide();var mergibility=this.mergibilities[idx];this.search(String('t/'+mergibility.dataset_id),jqMergible);});K.oo('method',"search",function(val,jqMergible){var self=this;var dsId=this.schema.primaryDataset.id;var search=val;var idInfo=sci.common.getIdInfo(search);idType=idInfo.type;searchId=idInfo.id;if(idType!='datasets'){self.showError("Only tables can be merged.");return;}
if(searchId<=0){self.showError("It seems that you have entered an invalid url. Url's must be at the factual.com domain and point to a valid table. You may include or omit the \"http://\" and the \"www\".");return;}
var jqLoading=this.jqSpinner;if(jqMergible)jqLoading=jqMergible.first('.fact-spinner');var datasetId=this.data.dataset.id;if(searchId==datasetId){self.showError("We cannot merge the same table, please try a different search.");}else{jqLoading.show();var params={searchId:searchId,search:search,datasetId:datasetId};AJAX.post('/tables/merge/search',params,function(obj){jqLoading.hide();obj.error?self.showError(obj.error):self.showSearch(obj,jqMergible);});}});K.oo('method',"showSearch",function(results,jqMergible){this.showError('');var cols=this.schema.primaryDataset.columns();var mappings={};var li=$('<li />');var jqPreview=this.jqPreviews;if(jqMergible){var idx=parseInt(jqMergible.attr('idx'));mappings=this.mergibilities[idx].mappings;jqPreview=jqMergible.first('.preview');}
jqPreview.prepend(li);for(var it23=0,result,it23__arr=results,it23__len=it23__arr.length;(result=it23__arr[it23])||it23<it23__len;it23++){var preview=APP(SchemaMatcher,{seed:li,merger:this.controller,mappings:mappings});result.mapColumns=cols;preview.start(result);}});K.oo('method',"showError",function(msg){this.jqMessage.html(msg);});K.oo('method',"performMerge",function(mapping){});K.oo('method',"openDialog",function(){if(!this.dialogInitiated)this.initDialog();this.jq.dialog('open');});K.oo('method',"toggleMenu",function(){});})(Grid0.MergerView,Grid0);JS2.OO.createClass("Grid0.MergerEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','gridMenu');K.oo('method',"e_initHTML",function(){this.view.toggleMenu();});K.oo('method',"e_improveMenuClicked",function(name,jqObject){if(name=='improve > merge'){if(jqObject.parent().hasClass('disabled'))return;this.controller.open();}});K.oo('method',"e_userLoggedIn",function(){this.view.toggleMenu();});})(Grid0.MergerEvents,Grid0);Grid0.MergerView.oo('setHTMLCache',{"mergibility":function(params){return"<li class='mergible' idx='"+params.idx+"'><div class='fact-spinner'><\/div><div class='info'>There are <strong>"+params.length+"<\/strong> columns that can be merged from:<br \/><em>\""+params.name+"\"<\/em><br \/>click here to&nbsp;<a>define the merge<\/a>.<\/div><ul class='preview'><\/ul><\/li>"},"main":function(){return"<div style='margin: 4px 0px'>Please enter the URL of the Factual table you'd like to merge:&nbsp;&nbsp;<input class=' textField' onblur='s.blur(this)' onfocus='s.focus(this)' type='text' \/><span class='search fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Search      <\/a>    <\/span>  <\/span><\/span><div><div class='fact-spinner'><\/div><\/div><div class='error' style='margin:5px 0px'><\/div><ul class='previews'><\/ul><fieldset class='suggests'><legend>Suggest Tables<\/legend><ul class='mergibilities'><\/ul><\/fieldset><\/div>"}});JS2.OO.createClass("Grid0.Admin");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"gridMenu");K.oo('method',"initHTML",function(){this.$menu=this.gridMenu.getMenu('admin').jq;var $states=this.$menu.find('.state span');this.states={};this.states.$apiTtl=$states.eq(0);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"ttlstate",this.states.$apiTtl,null);this.states.$cache=$states.eq(1);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"cachestate",this.states.$cache,null);this.states.$bigData=$states.eq(2);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"bigData",this.states.$bigData,null);this.states.$geo=$states.eq(3);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"geostate",this.states.$geo,null);this.states.$fulltextSearch=$states.eq(4);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"searchstate",this.states.$fulltextSearch,null);this.states.$identityFields=$states.eq(5);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"identitystate",this.states.$identityFields,null);this.states.$fqr=$states.eq(6);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"fqrstate",this.states.$fqr,null);this.initStates();this.checkLogin();});K.oo('method',"checkLogin",function(){this.auth.isAdmin()?this.$menu.show():this.$menu.hide();});K.oo('method',"initStates",function(){this.populateApiTtlState(this.data.dataset.cacheTtl);});K.oo('method',"showApiTtlDialog",function(){if(!this.$apiTtlDialog){this.buildApiTtlDialog();}
this.$apiTtlInput.val(this.data.dataset.cacheTtl);this.$apiTtlDialog.dialog('open');});K.oo('method',"hideApiTtlDialog",function(){this.$apiTtlDialog.dialog('close');});K.oo('method',"showCacheSettingDialog",function(){if(!this.$cacheSettingDialog){this.buildCacheSettingDialog();}
this.$cacheSettingDialog.dialog('open');});K.oo('method',"clearLastPresummaryFunction",function(){this.data.clearFunction();});K.oo('method',"buildApiTtlDialog",function(){this.$apiTtlDialog=$(this.htmlCache.apiTtlDialog())
this.$apiTtlDialog.dialog({autoOpen:false,title:'API TTL',resizable:false,modal:true});this.$apiTtlInput=this.$apiTtlDialog.first('input');this.$apiTtlDialog.first('.submit').click((function(self){return function(){self.submitApiTtl();}})(this));});K.oo('method',"buildCacheSettingDialog",function(){this.$cacheSettingDialog=$(this.htmlCache.cacheSettingDialog())
this.$cacheSettingDialog.dialog({autoOpen:false,title:'Cache Settings',resizable:false,modal:true,width:550}).parent().addClass('overflowVisibleDialog');this.$cacheSettingTab=this.$cacheSettingDialog.first('.tabs').tabs();var $buttons=this.$cacheSettingDialog.first('.buttons')
$buttons.first('.submit').click((function(self){return function(){self.submitCacheSettings();}})(this));$buttons.first('.reset').click((function(self){return function(){self.populateCacheSettingDialog();}})(this));var cachesetting=this.$cacheSettingDialog;var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"cachesetting",cachesetting,null);var submit=$buttons.first('.submit');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"submit",submit,null);var reset=$buttons.first('.reset');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"reset",reset,null);var geolink=cachesetting.first('a[href="#cacheSettings-geo"]');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"geolink",geolink,null);var fqrlink=cachesetting.first('a[href="#cacheSettings-fqr"]');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"fqrlink",fqrlink,null);var searchlink=cachesetting.first('a[href="#cacheSettings-fulltextSearch"]');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"searchlink",searchlink,null);var identitylink=cachesetting.first('a[href="#cacheSettings-identityFields"]');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"identitylink",identitylink,null);this.cacheSettings={};this.buildGeoTab();this.buildFqrTab();this.buildFulltextSearchTab();this.buildIdentityFieldsTab();this.populateCacheSettingDialog();});K.oo('method',"buildGeoTab",function(){var $tab=this.$cacheSettingDialog.first('#cacheSettings-geo');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"geotab",$tab,null);this.cacheSettings.geo={};this.cacheSettings.geo.$enable=$tab.first('.enable');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"geoenable",this.cacheSettings.geo.$enable,null);this.cacheSettings.geo.latSb=new Sci.SelectBox($tab.first('.lat'));var latselector=$tab.first('.lat');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"latselector",latselector,null);this.cacheSettings.geo.lngSb=new Sci.SelectBox($tab.first('.lng'));var lngselector=$tab.first('.lng');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"lngselector",lngselector,null);});K.oo('method',"buildFqrTab",function(){var $tab=this.$cacheSettingDialog.first('#cacheSettings-fqr');this.cacheSettings.fqr=new Grid0.Admin.Fqr($tab,this);});K.oo('method',"buildFulltextSearchTab",function(){var $tab=this.$cacheSettingDialog.first('#cacheSettings-fulltextSearch');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"searchtab",$tab,null);this.cacheSettings.fulltextSearch={};this.cacheSettings.fulltextSearch.$enable=$tab.first('.enable');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"searchenable",this.cacheSettings.fulltextSearch.$enable,null);this.cacheSettings.fulltextSearch.$fields=$tab.first('.fields');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"searchfields",this.cacheSettings.fulltextSearch.$fields,null);this.cacheSettings.fulltextSearch.$fields.delegate('input[type=checkbox]','click',(function(self){return function(){self.fieldSettingsIncludeClicked(this);}})(this));});K.oo('method',"buildIdentityFieldsTab",function(){var $tab=this.$cacheSettingDialog.first('#cacheSettings-identityFields');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"identitytab",$tab,null);this.cacheSettings.identityFields={};this.cacheSettings.identityFields.$fields=$tab.first('.fields');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"identityfields",this.cacheSettings.identityFields.$fields,null);this.cacheSettings.identityFields.$minDisplay=$tab.first('.minDisplay input');this.cacheSettings.identityFields.$minAutoFold=$tab.first('.minAutoFold input');this.cacheSettings.identityFields.$enable=$tab.first('.enable');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"identityenable",this.cacheSettings.identityFields.$enable,null);this.cacheSettings.identityFields.$fields.delegate('input[type=checkbox]','click',(function(self){return function(){self.fieldSettingsIncludeClicked(this);}})(this));});K.oo('method',"populateApiTtlState",function(apiTtl){apiTtl=apiTtl?apiTtl+' minutes':'NOT SET';this.states.$apiTtl.text(apiTtl);});K.oo('method',"populateCacheState",function(){this.states.$cache.text(this.data.cacheState);this.states.$bigData.text(this.data.bigData?"Yes":"No");});K.oo('method',"populateGeoState",function(){var state
if(this.data.cacheState=='WRITING'){state='Caching';}else if(this.data.isGeoStateReady()){state='READY';}else{state='NOT SET';}
this.states.$geo.text(state);});K.oo('method',"populateFulltextSearchState",function(){var state=this.actions.isFulltextSearchEnabled()?'ENABLED':'DISABLED';this.states.$fulltextSearch.text(state);});K.oo('method',"populateIdentityFieldsState",function(){var state=this.actions.isDedupeEnabled()?'ENABLED':'DISABLED';this.states.$identityFields.text(state);});K.oo('method',"populateFqrState",function(){var state=this.actions.isFqrRequirementSetsNotEmpty()?'READY':'NOT READY';this.states.$fqr.text(state);});K.oo('method',"populateCacheSettingDialog",function(){this.populateGeoTab();this.populateFqrTab();this.populateFulltextSearchTab();this.populateIdentityFieldsTab();});K.oo('method',"populateGeoTab",function(){this.cacheSettings.geo.latSb.clear();this.cacheSettings.geo.lngSb.clear();var latNames=[];var lngNames=[];var columns=this.data.columns();for(var i=0,col;col=columns[i];i++){if(col.hidden)continue;var datatype=col.datatype.toLowerCase();switch(datatype){case'lat':latNames.push(col.name);this.cacheSettings.geo.latSb.addItem(col.id,col.name);break;case'lng':lngNames.push(col.name);this.cacheSettings.geo.lngSb.addItem(col.id,col.name);break;case'double':latNames.push(col.name);lngNames.push(col.name);this.cacheSettings.geo.latSb.addItem(col.id,col.name);this.cacheSettings.geo.lngSb.addItem(col.id,col.name);break;}}
this.cacheSettings.geo.latSb.selectIndex(0);this.cacheSettings.geo.lngSb.selectIndex(0);for(var i=0,n,i__arr=latNames,i__len=i__arr.length;(n=i__arr[i])||i<i__len;i++){if(n.match(/lat|latitude/i)){this.cacheSettings.geo.latSb.selectIndex(i);break;}}
for(var i=0,n,i__arr=lngNames,i__len=i__arr.length;(n=i__arr[i])||i<i__len;i++){if(n.match(/lng|long|longitude/i)){this.cacheSettings.geo.lngSb.selectIndex(i);break;}}
var checked=false;if(this.actions.verifyGeoFunction()){checked=true;}
this.cacheSettings.geo.$enable.prop('checked',checked);var geoFunction=this.actions.geoFunction()||{};if(geoFunction.latFieldId)this.cacheSettings.geo.latSb.selectValue(geoFunction.latFieldId);if(geoFunction.lngFieldId)this.cacheSettings.geo.lngSb.selectValue(geoFunction.lngFieldId);});K.oo('method',"populateFqrTab",function(){this.cacheSettings.fqr.populate();});K.oo('method',"populateFulltextSearchTab",function(){var $fields=this.cacheSettings.fulltextSearch.$fields;var fieldIds=this.actions.getFulltextSetting();var options={includeJoinTables:true,includeFirstPK:true};this.cacheSettings.fulltextSearch.$enable.prop('checked',this.actions.isFulltextSearchEnabled());this.populateFields($fields,this.actions.getFulltextSetting(),options);});K.oo('method',"populateIdentityFieldsTab",function(){var $fields=this.cacheSettings.identityFields.$fields;var options={includeFirstPK:true};var dedupeSetting=this.actions.getDedupeSetting();this.cacheSettings.identityFields.$enable.prop('checked',this.actions.isDedupeEnabled());this.populateFields($fields,dedupeSetting.fieldSettings,options);this.cacheSettings.identityFields.$minDisplay.val(dedupeSetting.minDisplay);this.cacheSettings.identityFields.$minAutoFold.val(dedupeSetting.minAutoFold);});K.oo('method',"populateFields",function(jq,fieldSettings,options){jq.html('');options=options||{};var allColumns=options.includeJoinTables?this.schema.columns():this.schema.primaryDataset.columns();for(var i=0,c,i__arr=allColumns,i__len=i__arr.length;(c=i__arr[i])||i<i__len;i++){if(c.isPrimary&&!(options.includeFirstPK&&i==0))continue;var id=c.id;var $field=$(this.htmlCache.settingField({id:id,name:options.useRefName?c.reference:c.name,fClass:(c.hidden?'hiddenField ':'')+(c.isPrimary?'pk':(i%2==0?'odd':'even'))}));jq.append($field);}
for(var i=0,f,i__arr=fieldSettings,i__len=i__arr.length;(f=i__arr[i])||i<i__len;i++){var $enable=jq.first('input[fieldId='+f.fieldId+']').prop('checked',true);var $weight=$enable.parent().siblings('.weight');$weight.first('.na').hide();$weight.first('select').show().val(f.weight);}
this.toggleFieldSettingsEnabled(jq);});K.oo('method',"applyGeoTab",function(){if(this.cacheSettings.geo.$enable.prop('checked')){this.actions.initGeoFunction(parseInt(this.cacheSettings.geo.latSb.value()),parseInt(this.cacheSettings.geo.lngSb.value()));}else{this.actions.disableGeoFunction();}});K.oo('method',"applyFqrTab",function(){this.cacheSettings.fqr.apply();});K.oo('method',"applyFulltextSearchTab",function(){this.actions.setFulltextSearchEnabled(this.cacheSettings.fulltextSearch.$enable.is(':checked'));this.actions.setFulltextSetting(this.getFieldSettings(this.cacheSettings.fulltextSearch.$fields));});K.oo('method',"applyIdentityFieldsTab",function(){var fieldSettings=this.getFieldSettings(this.cacheSettings.identityFields.$fields);if(fieldSettings.length==1){alert('Deduplication cannot be enabled unless you select at least two fields.');this.cacheSettings.hasError=true;}else{var minAutoFold=DISPLAY.trim(this.cacheSettings.identityFields.$minAutoFold.val());var minDisplay=DISPLAY.trim(this.cacheSettings.identityFields.$minDisplay.val());if((minAutoFold==''||minDisplay=='')||(isNaN(minAutoFold)||isNaN(minDisplay))||(minDisplay>minAutoFold||minAutoFold<=0||minAutoFold>1||minDisplay<=0||minDisplay>1)){alert('Threshold values cannot be blank and must be greater 0 and less than or equal to 1. Minimum auto-fold threshold must be greater than minimum display threshold');this.cacheSettings.hasError=true;}
this.actions.setDedeupSetting({minDisplay:parseFloat(minDisplay),minAutoFold:parseFloat(minAutoFold),fieldSettings:fieldSettings});}
this.actions.setDedupeEnabled(this.cacheSettings.identityFields.$enable.is(':checked'));});K.oo('method',"fieldSettingsIncludeClicked",function(include){var $include=$(include);var $field=$include.closest('li');var $select=$field.first('select');var $na=$field.first('.na');if($include.is(':checked')){$select.show();$na.hide();}else{$select.hide();$na.show();}
this.toggleFieldSettingsEnabled($field.parent());});K.oo('method',"toggleFieldSettingsEnabled",function($fields){var $checkedInputs=$fields.find('input:checked');var $enable=$fields.parent().first('.enable');if($checkedInputs.length){$enable.prop('disabled',false);}else{$enable.prop('disabled',true);$enable.prop('checked',false);}});K.oo('method',"getFieldSettings",function($fields){var fieldSettings=[];var $checkboxes=$fields.find('input:checked');for(var it8=0,cb,it8__arr=$checkboxes,it8__len=it8__arr.length;(cb=it8__arr[it8])||it8<it8__len;it8++){var $cb=$(cb);fieldSettings.push({fieldId:$cb.attr('fieldId'),weight:$cb.closest('li').first('select').val()});}
return fieldSettings;});K.oo('method',"submitCacheSettings",function(){this.applyGeoTab();this.applyFqrTab();this.applyFulltextSearchTab();this.applyIdentityFieldsTab();if(this.cacheSettings.hasError){this.cacheSettings.hasError=false;}else{this.saveGridState((function(self){return function(){self.notify('alert');;self.forceCache();}})(this));this.$cacheSettingDialog.dialog('close');this.notify('alert','Saving ...');}});K.oo('method',"submitApiTtl",function(apiTtl){var apiTtl=this.$apiTtlInput.val();if(apiTtl.match(/^[1-9]\d*$/)){var apiTtl=parseInt(apiTtl,10);this.data.setCacheTtl(apiTtl,(function(self){return function(p){self.populateApiTtlState(p);}})(this));this.hideApiTtlDialog();}else{alert('please input ttl minutes!');}});K.oo('method',"forceCache",function(){window.location.href=['/tables/main/',this.data.dataset.id,'/force_cache'].join('');});K.oo('method',"saveGridState",function(callback,onError){this.data.saveGridState((function(callback){return function(){if(callback)callback();}})(callback),onError);});K.oo('method',"saveGridStateAndForceCache",function(onError){this.saveGridState((function(self){return function(){self.forceCache();}})(this),onError);});})(Grid0.Admin,Grid0);JS2.OO.createClass("Grid0.AdminEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();});K.oo('method',"e_adminMenuClicked",function(name,jqObject){switch(name){case'admin > setApiTtl':this.controller.showApiTtlDialog();break;case'admin > forceCache':if(confirm('Re-caching this table will save the current grid state. Are you sure you want to continue?')){this.controller.saveGridStateAndForceCache();}
break;case'admin > cacheSettings':this.controller.showCacheSettingDialog();break;case'admin > clearLastPresummaryFunction':this.controller.clearLastPresummaryFunction();break;}});K.oo('method',"e_userLoggedIn",function(){this.controller.checkLogin();});K.oo('method',"e_forceCache",function(){this.controller.saveGridStateAndForceCache();});K.oo('method',"e_dataLoaded",function(){this.controller.populateCacheState();this.controller.populateGeoState();this.controller.populateFulltextSearchState();this.controller.populateIdentityFieldsState();this.controller.populateFqrState();});})(Grid0.AdminEvents,Grid0);JS2.OO.createClass("Grid0.Admin.Fqr");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','DEFAULT_FQR',[{name:2,address:2,city:2},{name:2,address:2,postcode:2},{name:2,latitude:1,longitude:1}]);K.oo('method',"initialize",function($root,owner){this.$root=$root;this.data=owner.data;this.schema=owner.schema;this.actions=owner.actions;this.fqrRequirementSets=[];this.initHTML();this.registerEvents();});K.oo('method',"initHTML",function(){this.$enable=this.$root.first('.enable');this.$fqrRequirementSets=this.$root.first('.fqrRequirementSets');this.$addFqrRequirementSet=this.$root.first('.add');});K.oo('method',"registerEvents",function(){this.$addFqrRequirementSet.click((function(self){return function(){self.addFqrRequirementSet();}})(this));this.$fqrRequirementSets.delegate('.delete','click',(function(self){return function(){self.deleteFqrRequirementSet($(this));}})(this));});K.oo('method',"populate",function(){var fqrEnabled=this.actions.getUseFqr();this.$enable.prop('checked',fqrEnabled);this.$fqrRequirementSets.html('');this.fqrRequirementSets=[];var fqrRequirementSets=this.actions.getFqrRequirementSets();if(!fqrEnabled&&(!fqrRequirementSets||fqrRequirementSets.length<1)){fqrRequirementSets=this.getDefaultFqr();}
for(var it9=0,fqrRequirementSet,it9__arr=fqrRequirementSets,it9__len=it9__arr.length;(fqrRequirementSet=it9__arr[it9])||it9<it9__len;it9++){var fqrRSet=this.addFqrRequirementSet();fqrRSet.populate(fqrRequirementSet.fqrRequirements);}});K.oo('method',"getDefaultFqr",function(){var fqr=[];for(var it10=0,fqr_set,it10__arr=this.DEFAULT_FQR,it10__len=it10__arr.length;(fqr_set=it10__arr[it10])||it10<it10__len;it10++){var set=[];for(var field in fqr_set){var fieldId=this.schema.getFieldIdByName(field);if(!fieldId)return[];set.push({fieldId:fieldId,inputs:fqr_set[field]});}
fqr.push({fqrRequirements:set});}
return fqr;});K.oo('method',"addFqrRequirementSet",function(){var fqrRequirementSet=new Grid0.Admin.FqrRequirementSet(this.$fqrRequirementSets,this.data.columns());this.fqrRequirementSets.push(fqrRequirementSet);this.populateFqrRequirementSets();return fqrRequirementSet;});K.oo('method',"populateFqrRequirementSets",function(){for(var i=0,fqrRequirementSet,i__arr=this.fqrRequirementSets,i__len=i__arr.length;(fqrRequirementSet=i__arr[i])||i<i__len;i++){i?fqrRequirementSet.markAsFirst(false):fqrRequirementSet.markAsFirst(true);}});K.oo('method',"deleteFqrRequirementSet",function($delete){var $fqrRequirementSet=$delete.closest('.fqrRequirementSet');this.fqrRequirementSets.remove($fqrRequirementSet.prevAll().length);$fqrRequirementSet.remove();this.populateFqrRequirementSets();});K.oo('method',"apply",function(){this.actions.setUseFqr(this.$enable.is(':checked'));this.actions.setFqrRequirementSets(this.toHash());});K.oo('method',"toHash",function(){var fqrRequirementSets=[];for(var it11=0,fqrRequirementSet,it11__arr=this.fqrRequirementSets,it11__len=it11__arr.length;(fqrRequirementSet=it11__arr[it11])||it11<it11__len;it11++){var fqrRequirementSetHash=fqrRequirementSet.toHash();if(fqrRequirementSetHash)fqrRequirementSets.push(fqrRequirementSetHash);}
return fqrRequirementSets;});})(Grid0.Admin.Fqr,Grid0.Admin);JS2.OO.createClass("Grid0.Admin.FqrRequirementSet");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function($parent,columns){this.$parent=$parent;this.columns=columns;this.fqrRequirements=[]
this.initHTML();this.registerEvents();});K.oo('method',"initHTML",function(){this.$root=$(this.htmlCache.main());this.$root.appendTo(this.$parent);this.$fqrRequirements=this.$root.first('.fqrRequirements');this.$addRequirement=this.$root.first('.add');});K.oo('method',"registerEvents",function(){this.$addRequirement.click((function(self){return function(){self.addRequirement();}})(this));});K.oo('method',"addRequirement",function(){var fqrRequirement=new Grid0.Admin.FqrRequirement(this.$fqrRequirements,this.columns);this.fqrRequirements.push(fqrRequirement);return fqrRequirement;});K.oo('method',"deleteRequirementSet",function(){this.$root.remove();});K.oo('method',"populate",function(requirements){this.$fqrRequirements.html('');this.fqrRequirements=[];for(var it12=0,requirement,it12__arr=requirements,it12__len=it12__arr.length;(requirement=it12__arr[it12])||it12<it12__len;it12++){var fqrRequirement=this.addRequirement();fqrRequirement.populate(requirement);}});K.oo('method',"markAsFirst",function(isFirst){isFirst?this.$root.addClass('first'):this.$root.removeClass('first');});K.oo('method',"toHash",function(){var requirements=[];for(var it13=0,requirement,it13__arr=this.fqrRequirements,it13__len=it13__arr.length;(requirement=it13__arr[it13])||it13<it13__len;it13++){requirements.push(requirement.toHash());}
if(requirements.length){return{fqrRequirements:requirements};}else{return undefined;}});})(Grid0.Admin.FqrRequirementSet,Grid0.Admin);JS2.OO.createClass("Grid0.Admin.FqrRequirement");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function($parent,columns){this.$parent=$parent;this.columns=columns
this.initHTML();});K.oo('method',"initHTML",function(){this.$root=$(this.htmlCache.main());this.$root.appendTo(this.$parent);this.$inputs=this.$root.first('.inputs');this.columnSb=new Sci.SelectBox(this.$root.first('.columns'));this.populateColumnSb();});K.oo('method',"populateColumnSb",function(){this.columnSb.clear();for(var it14=0,col,it14__arr=this.columns,it14__len=it14__arr.length;(col=it14__arr[it14])||it14<it14__len;it14++){if(col.hidden||col.isPrimary)continue;this.columnSb.addItem(col.id,col.name);}
this.columnSb.selectIndex(0);});K.oo('method',"populate",function(requirement){this.$inputs.val(requirement.inputs);this.columnSb.selectValue(requirement.fieldId);});K.oo('method',"toHash",function(){return{fieldId:this.columnSb.value(),inputs:this.$inputs.val()};});})(Grid0.Admin.FqrRequirement,Grid0.Admin);Grid0.Admin.FqrRequirement.oo('setHTMLCache',{"main":function(){return"<li class='fqrRequirement'>At least&nbsp;<input class='inputs textField' \/>&nbsp;inputs for&nbsp;<span class='columns'><\/span><\/li>"}});Grid0.Admin.oo('setHTMLCache',{"fieldCheckbox":function(id,name,hiddenClass){return"<li class='"+hiddenClass+"'><label><input class='checkbox' fieldId='"+id+"' type='checkbox' \/>"+name+"<\/label><\/li>"},"cacheSettingDialog":function(){return"<div class='cacheSettingDialog'><div class='tabs'><ul><li><a href='#cacheSettings-geo'>Geo<\/a><\/li><li><a href='#cacheSettings-fqr'>FQR<\/a><\/li><li><a href='#cacheSettings-fulltextSearch'>Full-text search<\/a><\/li><li><a href='#cacheSettings-identityFields'>Deduplication<\/a><\/li><\/ul><div id='cacheSettings-geo'><label class='center'><input class='enable' type='checkbox' \/>&nbsp;Enable Geo queries using the following lat\/lng:<\/label><ul><li><label>Lat Field:<\/label><div class='lat'><\/div><\/li><li><label>Lng Field:<\/label><div class='lng'><\/div><\/li><\/ul><\/div><div id='cacheSettings-fqr'><label class='center'><input class='enable' type='checkbox' \/>&nbsp;Enable FQR on this table by default<\/label><ul class='fqrRequirementSets'><\/ul><span class='add fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        + add set of requirements      <\/a>    <\/span>  <\/span><\/span><\/div><div id='cacheSettings-fulltextSearch'><label class='center'><input class='enable' type='checkbox' \/>&nbsp;Enable full-text search for the following fields:<\/label><div class='header'><div class='include'>include?<\/div><div class='name'>name<\/div><div class='weight'>weight<\/div><\/div><ul class='fields'><\/ul><\/div><div id='cacheSettings-identityFields'><label class='center'><input class='enable' type='checkbox' \/>&nbsp;Enable real-time deduplication using the following settings:<\/label>The following fields generally identify uniqueness for this table:<div class='header'><div class='include'>include?<\/div><div class='name'>name<\/div><div class='weight'>weight<\/div><\/div><ul class='fields'><\/ul><div class='footer'><div class='minDisplay'>minimum display threshold:<input class='textField' \/><\/div><div class='minAutoFold'>minimum auto-fold threshold:<input class='textField' \/><\/div><\/div><\/div><\/div><div class='buttons'><div class='line'><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        submit      <\/a>    <\/span>  <\/span><\/span><em>Will apply all changes and re-cache this table.<\/em><\/div><div class='line'><span class='reset fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        reset      <\/a>    <\/span>  <\/span><\/span><em>Will reset all settings to reflect the current cached state.<\/em><\/div><\/div><\/div>"},"apiTtlDialog":function(){return"<div class='apiTtlDialog'>API TTL:<input class='textField' \/>(Minutes)<div class='buttons'><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Update      <\/a>    <\/span>  <\/span><\/span><\/div><\/div>"},"settingField":function(field){return"<li class='"+field.fClass+"'><div class='include'><input class='checkbox' fieldId='"+field.id+"' type='checkbox' \/><\/div><div class='name'>"+field.name+"<\/div><div class='weight'><span class='na'>N\/A<\/span><select class='hidden'><option value='A'>1.0<\/option><option value='B'>0.4<\/option><option value='C'>0.2<\/option><option value='D'>0.1<\/option><\/select><\/div><\/li>"}});Grid0.Admin.FqrRequirementSet.oo('setHTMLCache',{"main":function(){return"<li class='fqrRequirementSet'><div class='spliter'>- OR -<\/div><fieldset><legend>Factual requirements -&nbsp;<a class='delete'>delete<\/a><\/legend><ul class='fqrRequirements'><\/ul><span class='add fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        + add requirement      <\/a>    <\/span>  <\/span><\/span><\/fieldset><\/li>"}});JS2.OO.createClass("Grid0.AggregationController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','columnMenu header');K.oo('method',"registerEvents",function(){var view=this.view;view.jqMenu.hover((function(self){return function(){self.show();}})(this),(function(self){return function(){self.hide();}})(this));view.jqSecondaryMenu.click((function(self){return function(evt){self.selectAggregation(evt.target);}})(this));});K.oo('method',"selectAggregation",function(target){if(target.nodeName!='LI'){var jq=$(target).parents('li:first');target=jq[0];}
var agg=target.getAttribute('value');if(agg&&this.col.aggregationMethod!=agg){if(agg==this.col.field.aggregation)agg=null;if(this.data.confirmForDBCache()){this.data.setAggregation(this.col.colIdx,agg);this.view.hide();}}});K.oo('method',"showColumnMenu",function(){this.col=this.header.contexts.click.col;this.view.context=this.header.contexts.click;});K.oo('method',"show",function(){var dt=sci.constants.datatypes[this.col.datatype];var methods=dt.aggregationMethods;this.view.highlightSelect(this.col.aggregationMethod||this.col.aggregation,methods);this.view.show();});K.oo('method',"hide",function(){this.view.hide();});K.oo('method',"isBigData",function(){return this.bigData==true;});K.oo('method',"setBigData",function(bigData){this.bigData=bigData;this.toggle();});K.oo('method',"toggle",function(){if(this.bigData&&!this.auth.isAdmin()&&!this.data.isOwner()){this.view.jqMenu.hide();}else{this.view.jqMenu.show();}});})(Grid0.AggregationController,Grid0);JS2.OO.createClass("Grid0.AggregationView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','columnMenu');K.oo('method',"initHTML",function(){var secondMenuHtml=this.htmlCache.menu();var liHtml=this.htmlCache.listItem();this.jqMenu=this.columnMenu.addItem(liHtml,'aggregation',{secondaryMenu:secondMenuHtml});this.jqSecondaryMenuContainer=this.jqMenu.first('.dialogShadow');this.jqSecondaryMenu=this.jqSecondaryMenuContainer.first('ul');this.jqItems=this.jqSecondaryMenu.find('>li');});K.oo('method',"highlightSelect",function(agg,methods){var methodLookup={};for(var it2=0,method,it2__arr=methods,it2__len=it2__arr.length;(method=it2__arr[it2])||it2<it2__len;it2++){methodLookup[method.id]=true;}
for(var it3=0,item,it3__arr=this.jqItems,it3__len=it3__arr.length;(item=it3__arr[it3])||it3<it3__len;it3++){var itemAgg=item.getAttribute('value');if(!methodLookup[itemAgg]){$(item).hide();}else{$(item).show();if(itemAgg==agg){$(item).addClass('checked');}else{$(item).removeClass('checked');}}}});K.oo('method',"show",function(){this.jqSecondaryMenuContainer.show();});K.oo('method',"hide",function(){this.jqSecondaryMenuContainer.hide();});})(Grid0.AggregationView,Grid0);JS2.OO.createClass("Grid0.AggregationEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.controller.registerEvents();});K.oo('method',"e_showColumnMenu",function(){this.controller.showColumnMenu();});K.oo('method',"e_bigData",function(bigData){this.controller.setBigData(bigData);});K.oo('method',"e_userLoggedIn",function(){this.controller.toggle();});})(Grid0.AggregationEvents,Grid0);Grid0.AggregationView.oo('setHTMLCache',{"menu":function(){return"<div class='dialogShadow'><div class='content'><ul class='aggregationDialog'><li class='mean' value='mean'><strong>Mean<\/strong>&nbsp;(the arithmetic average of submitted values)<\/li><li class='mode' value='mode'><strong>Mode<\/strong>&nbsp;(the most common value)<\/li><li class='wiki' value='wiki'><strong>Wiki<\/strong>&nbsp;(the most recently submitted value)<\/li><li class='top-values' value='top-values'><strong>List<\/strong>&nbsp;(all unique values)<\/li><li class='json-list' value='json-list'><strong>JSON List<\/strong>&nbsp;(json list)<\/li><\/ul><\/div><\/div>"},"listItem":function(){return"Aggregation<span class='rightArrow'><\/span>"},"dialog":function(){return"<ol class='aggregationMethodList'><li class='mean'><input type='checkbox' value='mean' \/>Mean<\/li><li class='mode'><input type='checkbox' value='mode' \/>Mode<\/li><li class='wiki'><input type='checkbox' value='wiki' \/>Wiki<\/li><\/ol>"}});JS2.OO.createClass("Grid0.AddRow");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','mainFooter');K.oo('method',"initialize",function(options){this.url='/tables/'+options.dataset.key+'/apps/add_row';$.receiveMessage((function(self){return function(e){var m=e.data.match(/rowAdded_(.*)/);if(m)self.rowAdded(m[1]);}})(this));});K.oo('method',"initHTML",function(){this.initDialog();this.$addRow=this.mainFooter.addRowButton;var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"addrow",this.$addRow,null);this.$iframe=this.$dialog.first('iframe');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"dialog",this.$iframe,null);});K.oo('method',"initDialog",function(){this.$dialog=this.util.buildDialog('addRowExplorer',this.htmlCache.main(),{title:'Add Row',width:600,height:400,minWidth:600,minHeight:400,modal:true,autoOpen:false,resizable:'se',resize:(function(self){return function(){self.resize();}})(this),resizeStop:(function(self){return function(){self.resize();}})(this)});});K.oo('method',"registerEvents",function(){this.$addRow.click((function(self){return function(){self.open();}})(this));});K.oo('method',"toggleMenu",function(){if(this.data.editable()){this.$addRow.show();}else{this.$addRow.hide();}});K.oo('method',"open",function(){if(this.auth.requireLogin(this))return;this.$iframe.attr('src',this.getAddRowAppUrl());this.$dialog.dialog('open');this.resize();});K.oo('method',"close",function(){this.$dialog.dialog('close');});K.oo('method',"getAddRowAppUrl",function(){return"http://"+window.location.hostname+this.url+"?origin_url="+window.location.href;});K.oo('method',"resize",function(){this.$iframe.width(this.$dialog.width()-18);this.$iframe.height(this.$dialog.height()-6);});K.oo('method',"rowAdded",function(rowHash){this.data.jumpToRow(rowHash,(function(self){return function(){self.notify('subjectAdded');}})(this));this.close();});})(Grid0.AddRow,Grid0);JS2.OO.createClass("Grid0.AddRowEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();this.controller.registerEvents();this.controller.toggleMenu();});K.oo('method',"e_userLoggedIn",function(){this.controller.toggleMenu();});})(Grid0.AddRowEvents,Grid0);Grid0.AddRow.oo('setHTMLCache',{"main":function(){return"<div class='addRowExplorer explorer'><iframe frameborder='0'><\/iframe><\/div>"}});JS2.OO.createClass("Grid0.ToggleFieldsController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.registerEvents();});K.oo('method',"registerEvents",function(){this.view.jqSubmit.click((function(self){return function(){self.submit();self.view.hide();}})(this));this.view.jqSelectAll.click((function(self){return function(){self.selectAll();}})(this));this.view.jqSelectNone.click((function(self){return function(){self.selectNone();}})(this));this.view.jqShowFields.click((function(self){return function(){self.view.show();}})(this));});K.oo('method',"submit",function(){var visibility_changed=[];for(var colId in this.view.colCheckBoxLookup){var col=this.schema.columnById(colId);col.hidden=this.view.colCheckBoxLookup[colId].checked?false:true;if(this.hidden_hash[col.id]!=col.hidden){visibility_changed.push({field_id:col.id,is_visible:!col.hidden,table_id:col.datasetId});}}
if(visibility_changed.length>0){AJAX.post('/tables/visibility/toggle',{changed:JSON.stringify(visibility_changed)});}
this.notify('resizeWidth');this.notify('hideMetadataInput');this.notify('viewModified');});K.oo('method',"e_initCols",function(){this.view.addToggles();});K.oo('method',"selectAll",function(){for(var colId in this.view.colCheckBoxLookup){this.view.colCheckBoxLookup[colId].checked=true;}});K.oo('method',"selectNone",function(){for(var colId in this.view.colCheckBoxLookup){this.view.colCheckBoxLookup[colId].checked=false;}});K.oo('method',"e_displayMenuClicked",function(name,jqObject){if(name=='display > showFields'){this.view.show();}});K.oo('method',"e_fieldsMenuClicked",function(name,jqObject){if(name=='fields > showFields'){this.view.show();}});K.oo('method',"e_deleteField",function(id){$(this.view.colCheckBoxLookup[id]).parent().remove();delete this.view.colCheckBoxLookup[id];});})(Grid0.ToggleFieldsController,Grid0);JS2.OO.createClass("Grid0.ToggleFieldsView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dialogName','toggleFields');K.oo('method',"initHTML",function(){var dialogOptions={autoOpen:false,width:600,minWidth:600,height:300,minHeight:300,modal:true,resizable:false,draggable:false,title:'Show or Hide Fields'}
this.jqDialog=this.util.buildDialog(this.dialogName,this.htmlCache.main(),dialogOptions);this.jqFieldCont=this.jqDialog.find('.fields');this.jqSubmit=this.jqDialog.find('center input');this.jqCheckBoxes=this.jqDialog.find('input[type=checkbox]');this.jqSelectAll=this.jqDialog.find('.selectAll');this.jqSelectNone=this.jqDialog.find('.selectNone');this.jqShowFields=this.jqGrid.find('>.showFields');this.colCheckBoxLookup={};});K.oo('method',"addToggles",function(){this.jqFieldCont.html('');var datasets=this.schema.viewDatasets();for(var dsId in datasets){var ds=datasets[dsId];var datasetInfo=this.schema.getDatasetInfo(dsId);this.jqFieldCont.append(this.htmlCache.dataSource(DISPLAY.dsPage(datasetInfo.urlName,datasetInfo.name,50)));var cols=ds.viewColumns();for(var it58=0,c,it58__arr=cols,it58__len=it58__arr.length;(c=it58__arr[it58])||it58<it58__len;it58++){var jqLi=$(this.htmlCache.list(c.isPrimary?'primary':'',DISPLAY.html(c.name)));this.colCheckBoxLookup[c.id]=jqLi.first('input')[0];this.jqFieldCont.append(jqLi);}}});K.oo('method',"show",function(){this.controller.hidden_hash={};var cols=this.schema.columns();for(var it59=0,c,it59__arr=cols,it59__len=it59__arr.length;(c=it59__arr[it59])||it59<it59__len;it59++){if(this.colCheckBoxLookup[c.id]){this.colCheckBoxLookup[c.id].checked=c.hidden?false:true;this.controller.hidden_hash[c.id]=c.hidden;}}
this.jqDialog.dialog('open');});K.oo('method',"hide",function(){this.jqDialog.dialog('close');});})(Grid0.ToggleFieldsView,Grid0);Grid0.ToggleFieldsView.oo('setHTMLCache',{"list":function(){return"<dd class='"+arguments[0]+"'><input type='checkbox' \/><label>"+arguments[1]+"<\/label><\/dd>"},"main":function(){return"<div class='toggleFields'><div class='subHead'>Unchecked fields will be hidden:<\/div><ul class='bulletList' style='margin-bottom:10px;'><li>You can always show them again by returning to this menu option.<\/li><li>These fields will only be 'out of sight' for you until you reload the page.<\/li><\/ul><div class='fieldSelections'><dl class='fields'><\/dl><div class='clear'><\/div><\/div><div class='selectBox'>Select:&nbsp;<a class='selectAll' href='javascript: void(0);'>All<\/a>,&nbsp;<a class='selectNone' href='javascript: void(0);'>None<\/a><\/div><div><center><input class='submit' type='button' value='Apply Changes' \/><\/center><\/div><\/div>"},"dataSource":function(){return"<dt>From table&nbsp;"+arguments[0]+"<\/dt>"}});JS2.OO.createClass("Grid0.Paging");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','mainFooter');K.oo('member','MAX_ROW_COUNT',2000);K.oo('member','TOOLTIP_OFFSET_TOP',20);K.oo('member','TOOLTIP_SHOW_TIMEOUT',3000);K.oo('method',"e_initHTML",function(){this.initHTML();this.registerEvents();});K.oo('method',"initHTML",function(){var html=this.htmlCache.main();this.jq=this.mainFooter.addControl(html);this.$limit=this.jq.find('.limit');this.$pages=this.jq.find('.pagesList');});K.oo('method',"registerEvents",function(){this.$limit.change((function(self){return function(){self.limitChanged();}})(this));this.$pages.live('click',(function(self){return function(e){self.pageClicked(e.target);}})(this));});K.oo('method',"e_dataLoaded",function(){this.populate();});K.oo('method',"e_resetPagination",function(){this.actions.paginate(1,this.limit);});K.oo('method',"getRowCount",function(p){if(p.totalRows<0||p.totalRows>this.MAX_ROW_COUNT){this.hasMore=true;return this.MAX_ROW_COUNT;}else{this.hasMore=false;return p.totalRows;}});K.oo('method',"populate",function(){var p=this.actions.pagination();this.rowCount=this.getRowCount(p);this.limit=p.limit;this.page=p.page;this.populateLimit();this.populatePages();});K.oo('method',"populateLimit",function(){this.$limit.val(this.limit);});K.oo('method',"populatePages",function(){var maxPage=Math.ceil(this.rowCount/this.limit);this.$pages.html('');for(var i=1;i<=maxPage;i++){var className=i==this.page?'page current':'page';this.$pages.append(this.htmlCache.page(i,className));}
if(this.hasMore){this.$pages.append(this.htmlCache.more());this.$moreTooltip=this.jq.find('.moreTooltip').hide();}});K.oo('method',"limitChanged",function(){var limit=this.$limit.val();this.data.paginate(1,limit);});K.oo('method',"pageClicked",function(ele){var jq=$(ele);if(jq.is('.page')){var page=parseInt(jq.html());this.data.paginate(page,this.limit);}else if(jq.is('.more')){this.showMoreToolTip(jq);}});K.oo('method',"showMoreToolTip",function(jq){if(!this.$moreTooltip)return;this.$moreTooltip.show();if(this.toolTipTimeout)clearTimeout(this.toolTipTimeout);this.toolTipTimeout=setTimeout((function(self){return function(){self.$moreTooltip.hide();}})(this),this.TOOLTIP_SHOW_TIMEOUT);});})(Grid0.Paging,Grid0);Grid0.Paging.oo('setHTMLCache',{"page":function(n,className){return"<li><a class='"+className+"'>"+n+"<\/a><\/li>"},"main":function(){return"<div class='paging'><select class='limit'><option value='200'>200<\/option><option value='500'>500<\/option><option value='1000'>1000<\/option><option value='2000'>2000<\/option><\/select><span>rows per page<\/span><span class='pages'>page:<ol class='pagesList' style='display:inline'><\/ol><\/span><\/div>"},"more":function(){return"<li class='moreOption'><a class='more'>more?<\/a><div class='moreTooltip'><span class='icon'><\/span>To see more of this data, further refine your filters.<\/div><\/li>"}});JS2.OO.createClass("Grid0.TooltipController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','header');K.oo('method',"e_initHTML",function(){this.view.initHTML();this.registerEvents();});K.oo('method',"e_showTooltip",function(){var context=this.header.contexts.hover;var jqCol=context.jqEle;var col=context.col;this.view.populateHdrTip(col);this.view.show(jqCol.offset());});K.oo('method',"e_hideTooltip",function(){this.view.hide();});K.oo('method',"registerEvents",function(){var self=this;var view=this.view;view.jq.hover(function(e){view.jq.show();},function(e){view.jq.hide();});});})(Grid0.TooltipController,Grid0);JS2.OO.createClass("Grid0.TooltipView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','topOffset',-84);K.oo('member','dependencies','body');K.oo('method',"initHTML",function(){this.jqParent=$('#tooltips:first');this.jq=this.jqParent.append(this.htmlCache.hdrTip()).find('.hdrTip');this.jqColName=this.jq.find('.colName');this.jqDataType=this.jq.find('.datatype');this.jqAggMeth=this.jq.find('.aggMeth');this.jqSourceTable=this.jq.find('.sourceTable');this.jqMergeFields=this.jq.first('.mergeFields');this.jqMergeList=this.jqMergeFields.first('ol');this.showSourceTable=false;});K.oo('method',"datasetUrl",function(urlName){return'/t/'+urlName;});K.oo('method',"populateHdrTip",function(col){var dataset=this.schema.getDatasetInfo(col.datasetId);this.jqColName.html('<strong>'+DISPLAY(col.name).trunc(36).html()+'</strong>');this.jqDataType.html('Data type: <strong>'+sci.constants.datatypes[col.datatype].viewName+'</strong>');var aggMeth=col.aggregation;if(col.isPrimary){aggMeth="NONE - subject";}
this.jqAggMeth.html('Aggregation method: <strong>'+aggMeth+'</strong>');if(col.field.datasetId!=this.data.dataset.id){this.populateSrcTable(dataset);this.jqSourceTable.show();}else{this.jqSourceTable.hide();}
if(col.field.mergeFields.length){this.populateMergeFields(col.field.mergeFields);this.jqMergeFields.show();}else{this.jqMergeFields.hide();}});K.oo('method',"populateMergeFields",function(mergeFields){var names='';for(var it1=0,f,it1__arr=mergeFields,it1__len=it1__arr.length;(f=it1__arr[it1])||it1<it1__len;it1++){var dataset=this.schema.getDatasetInfo(f.datasetId);names+="<li>- <strong>"+DISPLAY(f.name).trunc(10).html()+'</strong> from '+this.datasetLink(dataset)+"</li>";}
this.jqMergeList.html(names);});K.oo('method',"populateSrcTable",function(dataset){this.jqSourceTable.html('Source table: '+this.datasetLink(dataset));});K.oo('method',"datasetLink",function(dataset){var srcTable=DISPLAY(dataset.name).trunc(16).html();var srcTableText='<a href="'+this.datasetUrl(dataset.urlName)+'" target="_blank" title="'+dataset.name+'">'+srcTable+'</a>';return srcTableText;});K.oo('method',"show",function(pos){this.jq.show();this.jq.css({top:pos.top-this.jq.height()+this.topOffset,left:pos.left});});K.oo('method',"hide",function(){this.jq.hide();});})(Grid0.TooltipView,Grid0);Grid0.TooltipView.oo('setHTMLCache',{"hdrTip":function(){return"<div class='hdrTip tooltip'><ul><li class='colName'><\/li><li class='datatype'><\/li><li class='aggMeth'><\/li><li class='sourceTable'><\/li><li class='mergeFields'>Also contains data from:<ol><\/ol><\/li><\/ul><div class='fieldConnector down'><\/div><\/div>"}});JS2.OO.createClass("Grid0.BulkImportController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"open",function(){this.view.openDialog();this.registerEvents();});K.oo('method',"registerEvents",function(){var self=this;var options={type:"POST",dataType:"json",beforeSubmit:(function(self){return function(d,$f,op){self.showLoading('uploading...');}})(this),success:function(file){self.request_preview(file);}};this.view.jqFileForm.ajaxForm(options);this.view.jqTextForm.ajaxForm(options);this.view.jqViewForm.ajaxForm(options);});K.oo('method',"showLoading",function(msg){this.view.showLoading(msg);});K.oo('method',"request_preview",function(file){if(file.error){this.view.hideSpinner();this.showMessage(file.error);this.file=null;this.view.close();return;}
this.showLoading('loading...');this.file=file;var self=this;var url=this.data.baseUrl()+'/import/preview_file';$.ajax({url:url,data:{id:file.id,key:file.key},dataType:"json",success:function(ret){self.preview(ret)}});});K.oo('method',"preview",function(ret){this.view.hideSpinner();if(ret.error){this.showMessage(ret.error);return;}
var p=ret.tables[0];this.numRows=p.row_count;this.view.preview(p);});K.oo('method',"submit",function(params){if(this.auth.requireLogin(this,params))return;this.view.jqLoginMessage.html('');if(this.file){params.mapping=JSON.stringify(params.mapping);params.file=this.file.id;params.key=this.file.key;params.numRows=this.numRows;this.data.submitImport(params);}else{this.showMessage('need data');}});K.oo('method',"importSubmitted",function(notice){if(notice=='success'){this.view.jq.dialog('close');var html='<li>Your bulk import is being processed, please <a href="javascript:void(0);" onclick="window.location.href = window.location.href;">refresh</a> the page in a few minutes to see your votes.</li>';this.showMessage(html);this.reset();}else{this.showMessage(notice);this.view.enableSubmit();}});K.oo('method',"reset",function(){this.file=null;this.view.clearPreview();});K.oo('method',"showMessage",function(msg){sci.website.message(msg);});K.oo('method',"initialize",function(options){this.isDownloadable=options.dataset.isDownloadable;});})(Grid0.BulkImportController,Grid0);JS2.OO.createClass("Grid0.BulkImportView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','gridMenu');K.oo('member','dialogName','bulkImport');K.oo('method',"initHTML",function(){this.setImportable();if(this.controller.isDownloadable&&!this.auth.isAdmin()&&!this.data.isOwner()){this.gridMenu.disableMenuItem('improve > bulkImport')}});K.oo('method',"e_bigData",function(bigData){this.gridMenu.enableMenuItem('improve > bulkImport')});K.oo('method',"e_dataLoaded",function(){this.setImportable();});K.oo('method',"openDialog",function(){if(!this.jq)this.initDialog();this.jq.dialog('open');});K.oo('method',"initDialog",function(){var self=this;var dialogOptions={autoOpen:false,width:800,minWidth:550,height:480,minHeight:480,modal:true,draggable:true,title:'Import Data',resizeStop:function(e,ui){self.resizeGrid(ui);}}
this.jq=this.util.buildDialog(this.dialogName,this.htmlCache.main(),dialogOptions);this.jqTabs=this.jq.find('.fact-tabs');WIDGET.tabs(this.jqTabs)
this.jqFileForm=this.jq.find('form[name="dataset_import_file"]');this.jqFileForm[0].action=this.data.baseUrl()+'/import/submit_ajax';this.jqTextForm=this.jq.find('form[name="dataset_import_text"]');this.jqTextForm[0].action=this.data.baseUrl()+'/import/submit_ajax';this.jqViewForm=this.jq.find('form[name="dataset_import_view"]');this.jqViewForm[0].action=this.data.baseUrl()+'/import/submit_ajax';this.jqLoadFile=this.jq.find("input[name='load_file']");this.jqLoadPaste=this.jq.find("input[name='load_paste']");this.jqLoadView=this.jq.find("input[name='load_view']");this.jqPreview=this.jq.find(".previewContainer");this.jqSpinner=this.jq.find(".fact-spinner").hide();this.jqLoginMessage=this.jq.find('.loginMessage');this.jqDataMessage=this.jq.find('.dataMessage');checkLoadable(this.jq.find('input[name="file"]'),this.jqLoadFile);checkLoadable(this.jq.find('textarea[name="pasted_data"]'),this.jqLoadPaste);checkLoadable(this.jq.find('input[name="view"]'),this.jqLoadView);});K.oo('method',"showLoading",function(msg){this.clearPreview();this.jqSpinner.html(msg).show();});K.oo('method',"hideSpinner",function(){this.jqSpinner.hide();});K.oo('method',"preview",function(p){this.clearPreview();var cols=this.schema.primaryDataset.columns();var model={columns:[],sampleRows:p.rows,mapColumns:cols,matches:p.matches,containsHeader:!!p.header};for(var i=0,len=p.datatypes.length;i<len;i++){var column={};column.name=p.header?p.header[i]:'';column.datatype=this.getDatatype(p.datatypes[i]);column.width=110;model.columns.push(column);}
var options={seed:this.jqPreview,importer:this.controller,auth:this.auth};this.matcher=APP(ImportSchemaMatcher,options);this.matcher.start(model);this.auth.checkLogin(this.jqLoginMessage);this.notify('checkReferenceState',this.schema.primaryDataset.id,this.jqDataMessage);});K.oo('method',"clearPreview",function(){this.hideSpinner();this.jqPreview.html('');this.jqLoginMessage.html('');this.jqDataMessage.html('');});K.oo('method',"close",function(){this.jq.dialog('close');this.clearPreview();});K.oo('method',"setImportable",function(){if(!this.data.editable()||(this.bigData&&!this.auth.isAdmin())){this.gridMenu.hideMenuItem('improve>bulkImport');}else{this.gridMenu.showMenuItem('improve>bulkImport');}});K.oo('method',"getDatatype",function(datatype){return datatype;});K.oo('method',"resizeGrid",function(ui){var height=ui.size.height;if(this.matcher)this.matcher.resizeHeight(height);});K.oo('method',"enableSubmit",function(){if(this.matcher)this.matcher.enableSubmit();});})(Grid0.BulkImportView,Grid0);JS2.OO.createClass("Grid0.BulkImportEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','gridMenu');K.oo('method',"e_initHTML",function(){this.view.initHTML();});K.oo('method',"e_importSubmitted",function(notice){this.controller.importSubmitted(notice);});K.oo('method',"e_improveMenuClicked",function(name,jqObject){if(name=='improve > bulkImport'){if(jqObject.parent().hasClass('disabled'))return;this.controller.open();}});K.oo('method',"e_userLoggedIn",function(){this.view.setImportable();});})(Grid0.BulkImportEvents,Grid0);JS2.OO.createClass("ImportSchemaMatcher.Main");ImportSchemaMatcher.Main.oo('extends',SchemaMatcher.Main);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','components',['Controls','Preview']);K.oo('member','gridVPaddings',280);K.oo('method',"start",function(model){this.jq=$(this.options.importer.view.htmlCache.matcher());this.seed.append(this.jq);this.seed.setSeed(this.jq);this.assign('importer',this.options.importer);this.assign('model',model);this.assign('auth',this.options.auth);this.notify('initHTML');});K.oo('method',"resizeHeight",function(h){this.notify('resizeHeight',h-this.gridVPaddings);});K.oo('method',"enableSubmit",function(){this.notify('enableSubmit');});})(ImportSchemaMatcher.Main,ImportSchemaMatcher);JS2.OO.createClass("ImportSchemaMatcher.Controls");ImportSchemaMatcher.Controls.oo('extends',SchemaMatcher.Controls);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){this.auth=options.auth;});K.oo('method',"e_initHTML",function(){this.ch=this.model.containsHeader;this.tws=true;this.jq=this.seed.first('.controls:first');this.jqFif=this.jq.find("input[name='fif']").prop('checked',this.ch);this.jqTws=this.jq.find("input[name='tws']").prop('checked',this.tws).hide();this.jqSource=this.jq.find("input[name='twsource']");this.jqSubmit=this.seed.find(".submitImport");this.jqSubmitLoading=this.seed.find(".submitLoading").hide();this.registerEvents();if(this.auth.isAdmin())this.jqTws.show();});K.oo('method',"registerEvents",function(){var self=this;this.jqSubmit.click(function(){self.submit();});this.jqFif.click(function(){self.toggleHeader();});this.jqTws.click(function(){self.toggleSource();});});K.oo('method',"toggleSource",function(){if(!this.auth.isAdmin())return;var tws=this.jqTws.prop('checked');this.tws=tws;if(tws){this.jqSource.show();this.notify('toggleColumnSource',false);}else{this.jqSource.hide();this.notify('toggleColumnSource',true);}});K.oo('method',"toggleHeader",function(){var ch=this.jqFif.prop('checked');this.ch=ch;this.model.containsHeader=ch;if(ch){var headerNames=this.model.sampleRows.shift();for(var i=0,len=headerNames.length;i<len;i++){if(this.model.columns[i].gdt)this.model.columns[i].datatype=this.model.columns[i].gdt;this.model.columns[i].name=headerNames[i];}}else{var row=[];for(var i=0,len=this.model.columns.length;i<len;i++){if(!this.model.columns[i].gdt)this.model.columns[i].gdt=this.model.columns[i].datatype;if(!sci.validatorFactory.get_validator(this.model.columns[i].datatype,{notNull:false}).validate(this.model.columns[i].name))this.model.columns[i].datatype='String';row[i]=this.model.columns[i].name;this.model.columns[i].name='';}
this.model.sampleRows.unshift(row);}
this.notify('loadPreview');});K.oo('method',"e_enableSubmit",function(){this.jqSubmitLoading.hide();this.jqSubmit.show();});K.oo('method',"disableSubmit",function(){this.jqSubmit.hide();this.jqSubmitLoading.show();});K.oo('method',"submit",function(){var params=this.preview.getMapping();var source=this.jqSource.val();params.tws=params.mapping.source?true:this.tws;params.source=source||'';params.ch=this.ch;if(params.isEmpty||!params.pkMatched){var subject_names=[];for(var it36=0,col,it36__arr=this.model.mapColumns,it36__len=it36__arr.length;(col=it36__arr[it36])||it36<it36__len;it36++){if(col.isPrimary)subject_names.push(DISPLAY.html(col.name));}
this.importer.showMessage('You must choose which field[s] in the file most closely match[es] the subject[s] in this table: ['+subject_names.join(', ')+']');}else{this.auth.requireLogin(this);this.disableSubmit();this.importer.submit(params);}});K.oo('method',"e_sourceColumn",function(bool){this.jqSource.prop('disabled',bool);this.jqTws.prop('disabled',bool);});})(ImportSchemaMatcher.Controls,ImportSchemaMatcher);JS2.OO.createClass("ImportSchemaMatcher.Preview");ImportSchemaMatcher.Preview.oo('extends',SchemaMatcher.Preview);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','GRID_CLASS',"ImportSchemaMatcher.Grid");K.oo('method',"getMapping",function(){return this.grid.getMapping();});K.oo('method',"e_loadPreview",function(){this.jq.html('');this.e_initHTML();});K.oo('method',"e_initHTML",function(){_super(this);this.jq.height(210);if(this.model.matches)this.setMapping();this.grid.setPreviewController(this);});K.oo('method',"e_toggleColumnSource",function(show){this.grid.toggleColumnSource(show);});K.oo('method',"setMapping",function(){var lookup={};for(var fieldId in this.model.matches){for(var it37=0,idx,it37__arr=this.model.matches[fieldId],it37__len=it37__arr.length;(idx=it37__arr[it37])||it37<it37__len;it37++){lookup[idx]=fieldId;}}
this.grid.setMapping(lookup);});K.oo('method',"setSourceColumn",function(bool){this.notify('sourceColumn',bool);});K.oo('method',"e_resizeHeight",function(h){this.grid.setHeight(h);});})(ImportSchemaMatcher.Preview,ImportSchemaMatcher);JS2.OO.createClass("ImportSchemaMatcher.Grid.Main");ImportSchemaMatcher.Grid.Main.oo('extends',SchemaMatcher.Grid.Main);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','components',['Mappers','Resizer']);K.oo('method',"setMapping",function(matches){this.notify('setMapping',matches);});K.oo('method',"toggleColumnSource",function(show){this.notify('toggleColumnSource',show);});K.oo('method',"setPreviewController",function(con){this.previewController=con;});K.oo('method',"e_sourceColumn",function(bool){if(this.previewController)this.previewController.setSourceColumn(bool);});})(ImportSchemaMatcher.Grid.Main,ImportSchemaMatcher.Grid);JS2.OO.createClass("ImportSchemaMatcher.Grid.Mappers");ImportSchemaMatcher.Grid.Mappers.oo('extends',SchemaMatcher.Grid.Mappers);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','DATATYPES',['String','Double','Integer','Date','Link','PhoneNumber','ZipCode','UUID','Lat','Lng']);K.oo('method',"e_initCols",function(){this.columnSource=false;_super(this);this.selects=this.jqMergeContainer.find('select');var self=this;this.selects.change(function(){self.uniquePkOptions();});this.jqSourceContainer=$('<div class="columnSources"></div>');this.jqMergeContainer.before(this.jqSourceContainer);for(var i=0,col;col=this.data.columns[i];i++){this.sourceForCol(col,i);}
this.jqColumnSources=this.jqSourceContainer.find('.columnSource');this.resizeColumnSources();this.jqColumnSources.hide();});K.oo('method',"sourceForCol",function(col,idx){this.jqSourceContainer.append('<div class="columnSource"><input type="text" /></div>').children(':last');});K.oo('method',"uniquePkOptions",function(){var pk_select={};var metadata={};for(var i=1,len=this.selectors.length;i<=len;i++){var selector=this.selectors[i-1];var val=selector.sb.value();if(val.toString().match(/^\d+$/)){var id=val;pk_select[id]=i;(this.pkLookup[id]&&id!=this.firstPkId)?this.disablePkSource(i-1):this.enablePkSource(i-1);}
if(val=='source'){metadata.source=i;}
if(val=='comments'){metadata.comments=i;}}
for(var j=1,len=this.selectors.length;j<=len;j++){var selector=this.selectors[j-1];for(var it38=0,c,it38__arr=this.mapColumns,it38__len=it38__arr.length;(c=it38__arr[it38])||it38<it38__len;it38++){var pkId=c.id;if(pk_select[pkId]&&pk_select[pkId]!=j){selector.sb.disableOption(pkId);}else{selector.sb.enableOption(pkId);}}
if(metadata.source&&metadata.source!=j){selector.sb.disableOption('source');}else{selector.sb.enableOption('source');}
if(metadata.comments&&metadata.comments!=j){selector.sb.disableOption('comments');}else{selector.sb.enableOption('comments');}}
this.sourceColumn=!!metadata.source;this.notify('sourceColumn',this.sourceColumn);this.toggleColumnSource();});K.oo('method',"enablePkSource",function(idx){this.jqColumnSources.eq(idx).find('input').prop('disabled','');});K.oo('method',"disablePkSource",function(idx){this.jqColumnSources.eq(idx).find('input').prop('disabled','disabled');});K.oo('method',"buildDatatypeOrder",function(){this.datatypeOrder={};this.pkLookup={};for(var it39=0,dt,it39__arr=this.DATATYPES,it39__len=it39__arr.length;(dt=it39__arr[it39])||it39<it39__len;it39++){if(dt=='Numeric')dt='Double';this.datatypeOrder[dt]=[];}
this.firstPkId=0;for(var i=0,c;c=this.mapColumns[i];i++){if(c.isPrimary){this.pkLookup[c.id]=true;if(this.firstPkId==0||this.firstPkId>c.id)this.firstPkId=c.id;}
this.datatypeOrder[c.datatype].push(c);}});K.oo('method',"optionsForCol",function(col,i){var jq=this.jqMergeContainer.append('<div class="column">&nbsp;</div>').children(':last')
var importableColumns=this.getImportableColumns(this.datatypeOrder);col.id=i;var options={jq:jq,mergeColumns:importableColumns[col.datatype],htmlCache:this.htmlCache,column:col};this.selectors.push(new ImportSchemaMatcher.Grid.Selector2(options));});K.oo('method',"getImportableColumns",function(dtHash){var ret={};var columns=dtHash['Double'].concat(dtHash['Date']).concat(dtHash['Integer']).concat(dtHash['String']).concat(dtHash['Link']).concat(dtHash['PhoneNumber']).concat(dtHash['ZipCode']).concat(dtHash['UUID']).concat(dtHash['Lat']).concat(dtHash['Lng']);ret['Integer']=columns;ret['Double']=columns;ret['Date']=columns;ret['String']=columns;ret['Lat']=columns;ret['Lng']=columns;ret['UUID']=dtHash['UUID'];return ret;});K.oo('method',"e_getMapping",function(ret){ret.isEmpty=true;ret.pkMatched=true;var mapping={};var addColumns=[];var pkMapping={};for(var i=0,s;s=this.selectors[i];i++){var info=s.getMergeInfo();if(info){if(info.type=='map'&&info.val){if(!mapping[info.val])mapping[info.val]={};mapping[info.val].idxs=[];mapping[info.val].idxs.push(info.columnId);mapping[info.val].sources=[];mapping[info.val].sources.push(this.jqColumnSources.eq(i).first('input').val());if(info.val=='source'||info.val=='comments'||info.val=='weight'){mapping[info.val].ctype=info.val;}
ret.isEmpty=false;if(this.pkLookup[info.val])pkMapping[info.val]=true;}}}
for(var pk in this.pkLookup){if(!pkMapping[pk]){ret.pkMatched=false;break;}}
ret.mapping=mapping;});K.oo('method',"e_setMapping",function(matches){for(var i=0,s;s=this.selectors[i];i++){s.setMatch(matches[i]);}});K.oo('method',"e_toggleColumnSource",function(show){this.columnSource=show;this.toggleColumnSource();});K.oo('method',"toggleColumnSource",function(){if(this.columnSource&&!this.sourceColumn){this.resizeColumnSources();this.seed.jq.height(230).first('.universe').css('padding-top',21);}else{this.jqColumnSources.hide();this.seed.jq.height(210).first('.universe').css('padding-top',0);}});K.oo('method',"resizeColumnSources",function(){this.dim.setColumns(this.jqColumnSources,{jqParent:this.jqSourceContainer,adjust:1});});K.oo('method',"e_resizeWidth",function(){_super(this);if(this.columnSource)this.resizeColumnSources();});K.oo('method',"e_hScroll",function(params){_super(this,params);this.jqSourceContainer[0].style.left='-'+params.left+'px';});})(ImportSchemaMatcher.Grid.Mappers,ImportSchemaMatcher.Grid);JS2.OO.createClass("ImportSchemaMatcher.Grid.Selector2");ImportSchemaMatcher.Grid.Selector2.oo('extends',SchemaMatcher.Grid.Selector2);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"buildList",function(){this.jq.attr('title',"Select a field in your table that you'd like to import "+(this.column.name?this.column.name:'this column')+' into.');this.sb.addItem('ignore',"-- Ignore Column --");this.sb.addItem('source',"use as row source");this.sb.addItem('comments',"use as row comments");if(grid.auth.isAdmin()||grid.data.isOwner())this.sb.addItem('weight',"use as row weight");this.sb.jq.css({width:'100%',margin:'3 0'});if(this.mergeColumns&&this.mergeColumns.length>0){this.sb.addComment('Import to:');for(var i=0,c;c=this.mergeColumns[i];i++){if(!c.field.isSubmitable){this.sb.addComment('- '+c.name+' [non-submittable]');}else{this.sb.addItem(c.id,'- '+c.name);}}}});K.oo('method',"setMatch",function(fieldId){this.sb.selectValue(fieldId);});})(ImportSchemaMatcher.Grid.Selector2,ImportSchemaMatcher.Grid);Grid0.BulkImportView.oo('setHTMLCache',{"main":function(){return"<h1>Import Votes<\/h1><div class='explorer bulkImport'><div class='fact-tabs'><ul class='fact-tabList'><li class='selected'>Choose Local File<\/li><li>Cut and Paste Data Directly<\/li><li>From Table or View<\/li><\/ul><div class='panes fact-panes'><div class='uploadFile pane selected'><div class='container clearfix'><div class='entryName'>CSV File to Upload:<\/div><div class='entryValue'><form enctype='multipart\/form-data' name='dataset_import_file'><input class='file' name='file' type='file' \/><input class='uploadButton' name='load_file' type='submit' value='Upload' \/><\/form><\/div><\/div><\/div><div class='pasteData pane hidden'><div class='container clearfix'><div class='entryName'>Paste Data Directly:<\/div><div class='entryValue'><form name='dataset_import_text'><textarea class='textArea ' name='pasted_data' onblur='s.blur(this)' onfocus='s.focus(this)'><\/textarea><br \/><input class='loadButton' name='load_paste' type='submit' value='Load' \/><\/form><\/div><\/div><\/div><div class='fromView pane hidden'><div class='container clearfix'><div class='entryName'>Table or View:<\/div><div class='entryValue'><form name='dataset_import_view'><input class='textField ' name='view' onblur='s.blur(this)' onfocus='s.focus(this)' \/><input class='loadButton' name='load_view' style='margin-left:5px' type='submit' value='Load' \/><\/form><\/div><\/div><\/div><\/div><\/div><div class='previewContainer'><\/div><div class='fact-spinner'><\/div><div class='message'><div class='loginMessage'><\/div><div class='dataMessage'><\/div><\/div><\/div>"},"matcher":function(){return"<div class='SchemaMatcher Main'><div class='main'><div class='schemaMatcher'><div class='controls'><div class='uploadOptions'><input name='fif' type='checkbox' \/>Does the&nbsp;<strong>first row<\/strong>&nbsp;of your imported data contain the&nbsp;<strong>names of each column?<\/strong><\/div><div class='source'><input name='tws' type='checkbox' \/>Cite&nbsp;<strong>one source<\/strong>&nbsp;for&nbsp;<strong>all imported data<\/strong><!-- \/&nbsp;? --><p><input class='' name='twsource' onblur='s.blur(this)' onfocus='s.focus(this)' \/><\/p><\/div><\/div><div class='preview'><\/div><div class='submit'><span class='submitLoading'>Submitting...<\/span><span class='submitImport fact-button' id='submitImport'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Import Data into Table      <\/a>    <\/span>  <\/span><\/span><\/div><\/div><\/div><\/div>"}});JS2.OO.createClass("Grid0.DownCSVController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"auth gridMenu");K.oo('method',"e_initHTML",function(){this.view.initHTML();});K.oo('method',"e_fileMenuClicked",function(name,jqObject){var downloadMode=null;if(name=='file > download')downloadMode='normal';if(name=='file > downloadDev')downloadMode='developer';if(name=='file > downloadVotes')downloadMode='votes';if(downloadMode){if(jqObject.parent().hasClass('disabled'))return;if(jqObject.find('form').length==0){}
switch(this.data.downloadable()){case'FULLY':this.downloadData(downloadMode);break;case'PARTLY':if(window.confirm(_("The table you are downloading contains some data from a secondary source that is not available for download.  Your downloaded file may be incomplete compared to what you see here.  Do you still want to download this file?")))this.downloadData(downloadMode);break;default:sci.website.error('This table is not available for download.');}}});K.oo('method',"e_userLoggedIn",function(){this.view.updatePermissions();});K.oo('method',"getRichState",function(){return this.data.richState();});K.oo('method',"buildURL",function(mode){var url=this.data.workbenchUrl()+"/download/default.csv";var csaml=this.data.baseUrl()+'.csaml';if(!this.downloadFromCache())url=csaml;if(mode=='developer')url=csaml+'?developer_mode=true';if(mode=='votes')url=csaml+'?votes=true'
return url;});K.oo('method',"downloadFromCache",function(){return this.actions.isSimple();});K.oo('method',"downloadData",function(mode){var url=this.buildURL(mode);if(url.match(/^\/ts\//)){document.location=url;}else{var richState=this.getRichState();this.view.buildForm(url,richState);this.view.submitForm();}});})(Grid0.DownCSVController,Grid0);JS2.OO.createClass("Grid0.DownCSVView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','gridMenu auth mainHeader');K.oo('method',"initHTML",function(){this.jq=this.mainHeader.add(this.htmlCache.download());this.$download=this.jq.find('.downloadButton');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"downloadbutton",this.$download,null);this.$request=this.jq.find('.requestButton');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"requestbutton",this.$request,null);this.$downloadFormContainer=this.jq.find(".downloadForm");this.registerEvents();});K.oo('method',"registerEvents",function(){this.$download.click((function(self){return function(){self.controller.downloadData();}})(this));this.$request.click((function(self){return function(){key=self.data.workbenchUrl().replace("/t/","");window.location.href='/devtools/downloads?dataset='+key;}})(this));});K.oo('method',"e_dataLoaded",function(){this.updatePermissions();});K.oo('method',"updatePermissions",function(){if(this.auth.isAdmin()&&!grid.actions.containsJoin()){this.gridMenu.showMenuItem('file > downloadVotes');}else{this.gridMenu.hideMenuItem('file > downloadVotes');}
if(this.data.downloadable()!='FALSE'||sci.permissions.download_once){this.gridMenu.enableMenuItem('file > download');this.gridMenu.enableMenuItem('file > downloadDev');this.$download.show();this.$request.hide();this.gridMenu.view.jq.first('li.file li.download span').hide();}else{this.gridMenu.disableMenuItem('file > download');this.gridMenu.disableMenuItem('file > downloadDev');this.$download.hide();this.$request.show();this.gridMenu.view.jq.first('li.file li.download span').show();}});K.oo('method',"buildForm",function(url,richState){this.jqCSVForm=$(this.htmlCache.stateContainer(url,""));var $grid=this.jqCSVForm.first('input[name=grid]');$grid.val(richState);this.$downloadFormContainer.html(this.jqCSVForm);});K.oo('method',"submitForm",function(){this.jqCSVForm.submit();});})(Grid0.DownCSVView,Grid0);Grid0.DownCSVView.oo('setHTMLCache',{"download":function(){return"<div class='downloadCSV'><span class='featureButtonTiny downloadButton fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        <span class='icon'><\/span>        Download CSV      <\/a>    <\/span>  <\/span><\/span><div class='downloadForm hidden'><\/div><span class='featureButtonTiny requestButton fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Request Download      <\/a>    <\/span>  <\/span><\/span><\/div>"},"stateContainer":function(){return"<form action='"+arguments[0]+"' class='hidden' method='post'><input name='grid' type='hidden' value='"+arguments[1]+"' \/><input name='_event' type='hidden' value='DownloadAsCsv' \/><\/form>"}});JS2.OO.createClass("Grid0.ApiQuery");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"mainHeader");K.oo('method',"initHTML",function(){this.$link=this.mainHeader.add(this.htmlCache.link());this.$dialog=this.getDialog();this.$error=this.$dialog.first('.error');this.$success=this.$dialog.first('.success');this.$keys=this.$success.first('.keys');this.$query=this.$success.first('textarea');this.$test=this.$success.first('.test');this.$apigee=this.$success.first('.apigee');});K.oo('method',"getDialog",function(){return $(this.htmlCache.dialog()).dialog({title:"Get API Query",autoOpen:false,width:600,modal:true,resizable:false});});K.oo('method',"registerEvents",function(){this.$link.click((function(self){return function(){self.show();}})(this));this.$keys.change((function(self){return function(){self.setQuery();}})(this));});K.oo('method',"setQuery",function(){var host=document.location.host;if(m=host.match(/^www/)){host='api.factual.com';}else{host+='/api';}
var tableKey=this.data.dataset.key;var baseUrl="/v2/tables/"+tableKey+"/read";var paramsUrl=this.actions.getApiParams();var apiKey=this.$keys.val();var apiQuery="http://"+host+baseUrl+"?APIKey="+apiKey+paramsUrl;this.$query.text(apiQuery);this.populateTestLink();this.populateApigeeLink();this.$query[0].select();});K.oo('method',"populateTestLink",function(){this.$test.attr('href',this.$query.text());});K.oo('method',"populateApigeeLink",function(){var apigeePrefix="https://apigee.com/console?urlToTest=";this.$apigee.attr('href',apigeePrefix+this.$query.text());});K.oo('method',"show",function(){sci.apiKeys.getApiKeys({key_type:'server'},(function(self){return function(p){self.apiKeysLoaded(p);}})(this));});K.oo('method',"apiKeysLoaded",function(keys){if(keys.error){this.$success.hide();this.$error.html(keys.error).show();}else{this.$error.hide();this.$success.show();this.populateKeys(keys);this.setQuery();}
this.$dialog.dialog('open');});K.oo('method',"populateKeys",function(keys){var html=[];for(var it15=0,k,it15__arr=keys,it15__len=it15__arr.length;(k=it15__arr[it15])||it15<it15__len;it15++){var name=k[0];var key=k[1].key;html.push(this.htmlCache.key(key,name));}
this.$keys.html(html.join(''));});})(Grid0.ApiQuery,Grid0);JS2.OO.createClass("Grid0.ApiQueryEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.controller.initHTML();this.controller.registerEvents();});})(Grid0.ApiQueryEvents,Grid0);Grid0.ApiQuery.oo('setHTMLCache',{"link":function(){return"<div class='apiQuery'><span class='featureButtonTiny fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        <span class='icon'><\/span>        Get API Query      <\/a>    <\/span>  <\/span><\/span><\/div>"},"key":function(key,name){return"<option value='"+key+"'>"+name+"<\/option>"},"dialog":function(){return"<div class='apiQueryDialog'><div class='error'><\/div><div class='success'><div class='help'><span class='icon'><\/span><a href='http:\/\/wiki.developer.factual.com\/Server-API' target='_blank'>API Help<\/a><\/div><div class='selectKey'>Developer Key:<select class='keys'><\/select><a href='\/developers\/api_key' target='_blank'>manage my keys<\/a><\/div><div class='query'><span>READ from this table.&nbsp;<\/span><em>Reflects current filters and sorts.<\/em><textarea class='textArea' readonly=''><\/textarea><div class='buttons'><a class='test' target='_blank'>test<\/a>&nbsp;-&nbsp;<a class='apigee external' target='_blank'>develop in Apigee<\/a><\/div><\/div><\/div><\/div>"}});JS2.OO.createClass("Grid0.CloneController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.registerEvents();});K.oo('method',"registerEvents",function(){var self=this;this.view.jqSubmit.click(function(){self.submit();});});K.oo('method',"submit",function(){var self=this;var dsName=jQuery.trim(this.view.jqDSName.val());if(dsName.length==0){alert("Please supply the name of the new table");}else{if(this.auth.requireLogin(this))return;this.view.jqMessage.html('');var params={name:dsName,description:this.view.jqDSDesc.val(),tags:this.view.jqDSTags.val(),unlisted:!this.view.jqDsListed[0].checked,onError:function(){self.view.closeDialog();}};if(this.mode=='join'){this.data.publish(params);}else if(this.mode=='merge'){this.data.saveMerge(params);}else if(this.mode=='view'){this.data.saveView(params);}
this.view.jqSubmit.hide();this.view.jqSaving.show();}});K.oo('method',"e_dataLoaded",function(){if(this.actions.isTempMerge()){this.mode='merge';}else if(this.actions.isTempJoin()){this.mode='join';}});K.oo('method',"e_cloneSubmitted",function(res){this.view.jqSubmit[0].disabled=false;if((res+'').match(/^\d+$/))window.location.href='/tables/'+res;});K.oo('method',"e_fileMenuClicked",function(name,jqObject){if(jqObject.parent().hasClass('disabled'))return;if(name=='file > saveAs')this.saveAs();});K.oo('method',"saveAs",function(){if(this.actions.isTempMerge()){this.mode='merge';}else if(this.actions.isTempJoin()){this.mode='join';}else{this.mode='view';}
this.view.showDialog();});})(Grid0.CloneController,Grid0);JS2.OO.createClass("Grid0.CloneView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','mainFooter gridMenu auth');K.oo('member','dialogName','saveView');K.oo('method',"initHTML",function(){var jqFirstTab=$('.gridTabsContainer>ul>li:first');var dialogOptions={autoOpen:false,width:530,minWidth:530,height:250,minHeight:250,modal:true,draggable:false,title:'Save this view'}
this.jq=this.util.buildDialog(this.dialogName,this.htmlCache.main(),dialogOptions);this.jqForm=this.jq.find('form');this.jqDSName=this.jqForm.find('input[name    = "dsName"]');this.jqDSDesc=this.jqForm.find('textarea[name = "dsDesc"]');this.jqDSTags=this.jqForm.find('input[name    = "dsTags"]');this.jqDsListed=this.jqForm.find('input[name    = "dsListed"]');this.jqSubmit=this.jqForm.find('.submit');this.jqSaving=this.jqForm.find('.saving');this.jqMessage=this.jqForm.find('.message');var info=this.data.dataset;this.jqDSDesc.val(info.description);if(this.auth.isAdmin()){this.jqDSTags.val(info.tags);}else{this.jqForm.first('tr.tags').hide();this.jqForm.first('tr.tagsHelper').hide();}
var self=this;this.jqClose=this.jq.parents('.ui-dialog:first').first('.ui-dialog-titlebar-close');this.jqClose.click(function(){self.closeDialog();});});K.oo('method',"closeDialog",function(){this.jqSubmit.show();this.jqSaving.hide();});K.oo('method',"showDialog",function(){this.jq.dialog('open');this.auth.checkLogin(this.jqMessage);});})(Grid0.CloneView,Grid0);Grid0.CloneView.oo('setHTMLCache',{"button":function(){return"<span><b>Temporary View<\/b><\/span>"},"main":function(){return"<div class='explorer clone'><form><table><tr class='name'><td class='label'><span class='red'>*&nbsp;<\/span>New table name:<\/td><td class='input'><input class='textField ' name='dsName' onblur='s.blur(this)' onfocus='s.focus(this)' \/><\/td><\/tr><tr class='desc'><td class='label'>Description:<\/td><td class='input'><textarea class='textArea ' name='dsDesc' onblur='s.blur(this)' onfocus='s.focus(this)'><\/textarea><\/td><\/tr><tr class='tags'><td class='label'>Tags:<\/td><td class='input'><input class='textField ' name='dsTags' onblur='s.blur(this)' onfocus='s.focus(this)' \/><\/td><\/tr><tr class='tagsHelper'><td class='label'><\/td><td class='input'><ul class='helperText'><li>Separate each tag with a comma, and please do not use quotes.<\/li><li>For example:&nbsp;<em>ultraman, little monster, brown fox<\/em><\/li><\/ul><\/td><\/tr><br \/><tr class='sharing'><td class='label'>Other users can:<\/td><td class='input'><input checked='checked' class='checkBox ' name='dsListed' onblur='s.blur(this)' onfocus='s.focus(this)' type='checkbox' \/>find this table in search results<\/td><\/tr><\/table><center><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Create View      <\/a>    <\/span>  <\/span><\/span><div class='saving hidden' style='width: 100px'><div class='fact-spinner'>Saving ...<\/div><\/div><\/center><div class='message'><\/div><\/form><\/div>"}});JS2.OO.createClass("Grid0.InitiateJoinController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){var self=this;setTimeout(function(){self.initHTML();},500);});K.oo('method',"initHTML",function(){this.view.initHTML();this.registerEvents();this.searchType='all';this.view.searchType='all';this.query={};this.view.populate();});K.oo('method',"show",function(fieldId){this.buildJoinableFieldList();this.view.show();if(fieldId){this.view.showConsumerMode(fieldId);}else{this.view.showInitiateMode();}});K.oo('method',"showLoading",function(){this.view.jqLoading.show();});K.oo('method',"hideLoading",function(){this.view.jqLoading.hide();});K.oo('method',"setSearchType",function(){var type=this.view.jqTabContainer.find('.selected').is('.searchAll')?'all':'adv';this.searchType=type;this.view.searchType=type;});K.oo('method',"registerEvents",function(){var self=this;this.view.jqJoinField.click(function(){self.show(self.view.col.id);});this.view.jqDoneButton.click(function(e){if(!self.view.jqDoneButton.hasClass('disabled')){self.preview();self.view.hide();}});this.view.jqCloseButton.click(function(e){self.view.hide();});this.view.jqSearchButton.click(function(e){self.view.jqPage.val(1);self.search();});onEnterKey(this.view.jqSearchInput,function(){self.view.jqPage.val(1);self.search();});this.view.jqFindBox.selectionChanged(function(){self.view.grid.setRows([]);self.searchOnField(this);});this.view.jqPage.keydown(function(e){if(e.keyCode==KEYCODE.ENTER){self.search();}});this.view.jqNext.click(function(e){self.paginate(1);});this.view.jqPrev.click(function(e){self.paginate(-1);});this.view.jqTabContainer.click(function(){self.switchSearchType();});});K.oo('method',"switchSearchType",function(){this.setSearchType();this.view.jqSearchInput=this.view.jqPaneContainer.find('.'+this.searchType).find('.srchText');this.togglePagination();if(this.searchType=='all'){this.view.clearPossibleJoins();}
this.view.jqPage.val(1);this.search();});K.oo('method',"togglePagination",function(){if(this.searchType=='all'){this.view.jqPagination.show();}else{this.view.jqPagination.hide();}});K.oo('method',"paginate",function(move){var page=parseInt(this.view.jqPage.val());var total=parseInt(this.view.jqTotal.text());if(page>0&&total>0){var newPage=page+move;if((newPage<=total)&&(newPage>=1)){this.view.jqPage.val(newPage);this.search();}}});K.oo('method',"searchOnField",function(target){var selectedVal=target.value();this.joinTo=target.innerHtml().replace(/\s<cite>.*$/,'');var q=this.joinTo;if(selectedVal==0){this.joinOn='pk_pk';}else{var field=this.schema.getFieldInfo(selectedVal);if(field.isPrimary){this.joinOn='pk_fk';}else{this.joinOn='fk_pk';}}
this.view.joinOn=this.joinOn;this.view.jqFoundText.html('');if(this.searchType=='adv'){if(this.view.possibleJoins){this.view.toggleAdvResults();this.view.showFoundText(this.view.possibleJoins[selectedVal],this.joinTo);}}else{this.view.jqSearchInput.val('');this.view.jqPage.val(1);this.search();}});K.oo('method',"buildJoinableFieldList",function(){var cols=this.schema.columns();var items=[];if(this.schema.currentDataset()&&this.schema.currentDataset().pks().length>1){this.view.compoundPk=true;items.push([0,"Complete Subject",'completeSubject']);}
for(var i=0,c;c=cols[i];i++){if(c.datasetId==this.actions.primaryDatasetId()){var name=sci.common.htmlDisplay(c.name);if(c.isPrimary)items.push([c.id,name,'primarySelection']);else items.push([c.id,name]);}}
this.view.jqFindBox.clear();this.view.jqFindBox.items(items);});K.oo('method',"e_joinDetailClosed",function(){this.view.jqDialog.dialog('moveToTop',true);});K.oo('method',"preview",function(){this.data.join(this.view.joinOn,this.view.fields,this.view.datasetsHash);this.notify('actionsModified');});K.oo('method',"advSearch",function(q){this.query['adv']=q;var idInfo=sci.common.getIdInfo(q);var idType=idInfo.type;var searchDatasetOrId=idInfo.id;if(idType!="datasets"){alert("Please enter a valid factual url");return;}
if(searchDatasetOrId<=0){searchDatasetOrId=q;}
this.data.advSearchFields(searchDatasetOrId);this.showLoading();});K.oo('method',"search",function(){this.view.grid.setRows([]);var q=this.view.jqSearchInput.val();q=q.replace(/\s+$/,"");if(this.searchType=='adv'){if(q)this.advSearch(q);return;}else{this.query['all']=q;}
var page=parseInt(this.view.jqPage.val());var total=parseInt(this.view.jqTotal.text());var limit=parseInt(this.view.jqLimit.value());if(!page||!total||!limit){alert('Invalid Page Range!');return;}
if(page>total){alert('Invalid Page Range!');return;}
if(limit<1){alert('Invalid Limit value!');return;}
var params={};params.q=q;params.page=parseInt(this.view.jqPage.val());params.page=params.page>0?params.page:1;params.limit=limit;params.field_id=this.view.jqFindBox.value();params.join_on=this.view.joinOn;this.data.searchFields(params);this.showLoading();if(this.view.grid){this.view.grid.notify('alert',"Searching Fields...");}});K.oo('method',"e_searchFieldResultsLoaded",function(data){this.hideLoading();this.view.jqFoundText.html('');if(data.error){this.view.jqFoundText.html(data.error);return;}
data.joinTo=this.joinTo;data.joinOn=this.view.joinOn;this.view.showResults(data);this.setSearchType();this.togglePagination();});K.oo('method',"addingJoinField",function(data){this.view.setClickField(data);this.view.addingJoinField();});K.oo('method',"initialize",function(options){});})(Grid0.InitiateJoinController,Grid0);JS2.OO.createClass("Grid0.InitiateJoinView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','header columnMenu gridMenu');K.oo('member','dialogName','joinDataset');K.oo('member','LIMIT_OPTIONS',[[200,200],[400,400]]);K.oo('method',"showConsumerMode",function(fieldId){this.jqFindBox.selectValue(fieldId);this.jqHeader.addClass('consumer');});K.oo('method',"showInitiateMode",function(){this.jqFindBox.selectIndex(0);this.jqHeader.removeClass('consumer');});K.oo('method',"e_showColumnMenu",function(){this.col=this.header.contexts.click.col;});K.oo('method',"initHTML",function(){this.jqJoinField=this.columnMenu.addItem('Find related data','joinField');this.jqJoinField.hide();var self=this;var dialogOptions={width:600,minWidth:600,height:460,minHeight:460,maxHeight:460,title:this.htmlCache.title(),modal:true,autoOpen:false,resize:function(event,ui){self.resizeGrid();}};this.jqDialog=this.util.buildDialog(this.dialogName,this.htmlCache.main(),dialogOptions);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Dialog",this.jqDialog,null);this.jqDoneButton=this.jqDialog.find('.btnDone');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Submit",this.jqDoneButton,null);this.jqCloseButton=this.jqDialog.find('.btnCancel');this.jqPagination=this.jqDialog.find('.pagination');this.jqSimpleGrid=this.jqDialog.find('.miniGrid');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Grid",this.jqSimpleGrid,null);this.jqGridBody=this.jqSimpleGrid.find('.universe');this.jqHeader=this.jqDialog.first('.header');this.jqJoinTo=this.jqHeader.first('table.joinTo');this.jqFind=this.jqJoinTo.first('.find');this.jqFindBox=new Sci.SelectBox(this.jqFind);this.jqSearchInput=this.jqDialog.find('.srchText');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Search Input",this.jqSearchInput,null);this.jqSearchButton=this.jqDialog.find('.srchButton');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Search Button",this.jqSearchButton,null);this.jqFoundText=this.jqDialog.find('.foundText');this.jqAdvToggle=this.jqDialog.find('.toggleAdv');this.jqAdvSearchButton=this.jqDialog.find('.sample');this.jqPage=this.jqDialog.find('.page');this.jqTotal=this.jqDialog.find('.total');this.jqNext=this.jqDialog.find('.next').hide();this.jqNextDisabled=this.jqDialog.find('.nextDisabled');this.jqPrev=this.jqDialog.find('.prev').hide();this.jqPrevDisabled=this.jqDialog.find('.prevDisabled');this.jqMiniList=this.jqDialog.find('.miniList');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Fields",this.jqMiniList,null);this.jqSelectedFields=this.jqDialog.find('.miniList>.fields');this.jqTabContainer=this.jqDialog.find('.searchType');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Search Type",this.jqTabContainer,null);this.jqPaneContainer=this.jqDialog.find('.searchPanes');this.jqLoading=this.jqDialog.find('.loading');this.jqMessage=this.jqDialog.find('.loginMessage');var self=this;this.tabHandler=new Sci.TabHandler(this.jqTabContainer,this.jqPaneContainer,{alreadyBuilt:true});var changeLimit=function(){self.changeLimit();};this.jqLimit=new Sci.SelectBox(this.jqDialog.find('.limit'),{selChangeCallBack:changeLimit});this.fields=[];this.datasetsHash={};this.jqPage.val(1);this.jqLimit.items(this.LIMIT_OPTIONS);this.jqLimit.setIndex(0);this.initGrid();});K.oo('method',"changeLimit",function(){this.jqPage.val(1);this.controller.search();});K.oo('method',"hide",function(){this.jqDialog.dialog('close');});K.oo('method',"initGrid",function(){this.grid=APP(GridJoinSearch,{seed:this.jqSimpleGrid,height:140});this.grid.start();this.grid.setColumns([{name:'',width:50,datatype:'String'},{name:'Field Name',width:240,datatype:'String'},{name:'Source Table',width:260,datatype:'String'},{name:'Subject?',width:100,datatype:'String'}]);this.jqGridBody.hide();var adapter=new JoinSearchRsGridAdapter(this.controller);this.grid.addEventAdapter(adapter);});K.oo('method',"resizeGrid",function(){var width=this.jqDialog.width()-2;this.jqSimpleGrid.css('width',width);});K.oo('method',"setClickField",function(data){this.clickField={};this.clickField.fieldId=data[0];this.clickField.fieldName=data[1];this.clickField.datasetId=data[2];this.clickField.datasetName=data[3];this.clickField.rightFieldId=data[4];});K.oo('method',"populate",function(){var infos=this.actions.getJoinFieldsInfo();for(var it43=0,info,it43__arr=infos,it43__len=it43__arr.length;(info=it43__arr[it43])||it43<it43__len;it43++){var field=info.field;var datasetInfo=info.datasetInfo;this.addJoinField(field,datasetInfo);}});K.oo('method',"addingJoinField",function(){if(this.fieldExists(this.clickField.fieldId)){alert('This field has already been added.');return;}
var selectedVal=this.jqFindBox.value();if((this.searchType=='adv')&&(selectedVal>0)){var datasetInfo=this.datasetsHash[this.clickField.datasetId];if(datasetInfo){this.addJoinField(this.clickField,datasetInfo);return;}
var field=this.schema.getFieldInfo(selectedVal);var params={};params.joinOn=this.joinOn;params.clickField=this.clickField;params.foundField=this.foundFields[this.clickField.fieldId];params.joinToField=field;this.notify('loadJoinDetails',params);return;}
this.addJoinFieldDirectly();});K.oo('method',"addJoinFieldDirectly",function(){var selectedVal=this.jqFindBox.value();var datasetInfo={joinType:'join-outer-left'};datasetInfo.datasetId=this.clickField.datasetId;datasetInfo.leftFieldId=selectedVal;datasetInfo.rightFieldId=this.clickField.rightFieldId;this.addJoinField(this.clickField,datasetInfo);});K.oo('method',"showFoundText",function(count,joinTo){this.jqFoundText.html('');var html=this.htmlCache.found(count,joinTo);this.jqFoundText.html(html);});K.oo('method',"showResults",function(data){var fields=data.fields;if(!fields)return;var totalCount=data.total_count;var pages=data.pages;var page=data.page;this.joinTo=data.joinTo;this.joinOn=data.joinOn;this.jqTotal.html(pages);this.buildGrid(fields);this.possibleJoins=data.possible_joins;this.showAllResults();this.showPossibleJoins();if(this.searchType=='adv'){this.showFoundText(this.possibleJoins[this.jqFindBox.value()],this.joinTo);}else{this.showFoundText(totalCount,this.joinTo);}
if(page==1){this.jqPrev.hide();this.jqPrevDisabled.show();}else{this.jqPrev.show();this.jqPrevDisabled.hide();}
if(page==pages){this.jqNext.hide();this.jqNextDisabled.show();}else{this.jqNext.show();this.jqNextDisabled.hide();}});K.oo('method',"showPossibleJoins",function(){this.clearPossibleJoins();if(this.possibleJoins){var sel=this.jqFindBox.value();var items=this.jqFindBox.options;for(var it44=0,item,it44__arr=items,it44__len=it44__arr.length;(item=it44__arr[it44])||it44<it44__len;it44++){item[1]+=' <cite>('+this.possibleJoins[item[0]]+')</cite>';}
this.jqFindBox.items(items);this.jqFindBox.setValue(sel);this.toggleAdvResults();}});K.oo('method',"showAllResults",function(){this.jqSimpleGrid.find('.body').show();});K.oo('method',"toggleAdvResults",function(){var sel=this.jqFindBox.value();if(this.possibleJoins&&this.possibleJoins[sel]==0){this.jqSimpleGrid.find('.body').hide();}else{this.jqSimpleGrid.find('.body').show();}});K.oo('method',"clearPossibleJoins",function(){var sel=this.jqFindBox.value();var items=this.jqFindBox.options;for(var it45=0,item,it45__arr=items,it45__len=it45__arr.length;(item=it45__arr[it45])||it45<it45__len;it45++){item[1]=item[1].replace(/\s<cite>.*$/,'');}
this.jqFindBox.items(items);this.jqFindBox.setValue(sel);});K.oo('method',"buildGrid",function(fields){this.foundFields={};var rows=[];for(var it46=0,f,it46__arr=fields,it46__len=it46__arr.length;(f=it46__arr[it46])||it46<it46__len;it46++){this.foundFields[f.fieldId]=f;var newRow=[];newRow[0]=[];newRow[0][0]=f.fieldId;newRow[0][1]=f.rightFieldId;newRow[1]=f.fieldName;newRow[2]=[];newRow[2][0]=f.datasetId;newRow[2][1]=f.datasetName;newRow[2][2]=f.isPrivate;newRow[3]=f.isPrimary?'yes':'no';rows.push(newRow);}
this.grid.clear();this.grid.setRows(rows);});K.oo('method',"show",function(){this.jqDialog.dialog('open');});K.oo('method',"e_addJoinField",function(datasetInfo){var selectedVal=this.jqFindBox.value();var field=this.schema.getFieldInfo(selectedVal);datasetInfo.leftFieldId=selectedVal;this.addJoinField(this.clickField,datasetInfo);});K.oo('method',"addJoinField",function(field,datasetInfo){this.fields.push({qfieldId:field.fieldId,datasetId:field.datasetId});this.datasetsHash[field.datasetId]=datasetInfo;var html=this.htmlCache.selectedField(field.fieldId,field.fieldName,field.datasetName);var jqField=$(html);this.jqSelectedFields.append(jqField);var self=this;jqField.find('.listButton').click(function(){jqField.remove();self.removeField(field.fieldId);});this.jqDoneButton.removeClass('disabled');});K.oo('method',"fieldExists",function(fId){for(var it47=0,f,it47__arr=this.fields,it47__len=it47__arr.length;(f=it47__arr[it47])||it47<it47__len;it47++){if(f.qfieldId==fId)return true;}
return false;});K.oo('method',"removeField",function(fId){var newFields=[];var newDatasetsHash={};for(var it48=0,f,it48__arr=this.fields,it48__len=it48__arr.length;(f=it48__arr[it48])||it48<it48__len;it48++){if(f.qfieldId!=fId){newFields.push(f);newDatasetsHash[f.datasetId]=this.datasetsHash[f.datasetId];}}
this.fields=newFields;this.datasetsHash=newDatasetsHash;if(this.fields.length==0)this.jqDoneButton.addClass('disabled');});K.oo('method',"clearList",function(){this.fields=[];this.datasetsHash={};this.jqSelectedFields.empty();});K.oo('method',"e_improveMenuClicked",function(name,jqObject){if(name=='improve > joinDataset'){if(jqObject.parent().hasClass('disabled'))return;this.controller.show();}});K.oo('method',"e_userLoggedIn",function(){if(this.auth.isAdmin()||this.data.isOwner()){this.gridMenu.enableMenuItem('improve > joinDataset');}});})(Grid0.InitiateJoinView,Grid0);JS2.OO.createClass("JoinSearchRsGridAdapter");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(controller){this.controller=controller;});K.oo('method',"e_addingJoinField",function(data){this.controller.addingJoinField(data);});})(JoinSearchRsGridAdapter,null);JS2.OO.createClass("GridJoinSearch.Main");GridJoinSearch.Main.oo('extends',GridSimple.Main);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','components',['Main','Data','Body']);K.oo('member','core',['Data']);K.oo('method',"addEventAdapter",function(adapter){this.notifier.register(adapter);});})(GridJoinSearch.Main,GridJoinSearch);JS2.OO.createClass("GridJoinSearch.Data");GridJoinSearch.Data.oo('extends',GridSimple.Data);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_clickCell",function(context){if(context.colIdx==0){var data=[];var row=this.rows[context.rowIdx];data.push(row[0][0]);data.push(row[1]);data.push(row[2][0]);data.push(row[2][1]);data.push(row[0][1]);this.notify('addingJoinField',data);}});})(GridJoinSearch.Data,GridJoinSearch);JS2.OO.createClass("GridJoinSearch.BodyController");GridJoinSearch.BodyController.oo('extends',GridSimple.BodyController);(function(K,Package){var self=K;var _super=JS2.OO['super'];})(GridJoinSearch.BodyController,GridJoinSearch);JS2.OO.createClass("GridJoinSearch.BodyView");GridJoinSearch.BodyView.oo('extends',GridSimple.BodyView);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"getCellData",function(colIdx,rowIdx){if(colIdx==0){var fieldId=this.data.rows[rowIdx][0][0];var rightFieldId=this.data.rows[rowIdx][0][1];return'<a class="addJoinField" fieldId="'+fieldId+'" rightFieldId="'+rightFieldId+'">add</a>';}
if(colIdx==2){datasetType=this.data.rows[rowIdx][2][2]?'private':'standard';return'<div class="'+datasetType+'">'+
DISPLAY.datatype('String',this.data.rows[rowIdx][2][1])+'</div>';}
return _super(this,colIdx,rowIdx);});})(GridJoinSearch.BodyView,GridJoinSearch);Grid0.InitiateJoinView.oo('setHTMLCache',{"title":function(){return"Join fields from related tables"},"selectedField":function(){return"<div class='listRow h'><div class='listText' fieldId='"+arguments[0]+"'>"+arguments[1]+"("+arguments[2]+")<\/div><div class='listButton h'><\/div><\/div>"},"found":function(){return"Found&nbsp;<strong>"+arguments[0]+"<\/strong>&nbsp;fields related to&nbsp;<strong>"+arguments[1]+"<\/strong>&nbsp;can be added to your table&nbsp;:"},"main":function(){return"<div class='joinDataset'><div class='header'><table class='joinTo'><tr><td>Find more facts related to:<\/td><td><div class='find'><\/div><\/td><\/tr><\/table><ul class='searchType'><li class='searchAll selected'><a>Search all Joinable Tables<\/a><\/li><li class='searchDataset'><a>Search for a Specific Table<\/a><\/li><\/ul><\/div><div class='foundText clear'><\/div><div class='searchPanes'><div class='all pane'><table><tr><td class='label'>Find field names containing:<\/td><td class='search'><div><input class='srchText' type='text' \/><input class='srchButton' type='button' \/><\/div><\/td><\/tr><\/table><\/div><div class='adv pane hidden'><table><tr><td class='label'>Retrieve fields to join to by specific id or url:<\/td><td class='search'><div><input class='srchText' type='text' \/><input class='srchButton' type='button' \/><\/div><\/td><\/tr><\/table><\/div><\/div><div class='clear'><\/div><div class='miniGrid'><\/div><div class='pagination'><span>rows per page<\/span><div class='limit'><\/div><div class='verbiage'><div class='prev h p'><\/div><div class='prevDisabled hidden'><\/div><input class='page tinyInput' \/><span>\/<\/span><span class='total'>1<\/span><div class='next h p'><\/div><div class='nextDisabled hidden'><\/div><\/div><\/div><div class='clear'><\/div><div>You have chosen to add data from the following fields to your table:<\/div><div class='miniList'><div class='fields'><\/div><\/div><div class='buttons'><span class='btnDone disabled fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Initiate Join      <\/a>    <\/span>  <\/span><\/span><span class='btnCancel fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Cancel      <\/a>    <\/span>  <\/span><\/span><\/div><div class='loginMessage'><\/div><div class='loading'><div class='message'><strong>Retrieving data ...<\/strong><\/div><\/div><\/div>"}});JS2.OO.createClass("Grid0.JoinDetails");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dialogName','joinDetails');K.oo('method',"e_initHTML",function(){var html=this.htmlCache.joinDetails();var dialogOptions={width:450,height:315,title:'Join Details',modal:true,autoOpen:false,draggable:false};this.jqDialog=this.util.buildDialog(this.dialogName,html,dialogOptions);this.jqJoinTable=this.jqDialog.find('.joinTable');this.jqJoinTo=this.jqDialog.find('.joinTo');this.jqDefineFk=this.jqDialog.find('.defineFk');this.jqFkFields=this.jqDefineFk.find('.fields');this.jqJoinTypeSection=this.jqDialog.find('div.joinType');this.jqJoinType=this.jqJoinTypeSection.find('select.joinType');this.jqSecondaryDone=this.jqDialog.find('.btnDone');this.jqSecondaryCancel=this.jqDialog.find('.btnCancel');var self=this;this.jqSecondaryDone.click(function(e){var datasetInfo=self.getDatasetInfo();if(datasetInfo.rightFieldId===null){alert("please select one field!");return;}
self.notify('addJoinField',datasetInfo);self.hide();});this.jqSecondaryCancel.click(function(e){self.hide();});});K.oo('method',"showSecondaryDialog",function(){this.jqDialog.dialog('open');});K.oo('method',"hide",function(){this.jqDialog.dialog('close');this.notify('joinDetailClosed');});K.oo('method',"e_loadJoinDetails",function(params){this.joinOn=params.joinOn;this.clickField=params.clickField;this.foundField=params.foundField;this.joinToField=params.joinToField;this.load();});K.oo('method',"load",function(){this.jqJoinTable.html(this.foundField.datasetName);this.jqJoinTo.html(this.joinToField.name);this.jqFkFields.empty();var baseDatatype=this.consistNumeric(this.joinToField.datatype);for(var it40=0,f,it40__arr=this.foundField.datasetFields,it40__len=it40__arr.length;(f=it40__arr[it40])||it40<it40__len;it40++){var isFact=!f[3];if(f[2]==baseDatatype){if((this.joinOn=='fk_pk')&&isFact)continue;var html=this.htmlCache.fkField(f[0],sci.common.htmlEscape(f[1]));this.jqFkFields.append(html);}}
if(this.jqFkFields.html()==''){alert('There is no field as "'+baseDatatype+'" in the source table');return;}else{this.jqFkRadios=this.jqFkFields.find('.fkRadio');this.jqFkRadios[0].checked=true;this.jqDefineFk.show();}
this.jqJoinTypeSection.show();this.showSecondaryDialog();});K.oo('method',"getFkFieldId",function(){return sci.common.getRadioValue(this.jqFkRadios);});K.oo('method',"getJoinType",function(){return this.jqJoinType.val();});K.oo('method',"getDatasetInfo",function(){var datasetInfo={};datasetInfo.joinOn=this.joinOn;datasetInfo.joinType=this.getJoinType();datasetInfo.rightFieldId=this.getFkFieldId();return datasetInfo;});K.oo('method',"consistNumeric",function(datatype){if((datatype=='Integer')||(datatype=='Double')){return'Numeric';}else{return datatype;}});})(Grid0.JoinDetails,Grid0);Grid0.JoinDetails.oo('setHTMLCache',{"fkField":function(){return"<div class='fkField'><input class='fkRadio' name='fk' type='radio' value='"+arguments[0]+"'>"+arguments[1]+"<\/input><\/div>"},"joinDetails":function(){return"<div class='joinDetails'><div class='defineFk'><div class='prompt'>Select which field from the table<strong class='joinTable'><\/strong>best matches\"<strong class='joinTo'><\/strong>\"<\/div><div class='box'><div class='fields'><\/div><div class='clear'><\/div><\/div><\/div><div class='joinType'><div class='prompt'>Your new table's rows will be composed of:<\/div><select class='joinType'><option value='join-outer-left'>Only the rows from the original table<\/option><option value='join-inner'>Rows with a common subject label<\/option><\/select><\/div><div class='clear' style='margin-bottom:10px;'><\/div><center class='buttons'><span class='btnDone fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Done      <\/a>    <\/span>  <\/span><\/span><span class='btnCancel fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Cancel      <\/a>    <\/span>  <\/span><\/span><\/center><div class='clear' style='margin-bottom:10px;'><\/div><\/div>"}});JS2.OO.createClass("Grid0.HideColumn");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','columnMenu header');K.oo('method',"e_initHTML",function(){var self=this;this.jqHideColumnButton=this.columnMenu.addItem('Hide this field','hideColumn');this.jqHideColumnButton.click(function(){self.hideColumn();});this.jqHideColumnButton.hide();});K.oo('method',"e_showColumnMenu",function(){this.col=this.header.contexts.click.col;});K.oo('method',"hideColumn",function(){this.col.hidden=true;var v_params={table_id:this.col.datasetId,field_id:this.col.id,isVisible:false};$.post('/logging',{_event:'SetFieldVisibility',_event_params:JSON.stringify(v_params)});this.notify('resizeWidth');this.notify('viewModified');});})(Grid0.HideColumn,Grid0);JS2.OO.createClass("Grid0.VotePresentation");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','modes',{uvo:'<strong>Your value only</strong>',cvo:'Consensus value only',uvf:'<strong>Your value</strong> (consensus value)',cvf:'Consensus value (<strong>your value</strong>)'});K.oo('method',"changeMode",function(m){this.data.changeVotePresentMode(m);this.notify('viewModified');});K.oo('method',"e_displayMenuClicked",function(name,jqObject){var mode=$.trim(name.split('>')[1]);if(this.modes[mode]){this.changeMode(mode);}});})(Grid0.VotePresentation,Grid0);JS2.OO.createClass("ValueSelector");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.topOffset=0;this.leftOffset=0;this.jq=$(this.htmlCache.main());this.jqGrid.first('>.body').append(this.jq);this.hide();this.jqValue=this.jq.first('.voteValue');this.jqClose=this.jq.first('.smallClose');this.messages={agree:this.jqValue.first('a.agree'),update:this.jqValue.first('a.update'),change:this.jqValue.first('a.change')};this.registerEvents();});K.oo('method',"registerEvents",function(){var self=this;this.jqValue.click(function(){self.submit();});this.jqClose.click(function(){self.hide();});});K.oo('method',"e_clickCell",function(context){this.context=context;if(this.data.isVoteValueColumn(context.colIdx)){var params={valueSelector:this,values:this.data.getValues(context.rowIdx)};this.notify('showValueSelector',params);}else{if(context.jqTarget.is('a')&&this.data.isVoteCountColumn(context.colIdx)){this.notify('showRollupHistory',this.data.getValues(context.rowIdx));}}});K.oo('method',"e_vScroll",function(p){this.hide();this.topOffset=p.top;});K.oo('method',"e_hScroll",function(p){this.hide();this.leftOffset=p.left;});K.oo('method',"e_dataLoaded",function(){this.hide();});K.oo('method',"submit",function(){this.hide();var rowIdx=this.context.rowIdx;this.notify('rollupValueSelected',{messageType:this.messageType,vals:this.data.getValues(rowIdx)});});K.oo('method',"hide",function(){this.jq.removeClass('showing');});K.oo('method',"setPosition",function(){var pos=this.dim.getCellPosition(this.context.colIdx,this.context.rowIdx);this.jq.css({left:pos.left-this.leftOffset+5,top:pos.top-this.topOffset-10});});K.oo('method',"show",function(messageType){this.messageType=messageType;this.setPosition();this.showMessage(messageType);this.jq.addClass('showing');});K.oo('method',"showMessage",function(messageType){for(message in this.messages){if(message==messageType){this.messages[message].show();}else{this.messages[message].hide();}}});})(ValueSelector,null);ValueSelector.oo('setHTMLCache',{"main":function(){return"<div class='valueSelector'><div class='voteValue'><a class='change'>change my latest input to agree with this<\/a><a class='update'>update my current input<\/a><a class='agree'>agree with this<\/a><\/div><div class='smallClose'><\/div><\/div>"}});JS2.OO.createClass("GridExplorerAdapter");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(controller){this.controller=controller;});K.oo('method',"e_showRollupHistory",function(vals){this.controller.view.tabs.tabs('select',0);this.controller.view.filterHistory(vals);});K.oo('method',"e_rollupValueSelected",function(params){this.controller.view.gridValueSelected(params);});K.oo('method',"e_showValueSelector",function(params){var valueSelector=params.valueSelector;var values=params.values;var userValues=this.controller.getUserValues();var equivalent=this.equivalent(userValues,values);var messageType='change';if(equivalent==-1){messageType='agree';}
else if(equivalent==0){messageType='update';}
valueSelector.show(messageType);});K.oo('method',"e_showFullComment",function(value){this.controller.view.showFullComment(value);});K.oo('method',"e_showFullSource",function(value){this.controller.view.showFullSource(value);});K.oo('method',"equivalent",function(userValues,values){var voted=false;var equivalent=true;for(var i=0;i<values.length;i++){if(userValues[i]||userValues[i]==0)voted=true;if(userValues[i]==values[i])equivalent=false;}
if(!voted)return-1;return equivalent?1:0;});K.oo('method',"e_reportAbuser",function(userId){this.controller.data.reportAbuser(userId);});K.oo('method',"e_addToWhiteList",function(userId){this.controller.data.addToWhiteList(userId);});K.oo('method',"e_addToBlackList",function(userId,reason){this.controller.data.addToBlackList(userId,reason);});})(GridExplorerAdapter,null);JS2.OO.createClass("GridExplorerAppBase.ValueSelector");GridExplorerAppBase.ValueSelector.oo('extends',ValueSelector);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){this.parent=options.parent;this.auth=(this.parent)?this.parent.auth:null;this.noAbuse=options.noAbuse;});K.oo('method',"e_initHTML",function(){this.topOffset=0;this.leftOffset=0;this.jq=$(this.htmlCache.main());this.jqGrid.first('>.body').append(this.jq);this.hide();this.jqValue=this.jq.first('.voteValue');this.jqClose=this.jq.first('.smallClose');this.messages={agree:this.jqValue.first('a.agree'),update:this.jqValue.first('a.update'),change:this.jqValue.first('a.change')};this.jqReportAbuse=this.jq.first('.reportAbuse');this.jqWhiteList=this.jq.first('.whiteList');this.jqBlackList=this.jq.first('.blackList');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"blacklist link",this.jqBlackList,null);this.buildAbuseDialog();this.registerEvents();});K.oo('method',"buildAbuseDialog",function(){var self=this;this.jqAbuseDialog=$('<div><textarea class="abuseReason">please input the reason.</textarea></div>');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"abuse dialog",this.jqAbuseDialog,null);this.jqAbuseReason=this.jqAbuseDialog.first('textarea');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"abuse reason",this.jqAbuseReason,null);this.jqAbuseReason.toggleInput();this.abuseDialog=this.jqAbuseDialog.dialog({autoOpen:false,buttons:{'Done':function(){self.addToBlackList();}},height:160,width:320,resizable:false,modal:true,dialogClass:'abuseReason',title:'Reason'});this.jqDone=this.jqAbuseDialog.parent().find('button');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"done",this.jqDone,null);});K.oo('method',"registerEvents",function(){_super(this);var self=this;this.jqReportAbuse.click(function(){self.reportAbuser();});this.jqWhiteList.click(function(){self.addToWhiteList();});this.jqBlackList.click(function(){self.abuseDialog.dialog('open');});});K.oo('method',"show",function(messageType){_super(this,messageType);this.showExtLinksByUser();});K.oo('method',"hide",function(){this.jq.removeClass('showing');this.jq.removeClass('force');});K.oo('method',"showExtLinksByUser",function(){this.jqReportAbuse.hide();this.jqWhiteList.hide();this.jqBlackList.hide();this.jq.removeClass('force');if(this.noAbuse)return;var hasExtLinks=false;if(this.auth.userId()==this.getVoterId())return;if(!this.auth.loggedIn())return;this.jqReportAbuse.show();if(this.auth.isDev()||this.auth.isAdmin())this.jqWhiteList.show();if(this.auth.isAdmin())this.jqBlackList.show();this.jq.addClass('force');});K.oo('method',"reportAbuser",function(){if(!confirm('Are you sure you want to report this user?'))return;this.notify('reportAbuser',this.getVoterId());this.hide();});K.oo('method',"addToWhiteList",function(){if(!confirm('Are you sure you want to whitelist this user?'))return;this.notify('addToWhiteList',this.getVoterId());this.hide();});K.oo('method',"addToBlackList",function(){if(!confirm('Are you sure you want to blacklist this user?'))return;var reason=this.jqAbuseReason.toggleInput('val');this.notify('addToBlackList',this.getVoterId(),reason);this.hide();this.abuseDialog.dialog('close');});K.oo('method',"getVoterId",function(){return this.data.rows[this.context.rowIdx][0][0];});})(GridExplorerAppBase.ValueSelector,GridExplorerAppBase);JS2.OO.createClass("GridExplorerAppBase.ToolTip");GridExplorerAppBase.ToolTip.oo('extends',ValueSelector);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.htmlCache=this.klass.oo('super','htmlCache');;_super(this);this.jq.html("<div class=\"miniTooltip\">Clicking on this comment will let you see the comment in its entirety.</div>");});K.oo('method',"e_clickCell",function(context){var source=this.data.getSource(context.rowIdx);var comment=this.data.getComment(context.rowIdx);if(source!=''&&this.data.isVoteSourceColumn(context.colIdx)){this.notify('showFullSource',source);}
if(comment!=''&&this.data.isVoteCommentColumn(context.colIdx)){this.notify('showFullComment',comment);}});K.oo('method',"e_mouseoverCell",function(context){var self=this;this.context=context;if(this.data.isVoteCommentColumn(context.colIdx)&&this.data.getComment(context.rowIdx)!=''){this.timeout=setTimeout(function(){self.show();},500);}});K.oo('method',"e_mouseoutCell",function(){if(this.timeout){clearTimeout(this.timeout);this.timeout=null;}
this.hide();});K.oo('method',"setPosition",function(){var pos=this.dim.getCellPosition(this.context.colIdx,this.context.rowIdx);this.jq.css({left:pos.left-this.leftOffset-this.jq.width()+15,top:pos.top-this.topOffset-this.jq.height()+35});});K.oo('method',"show",function(){this.setPosition();this.jq.addClass('showing');});})(GridExplorerAppBase.ToolTip,GridExplorerAppBase);JS2.OO.createClass("GridExplorerAppBase.Main");GridExplorerAppBase.Main.oo('extends',GridSimple.Main);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','components',['Main','Data','Body','ValueSelector','ToolTip']);K.oo('member','core',['Data']);K.oo('member','dependencies','notifier');K.oo('method',"addEventAdapter",function(adapter){this.notifier.register(adapter);});K.oo('method',"setReadonly",function(votable){votable?this.jqGrid.removeClass('readonly'):this.jqGrid.addClass('readonly');});K.oo('method',"setColumnDatatype",function(colIdx,datatype){this.data.columns[colIdx].datatype=datatype;});})(GridExplorerAppBase.Main,GridExplorerAppBase);JS2.OO.createClass("GridExplorerAppBase.Data");GridExplorerAppBase.Data.oo('extends',GridSimple.Data);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"isVoteValueColumn",function(colIdx){return this.columns[colIdx].columnType=='voteValue';});K.oo('method',"isVoteCountColumn",function(colIdx){return this.columns[colIdx].columnType=='voteCount';});K.oo('method',"isVoterLinkColumn",function(colIdx){return this.columns[colIdx].columnType=='voterLink';});K.oo('method',"isVoteDateColumn",function(colIdx){return this.columns[colIdx].columnType=='voteDate';});K.oo('method',"isVoteSourceColumn",function(colIdx){return this.columns[colIdx].columnType=='voteSource';});K.oo('method',"isVoteCommentColumn",function(colIdx){return this.columns[colIdx].columnType=='voteComment';});K.oo('method',"isUnderlyingTableColumn",function(colIdx){return this.columns[colIdx].columnType=='underlyingTable';});K.oo('method',"getValues",function(rowIdx){var vals=[];var row=this.rows[rowIdx];for(var i=0,len=this.columns.length;i<len;i++){if(this.isVoteValueColumn(i))vals.push(row[i]);}
vals.isGarbage=row.isGarbage;return vals;});K.oo('method',"getComment",function(rowIdx){var row=this.rows[rowIdx];for(var i=0,len=this.columns.length;i<len;i++){if(this.isVoteCommentColumn(i))return row[i];}});K.oo('method',"getSource",function(rowIdx){var row=this.rows[rowIdx];for(var i=0,len=this.columns.length;i<len;i++){if(this.isVoteSourceColumn(i))return row[i];}});})(GridExplorerAppBase.Data,GridExplorerAppBase);JS2.OO.createClass("GridExplorerAppBase.BodyController");GridExplorerAppBase.BodyController.oo('extends',GridSimple.BodyController);(function(K,Package){var self=K;var _super=JS2.OO['super'];})(GridExplorerAppBase.BodyController,GridExplorerAppBase);JS2.OO.createClass("GridExplorerAppBase.BodyView");GridExplorerAppBase.BodyView.oo('extends',GridSimple.BodyView);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','SEE_COMMENTS_LINK','(<a class=".showRollupVoteHistory">see their comments</a>)');K.oo('method',"initialize",function(options){this.options=options;});K.oo('method',"getCellData",function(colIdx,rowIdx){var row=this.data.rows[rowIdx];var cell=this.data.rows[rowIdx][colIdx];var html='';if(this.data.isVoteCountColumn(colIdx)){return this._wrapCell(cell+this.SEE_COMMENTS_LINK);}
if(this.data.isVoterLinkColumn(colIdx)){return this._wrapCell(DISPLAY.user(cell[0],cell[1]));}
if(this.data.isVoteDateColumn(colIdx)){return this._wrapCell(DISPLAY.datatype('Date',cell,'humanTime'));}
if(this.data.isVoteSourceColumn(colIdx)){return this._wrapCell('<span class="expandSource"></span>'+DISPLAY.link(cell));}
if(this.data.isVoteCommentColumn(colIdx)){var klass="comment";if(this.data.getComment(rowIdx)==''){klass+=' blank';}
return'<div class="'+klass+'">'+
_super(this,colIdx,rowIdx)+'</div>';}
if(this.data.isUnderlyingTableColumn(colIdx)){return this._wrapCell(cell);}
if(row.isGarbage&&this.data.isVoteValueColumn(colIdx)){val='<span class="garbage">[Garbage]</span>';var unCounted=this.data.rows[rowIdx].unCounted;if(unCounted)val='<strike>'+val+'</strike>';return'<div class="clickable">'+val+'</div>';}
if(this.data.isVoteValueColumn(colIdx)){var val=cell
var datatype=this.data.columns[colIdx].datatype;var unCounted=this.data.rows[rowIdx].unCounted;val=this._getVoteValue(datatype,val);if(unCounted)val='<strike>'+val+'</strike>';return'<div class="clickable">'+val+'</div>';}
return this._wrapCell(_super(this,colIdx,rowIdx));});K.oo('method',"_wrapCell",function(cell){if($.browser.msie){return'<div>'+cell+'</div>';}else{return cell;}});K.oo('method',"_getVoteValue",function(datatype,val){if(val===null||$.trim(String(val)).length==0){return'<em class="blank">[blank]</em>';}
return(datatype=='String'||datatype=='Link')?DISPLAY.link(val):DISPLAY.datatype(datatype,val);});})(GridExplorerAppBase.BodyView,GridExplorerAppBase);GridExplorerAppBase.ValueSelector.oo('setHTMLCache',{"main":function(){return"<div class='valueSelector'><div class='voteValue'><a class='change'>change my latest input to agree with this<\/a><a class='update'>update my current input<\/a><a class='agree'>agree with this<\/a><\/div><div class='reportAbuse'><span class='split'>&nbsp;-&nbsp;<\/span><a>report abuse<\/a><\/div><div class='whiteList'><span class='split'>&nbsp;-&nbsp;<\/span><a>white list<\/a><\/div><div class='blackList'><span class='split'>&nbsp;-&nbsp;<\/span><a>black list<\/a><\/div><div class='smallClose'><\/div><\/div>"}});JS2.OO.createClass("Grid0.ExplorerPayload");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){this.url='/tables/explorers/'+options.dataset.key;this.unsubscribe=options.grid.unsubscribe;});K.oo('method',"pkVals",function(){return this.data.getPkVals(this.colIdx,this.rowIdx);});K.oo('method',"isLeft",function(){return this.data.isLeftCol(this.colIdx);});K.oo('method',"loadParams",function(){var params={};if(this.isLeft()){params.row_hash=this.data.getHash(this.rowIdx);}else{var pkVals=this.data.getPkVals(this.colIdx,this.rowIdx);params.pk_vals=JSON.stringify(pkVals);}
this.column=this.data.columns()[this.colIdx];params.field_id=this.column.id;params.grid=this.data.gridJson();return params;});K.oo('method',"loadFact",function(colIdx,rowIdx){this.colIdx=colIdx;this.rowIdx=rowIdx;var url=this.url+'/fact.js';if(this.unsubscribe)url+="?unsubscribe=true";var self=this;sci.ajax.post(url,this.loadParams(),function(p){self._loadFact(p)});});K.oo('method',"_loadFact",function(p){var cols=this.data.columns();var summaryParser=new Grid0.SummaryParser('cell',p.cellSummary,cols);var cellSummary;if(summaryParser.rows.length==0){cellSummary={numVotes:0,consensus:1,val:null,userVal:null};}else{cellSummary=summaryParser.rows[0][this.colIdx];}
var rollup=new Grid0.BallotParser(JSON.parse(p.rollup));var history=new Grid0.VotesParser(JSON.parse(p.history));var lastVote=new Grid0.VoteParser(JSON.parse(p.lastVote));var fact={cellSummary:cellSummary,rollup:rollup,lastVote:lastVote,history:history};this.notify('factLoaded',fact);});K.oo('method',"loadSubject",function(colIdx,rowIdx){this.colIdx=colIdx;this.rowIdx=rowIdx;var url=this.url+'/subject.js';var self=this;sci.ajax.post(url,this.loadParams(),function(p){self._loadSubject(p)});});K.oo('method',"_loadSubject",function(p){var alternative=new Grid0.SuggestionsParser(JSON.parse(p.alternative));var firstVote=new Grid0.VoteParser(JSON.parse(p.firstVote));var lastVote=new Grid0.VoteParser(JSON.parse(p.lastVote));var history=new Grid0.VotesParser(JSON.parse(p.history));var subject={alternative:alternative,lastVote:lastVote,firstVote:firstVote,history:history};this.notify('subjectLoaded',subject);});K.oo('method',"loadHistory",function(colIdx,rowIdx,counted){this.colIdx=colIdx;this.rowIdx=rowIdx;var url=this.url+'/history.js';if(this.unsubscribe)url+="?unsubscribe=true";var params=this.loadParams();params.counted=counted;sci.ajax.post(url,params,(function(self){return function(history){self._loadHistory(history);}})(this));});K.oo('method',"_loadHistory",function(history){history=new Grid0.VotesParser(JSON.parse(history));this.notify('historyLoaded',history);});})(Grid0.ExplorerPayload,Grid0);JS2.OO.createClass("Grid0.ExplorerHelper");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','bodyEventHandler bodyView');K.oo('member','EXPLORER_TYPE',{fact:"FactExplorer",subject:"SubjectExplorer",metadata:"MetadataExplorer"});K.oo('member','DIALOG_OFFSET_X',50);K.oo('member','DIALOG_OFFSET_Y',-26);K.oo('method',"e_dblClkCell",function(context){this.context=context;});K.oo('method',"e_showCellInput",function(context){this.context=context;});K.oo('method',"e_pasteValues",function(context){this.context=context;});K.oo('method',"e_markGarbage",function(context){this.context=context;});K.oo('method',"e_initHTML",function(){this.initHTML();this.initPointer();this.registerEvents();});K.oo('method',"initHTML",function(){this.jqMainTabs=$('.gridTabsContainer>.fact-tabList>li');this.isPointerVisible=true;});K.oo('method',"registerEvents",function(){var self=this;this.jqMainTabs.click(function(){var tabIndex=$(this).prevAll().length;if(tabIndex===0){self.isPointerVisible=true;}else{self.isPointerVisible=false;}
self.notify('mainTabSwitched',tabIndex);});});K.oo('method',"getExplorerTitle",function(titleHeader){var table=this.getPkTable();var html=titleHeader;for(var i=0,len=table.length;i<len;i++){var value=table[i][1];if($.trim(value).length==0)value='<em class="blank">[blank]</em>';html+='<strong>'+value+'</strong>';if(i<len-1){html+=', ';}}
return'<span class="explorerTitle">'+html+'</span>';});K.oo('method',"getPkTable",function(){var col=this.context.col;var dataset=this.schema.dataset(col.datasetId);var table=dataset.pkTable(this.context.absRowIdx);return table;});K.oo('method',"checkExplorerType",function(explorer,type){var klass=explorer.klass.className;var index=klass.indexOf(this.EXPLORER_TYPE[type]);if(index==-1){return false;}else{return true;}});K.oo('method',"initPointer",function(){var options={};var beh=this.bodyEventHandler;options.move=function(e){beh.mouseMove(e);};options.click=function(e){beh.click();};options.dblClick=function(e){beh.dblClick();};this.factPointer=new Sci.DialogPointer(options);this.subjectPointer=new Sci.DialogPointer(options);this.metadataPointer=new Sci.DialogPointer(options);});K.oo('method',"point",function(explorerView,zIndex){if(!this.context)return;var colIdx=this.context.colIdx;var rowIdx=this.dim.rowIdx(this.context.absRowIdx);this.explorerView=explorerView;var pointer=null;if(this.checkExplorerType(explorerView,"fact")){pointer=this.factPointer;}
if(this.checkExplorerType(explorerView,"subject")){pointer=this.subjectPointer;}
if(this.checkExplorerType(explorerView,"metadata")){pointer=this.metadataPointer;}
if(zIndex)pointer.setZIndex(zIndex);if(explorerView.jq.dialog('isOpen')&&this.isPointerVisible&&explorerView.dim.isCellVisible(this.context,pointer.padding)){var ele=this.bodyView.matrix[colIdx][rowIdx];pointer.show();pointer.point(explorerView.jqUiDialog,$(ele));}else{pointer.hide();}});K.oo('method',"hidePointer",function(explorerView){if(this.checkExplorerType(explorerView,"fact")){this.factPointer.hide();}
if(this.checkExplorerType(explorerView,"subject")){this.subjectPointer.hide();}
if(this.checkExplorerType(explorerView,"metadata")){this.metadataPointer.hide();}});K.oo('method',"getCellStyle",function(){var cellStyle={left:this.dim.leftOfColumn(this.context.colIdx)+
this.dim.hScrollOffset,top:this.dim.topOfRow(this.context.rowIdx),width:this.schema.column(this.context.colIdx).width,height:this.dim.rowHeight};return cellStyle;});K.oo('method',"setDialogPosition",function(jq){var cellStyle=this.getCellStyle();var left=cellStyle.left+cellStyle.width+this.DIALOG_OFFSET_X;var width=jq.dialog('option','width');var pageWidth=$(document).width();if((left+width)>pageWidth){left=cellStyle.left-width-this.DIALOG_OFFSET_X;}
left=left<0?0:left;jq.parent().css('left',left);});K.oo('method',"setMetaPosition",function(jq){var cellStyle=this.getCellStyle();var height=jq.dialog('option','height');var width=jq.dialog('option','width');var pageWidth=$(document).width();var left=cellStyle.left+cellStyle.width;if((left+width)>pageWidth){left=cellStyle.left-width;}
jq.parent().css({left:left,top:cellStyle.top-height+this.DIALOG_OFFSET_Y});});K.oo('method',"openable",function(explorerType){var col=this.context.col;var field=col.field;var colIdx=this.context.colIdx;var absRowIdx=this.context.absRowIdx;var cell=this.data.getCell(colIdx,absRowIdx);var val=cell.val;var numVotes=cell.numVotes;var isMetadata=((val===null&&numVotes<1)||val===undefined)&&field.isVotable&&col.editable();switch(explorerType){case'metadata':return!this.context.col.isPrimary&&isMetadata;break;case'fact':return!(isMetadata||!this.context.col.field||!this.context.col.field.isExplorable||this.context.col.isPrimary)
break;default:return false;}});K.oo('method',"toggleUnderlyingTableColumn",function(history,defaultColumns){if(this.actions.collection.length>1){var tempColumns=[];for(var j=0,col;col=defaultColumns[j];j++){tempColumns.push(col);}
tempColumns.push({name:'Source Table',datatype:'String',width:150,columnType:'underlyingTable'});history.setColumns(tempColumns);}else{history.setColumns(defaultColumns);}});K.oo('method',"buildDatasetLink",function(datasetId){var dataset=this.schema.getDatasetInfo(datasetId);var html=(dataset)?'<a href="/t/'+dataset.urlName+'">'+dataset.name+'</a>':_("Some view of the source table.");return html;});K.oo('method',"getValueByDatatype",function(datatype,value){if(datatype=='String'||datatype=='Link'){return DISPLAY.link(value,30);}else{return DISPLAY.datatype(datatype,value);}});})(Grid0.ExplorerHelper,Grid0);JS2.OO.createClass("Grid0.SubjectValueControl");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','LABEL_LENGTH',16);K.oo('method',"initialize",function(jq,pks,enableSuggest){this.jq=jq;this.pks=pks;this.inputControls=[];this.jqSubmit=$('#subj-tab-input .submit');this.enableSuggest=enableSuggest;this._buildItems();this._initInputControls();});K.oo('method',"focus",function(idx){if(!idx)idx=0;this.inputControls[idx].focus();});K.oo('method',"blur",function(){for(var i=0,input;input=this.inputControls[i];i++){input.blur();}});K.oo('method',"reset",function(){for(var i=0,input;input=this.inputControls[i];i++){if(this.pks[i].datatype=='UUID'&&this.pks[i].autogen){input.setValue(Math.uuid());}else{input.clear();}}});K.oo('method',"getValues",function(){var values={};for(var i=0;i<this.pks.length;i++){var input=this.inputControls[i];var field=this.pks[i];var value=input.getValue();values[field.fieldId]=value;}
return values;});K.oo('method',"setValues",function(values){for(var i=0,len=values.length;i<len;i++){if(this.pkDefaultValues){var fieldId=this.pks[i].fieldId;if(this.pkDefaultValues[fieldId]!=undefined)continue;}
this.inputControls[i].setValue(values[i]);}});K.oo('method',"setValuesWithoutDatatype",function(values){for(var i=0,len=values.length;i<len;i++){this.inputControls[i].setValueWithoutDatatype(values[i]);}});K.oo('method',"activeValidate",function(){var self=this;this.cancelValidate();this.intval=setInterval(function(){var isValidate=true;for(var i=0,input;input=self.inputControls[i];i++){if(!input.validate())isValidate=false;}
if(isValidate){self.jqSubmit.removeClass('disabled');}else{self.jqSubmit.addClass('disabled');}},300);});K.oo('method',"cancelValidate",function(){if(this.intval){clearInterval(this.intval);delete this.intval;}});K.oo('method',"setJqSubmit",function(jq){this.jqSubmit=jq;});K.oo('method',"setPkDefaultValues",function(pkDefaultValues){this.pkDefaultValues=pkDefaultValues;for(var i=0,input;input=this.inputControls[i];i++){for(var key in pkDefaultValues){if(key==this.pks[i].fieldId&&pkDefaultValues[key]!=null&&pkDefaultValues[key]!=undefined){input.setValue(pkDefaultValues[key]);break;}}}});K.oo('method',"_setLabelName",function(name){if(!name)name='Your Input';var sortLabelName=DISPLAY.html(name,this.LABEL_LENGTH);return sortLabelName+':';});K.oo('method',"_buildItems",function(){this.jq.html('');for(var i=0,p;p=this.pks[i];i++){var jqItem=$(this.htmlCache.listItem({title:p.name,name:this._setLabelName(p.name)}));this.jq.append(jqItem);}
this.jqInputs=this.jq.find('.input');this.jqSearchButton=$(this.htmlCache.searchButton());this.jq.append(this.jqSearchButton);});K.oo('method',"_initInputControls",function(){for(var i=0,field;field=this.pks[i];i++){var options={indicatorTogglable:false,validatorOptions:{compoundValidate:true,allowNull:true}};var inputControl=new Sci.InputControl(this.jqInputs.eq(i),options);inputControl.populate(field.datatype,false);this.inputControls.push(inputControl);if(field.datatype=='UUID'&&field.autogen){inputControl.setValue(Math.uuid());}}});})(Grid0.SubjectValueControl,Grid0);Grid0.SubjectValueControl.oo('setHTMLCache',{"searchButton":function(){return"<input class='hidden' type='button' \/>"},"listItem":function(item){return"<div class='row'><div class='label'><label title='"+item.title+"'>"+item.name+"<\/label><\/div><div class='input'><\/div><\/div>"}});JS2.OO.createClass("Grid0.JsapiPreview");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.jq=$(this.htmlCache.main());this.initHTML();});K.oo('method',"initHTML",function(){this.$keySelect=this.jq.find('select.apiKeys');this.$rowApiUrlInput=this.jq.find('textarea.rowApiUrl');this.$testLink=this.jq.find('a.testRowLink');this.registerEvents();});K.oo('method',"registerEvents",function(){this.$keySelect.change((function(self){return function(){self.populateRowApiUrl();}})(this));this.$testLink.click((function(self){return function(){window.open(self.$rowApiUrlInput.val(),'_blank');}})(this));});K.oo('method',"appendTo",function(jq,context){this.targetContainer=jq;this.cellContext=context;sci.apiKeys.getApiKeys({key_type:'server'},(function(self){return function(p){self.apiKeysLoaded(p);}})(this));});K.oo('method',"apiKeysLoaded",function(keys){if(keys.error){this.targetContainer.html(keys.error);}else{this.populateApiKeys(keys);this.populateRowApiUrl();this.jq.appendTo(this.targetContainer);}});K.oo('method',"populateApiKeys",function(keys){this.$keySelect.html('');var options=this.$keySelect[0].options;for(var it4=0,k,it4__arr=keys,it4__len=it4__arr.length;(k=it4__arr[it4])||it4<it4__len;it4++){options[options.length]=new Option(k[0],k[1].key);}});K.oo('method',"populateRowApiUrl",function(){var url=this.apiUrl(this.$keySelect.val());this.$rowApiUrlInput.val(url);});K.oo('method',"apiUrl",function(key){return"http://"+this.apiHost()+"/v2/tables/"+this.getTableId()+"/read?APIKey="+key+"&subject_key="+this.getSubjectKey();});K.oo('method',"apiHost",function(){var host=document.location.host;if(m=host.match(/^www/)){return'api.factual.com';}else{return host+'/api';}});K.oo('method',"getSubjectKey",function(){return this.cellContext.subjectKey;});K.oo('method',"getFieldId",function(){return this.cellContext.fieldId;});K.oo('method',"getTableId",function(){return this.cellContext.tableId;});K.oo('method',"setCellContext",function(context){this.cellContext=context;});})(Grid0.JsapiPreview,Grid0);Grid0.JsapiPreview.oo('setHTMLCache',{"main":function(){return"<div class='previewPane'><\/div><div class='helpLink'><span class='icon'><\/span><a href='http:\/\/wiki.developer.factual.com\/Server-API' target='_blank'>API Help<\/a><\/div><div class='apiKeySelection'>Select API Key:<select class='apiKeys'><\/select><a class='manageApiKeyLink' href='\/developers\/api_key' target='_blank'>manage keys<\/a><\/div><div class='rowApi'><label>Read this Row<\/label><textarea class='textArea rowApiUrl'><\/textarea><\/div><div class='actions'><a class='testRowLink' href='javascript:void(0);'>test<\/a><\/div>"}});JS2.OO.createClass("Grid0.CellFormController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','bodyView factExplorerView subjectExplorerView');K.oo('method',"registerEvents",function(){var self=this;var view=this.view;view.jqSource.changable();view.jqComment.changable();view.jqCancel.click(function(){view.hide(true);});view.jqValue.escKey(function(){view.hide(true);});view.jqSubmit.click(function(){self.submit();});view.jqForm.submit(function(){self.submit();});view.jqExplain.click(function(){self.explain();});view.inputControl.setValidateCallback(function(validated){self.setSubmitable(validated);});});K.oo('method',"explain",function(){this.view.hide(true);this.notify('dblClkCell',this.context);});K.oo('method',"getConsensus",function(context){var col=context.col;var colIdx=context.colIdx;var absRowIdx=context.absRowIdx;return this.data.getCell(colIdx,absRowIdx);});K.oo('method',"isOpenable",function(context){if(!context||context.col.isPrimary||!context.col.field.isVotable||!context.col.editable()){return false;}else{return true;}});K.oo('method',"show",function(context){if(!this.isOpenable(context))return;this.setContext(context);this.view.toggleExplain(this.data.isEmptyCell(context));this.view.show();});K.oo('method',"setContext",function(context){this.context=context;this.view.context=context;});K.oo('method',"setSubmitable",function(submitable){this.submitable=submitable;this.view.toggleSubmit(submitable);});K.oo('method',"submit",function(){if(this.view.isSubmitDisabled())return;if(this.auth.requireLogin(this))return;this.view.isOpen=false;var hash=this.view.getHash();if(hash){this.view.hide();this.data.vote(this.context.colIdx,this.context.absRowIdx,hash);}});K.oo('method',"isOpen",function(){return this.view.isOpen;});K.oo('method',"pasteValues",function(context,values){if(context.col.isPrimary)return;this.show(context);this.view.setValue(values[0]);});K.oo('method',"openCell",function(colIdx,rowIdx){this.context=this.dim.getContextFromCell(colIdx,rowIdx,this.bodyView.matrix);if(this.context){this.notify('showCell',this.context);this.notify('highlightCell',this.context);this.notify('showCellInput',this.context);}});K.oo('method',"subjectAdded",function(){this.onSubjectAdded=true;});K.oo('method',"e_resized",function(){if(!this.onSubjectAdded)return;var rowOffset=this.actions.summary['row-offset'];if(rowOffset!=-1){this.context=this.dim.getContextFromCell(0,rowOffset-this.dim.rowOffset,this.bodyView.matrix);}
this.onSubjectAdded=false;});K.oo('method',"highlightCell",function(context){if(!context){this.view.hide();return;}});K.oo('method',"dblClkCell",function(context){if(!context){this.view.hide();return;}
if(this.data.isEmptyCell(context)){if(this.view.isOpen)this.view.hide();this.show(context);}else{this.view.hide();}});})(Grid0.CellFormController,Grid0);JS2.OO.createClass("Grid0.CellFormView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','PADDING',11);K.oo('method',"initHTML",function(){this.jq=this.jqGrid.find('>.bodyEventHandler>.cellForm').hide();this.jq[0].innerHTML=this.htmlCache.main();this.jqForm=this.jq.first('form');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"form",this.jqForm,null);this.jqValue=this.jqForm.first('.valueInput');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"votevalue",this.jqValue,".textField");this.jqSubmit=this.jqForm.first('.submit');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"submit",this.jqSubmit,null);this.jqCancel=this.jqForm.first('.cancel');this.jqSource=this.jqForm.first('.source>input');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"source",this.jqSource,null);this.jqComment=this.jqForm.first('.comment>textarea');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"comment",this.jqComment,null);this.jqLoginMessage=this.jqForm.first('.loginMessage');this.jqDataMessage=this.jqForm.first('.dataMessage');this.jqExplain=this.jqForm.first('a.explain');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"explain",this.jqExplain,null);this.initValue();this.isOpen=false;});K.oo('method',"initValue",function(){this.inputControl=new Sci.FactInputControl(this.jqValue);});K.oo('method',"hide",function(){this.jq.hide();if(this.isOpen){this.notify('resizeScroller',0,0);this.isOpen=false;this.inputControl.blur();}});K.oo('method',"show",function(){this.populateValueControl();this.setConsensusValue();this.jq.show();this.isOpen=true;this.auth.checkLogin(this.jqLoginMessage);this.notify('checkReferenceState',this.context.col.datasetId,this.jqDataMessage);this.resizeScroller();this.scrollToShow();this.inputControl.select();this.focus();if($.browser.msie){setTimeout((function(self){return function(){self.inputControl.getInput().val(self.inputControl.getValue());}})(this),0);}});K.oo('method',"populateValueControl",function(){var field=this.context.col.field;this.inputControl.populate(field);this.inputControl.clear();this.inputControl.validate();});K.oo('method',"setConsensusValue",function(){var consensus=this.controller.getConsensus(this.context);var value=consensus.val;if(consensus.userVal||consensus.userVal===0){value=consensus.userVal;}
this.setValue(value);});K.oo('method',"toggleSubmit",function(submitable){if(submitable){this.jqSubmit.removeClass('fact-button-disabled');}else{this.jqSubmit.addClass('fact-button-disabled');}});K.oo('method',"setPosition",function(){if(!this.context)return;this.jq.css(this.getPosition(this.context));});K.oo('method',"getPosition",function(context){var position=this.dim.getCellPosition(context);position.top-=this.PADDING;position.left-=this.PADDING;return position;});K.oo('method',"resizeScroller",function(){if(!this.context)return;var pos=this.dim.getCellAbsolutePosition(this.context);this.notify('resizeScroller',pos.left+this.jq.width(),pos.top+this.jq.height());});K.oo('method',"scrollToShow",function(){if(!this.context)return;var position=this.getPosition(this.context);var posLeft=position.left+this.jq.width();var posTop=position.top+this.jq.height();var deltaLeft=posLeft>this.dim.body.width?posLeft-this.dim.body.width:null;var deltaTop=posTop>this.dim.body.height?posTop-this.dim.body.height:0;deltaTop=position.top>deltaTop?deltaTop:position.top;if(deltaLeft>0||deltaTop>0){this.notify('deltaScroll',{left:deltaLeft,top:deltaTop});}else{this.setPosition();}});K.oo('method',"setValue",function(value){if(value==null||value==undefined)value='';this.inputControl.setValue(value);});K.oo('method',"getHash",function(){var hash={value:this.inputControl.getValue(),source:this.jqSource.val(),comments:this.jqComment.val(),confidence:1,weight:1};return hash;});K.oo('method',"isSubmitDisabled",function(){return this.jqSubmit.is('.fact-button-disabled');});K.oo('method',"toggleExplain",function(isEmptyCell){isEmptyCell?this.jqExplain.hide():this.jqExplain.show();});K.oo('method',"focus",function(){this.inputControl.focus();});K.oo('method',"move",function(pos){if(this.isOpen)this.setPosition();});})(Grid0.CellFormView,Grid0);JS2.OO.createClass("Grid0.CellFormEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.controller.registerEvents();});K.oo('method',"e_showCellInput",function(context){this.controller.show(context);});K.oo('method',"e_dblClkCell",function(context){this.controller.dblClkCell(context);});K.oo('method',"e_pasteValues",function(context,values){this.controller.pasteValues(context,values);});K.oo('method',"e_highlightCell",function(context){this.controller.highlightCell(context);});K.oo('method',"e_subjectAdded",function(){this.controller.subjectAdded();});K.oo('method',"e_resizing",function(){this.view.setPosition();});K.oo('method',"e_beforeScroll",function(){});K.oo('method',"e_vScroll",function(pos){this.view.move(pos);});K.oo('method',"e_hScroll",function(pos){this.view.move(pos);});K.oo('method',"e_mainTabSwitched",function(){this.view.hide();});K.oo('method',"e_dataLoaded",function(){this.view.hide();});})(Grid0.CellFormEvents,Grid0);Grid0.CellFormView.oo('setHTMLCache',{"main":function(){return"<form action='javascript:void(0)'><div class='valueInput'><\/div><div class='buttons'><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Submit      <\/a>    <\/span>  <\/span><\/span><span class='cancel fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Cancel      <\/a>    <\/span>  <\/span><\/span><a class='explain'>what others said<\/a><input class='hidden' type='submit' \/><\/div><div class='message'><div class='loginMessage'><\/div><div class='dataMessage'><\/div><\/div><fieldset><legend>optional<\/legend><div class='source'><label>cite a source:<\/label><input class='textField' \/><\/div><div class='comment'><label>comments:<\/label><textarea class='textArea'><\/textarea><\/div><\/fieldset><\/form>"}});JS2.OO.createClass("Grid0.CellOptionsController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','factExplorerView subjectExplorerView cellForm body');K.oo('method',"registerEvents",function(){var self=this;var view=this.view;view.jqExplain.click(function(){self.openExplorer();});view.jqDisagree.click(function(){self.openCellForm();});view.jqExpand.click(function(){self.expandCell();});view.jqCorrect.click(function(){self.correct();});view.jqGarbage.click(function(){self.garbage();});view.jqEndpoint.click(function(){self.gotoEndpoint();});view.jqDevelops.click(function(){self.openDevelop();});});K.oo('method',"isShowable",function(context){if(!context||this.data.isEmptyCell(context)||this.factExplorerView.isOpen()||this.subjectExplorerView.isOpen()||this.cellForm.isOpen()||this.isSameCell(context)){return false;}else{return true;}});K.oo('method',"isSameCell",function(context){if(this.view.isShowing()){if(context.colIdx==this.context.colIdx&&context.absRowIdx==this.context.absRowIdx){return true;}else{return false;}}else{return false;}});K.oo('method',"show",function(context){if(!this.isShowable(context)){this.view.hide();return;}
this.setContext(context);var haveOption=this.view.populateOptions(this.getLink(),this.isCellOverflow(),context.col.isPrimary);if(!haveOption){this.view.hide();return;}
this.setContext(context);this.view.show();});K.oo('method',"getLink",function(){var colIdx=this.context.colIdx;var absRowIdx=this.context.absRowIdx;var value=this.data.getCell(colIdx,absRowIdx).val;return DISPLAY.isAndReturnLink(value);});K.oo('method',"isCellOverflow",function(){var colIdx=this.context.colIdx;var absRowIdx=this.context.absRowIdx;var datatype=this.context.col.datatype;return this.body.isCellOverflow(colIdx,absRowIdx,datatype);});K.oo('method',"setContext",function(context){this.context=context;this.view.context=context;});K.oo('method',"openExplorer",function(){this.notify('dblClkCell',this.context);this.view.hide();});K.oo('method',"openCellForm",function(){this.notify('showCellInput',this.context);});K.oo('method',"expandCell",function(){this.notify('expandCell');this.view.hideExpand();});K.oo('method',"correct",function(){this.notify('pasteValues',this.context,'');this.view.hide();});K.oo('method',"garbage",function(){this.notify('markGarbage',this.context);this.view.hide();});K.oo('method',"gotoEndpoint",function(){this.notify('gotoEndpoint',this.context);});K.oo('method',"openDevelop",function(){if(this.auth.requireLogin(this))return;this.context.developTab=true;this.openExplorer();});})(Grid0.CellOptionsController,Grid0);JS2.OO.createClass("Grid0.CellOptionsView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','TOP_OFFSET',30);K.oo('member','LEFT_OFFSET',7);K.oo('member','MIN_WIDTH_TO_SHOW',10);K.oo('member','POINTER_WIDTH',10);K.oo('method',"initialize",function(options){this.showExpandCellByDefault=true;this.isPoiTable=options.dataset.isPoiTable;});K.oo('method',"initHTML",function(){this.jq=this.jqGrid.first('>.cellOptions');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"options",this.jq,null);this.jq[0].innerHTML=this.htmlCache.main();this.jqPointer=this.jq.first('.pointer');this.jqFact=this.jq.first('.fact');this.jqSubject=this.jq.first('.subject');this.jqExplainSpan=this.jqFact.first('.explain');this.jqExplain=this.jqExplainSpan.first('a');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"explain",this.jqExplain,null);this.jqDisagreeSpan=this.jqFact.first('.disagree');this.jqSeparator=this.jqDisagreeSpan.first('.separator');this.jqDisagree=this.jqDisagreeSpan.first('a');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"disagree",this.jqDisagree,null);this.jqLinkSpan=this.jqFact.first('.link');this.jqLink=this.jqLinkSpan.first('a');this.jqExpandSpan=this.jqFact.first('.expand');this.jqExpand=this.jqExpandSpan.first('a');this.jqCorrectSpan=this.jqSubject.first('.correct');this.jqCorrect=this.jqCorrectSpan.first('a');this.jqGarbageSpan=this.jqSubject.first('.garbage');this.jqGarbage=this.jqGarbageSpan.first('a');this.jqSubjectLinkSpan=this.jqSubject.first('.link');this.jqSubjectLink=this.jqSubjectLinkSpan.first('a');this.jqEndpointSpan=this.jqSubject.first('.endpoint');this.jqEndpoint=this.jqEndpointSpan.first('a');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"endpoint",this.jqEndpoint,null);this.jqDevelopSpans=this.jq.find('.develop');this.jqDevelops=this.jq.find('.develop a');this.hide();});K.oo('method',"show",function(){this.jq.show();this.setPosition();});K.oo('method',"hide",function(){this.context=null;this.jq.hide();});K.oo('method',"hideExpand",function(){this.jqExpandSpan.hide();this.setPosition();});K.oo('method',"needToShow",function(cellPosition){if(this.dim.body.width-cellPosition.left<this.MIN_WIDTH_TO_SHOW)return false;if(cellPosition.left+this.context.col.width<this.MIN_WIDTH_TO_SHOW)return false;return true;});K.oo('method',"setPosition",function(){if(!this.context)return;var position=this.dim.getCellPosition(this.context);if(this.needToShow(position)){this.jq.show();}else{this.jq.hide();return;}
var left=position.left<0?0:position.left;var top=position.top+this.dim.body.top-this.TOP_OFFSET;var cellMarginRight=this.dim.body.width-(position.left+this.context.col.width);cellMarginRight=cellMarginRight<0?0:cellMarginRight;if((left+this.jq.width())>this.dim.body.width){var pointLeft=this.jq.width()-this.LEFT_OFFSET-this.POINTER_WIDTH;left=this.dim.body.width-this.jq.width()-cellMarginRight;}else{var pointLeft=this.LEFT_OFFSET;left-=this.LEFT_OFFSET;}
this.jqPointer.css('left',pointLeft);this.jq.css({left:left,top:top});});K.oo('method',"getConsensus",function(){var col=this.context.col;var colIdx=this.context.colIdx;var absRowIdx=this.context.absRowIdx;return this.data.getCell(colIdx,absRowIdx);});K.oo('method',"isExplainable",function(){var val=this.getConsensus().val;return!(val===null||val===undefined);});K.oo('method',"isDisagreeable",function(){return this.context.col.field.isVotable&&this.context.col.editable();});K.oo('method',"populateOptions",function(link,cellOverflow,isPrimary){var haveOption=false;if(isPrimary){this.jqFact.hide();this.jqSubject.show();if(this.isDisagreeable())haveOption=true;if(link){this.jqSubjectLink.attr('href',link);this.jqSubjectLinkSpan.show();}else{this.jqSubjectLinkSpan.hide();}
if(this.isPoiTable){this.jqEndpointSpan.show();}else{this.jqEndpointSpan.hide();}}else{this.jqFact.show();this.jqSubject.hide();if(this.isExplainable()){this.jqExplainSpan.show();this.jqSeparator.show();haveOption=true;}else{this.jqExplainSpan.hide();this.jqSeparator.hide();}
if(this.isDisagreeable()){this.jqDisagreeSpan.show();haveOption=true;}else{this.jqDisagreeSpan.hide();}
if(link){this.jqLink.attr('href',link);this.jqLinkSpan.show();}else{this.jqLinkSpan.hide();}
if(cellOverflow&&!this.showExpandCellByDefault){this.jqExpandSpan.show();}else{this.jqExpandSpan.hide();}}
return haveOption;});K.oo('method',"toggleExpendCell",function(jq){this.showExpandCellByDefault=jq.is(':checked');});K.oo('method',"isShowing",function(){return this.jq.is(':visible');});})(Grid0.CellOptionsView,Grid0);JS2.OO.createClass("Grid0.CellOptionsEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.controller.registerEvents();});K.oo('method',"e_highlightCell",function(context){this.controller.show(context);});K.oo('method',"e_hScroll",function(){this.view.setPosition();});K.oo('method',"e_resizing",function(){this.view.setPosition();});K.oo('method',"e_dblClkCell",function(){this.view.hide();});K.oo('method',"e_dataLoaded",function(){this.view.hide();});K.oo('method',"e_displayMenuClicked",function(selector,jq){if(selector=='display > expandCell'){this.view.toggleExpendCell(jq);}});K.oo('method',"e_showCellInput",function(){this.view.hide();});K.oo('method',"e_beforeScroll",function(){this.view.hide();});K.oo('method',"e_pasteValues",function(){this.view.hide();});K.oo('method',"e_gotoEndpoint",function(context){var uuid=this.data.getCell(0,context.absRowIdx).val;var url='/'+uuid;document.location=url;});})(Grid0.CellOptionsEvents,Grid0);Grid0.CellOptionsView.oo('setHTMLCache',{"main":function(){return"<div class='content'><div class='fact'><span class='explain'><span class='icon'><\/span><a>explain<\/a><\/span><span class='disagree'><span class='separator'>&nbsp;-&nbsp;<\/span><span class='icon'><\/span><a>disagree<\/a><\/span><span class='develop'><span class='separator'>&nbsp;-&nbsp;<\/span><span class='icon'><\/span><a>develop<\/a><\/span><span class='link'>&nbsp;-&nbsp;<span class='icon'><\/span><a target='_blank'>open link<\/a><\/span><span class='expand'>&nbsp;-&nbsp;<span class='icon'><\/span><a>expand cell<\/a><\/span><\/div><div class='subject'><span class='hidden correct'><span class='icon'><\/span><a>correct this<\/a><span class='separator'>&nbsp;-&nbsp;<\/span><\/span><span class='garbage'><span class='icon'><\/span><a>garbage<\/a><\/span><span class='develop'><span class='separator'>&nbsp;-&nbsp;<\/span><span class='icon'><\/span><a>develop<\/a><\/span><span class='endpoint'><span class='separator'>&nbsp;-&nbsp;<\/span><span class='icon'><\/span><a>go to endpoint<\/a><\/span><span class='link'><span class='separator'>&nbsp;-&nbsp;<\/span><span class='icon'><\/span><a target='_blank'>open link<\/a><\/span><\/div><\/div><div class='factOptionsBubble'><\/div><div class='pointer'><\/div>"}});JS2.OO.createClass("Grid0.ExpandedCellController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','bodyView factExplorerView subjectExplorerView cellForm');K.oo('method',"initialize",function(){this.showByDefault=true;});K.oo('method',"registerEvents",function(){var self=this;this.view.jqContent.dblclick(function(){self.dblclick();});});K.oo('method',"dblclick",function(){if(this.context){this.notify('dblClkCell',this.context);}});K.oo('method',"show",function(context){if(!context){this.view.hide();return;}
this.setContext(context);this.setCellValue();if(!this.showByDefault){this.view.hide();return;}
this.view.show();});K.oo('method',"setContext",function(context){this.context=context;this.view.context=context;});K.oo('method',"setCellValue",function(){if(!this.context)return;this.view.setCellValue(this.bodyView.getCellHTML(this.context));});K.oo('method',"toggleExpendCell",function(jq){this.showByDefault=jq.is(':checked');});K.oo('method',"cellRefreshed",function(absRowIdx,colIdx){if(absRowIdx==this.context.absRowIdx&&colIdx==this.context.colIdx){this.setCellValue();}});})(Grid0.ExpandedCellController,Grid0);JS2.OO.createClass("Grid0.ExpandedCellView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initHTML",function(){this.jq=this.jqGrid.first('>.expandedCell');this.jq[0].innerHTML=this.htmlCache.main();this.jqContent=this.jq.first('.content');this.jqText=this.jqContent.first('div');this.hide();});K.oo('method',"show",function(){this.showing=true;this.jq.show();this.setConsensus();this.setPosition();});K.oo('method',"hide",function(){this.context=null;this.showing=false;this.jq.hide();});K.oo('method',"setConsensus",function(){if($(this.context.cell).hasClass('contentious')){this.jqContent.addClass('contentious');}else{this.jqContent.removeClass('contentious');}});K.oo('method',"setPosition",function(){if(!this.context)return;if(this.dim.isCellVisible(this.context,0)){if(this.showing)this.jq.show();}else{this.jq.hide();return;}
var position=this.dim.getCellPosition(this.context);position.top+=this.dim.body.top-1;this.jq.css(position);this.changeSize(position);});K.oo('method',"changeSize",function(position){var maxWidth=this.dim.body.width-position.left;var minWidth=this.context.col.width;minWidth=minWidth>maxWidth?maxWidth:minWidth;this.jq.css('max-width',maxWidth);this.jq.css('min-width',minWidth);if($.browser.msie&&parseInt($.browser.version)<8){var padding=20;this.jqContent.css('min-width',minWidth-padding);}});K.oo('method',"setCellValue",function(value){this.jqText[0].innerHTML=value;});})(Grid0.ExpandedCellView,Grid0);JS2.OO.createClass("Grid0.ExpandedCellEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.view.initHTML();this.controller.registerEvents();});K.oo('method',"e_highlightCell",function(context){this.controller.show(context);});K.oo('method',"e_dataLoaded",function(){this.view.hide();});K.oo('method',"e_hScroll",function(){this.view.setPosition();});K.oo('method',"e_vScroll",function(){this.view.setPosition();});K.oo('method',"e_resizing",function(){this.view.setPosition();});K.oo('method',"e_dblClkCell",function(context){this.controller.setContext(context);this.view.hide();});K.oo('method',"e_showCellInput",function(){this.view.hide();});K.oo('method',"e_expandCell",function(){this.view.show();});K.oo('method',"e_displayMenuClicked",function(selector,jq){if(selector=='display > expandCell'){this.controller.toggleExpendCell(jq);}});K.oo('method',"e_pasteValues",function(){this.view.hide();});K.oo('method',"e_cellRefreshed",function(absRowIdx,colIdx){this.controller.cellRefreshed(absRowIdx,colIdx);});})(Grid0.ExpandedCellEvents,Grid0);Grid0.ExpandedCellView.oo('setHTMLCache',{"main":function(){return"<div class='content'><span><\/span><div><\/div><\/div>"}});JS2.OO.createClass("Grid0.CellClipboard");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){this.initHTML();});K.oo('method',"e_highlightCell",function(context){var self=this;this.context=context;setTimeout(function(){self.populateTextarea();},10);});K.oo('method',"initHTML",function(){this.buildHiddenTextarea();this.registerEvents();});K.oo('method',"buildHiddenTextarea",function(){this.jqTextarea=$('<textarea id="clipboardTextarea"></textarea>');this.jqGrid.append(this.jqTextarea);this.jqTextarea.css({width:0,height:0,position:'absolute',left:'-1000px'});});K.oo('method',"registerEvents",function(){var self=this;this.jqTextarea.keydown(function(e){self.keyHandler(e);});});K.oo('method',"keyHandler",function(e){if(!e.ctrlKey)return;var self=this;if(e.keyCode==86){setTimeout(function(){self.paste();},100);}});K.oo('method',"populateTextarea",function(){var values=this.getCurrentValues();var text=values.join('\t');this.jqTextarea.val(text);this.jqTextarea[0].select();});K.oo('method',"getCurrentValues",function(){var values=[];if(!this.context)return values;var col=this.context.col;var absRowIdx=this.context.absRowIdx;if(col.isPrimary){var pkColIds=this.data.datasetPkColIds(this.context.colIdx);var columns=this.data.columns();for(var i=0,length=pkColIds.length;i<length;i++){var colIdx=pkColIds[i];var datatype=columns[colIdx].datatype;var value=this.getValue(colIdx,absRowIdx,datatype);values.push(value);}}else{var value=this.getValue(col.colIdx,absRowIdx,col.datatype);values.push(value);}
return values;});K.oo('method',"getValue",function(colIdx,absRowIdx,datatype){var value=this.data.getCell(colIdx,absRowIdx).val;if(datatype=='Date')value=sci.common.getDisplay(datatype,value);return value;});K.oo('method',"paste",function(){if(!this.context)return;var col=this.context.col;if(!(col.field.isVotable&&col.editable()))return;var values=this.jqTextarea.val().split("\t");this.notify('pasteValues',this.context,values);});})(Grid0.CellClipboard,Grid0);JS2.OO.createClass("Grid0.FactExplorerController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"explorerPayload explorerHelper cellForm");K.oo('method',"initHTML",function(){this.view.initHTML();var adapter=new GridExplorerAdapter(this);this.view.addEventAdapter(adapter);this.registerEvents();});K.oo('method',"registerEvents",function(){var self=this;var view=this.view;view.jqUserSource.changable();view.jqUserComment.changable();view.jqSubmit.click(function(){self.castVote();});view.jqCancel.click(function(){self.cancel();});view.jqCorrectLink.click(function(){view.correctLink();});view.jqUpdateDiv.first('a').click(function(){view.updateLink();});view.jqSeeFullHistory.first('a').click(function(){view.showFullHistory();});view.jqCounted.change(function(){view.toggleCountedHistory();});view.jqBackToHistory.click(function(){view.backToHistory();});view.jqForm.submit(function(){self.castVote();});view.jqUserComment.ctrlEnterKey(function(){self.castVote();});});K.oo('method',"castVote",function(){if(this.view.jqSubmit.is('.disabled'))return;if(this.auth.requireLogin(this))return;var hash=this.view.getFormHash();this.data.vote(this.context.colIdx,this.context.absRowIdx,hash);this.close();});K.oo('method',"cancel",function(){this.view.resetForm();this.view.toggleFactInput();});K.oo('method',"loadFact",function(fact){this.view.loadFact(fact);});K.oo('method',"open",function(context,options){if(this.data.isEmptyCell(context)){if(this.view.isOpen())this.close();return;}
this.setContext(context);if(!this.explorerHelper.openable('fact')){if(this.view.isOpen())this.close();return;}
this.explorerPayload.loadFact(context.colIdx,context.absRowIdx);this.view.open(options);});K.oo('method',"setContext",function(context){this.context=context;this.view.context=context;this.view.populateValueControl();});K.oo('method',"getConsensus",function(){var col=this.context.col;var colIdx=this.context.colIdx;var absRowIdx=this.context.absRowIdx;return this.data.getCell(colIdx,absRowIdx);});K.oo('method',"giveNewFact",function(context){if(this.needStop(context))return;this.open(context,{'noFocusLink':true});this.view.focusValueControl();});K.oo('method',"needStop",function(context){var col=context.col;var field=col.field;var isVotable=field.isVotable&&col.editable();if(this.view.isOpen()||!field.isExplorable||col.isPrimary||this.cellForm.isOpen()||!isVotable){return true;}else{return false;}});K.oo('method',"close",function(){this.view.hide();});K.oo('method',"getUserValues",function(){return this.view.userValue.value;});K.oo('method',"pasteValues",function(context,values){if(this.needStop(context))return;this.giveNewFact(context);this.view.populateInput(values,true);});K.oo('method',"loadHistory",function(counted){this.explorerPayload.loadHistory(this.context.colIdx,this.context.absRowIdx,counted);});})(Grid0.FactExplorerController,Grid0);JS2.OO.createClass("Grid0.FactExplorerView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth bodyEventHandler explorerHelper jsapiPreview');K.oo('member','TAB_HEIGHT_OFFSET',100);K.oo('member','dialogName','factExplorer');K.oo('member','consensusColorDesc',['not enough votes','very contentious','somewhat contentious','neutral','likely factual','fact']);K.oo('member','ROLLUP_VALUE_COLIDX',0);K.oo('member','HISTORY_VALUE_COLIDX',1);K.oo('method',"addEventAdapter",function(adapter){this.rollup.addEventAdapter(adapter);this.history.addEventAdapter(adapter);});K.oo('method',"initHTML",function(){var self=this;this.initDialog();this.initTab();this.initRollup();this.initHistory();this.initJqObjects();this.resizeDialog();});K.oo('method',"initDialog",function(){var self=this;var dialogOptions={width:550,minWidth:400,minHeight:350,height:450,autoOpen:false,resizable:'se',close:function(){self.closed();},resizeStart:function(){self.hidePointer();},resizeStop:function(){self.resizeDialog();self.point();},dragStart:function(){self.hidePointer();},dragStop:function(){self.point();}}
this.jq=this.util.buildDialog(this.dialogName,this.htmlCache.main(),dialogOptions);var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"dialog",this.jq,null);this.jqUiDialog=this.jq.parents('.ui-dialog:first');this.dialogClose=this.jqUiDialog.first('.ui-dialog-titlebar-close');this.jqUiDialog.mousedown(function(){self.point();});});K.oo('method',"initTab",function(){var self=this;this.jq.find('.tabs>ul a').each(function(){this.href=this.href.replace(/^(.*)(#.+)$/,'$2');});this.tabs=this.jq.find('.tabs').tabs();this.util.styleTab(this.tabs);this.jqTabs=this.tabs.find('ul:first li');this.jqFactHistoryTab=this.jqTabs.eq(0).first('a');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"history tab",this.jqFactHistoryTab,null);this.jqFactHistoryTab.click(function(){self.inputControl.focus();});this.jqDeveloperTab=this.jq.find('#fact-tab-developer');});K.oo('method',"initRollup",function(){this.rollupOptions={seed:this.jq.find('.factRollup:first'),width:'100%',height:200,noAbuse:true,name:'FactRollUp',parent:this};this.rollup=APP(GridExplorerAppBase,this.rollupOptions);this.rollup.start();this.rollup.setColumns([{name:'User Input',datatype:'String',width:270,columnType:'voteValue'},{name:'Concurring Users',datatype:'Integer',width:200,columnType:'voteCount'}]);});K.oo('method',"initHistory",function(){this.jqFactHistory=this.jq.first('.factHistory');this.historyOptions={seed:this.jqFactHistory,width:'100%',height:200,name:'FactHistory',parent:this};this.history=APP(GridExplorerAppBase,this.historyOptions);this.history.start();this.defaultHistoryColumns=[{name:'Submitted By',datatype:'String',width:115,columnType:'voterLink'},{name:'Input',datatype:'String',width:115,columnType:'voteValue'},{name:'Raw Input',datatype:'String',width:115,columnType:'rawValue'},{name:'Date & Time',datatype:'String',width:115,columnType:'voteDate'},{name:'Citation',datatype:'String',width:195,columnType:'voteSource'},{name:'Comments',datatype:'String',width:150,columnType:'voteComment'}];this.history.setColumns(this.defaultHistoryColumns);this.jqFactMetadata=this.jq.first('.factMetadata');});K.oo('method',"point",function(){if(!this.jqUiDialog)this.initDialog();var zIndex=parseInt(this.jqUiDialog.css('z-index'));this.explorerHelper.point(this,zIndex+1);});K.oo('method',"hidePointer",function(){this.explorerHelper.hidePointer(this);});K.oo('method',"initJqObjects",function(){var self=this;this.jqFactSummary=this.jq.first('.factSummary');this.jqFactConsensus=this.jqFactSummary.first('.factConsensus');this.jqUserFactInput=this.jqFactSummary.first('.userFactInput');this.jqFactInput=this.jqFactSummary.first('.factInput');this.jqColNames=this.jq.find('.colName');this.jqFactSpan=this.jqFactConsensus.first('span');this.jqConsensusRow=this.jqFactConsensus.first('.consensus-row');this.jqConfidence=this.jqFactConsensus.first('.confidence');this.jqAggregationLabel=this.jqFactConsensus.first('.aggregationLabel');this.jqUserSpan=this.jqUserFactInput.first('span');this.jqCorrectDiv=this.jqFactConsensus.first('.correct');this.jqCorrectLink=this.jqCorrectDiv.first('a');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"correct this",this.jqCorrectLink,null);this.jqUpdateDiv=this.jqUserFactInput.first('.update');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"update this",this.jqUpdateDiv,null);this.jqInfo=this.jq.first('.infobox');this.jqInfoJoin=this.jqInfo.first('.join');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"join_warning",this.jqInfoJoin,null);this.jqInfoJoinLink=this.jqInfoJoin.first('a');this.jqInfoNormal=this.jqInfo.first('.normal');this.jqSeeFullHistory=this.jq.first('.seeFullHistory');this.jqCounted=this.jq.first('.counted>input');this.jqBackToHistory=this.jq.first('.backToHistory');this.jqVoteInput=this.jqFactInput.first('.voteInput');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Vote Input",this.jqVoteInput,".textField");this.inputControl=new Sci.FactInputControl(this.jqVoteInput);this.inputControl.setValidateCallback(function(isValid){self.setSubmitable(isValid);});this.jqFactInputHeader=this.jqFactInput.first('h3');this.jqForm=this.jqFactInput.first('form');this.jqUserSource=this.jqFactInput.first('.source>input');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Source",this.jqUserSource,null);this.jqUserComment=this.jqFactInput.first('.comment>textarea');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"Comment",this.jqUserComment,null);this.jqSubmit=this.jq.find('.buttons .submit');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"submit",this.jqSubmit,null);this.jqCancel=this.jq.find('.buttons .cancel');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"cancel",this.jqCancel,null);this.jqLoginMessage=this.jq.find('.loginMessage');this.jqDataMessage=this.jq.find('.dataMessage');});K.oo('method',"resizeDialog",function(e,ui){var height=this.jq.height()-this.jqFactSummary.height()-this.TAB_HEIGHT_OFFSET;if(this.jqInfo.is(":visible"))height-=this.jqInfo.height();if(height<80)return;this.rollup.setHeight(height);this.history.setHeight(height);this.jqFactMetadata.height(height);});K.oo('method',"isOpen",function(){if(!this.jq)return false;return this.jq.dialog('isOpen');});K.oo('method',"setVotable",function(){var col=this.context.col;var field=col.field;this.isVotable=field.isVotable&&col.editable();this.rollup.setReadonly(this.isVotable);this.history.setReadonly(this.isVotable);if(this.isVotable){this.jqCorrectDiv.show();this.jqUpdateDiv.show();this.jqInfo.hide();}else{this.jqCorrectDiv.hide();this.jqUpdateDiv.hide();this.populateInfobox();this.jqInfo.show();}});K.oo('method',"populateInfobox",function(){var col=this.context.col;var isJoinField=!this.data.isLeftCol(col.colIdx);if(isJoinField){var dataset=this.schema.getDatasetInfo(col.datasetId);var href='/t/'+dataset.urlName;this.jqInfoJoinLink.attr('href',href);this.jqInfoJoinLink.attr('title',dataset.name);this.jqInfoJoinLink.html(dataset.name);this.jqInfoJoin.show();this.jqInfoNormal.hide();}else{this.jqInfoJoin.hide();this.jqInfoNormal.show();}});K.oo('method',"setAggregationLabel",function(context){var aggMeth=this.context.col.aggregation;this.jqAggregationLabel.html(this.htmlCache["aggregationLabel_"+aggMeth.replace(/\W/g,'')]());});K.oo('method',"open",function(options){this.resetExplorer();this.setAggregationLabel();this.rollup.setColumnDatatype(this.ROLLUP_VALUE_COLIDX,this.context.col.datatype);this.history.setColumnDatatype(this.HISTORY_VALUE_COLIDX,this.context.col.datatype);this.setVotable();this.populateTitle();if(this.auth.loggedIn()){this.jsapiPreview.appendTo(this.jqDeveloperTab,this.cellContext());this.showTab(2);}else{this.hideTab(2);}
var isOpen=this.isOpen();this.jq.dialog('open');if(this.context.developTab){this.selectTab(2);}else{this.selectTabByAggregation();}
this.populateConsensus(this.controller.getConsensus());if(!isOpen)this.explorerHelper.setDialogPosition(this.jq);this.resizeDialog();this.point();this.explorerHelper.toggleUnderlyingTableColumn(this.history,this.defaultHistoryColumns);this.handleFastInput(options&&options.noFocusLink);});K.oo('method',"handleFastInput",function(fast){if(fast){this.toggleFactInput('Add Fact');this.inputControl.focus();}else{this.jqFactConsensus.show();this.eleFocus();}});K.oo('method',"clearGridData",function(){this.rollup.clear();this.history.clear();});K.oo('method',"selectTabByAggregation",function(){var agg=this.context.col.aggregation;if(agg=='mean'){this.hideTab(1);this.selectTab(0);}else if(agg=='wiki'){this.hideTab(1);this.selectTab(0);}else{this.showTab(1);this.selectTab(1);}});K.oo('method',"populateTitle",function(){var factTitle='<strong>'+
DISPLAY.html(this.context.col.name)+'</strong> for Subject: ';var html=this.explorerHelper.getExplorerTitle(factTitle);this.jq.dialog('option','title',html);});K.oo('method',"cellContext",function(){var col=this.context.col;return{tableId:col.datasetKey,subjectKey:this.data.getHash(this.context.absRowIdx),fieldId:col.id};});K.oo('method',"previewCode",function(){var col=this.context.col;return this.htmlCache.previewCode(this.cellContext());});K.oo('method',"populateConsensus",function(consValue){var value=consValue.val;var userValue=consValue.userVal;var datatype=this.context.col.datatype;var fieldNameFull=this.context.col.name.toString();var fieldName=DISPLAY.html(this.context.col.name,18)+':';var factFull=sci.common.getDisplay(datatype,value);var fact=this.explorerHelper.getValueByDatatype(datatype,value);this.jqColNames.attr('title',fieldNameFull);this.jqColNames.html(fieldName);this.jqFactSpan.attr('title',factFull);this.jqFactSpan.html(fact);if(this.auth.isAdmin()){var numVotes=consValue.numVotes;var consensus=consValue.consensus;var colorNum=this.getColorNum(numVotes,consensus);this.jqConfidence.html(colorNum);}
else
{this.jqConsensusRow.hide();}
this.jqFactConsensus.show();});K.oo('method',"focusValueControl",function(){this.inputControl.focus();});K.oo('method',"populateValueControl",function(){var field=this.context.col.field;var params={datatype:field.datatype,isEnumerated:field.isEnumerated,enumerationList:field.enumerationList}
this.inputControl.populate(params);});K.oo('method',"populateRollup",function(rollup){var rows=[];for(var i=0,list;list=rollup.list[i];i++){rows.push([list[0],list[1]]);}
this.rollup.setRows(rows);this.rollup.sort(1,true);});K.oo('method',"populateUserValue",function(userValue){this.userValue=userValue;var value=userValue.value[0];var source=userValue.source;var comment=userValue.comment;var datatype=this.context.col.datatype;var htmlValFull=DISPLAY.html(value);var htmlVal=this.explorerHelper.getValueByDatatype(datatype,value);this.jqUserSpan.attr('title',htmlValFull);this.jqUserSpan.html(htmlValFull);if(userValue.value.length>0){this.jqUserFactInput.show();this.userVoted=true;}});K.oo('method',"getColorNum",function(numVotes,consensus){return(!numVotes||numVotes<2)?0:Math.round(consensus*5);});K.oo('method',"hide",function(){if(this.isOpen())this.jq.dialog('close');});K.oo('method',"closed",function(){this.hidePointer();this.inputControl.clear();this.dialogClose.removeClass('ui-state-focus');});K.oo('method',"eleFocus",function(){var self=this;this.jqCorrectLink.blur();setTimeout(function(){self.jqCorrectLink.focus();},500);});K.oo('method',"gridValueSelected",function(params){this.toggleFactInput(params.messageType);if(params.messageType=='agree')this.fromAgree=true;this.populateInput(params.vals);this.fromAgree=false;});K.oo('method',"populateInput",function(vals,withoutDatatype){if(vals.length==0)return;var value=vals[0];if(value instanceof Array){if(this.context.col.field.isEnumerated&&!this.fromAgree){value=null;}else if(this.isJsonListAgg(this.context.col)){value=sci.common.getJsonListVotes(value);}}
if(withoutDatatype){this.inputControl.setValueWithoutDatatype(value);}else{this.inputControl.setValue(value);}
this.inputControl.focus();});K.oo('method',"isJsonListAgg",function(col){if(col.aggregationMethod=='json-list')return true;if(col.aggregationMethod==null&&col.aggregation=='json-list')return true;return false;});K.oo('method',"populateHistory",function(rows){this.historyRows=rows;if(this.filterHistoryVals.length){this.filterHistory(this.filterHistoryVals);}else{this.showFullHistory();}});K.oo('method',"showFullHistory",function(){var rows=this.historyRows;this.history.setRows(this.parseHistory(rows));this.sortHistoryByAggregation();this.jqSeeFullHistory.hide();this.filterHistoryVals=[];});K.oo('method',"filterHistory",function(vals){this.filterHistoryVals=vals;var rows=[];for(var i=0,r;r=this.historyRows[i++];){for(var j=0,len=r.value.length;j<len;j++){if(r.value[j]!=vals[j])break;if(j==len-1)rows.push(r);}}
this.history.setRows(this.parseHistory(rows));this.sortHistoryByAggregation();this.jqSeeFullHistory.show();});K.oo('method',"parseHistory",function(rows){var histories=[];for(var i=0,r;r=rows[i];i++){var h=[];h.push([r.voterId,r.voterName]);for(var it21=0,v,it21__arr=r.value,it21__len=it21__arr.length;(v=it21__arr[it21])||it21<it21__len;it21++){h.push(v);}
for(var it22=0,rv,it22__arr=r.rawValue,it22__len=it22__arr.length;(rv=it22__arr[it22])||it22<it22__len;it22++){h.push(rv);}
h.push(r.submitted);h.push(r.source);h.push(r.comment);h.push(this.explorerHelper.buildDatasetLink(r.sourceDataset));h.unCounted=!r.counted;histories.push(h);}
return histories;});K.oo('method',"toggleCountedHistory",function(){this.showUnCountedHistory=this.jqCounted.is(':checked');this.history.clear();this.controller.loadHistory(!this.showUnCountedHistory);});K.oo('method',"sortHistoryByAggregation",function(){var agg=this.context.col.aggregation;if(agg=='mean'){this.history.sort(1,false);}else if(agg=='wiki'){this.history.sort(2,true);}else{this.history.sort(2,true);}});K.oo('method',"resetForm",function(){this.jqUserSource.val('');this.jqUserComment.val('');this.inputControl.clear();this.inputControl.focus();});K.oo('method',"resetExplorer",function(){this.jqFactInput.hide();this.jqFactConsensus.hide();this.jqUserFactInput.hide();this.backToHistory();this.userVoted=false;this.clearGridData();this.showUnCountedHistory=false;this.jqCounted.removeProp('checked');this.filterHistoryVals=[];this.resetForm();});K.oo('method',"getFormHash",function(){var hash={value:this.inputControl.getValue(),source:this.jqUserSource.val(),comments:this.jqUserComment.val(),confidence:1,weight:1};return hash;});K.oo('method',"selectTab",function(idx){this.tabs.tabs('select',idx);});K.oo('method',"hideTab",function(idx){this.jqTabs.eq(idx).hide();});K.oo('method',"showTab",function(idx){this.jqTabs.eq(idx).show();});K.oo('method',"loadFact",function(fact){this.populateRollup(fact.rollup);this.populateUserValue(fact.lastVote);this.populateHistory(fact.history.votes);this.resizeDialog();});K.oo('method',"correctLink",function(){this.toggleFactInput('Submit a correction');this.populateInput([this.controller.getConsensus().val]);this.inputControl.focus();});K.oo('method',"updateLink",function(){this.toggleFactInput('Update my latest input');this.populateInput(this.userValue.value,true);this.jqUserSource.val(this.userValue.source);this.jqUserComment.val(this.userValue.comment);this.inputControl.focus();});K.oo('method',"toggleFactInput",function(type){var tds=this.jqFactInput.find('table:first .value');if(type){this.jqFactInputHeader.html(type)
this.jqFactInput.show();this.jqFactConsensus.hide();this.jqUserFactInput.hide();tds.css({width:'auto'});this.auth.checkLogin(this.jqLoginMessage);this.notify('checkReferenceState',this.context.col.datasetId,this.jqDataMessage);}else{this.jqFactInput.hide();this.jqFactConsensus.show();tds.removeAttr('style');if(this.userVoted){this.jqUserFactInput.show();}}
this.resizeDialog();});K.oo('method',"showFullComment",function(value){this.jqFactMetadata.html(DISPLAY.html(value));this.showFullMetadata();});K.oo('method',"showFullSource",function(value){this.jqFactMetadata.html(DISPLAY.link(value));this.showFullMetadata();});K.oo('method',"showFullMetadata",function(){this.jqFactMetadata.show();this.jqBackToHistory.show();this.jqCounted.parent().hide();this.jqFactHistory.hide();});K.oo('method',"backToHistory",function(){this.jqFactMetadata.hide();this.jqBackToHistory.hide();this.jqCounted.parent().show();this.jqFactHistory.show();});K.oo('method',"setSubmitable",function(submitable){var jqSubmit=this.jqSubmit;submitable?jqSubmit.removeClass('disabled'):jqSubmit.addClass('disabled');});})(Grid0.FactExplorerView,Grid0);JS2.OO.createClass("Grid0.FactExplorerEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){var self=this;setTimeout(function(){self.controller.initHTML();},800);});K.oo('method',"e_factLoaded",function(fact){this.controller.loadFact(fact);});K.oo('method',"e_historyLoaded",function(history){if(!this.view.isOpen())return;this.view.populateHistory(history.votes);});K.oo('method',"e_dblClkCell",function(context){this.controller.open(context);});K.oo('method',"e_changeRow",function(context){this.view.point();});K.oo('method',"e_hScroll",function(){this.view.point();});K.oo('method',"e_resizing",function(){this.view.point();});K.oo('method',"e_hideExplorers",function(){this.view.hide();});K.oo('method',"e_dataLoaded",function(){this.view.hide();});K.oo('method',"e_mainTabSwitched",function(){this.view.hide();});K.oo('method',"e_showCellInput",function(context){this.controller.giveNewFact(context);});K.oo('method',"e_pasteValues",function(context,values){this.controller.pasteValues(context,values);});K.oo('method',"e_viewModified",function(){this.view.hide();});})(Grid0.FactExplorerEvents,Grid0);Grid0.FactExplorerView.oo('setHTMLCache',{"confidence":function(){return"<div class='"+arguments[0]+" consensusIcon'><\/div><div class='consensusDesc'>"+arguments[1]+"<\/div>"},"aggregationLabel_jsonlist":function(){return"Common values submitted"},"previewCode":function(options){return"<div class='factual-vis' factual='tableId: "+options.tableId+"'><span factual='marker:row;subjectKey:"+options.subjectKey+"'><span factual='explorer:fact $fieldId"+options.fieldId+"'>$fieldId"+options.fieldId+"<\/span><\/span><\/div>"},"aggregationLabel_topvalues":function(){return"Common values submitted"},"main":function(){return"<div class='factExplorer explorer'><div class='factSummary'><div class='factInput hidden'><h3><\/h3><form action='javascript:void(0)'><table><tr><td class='key'><label class='colName'><\/label><\/td><td class='value'><div class='voteInput'><\/div><\/td><td class='buttons' width='125'><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Submit      <\/a>    <\/span>  <\/span><\/span><span class='cancel fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Cancel      <\/a>    <\/span>  <\/span><\/span><\/td><\/tr><\/table><div class='jqMessage'><div class='loginMessage'><\/div><div class='dataMessage'><\/div><\/div><div class='voteOptionalInputs voteInput'><fieldset><legend>Optional Support for Your Input<\/legend><div class='row'><div class='label'><label>cite a source:<\/label><\/div><div class='input source'><input class='textField ' onblur='s.blur(this)' onfocus='s.focus(this)' type='text' \/><\/div><\/div><div class='row'><div class='label'><label>add a comment:<\/label><\/div><div class='input comment'><textarea class='textArea ' onblur='s.blur(this)' onfocus='s.focus(this)' type='text'><\/textarea><\/div><\/div><\/fieldset><\/div><input class='hidden' type='submit' \/><\/form><\/div><div class='factConsensus'><h3 class='aggregationLabel'><\/h3><table><tr><td class='key'><label class='colName'><\/label><\/td><td class='value'><span><\/span><span class='correct'>(<a href='javascript:void(0);'>correct this<\/a>)<\/span><\/td><\/tr><tr class='consensus-row'><td class='key'><label title='confidence:'>Confidence:<\/label><\/td><td class='value confidence'><\/td><\/tr><\/table><\/div><div class='userFactInput'><h3>Your Latest Input<\/h3><table><tr><td class='key'><label class='colName'><\/label><\/td><td class='value'><span><\/span><span class='update'>(<a href='javascript:void(0);'>update this<\/a>)<\/span><\/td><\/tr><\/table><\/div><\/div><div class='infobox hidden'><div class='join'>This data does not allow input because it comes from another factual table:<a><\/a><\/div><div class='normal'>The owner of this table does not allow this content to be edited.<\/div><\/div><div class='clear'><\/div><div class='tabs'><ul><li><a href='#fact-tab-history'>Fact History<\/a><\/li><li><a href='#fact-tab-rollUp'>Fact Roll-Up<\/a><\/li><li><a href='#fact-tab-developer'>Developer<\/a><\/li><\/ul><div id='fact-tab-history'><div class='factHistory'><\/div><div class='factMetadata hidden'><\/div><div class='seeFullHistory hidden'><a href='javascript:void(0);'>click here to see full fact history<\/a><\/div><div class='counted'><input type='checkbox' \/>Show inputs that&nbsp;<strike>no longer count<\/strike><\/div><div class='backToHistory hidden'><a href='javascript:void(0);'>back to history<\/a><\/div><\/div><div id='fact-tab-rollUp'><div class='factRollup'><\/div><\/div><div id='fact-tab-developer'><\/div><\/div><\/div>"},"aggregationLabel_wiki":function(){return"Last value submitted"},"aggregationLabel_mode":function(){return"Most common value submitted"},"aggregationLabel_mean":function(){return"Average value"},"keyValuePair":function(){return"<tr><td class='key'><label title='"+arguments[0]+"'>"+arguments[1]+"<\/label><\/td><td class='value'>"+arguments[2]+"<\/td><\/tr>"}});JS2.OO.createClass("Grid0.SubjectExplorerController");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"explorerPayload explorerHelper");K.oo('method',"initHTML",function(){this.view.initHTML();var adapter=new GridExplorerAdapter(this);this.view.addEventAdapter(adapter);this.registerEvents();});K.oo('method',"registerEvents",function(){var self=this;var view=this.view;view.jqYourSource.changable();view.jqYourComment.changable();view.jqSubmit.click(function(){self.suggestAlternative();});view.jqReset.click(function(){view.resetForm();});view.jqSuggestLink.click(function(){view.suggestLink();});view.jqGarbageLink.click(function(){view.garbageLink();});view.jqGarbageInfo.first('a').click(function(){view.showGarbageHistory();});view.jqSeeFullHistory.first('a').click(function(){view.showFullHistory();});view.jqCounted.change(function(){view.toggleCountedHistory();});view.jqBackToHistory.click(function(){view.backToHistory();});view.jqAllInputs.click(function(){view.jqRadios.eq(0).select();});view.jqForm.submit(function(){self.suggestAlternative();});view.jqYourComment.ctrlEnterKey(function(){self.suggestAlternative();});});K.oo('method',"discuss",function(){var firstValues=this.getFirstValues().join(', ');this.notify('switchPane',{firstValues:firstValues,pane:'newThread'});this.close();});K.oo('method',"suggestAlternative",function(){if(this.view.jqSubmit.is('.disabled'))return;if(this.auth.requireLogin(this))return;var hash=this.view.getFormHash();this.data.suggestAlternative(this.context.absRowIdx,hash);this.close();});K.oo('method',"loadSubject",function(subject){this.view.loadSubject(subject);});K.oo('method',"open",function(context,params){this.setContext(context);if(!context.col.field.isExplorable||!context.col.isPrimary){if(this.view.isOpen())this.close();return;}
this.explorerPayload.loadSubject(context.colIdx,context.absRowIdx);this.view.open(params);});K.oo('method',"giveNewSubject",function(context){if(this.needStop(context))return;this.open(context,{'noFocusSuggestLink':true});this.view.switchTab(2);this.view.focusSubjectValueControl();this.view.donotPopulateLastVote=true;});K.oo('method',"setContext",function(context){this.context=context;this.view.context=context;});K.oo('method',"close",function(){this.view.hide();});K.oo('method',"getUserValues",function(){return this.view.userValues;});K.oo('method',"getFirstValues",function(){return this.firstValues;});K.oo('method',"pasteValues",function(context,values){if(this.needStop(context))return;this.giveNewSubject(context);this.view.populateInput(values,true);});K.oo('method',"needStop",function(context){var col=context.col;var field=col.field;var isVotable=field.isVotable&&col.editable();if(this.view.isOpen()||!field.isExplorable||!col.isPrimary||!isVotable){return true;}else{return false;}});K.oo('method',"loadHistory",function(counted){this.explorerPayload.loadHistory(this.context.colIdx,this.context.absRowIdx,counted);});})(Grid0.SubjectExplorerController,Grid0);JS2.OO.createClass("Grid0.SubjectExplorerView");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth bodyEventHandler explorerHelper jsapiPreview');K.oo('member','TAB_HEIGHT_OFFSET',110);K.oo('member','dialogName','subjectExplorer');K.oo('method',"initialize",function(options){this.isPoiTable=options.dataset.isPoiTable;});K.oo('method',"addEventAdapter",function(adapter){this.rollup.addEventAdapter(adapter);this.history.addEventAdapter(adapter);});K.oo('method',"initHTML",function(){var self=this;this.initDialog();this.initTab();this.initRollup();this.initHistory();this.initJqObjects();});K.oo('method',"initDialog",function(){var self=this;var dHeight=$.browser.msie?530:525;var dialogOptions={width:580,minWidth:500,height:dHeight,minHeight:dHeight,autoOpen:false,resizable:'se',open:function(){self.opened();},close:function(){self.closed();},resizeStart:function(){self.hidePointer();},resizeStop:function(){self.resizeDialog();self.point();},dragStart:function(){self.hidePointer();},dragStop:function(){self.point();}};this.jq=this.util.buildDialog(this.dialogName,this.htmlCache.main(),dialogOptions);this.jqUiDialog=this.jq.parents('.ui-dialog:first');this.dialogClose=this.jqUiDialog.first('.ui-dialog-titlebar-close');this.jqUiDialog.mousedown(function(){self.point();});});K.oo('method',"initTab",function(){var self=this;this.jq.find('>.tabs>ul a').each(function(){this.href=this.href.replace(/^(.*)(#.+)$/,'$2');});this.tabs=this.jq.find('.tabs').tabs();this.util.styleTab(this.tabs);this.jqTabs=this.tabs.find('ul:first li');this.jqTabs.eq(2).first('a').click(function(){self.auth.checkLogin(self.jqLoginMessage);self.subjectValueControl.focus();});this.jqDeveloperTab=this.jq.find('#subj-tab-developer');});K.oo('method',"initJqObjects",function(){this.jqFirstVote=this.jq.first('.firstVote');var jqFirstVoterTr=this.jqFirstVote.first('.firstVoter');this.jqFirstVoter=jqFirstVoterTr.first('.value');var jqSubjectKeyTr=this.jqFirstVote.first('.subjectKey');this.jqSubjectKey=jqSubjectKeyTr.first('.value');this.jqFirstSourceTr=this.jqFirstVote.first('.firstSource');this.jqFirstSource=this.jqFirstSourceTr.first('.source');this.jqFirstCommentTr=this.jqFirstVote.first('.firstComment');this.jqFirstComment=this.jqFirstCommentTr.first('.comment');this.jqShortcuts=this.jq.first('.shortcuts');var jqShortcutLinks=this.jqShortcuts.find('a');this.jqEndpointSpan=this.jqShortcuts.find('span.endpoint');this.jqSuggestLink=jqShortcutLinks.eq(0);this.jqGarbageLink=jqShortcutLinks.eq(1);this.jqEndpointLink=jqShortcutLinks.eq(2);if(this.isPoiTable){this.jqEndpointSpan.show();this.jqEndpointLink.click((function(self){return function(){self.notify('gotoEndpoint',self.context);}})(this));}
this.jqInfo=this.jq.first('.infobox');this.jqInfoJoin=this.jqInfo.first('.join');this.jqInfoJoinLink=this.jqInfoJoin.first('a');this.jqInfoNormal=this.jqInfo.first('.normal');this.jqGarbageInfo=this.jq.first('.garbageInfo');this.jqGarbageNum=this.jqGarbageInfo.first('span');this.jqSeeFullHistory=this.jq.first('.seeFullHistory');this.jqCounted=this.jq.first('.counted>input');this.jqBackToHistory=this.jq.first('.backToHistory');this.jqYourInput=this.jq.first('#subj-tab-input');this.jqForm=this.jqYourInput.first('form');this.jqReqInputs=this.jqYourInput.first('ul');this.jqVoteInputs=this.jqYourInput.first('.voteInput>fieldset');this.jqRadios=this.jqReqInputs.find('input[type=radio]');var jqOptInputs=this.jqYourInput.find('.voteOptionalInputs');this.jqYourSource=jqOptInputs.find('input');this.jqYourComment=jqOptInputs.find('textarea');this.jqSubmit=this.jqYourInput.find('.buttonField .submit');this.jqReset=this.jqYourInput.find('.buttonField .reset');this.jqAllInputs=this.jqYourInput.find('.voteInputFields');this.jqLoginMessage=this.jqYourInput.find('.loginMessage');this.jqDataMessage=this.jqYourInput.find('.dataMessage');this.jqKeySpan=this.jq.find('span.keySpan');});K.oo('method',"point",function(){if(!this.jqUiDialog)this.initDialog();var zIndex=parseInt(this.jqUiDialog.css('z-index'));this.explorerHelper.point(this,zIndex+1);});K.oo('method',"hidePointer",function(){this.explorerHelper.hidePointer(this);});K.oo('method',"initRollup",function(){this.rollup=APP(GridExplorerAppBase,{seed:this.jq.first('.altRollup'),width:'100%',height:200,noAbuse:true,parent:this});this.rollup.start();});K.oo('method',"initHistory",function(){this.jqSubjectHistory=this.jq.first('.subjectHistory');this.history=APP(GridExplorerAppBase,{seed:this.jqSubjectHistory,width:'100%',height:200,parent:this});this.history.start();this.jqSubjectMetadata=this.jq.first('.subjectMetadata');});K.oo('method',"resizeDialog",function(){var height=this.jq.height()-this.TAB_HEIGHT_OFFSET;if(this.jqShortcuts.is(":visible"))height-=this.jqShortcuts.height();if(this.jqInfo.is(":visible"))height-=this.jqInfo.height();if(this.jqFirstVote.is(":visible"))height-=this.jqFirstVote.height();if(height<0)return;this.rollup.setHeight(height);this.history.setHeight(height);this.jqSubjectMetadata.height(height);});K.oo('method',"isOpen",function(){if(!this.jq)return false;return this.jq.dialog('isOpen');});K.oo('method',"switchTab",function(index){this.tabs.tabs('select',index);});K.oo('method',"focusSubjectValueControl",function(){this.subjectValueControl.focus();});K.oo('method',"setVotable",function(){var col=this.context.col;var field=col.field;var votable=field.isVotable&&col.editable();this.rollup.setReadonly(votable);this.history.setReadonly(votable);if(votable){this.showTab(2);this.jqShortcuts.show();this.jqInfo.hide();}else{this.hideTab(2);this.jqShortcuts.hide();this.populateInfobox();this.jqInfo.show();}});K.oo('method',"populateInfobox",function(){var col=this.context.col;var isJoinField=!this.data.isLeftCol(col.colIdx);if(isJoinField){var dataset=this.schema.getDatasetInfo(col.datasetId);var href='/t/'+dataset.urlName;this.jqInfoJoinLink.attr('href',href);this.jqInfoJoinLink.attr('title',dataset.name);this.jqInfoJoinLink.html(dataset.name);this.jqInfoJoin.show();this.jqInfoNormal.hide();}else{this.jqInfoJoin.hide();this.jqInfoNormal.show();}});K.oo('method',"setColumns",function(){var datasetId=this.context.col.datasetId;if(this.datasetId!=datasetId){this.datasetColumns=this.datasetColumns||{};if(!this.datasetColumns[datasetId])this.generateDatasetColumns(datasetId);this.rollup.setColumns(this.datasetColumns[datasetId].rollup);this.setVoteInputs(this.datasetColumns[datasetId].voteInput);this.datasetId=datasetId;}
this.explorerHelper.toggleUnderlyingTableColumn(this.history,this.datasetColumns[datasetId].history);});K.oo('method',"generateDatasetColumns",function(dsId){var dataset=this.schema.dataset(dsId);var rollupCols=[];var historyCols=[];var voteInputs=[];historyCols.push({name:'Submitted by',datatype:'String',width:200,columnType:'voterLink'});for(var it16=0,pk,it16__arr=dataset.pks(),it16__len=it16__arr.length;(pk=it16__arr[it16])||it16<it16__len;it16++){rollupCols.push({name:pk.name,datatype:pk.datatype,width:250,columnType:'voteValue'});historyCols.push({name:pk.name,datatype:pk.datatype,width:200,columnType:'voteValue'});voteInputs.push({name:pk.name,datatype:pk.datatype,isEnumerated:pk.field.isEnumerated,enumerationList:pk.field.enumerationList,isNullable:pk.field.isNullable,fieldId:pk.field.id,autogen:false});}
for(var it17=0,pk,it17__arr=dataset.pks(),it17__len=it17__arr.length;(pk=it17__arr[it17])||it17<it17__len;it17++){historyCols.push({name:pk.name+' (Raw Input)',datatype:'String',width:200,columnType:'rawValue'});}
historyCols.push({name:'Date & Time',datatype:'String',width:200,columnType:'voteDate'});historyCols.push({name:'Citation',datatype:'String',width:200,columnType:'voteSource'});historyCols.push({name:'Comments',datatype:'String',width:200,columnType:'voteComment'});this.datasetColumns[dsId]={rollup:rollupCols,history:historyCols,voteInput:voteInputs};});K.oo('method',"setVoteInputs",function(columns){this.subjectValueControl=new Grid0.SubjectValueControl(this.jqVoteInputs,columns);this.subjectValueControl.activeValidate();});K.oo('method',"populateTitle",function(){var html=this.explorerHelper.getExplorerTitle('Subject: ');this.jq.dialog('option','title',html);});K.oo('method',"setRollupColumns",function(){var col=this.context.col;var dataset=this.schema.dataset(col.datasetId);var pks=dataset.pks();var columns=[];for(var i=0,pk;pk=pks[i];i++){var name=DISPLAY.html(pk.name);var datatype=pk.datatype;columns.push({name:name,datatype:datatype,width:200,columnType:'voteValue'});}
this.rollup.setColumns(columns);});K.oo('method',"open",function(params){this.resetExplorer();this.setVotable();this.populateTitle();this.setColumns();if(this.auth.loggedIn()){this.jsapiPreview.appendTo(this.jqDeveloperTab,this.cellContext());this.showTab(3);}else{this.hideTab(3)}
var isOpen=this.isOpen();this.jq.dialog('open');if(this.context.developTab){this.selectTab(3);}else{this.selectTab(0);}
if(!isOpen)this.explorerHelper.setDialogPosition(this.jq);this.resizeDialog();this.point();if(!(params&&params.noFocusSuggestLink))this.eleFocus();});K.oo('method',"populateRollup",function(rollup){var lists=rollup.list;var rows=[];var garbageSuggs=0;for(var i=0,list;list=lists[i];i++){if(list.count<0){garbageSuggs=-list.count;continue;}
var row=[];var vals=list.value;for(var j=0,len=vals.length;j<len;j++){row.push(vals[j]);}
row.push(list.count);rows.push(row);}
this.rollup.setRows(rows);this.rollup.sort(0,false);});K.oo('method',"showGarbageInfo",function(){var garbageNum=0;var voter=[];for(var i=0,row;row=this.historyRows[i];i++){if(voter[row.voterId]===undefined&&row.weight==-1){voter[row.voterId]=true;garbageNum++;}}
if(garbageNum===0){this.jqGarbageInfo.hide();}else{this.jqGarbageNum.html(garbageNum);this.jqGarbageInfo.show();}});K.oo('method',"populateFirstVote",function(firstVote){this.controller.firstValues=firstVote.value;var voterId=firstVote.voterId;var voterName=firstVote.voterName;var source=firstVote.source;var comment=firstVote.comment;var htmlVoter="<em>[no voter]</em>";if(voterName){htmlVoter=DISPLAY.html(voterName);htmlVoter=DISPLAY.user(voterId,htmlVoter);}
var htmlSource='';var htmlComment='';if(source===''){this.jqFirstSourceTr.hide();}else{htmlSource=DISPLAY.link(source,50);this.jqFirstSourceTr.show();}
if(comment===''){this.jqFirstCommentTr.hide();}else{htmlComment=DISPLAY.wrap_html(comment);this.jqFirstCommentTr.show();}
this.jqFirstVoter.html(htmlVoter);this.jqSubjectKey.html(this.data.getHash(this.context.absRowIdx));this.jqFirstSource.html(htmlSource);this.jqFirstComment.html(htmlComment);this.jqFirstVote.show();});K.oo('method',"hide",function(){if(this.isOpen())this.jq.dialog('close');});K.oo('method',"opened",function(){if(this.subjectValueControl){this.subjectValueControl.activeValidate();this.subjectValueControl.setPkDefaultValues(this.schema.getPkDefaultValues());}});K.oo('method',"closed",function(){this.hidePointer();if(this.subjectValueControl){this.subjectValueControl.cancelValidate();}
this.dialogClose.removeClass('ui-state-focus');});K.oo('method',"eleFocus",function(){var self=this;this.jqSuggestLink.focus().blur();setTimeout(function(){self.jqSuggestLink.focus();},500);});K.oo('method',"populateLastVote",function(lastVote){this.userValues=lastVote.value;if(this.donotPopulateLastVote){this.donotPopulateLastVote=false;return;}
if(lastVote.value.length==0)return;var values=lastVote.value;var source=lastVote.source;var comment=lastVote.comment;var garbage=lastVote.weight==-1?true:false;var col=this.context.col;var dataset=this.schema.dataset(col.datasetId);var pks=dataset.pks();if(garbage){this.jqRadios.eq(1).select();}else{this.populateInput(values,true);}});K.oo('method',"gridValueSelected",function(params){this.selectTab(2);this.populateInput(params.vals);});K.oo('method',"populateInput",function(vals,withoutDatatype){if(vals.length==0)return;if(vals.isGarbage){this.jqRadios.eq(1).select();return;}else{this.jqRadios.eq(0).select();}
if(withoutDatatype){this.subjectValueControl.setValuesWithoutDatatype(vals);}else{this.subjectValueControl.setValues(vals);}
this.subjectValueControl.focus();});K.oo('method',"cellContext",function(){var col=this.context.col;return{tableId:col.datasetKey,subjectKey:this.data.getHash(this.context.rowIdx),fieldId:col.id};});K.oo('method',"previewCode",function(){var col=this.context.col;return this.htmlCache.previewCode(this.cellContext());});K.oo('method',"populateHistory",function(rows){this.historyRows=rows;this.showGarbageInfo();this.showFullHistory();});K.oo('method',"showFullHistory",function(){var rows=this.historyRows;this.history.setRows(this.parseHistory(rows));this.history.sort(2,true);this.jqSeeFullHistory.hide();this.onlyGarbageHistory=false;});K.oo('method',"filterGarbageHistory",function(){var rows=[];for(var i=0,r;r=this.historyRows[i++];){if(r.weight==-1){rows.push(r);}}
this.history.setRows(this.parseHistory(rows));this.history.sort(2,true);this.jqSeeFullHistory.show();this.onlyGarbageHistory=true;});K.oo('method',"parseHistory",function(rows){var histories=[];for(var i=0,r;r=rows[i];i++){var h=[];h.push([r.voterId,r.voterName]);for(var it18=0,v,it18__arr=r.value,it18__len=it18__arr.length;(v=it18__arr[it18])||it18<it18__len;it18++){h.push(v);}
for(var it19=0,rv,it19__arr=r.rawValue,it19__len=it19__arr.length;(rv=it19__arr[it19])||it19<it19__len;it19++){h.push(rv);}
if(r.weight==-1){h.isGarbage=true;}
h.push(r.submitted);h.push(r.source);h.push(r.comment);h.push(this.explorerHelper.buildDatasetLink(r.sourceDataset));h.unCounted=!r.counted;histories.push(h);}
return histories;});K.oo('method',"toggleCountedHistory",function(){this.showUnCountedHistory=this.jqCounted.is(':checked');this.history.clear();this.controller.loadHistory(!this.showUnCountedHistory);});K.oo('method',"getFormHash",function(){var pk_hash=this.data.getPkValHash(this.context.absRowIdx);var weight=1;if(this.jqRadios[0].checked){pk_hash=this.subjectValueControl.getValues();}
var pks=this.data.pks();var pk_values=[];for(var it20=0,pk,it20__arr=pks,it20__len=it20__arr.length;(pk=it20__arr[it20])||it20<it20__len;it20++){pk_values.push(pk_hash[pk.id]);}
if(this.jqRadios[1].checked)weight=-1;var hash={value:JSON.stringify(pk_hash),pk_values:pk_values,source:this.jqYourSource.val(),comments:this.jqYourComment.val(),confidence:1,weight:weight};return hash;});K.oo('method',"resetForm",function(){if(this.subjectValueControl)this.subjectValueControl.reset();this.jqRadios[0].checked=true;this.jqYourSource.val('');this.jqYourComment.val('');});K.oo('method',"resetExplorer",function(){this.jqFirstVote.hide();this.clearGridData();this.setCountedInfo(false);this.jqGarbageInfo.hide();this.resetForm();});K.oo('method',"setCountedInfo",function(show){this.showUnCountedHistory=show;this.jqCounted.prop('checked',show);});K.oo('method',"clearGridData",function(){this.rollup.clear();this.history.clear();});K.oo('method',"selectTab",function(idx){this.tabs.tabs('select',idx);if(idx==2){this.auth.checkLogin(this.jqLoginMessage);this.notify('checkReferenceState',this.context.col.datasetId,this.jqDataMessage)}});K.oo('method',"hideTab",function(idx){this.jqTabs.eq(idx).hide();});K.oo('method',"showTab",function(idx){this.jqTabs.eq(idx).show();});K.oo('method',"loadSubject",function(subject){this.populateFirstVote(subject.firstVote);this.populateRollup(subject.alternative);this.populateHistory(subject.history.votes);this.populateLastVote(subject.lastVote);this.resizeDialog();});K.oo('method',"suggestLink",function(){this.selectTab(2);this.jqRadios.eq(0).select();this.subjectValueControl.focus();});K.oo('method',"garbageLink",function(){this.subjectValueControl.reset();this.selectTab(2);this.jqRadios.eq(1).select();this.jqRadios.eq(1).focus();});K.oo('method',"addSource",function(){this.selectTab(2);this.jqYourSource.focus();});K.oo('method',"addComment",function(){this.selectTab(2);this.jqYourComment.focus();});K.oo('method',"showGarbageHistory",function(){this.setCountedInfo(true);this.filterGarbageHistory();this.selectTab(1);});K.oo('method',"showFullComment",function(value){this.jqSubjectMetadata.html(DISPLAY.html(value));this.showFullMetadata();});K.oo('method',"showFullSource",function(){this.jqSubjectMetadata.html(DISPLAY.link(value));this.showFullMetadata();});K.oo('method',"showFullSource",function(){this.jqSubjectMetadata.html(DISPLAY.link(value));});K.oo('method',"showFullMetadata",function(){this.jqSubjectMetadata.show();this.jqBackToHistory.show();this.jqCounted.parent().hide();this.jqSubjectHistory.hide();});K.oo('method',"backToHistory",function(){this.jqSubjectMetadata.hide();this.jqBackToHistory.hide();this.jqCounted.parent().show();this.jqSubjectHistory.show();});})(Grid0.SubjectExplorerView,Grid0);JS2.OO.createClass("Grid0.SubjectExplorerEvents");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_initHTML",function(){var self=this;setTimeout(function(){self.controller.initHTML();},800);});K.oo('method',"e_subjectLoaded",function(subject){this.controller.loadSubject(subject);});K.oo('method',"e_historyLoaded",function(history){if(!this.view.isOpen())return;this.view.populateHistory(history.votes);});K.oo('method',"e_dblClkCell",function(context){this.controller.open(context);});K.oo('method',"e_changeRow",function(context){this.view.point();});K.oo('method',"e_hScroll",function(){this.view.point();});K.oo('method',"e_resizing",function(){this.view.point();});K.oo('method',"e_hideExplorers",function(){this.view.hide();});K.oo('method',"e_dataLoaded",function(){this.view.hide();});K.oo('method',"e_mainTabSwitched",function(){this.view.hide();});K.oo('method',"e_showCellInput",function(context){this.controller.giveNewSubject(context);});K.oo('method',"e_pasteValues",function(context,values){this.controller.pasteValues(context,values);});K.oo('method',"e_viewModified",function(){this.view.hide();});K.oo('method',"e_markGarbage",function(context){this.controller.giveNewSubject(context);this.view.garbageLink();});})(Grid0.SubjectExplorerEvents,Grid0);Grid0.SubjectExplorerView.oo('setHTMLCache',{"voteInput":function(){return"<div class='row'><div class='label' title='"+arguments[0]+"'><label>"+arguments[1]+"<\/label><\/div><div class='input'><input class=' textField' id='"+arguments[2]+"' onblur='s.blur(this)' onfocus='s.focus(this)' \/><\/div><\/div>"},"previewCode":function(options){return"<div class='factual-vis' factual='tableId: "+options.tableId+"'><span factual='marker:row;subjectKey:"+options.subjectKey+"'><span factual='explorer:subject'>$fieldId"+options.fieldId+"<\/span><\/span><\/div>"},"voteInputRow":function(){return"<div class='row'><div class='label'><label>"+arguments[0]+"<\/label><\/div><div class='input'><input class='textField ' onblur='s.blur(this)' onfocus='s.focus(this)' type='text' \/><\/div><\/div>"},"voteEnumerate":function(){return"<div class='row'><div class='label' title='"+arguments[0]+"'><label>"+arguments[1]+"<\/label><\/div><div class='input'><\/div><\/div>"},"main":function(){return"<div class='subjectExplorer explorer'><div class='firstVote'><table><tr class='firstVoter'><td class='label'>Row first suggested by:<\/td><td class='value'><\/td><\/tr><tr class='subjectKey'><td class='label'>Subject key:<\/td><td class='value'><\/td><\/tr><tr class='firstSource'><td class='label'>original citation:<\/td><td class='value source'><\/td><\/tr><tr class='firstComment'><td class='label'>original comments:<\/td><td class='value comment'><\/td><\/tr><\/table><\/div><div class='shortcuts'><span class='suggest hidden'><a href='javascript:void(0);'>suggest a better label for this row<\/a>&nbsp;-&nbsp;<\/span><a href='javascript:void(0);'>flag this row as \"garbage\"<\/a><span class='endpoint hidden'>&nbsp;-&nbsp;<a href='javascript:void(0);'>go to endpoint<\/a><\/span><\/div><div class='infobox hidden'><div class='join'>This data does not allow input because it comes from another factual table:<a><\/a><\/div><div class='normal'>The owner of this table does not allow this content to be edited.<\/div><\/div><div class='clear'><\/div><div class='tabs'><ul><li><a href='#subj-tab-labels'>Alternate Labels<\/a><\/li><li><a href='#subj-tab-history'>Subject History<\/a><\/li><li><a href='#subj-tab-input'>Your Input<\/a><\/li><li><a href='#subj-tab-developer'>Developer<\/a><\/li><\/ul><div id='subj-tab-labels'><div class='altRollup'><\/div><div class='garbageInfo hidden'><a href='javascript:void(0);'><span><\/span>&nbsp;users thought this row was \"garbage\"<\/a><\/div><\/div><div id='subj-tab-history'><div class='subjectHistory'><\/div><div class='subjectMetadata hidden'><\/div><div class='seeFullHistory hidden'><a href='javascript:void(0);'>click here to see full subject history<\/a><\/div><div class='counted'><input type='checkbox' \/>Show inputs that&nbsp;<strike>no longer count<\/strike><\/div><div class='backToHistory hidden'><a href='javascript:void(0);'>back to history<\/a><\/div><\/div><div id='subj-tab-input'><form action='javascript:void(0)'><ul><li class='hidden'><input id='subjectRadio0' name='subjectType' type='radio' \/><label for='subjectRadio0'>I think there is a better label for the subject of this row.<\/label><div class='voteInput voteInputFields'><fieldset><\/fieldset><\/div><\/li><li><input id='subjectRadio1' name='subjectType' type='radio' \/><label for='subjectRadio1'>I think this row is a \"garbage\".<\/label><\/li><li><input checked='checked' id='subjectRadio2' name='subjectType' type='radio' \/><label for='subjectRadio2'>I think subject of this row is fine the way it is.<\/label><\/li><\/ul><div class='voteOptionalInputs voteInput'><fieldset><legend>Optional Support for Your Input<\/legend><div class='row'><div class='label'><label>cite a source:<\/label><\/div><div class='input source'><input class='textField ' onblur='s.blur(this)' onfocus='s.focus(this)' type='text' \/><\/div><\/div><div class='row'><div class='label'><label>add a comment:<\/label><\/div><div class='input comment'><textarea class='textArea ' onblur='s.blur(this)' onfocus='s.focus(this)' type='text'><\/textarea><\/div><\/div><\/fieldset><\/div><div class='buttonField'><div class='buttons'><span class='submit fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Submit      <\/a>    <\/span>  <\/span><\/span><span class='reset fact-button'>  <span class='button h p'>    <span>      <a href='javascript:void(0);' name='Submit'>        Reset Form      <\/a>    <\/span>  <\/span><\/span><\/div><\/div><div class='clear'><\/div><div class='message'><div class='loginMessage'><\/div><div class='dataMessage'><\/div><\/div><input class='hidden' type='submit' \/><\/form><\/div><div id='subj-tab-developer'><\/div><\/div><\/div>"},"keyValuePair":function(){return"<tr><td class='key'><label title='"+arguments[0]+"'>"+arguments[1]+"<\/label><\/td><td class='value'>"+arguments[2]+"<\/td><\/tr>"}});JS2.OO.createClass("Grid0.SaveGridState");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies','auth gridMenu');K.oo('member','menuName','file > saveGridState');K.oo('member','saveAsMenu','file > saveAs');K.oo('member','OWNER_NAME','file');K.oo('method',"e_fileMenuClicked",function(name,jqObject){if(jqObject.parent().hasClass('disabled'))return;if(name==this.menuName){this.saveGridState();}});K.oo('method',"initialize",function(options){this.options=options;});K.oo('method',"saveGridState",function(callback){if(this.auth.requireLogin(this))return;this.notify('alert','Saving...');this.data.saveGridState((function(self,callback){return function(id){self.gridMenu.disableMenuItem(self.menuName);self.gridMenu.hideSubMenu(self.OWNER_NAME);if(callback)callback();self.notify('alert');}})(this,callback));});K.oo('method',"checkLogin",function(){if(this.options.isOwner()||this.auth.isAdmin()){this.gridMenu.showMenuItem(this.menuName);}else{this.gridMenu.hideMenuItem(this.menuName);}
if(this.bigData&&!this.auth.isAdmin()){this.gridMenu.hideMenuItem(this.saveAsMenu);}else{this.gridMenu.showMenuItem(this.saveAsMenu);}});K.oo('method',"e_bigData",function(bigData){this.bigData=bigData;});K.oo('method',"e_viewModified",function(){this.gridMenu.enableMenuItem(this.menuName);this.gridMenu.enableMenuItem(this.saveAsMenu);});K.oo('method',"e_actionsModified",function(){this.gridMenu.enableMenuItem(this.menuName);this.gridMenu.enableMenuItem(this.saveAsMenu);});K.oo('method',"e_dataLoaded",function(){this.checkLogin();});K.oo('method',"e_userLoggedIn",function(){this.checkLogin();});K.oo('method',"e_saveGridState",function(callback){this.saveGridState(callback);});})(Grid0.SaveGridState,Grid0);JS2.OO.createClass("Grid0.Search");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','dependencies',"mainHeader");K.oo('method',"e_initHTML",function(){this.ops=['contains','equal','starts-with','ends-with'];this.initHTML();this.registerEvents();});K.oo('method',"initHTML",function(){this.jq=$(this.htmlCache.main());this.jqContainer.append(this.jq);this.jqSearchInput=this.jq.first('.textField');this.jqSearchButton=this.jq.first('.button');this.jqSearchSuggest=this.jq.first('.search-suggest-main');this.jqSuggest=this.jq.first('.suggest');this.jqSuggestList=this.jq.first('ol');this.closeSuggest();});K.oo('method',"registerEvents",function(){this.jqSearchInput.toggleInput();var defaultParams={'field_ids[]':this.schema.pkFieldIds()};var self=this;var self=this;this.jqSearchInput.keyup((function(self){return function(evt){if(evt.keyCode==KEYCODE.ENTER){self.startSearch();}}})(self))
this.jqSearchButton.click(function(){self.startSearch()});this.jqSearchInput.blur(function(){self.jqSearchInput.removeClass('textFieldFocus');});this.jqSearchInput.focus(function(){self.jqSearchInput.addClass('textFieldFocus');});});K.oo('method',"startSearch",function(){this.closeSuggest();var query=$.trim(this.jqSearchInput.val());if(query.length<=0)return;this.search(query);});K.oo('method',"registerSuggest",function(){var self=this;$(document).click(function(evt){var jq=$(evt.target||evt.srcElement).parents('.suggest');if(jq.length>0){self.replaceOp(jq.first('.operatorHover'));}
self.closeSuggest();});var self=this;this.jqSearchInput.keyup(function(evt){var query=$.trim(self.jqSearchInput.val());if(query.length<=0){self.closeSuggest();return;}
evt.preventDefault();switch(evt.keyCode){case KEYCODE.ESC:self.closeSuggest();break;case KEYCODE.ENTER:self.closeSuggest();self.search(query);break;case KEYCODE.DOWN:self.changeSelect(1);break;case KEYCODE.UP:self.changeSelect(-1);break;case KEYCODE.TAB:break;default:break;}});this.jqSearchInput.keydown(function(evt){if(evt.keyCode==KEYCODE.TAB&&self.jqSuggestList.children().size()>0){evt.preventDefault();self.changeSelect(1);}});});K.oo('method',"search",function(query){var operator=null;var val=null;query=$.trim(query);for(var i=0,op;op=this.ops[i];i++){if(query.indexOf(op)==0){operator=op;break;}}
if(operator){val=query.split(operator,2)[1]}else{operator='contains';val=query;}
this.notify('addSearchQuery',{operator:operator,value:$.trim(val)});});K.oo('method',"closeSuggest",function(){this.jqSuggest.hide();});K.oo('method',"highlight",function(query,text){return text.replace(new RegExp("("+query+")","gi"),"<strong>$1</strong>");});K.oo('method',"showSuggest",function(query){this.jqSuggestList.html('');var matches=[];var nonMatches=[];$.each(this.ops,function(){if(this.indexOf(query)==0){matches.push(this);}else{nonMatches.push(this);}});var self=this;$.each(matches,function(){self.jqSuggestList.append(self.htmlCache.operator(this,self.highlight(query,this)));});$.each(nonMatches,function(){self.jqSuggestList.append(self.htmlCache.operator(this,this));});this.jqSuggest.show();});K.oo('method',"changeSelect",function(step){var jqSelected=this.jqSuggestList.first('.operatorHover');if(jqSelected.size()>0){jqSelected.removeClass('operatorHover');var jqOps=this.jqSuggestList.find('.operator');var idx=jqOps.index(jqSelected);idx=(idx+step+jqOps.length)%jqOps.length;jqSelected=jqOps.eq(idx);}else{jqSelected=step>0?this.jqSuggestList.first('.operator'):this.jqSuggestList.find('.operator:last');}
jqSelected.addClass('operatorHover');this.replaceOp(jqSelected);});K.oo('method',"replaceOp",function(jq){var op=jq.attr('val');var match=jq.first('strong').size()>0;var re=new RegExp("("+this.ops.join('|')+")","i");var val=this.jqSearchInput.val();if(match){val=op;}else if(val.search(re)>=0){val=val.replace(re,op);}else{val=op+' '+val;}
this.jqSearchInput.val(val);});K.oo('method',"toggleSearchInputbox",function(){if(this.bigData&&!this.auth.isAdmin()&&!this.actions.isFulltextSearchEnabled()){this.jq.hide();}else{this.jq.show();}});K.oo('method',"e_clearAllFilters",function(){this.jqSearchInput.toggleInput('val','');});K.oo('method',"e_clearSearchContent",function(){this.clearSearchContent();});K.oo('method',"clearSearchContent",function(){this.jqSearchInput.toggleInput('val','');});K.oo('method',"e_setSearchContainer",function($container){this.jqContainer=$container;});})(Grid0.Search,Grid0);Grid0.Search.oo('setHTMLCache',{"operator":function(val,display){return"<li class='operator ' onmouseout='s.out(this)' onmouseover='s.over(this)' val='"+val+"'>"+display+"<\/li>"},"main":function(){return"<div class='searchGrid'><div class='searchIcon'><\/div><div class='query'><input autocomplete='off' class='textField' value='Search within Table' \/><\/div><div class='search-suggest-main'><\/div><div class='suggest'><ol class='operators'><\/ol><\/div><div class='button hidden'><\/div><\/div>"}});JS2.OO.createClass("Grid0.Authentication");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){sci.auth.addAuthListener(this);});K.oo('method',"userLoggedIn",function(){var permissionsUrl=this.data.workbenchUrl()+'/permissions.js';sci.ajax.get(permissionsUrl,{},(function(self){return function(p){sci.permissions=p;self.notify('userLoggedIn');}})(this));});})(Grid0.Authentication,Grid0);JS2.OO.createClass("Page.Developer");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(jqSeed,options){this.options=options;this.jq=jqSeed;this.initHTML();this.registerEvents();});K.oo('method',"initHTML",function(){this.jq.html(this.htmlCache.main());this.jqDetails=this.jq.first('.details');this.jqTableRef=this.jqDetails.first('.reference');this.jqTableRefVal=this.jqTableRef.first('.value');this.jqTableId=this.jqDetails.first('.id');this.jqTableIdVal=this.jqTableId.first('.value');this.jqFields=this.jq.first('.fields');this.jqBracket=this.jqFields.first('.subjectIndicator');this.jqGridSeed=this.jqFields.first('.fieldsGrid');this.populateDetails();this.initFieldsGrid();});K.oo('method',"registerEvents",function(){this.jqGridSeed.click((function(self){return function(e){if($(e.target).is('.editFieldLink')){var fieldId=parseInt($(e.target).attr('field'));self.showFieldEditor(fieldId);}}})(this));});K.oo('method',"populateDetails",function(){this.jqTableRefVal.text(this.options.dataset.key);if(this.options.isAdmin()){this.jqTableIdVal.text(this.options.dataset.id);this.jqTableId.show();}else{this.jqTableId.hide();}});K.oo('method',"initFieldsGrid",function(){this.fieldsGrid=APP(Page.Developer.FieldsGrid,{seed:this.jqGridSeed,width:'100%',jqBracket:this.jqBracket,owner:this});this.fieldsGrid.start();var columns=[{name:'',datatype:'String',width:35},{name:'Field ID',datatype:'String',width:70},{name:'Field Name',datatype:'String',width:200},{name:'Field Refs',datatype:'String',width:200},{name:'Data Type',datatype:'String',width:100},{name:'Aggregation',datatype:'String',width:150},{name:'Created By',datatype:'String',width:150},{name:'Date Created',datatype:'String',width:100},{name:'Description',datatype:'String',width:150}];if(this.options.dataset.type!='standard'){columns.push({name:'Source Table',datatype:'String',width:150,escapeHTML:false});}
this.fieldsGrid.setColumns(columns);});K.oo('method',"populateFieldsGrid",function(columns){var data=[];var immutable=this.schema.immutable;var fieldRefs=this.schema.getDatasetInfo(this.data.dataset.id).fieldRefs;var isStandard=this.options.dataset.type=='standard';var datasetId=this.options.dataset.id;$.each(columns,function(i,c){var isHidden=false;for(var i=0,f;f=immutable.fields[i];i++){if(f.id==c.id){isHidden=f.isHidden;break;}}
data.push({aggregation:c.aggregation=="top-values"?'list':c.aggregation,creatorId:c.creatorId,creatorName:c.creatorName,datatype:c.datatype,dateCreated:c.dateCreated,deletableBy:c.deletableBy,fieldId:c.id,isEnumerable:c.field.isEnumerated,isHidden:isHidden,isPrimary:c.isPrimary,isVotable:c.field.isVotable,isVirtual:c.datasetId!=datasetId,name:c.name,refsname:fieldRefs[c.field.id],description:c.field.description,sourceTable:$.grep(immutable.datasets,function(d,i){return d.id==c.datasetId;})[0],enumerationList:c.field.enumerationList,defaultValue:immutable.fieldDefaultValues[c.field.id],datasetId:c.datasetId,isStandard:isStandard});});this.fieldsGrid.setRows(data);});K.oo('method',"showFieldEditor",function(fieldId){});K.oo('method',"autoHeight",function(height){this.fieldsGrid.setHeight(height-this.jqDetails.height()-40);});K.oo('method',"e_buildColumns",function(columns){this.populateFieldsGrid(columns);});K.oo('method',"e_userLoggedIn",function(){});})(Page.Developer,Page);JS2.OO.createClass("Page.Developer.FieldsGrid.Main");Page.Developer.FieldsGrid.Main.oo('extends',GridSimple.Main);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"showEdits",function(){this.notify('showEdits');});K.oo('method',"hideEdits",function(){this.notify('hideEdits');});})(Page.Developer.FieldsGrid.Main,Page.Developer.FieldsGrid);JS2.OO.createClass("Page.Developer.FieldsGrid.Sorter");Page.Developer.FieldsGrid.Sorter.oo('extends',GridSimple.Sorter);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"e_colsInit",function(){_super(this);this.jqColumns.unbind('click');});})(Page.Developer.FieldsGrid.Sorter,Page.Developer.FieldsGrid);JS2.OO.createClass("Page.Developer.FieldsGrid.Data");Page.Developer.FieldsGrid.Data.oo('extends',GridSimple.Data);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){_super(this,options);this.globalInfo=options.owner.options;});K.oo('method',"setRows",function(data){this.origData=data;var rows=[];for(var it198=0,f,it198__arr=data,it198__len=it198__arr.length;(f=it198__arr[it198])||it198<it198__len;it198++){var row=[];row.isPrimary=f.isPrimary;row.isVirtual=f.isVirtual;row.dsOwner=this.globalInfo.isOwner();row.owner=f.creatorId==this.globalInfo.user.id&&f.deletableBy=='CREATOR';row.datatype=f.datatype;row.isVotable=f.isVotable;row.isStandard=f.isStandard;row.isEnumerable=f.isEnumerable;row.enumerationList=f.enumerationList;row.editable=false;row[0]=row.editable?'<a url="javascript:void(0)" class="editFieldLink" field="'+f.fieldId+'">Edit</a>':'<span class="uneditable"/>';row[1]=f.fieldId;row[2]=f.name;row[3]=f.refsname;row[4]=sci.constants.datatypes[f.datatype].viewName;row[5]=f.isPrimary?'N/A':f.aggregation;row[6]=DISPLAY.user(f.creatorId||this.globalInfo.ownerId(),f.creatorName||this.globalInfo.ownerName());row[7]=f.dateCreated;row[8]=f.description;if(!f.isStandard)row[9]=f.datasetId==this.globalInfo.dataset.id?'this table':DISPLAY.dsPage(f.sourceTable.urlName,f.sourceTable.name,100);rows.push(row);}
this.rows=rows;this.notify('dataLoaded');});})(Page.Developer.FieldsGrid.Data,Page.Developer.FieldsGrid);JS2.OO.createClass("Page.Developer.FieldsGrid.BodyController");Page.Developer.FieldsGrid.BodyController.oo('extends',GridSimple.BodyController);(function(K,Package){var self=K;var _super=JS2.OO['super'];})(Page.Developer.FieldsGrid.BodyController,Page.Developer.FieldsGrid);JS2.OO.createClass("Page.Developer.FieldsGrid.BodyView");Page.Developer.FieldsGrid.BodyView.oo('extends',GridSimple.BodyView);(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(options){this.jqBracket=options.jqBracket;});K.oo('method',"initHTML",function(){_super(this);this.jqBody.enableSelection();});K.oo('method',"populate",function(){_super(this);var rows=this.data.rows;var primaryRowCount=0;var isFirstTablePk=true;for(var z=0,zlen=rows.length;z<zlen;z++){if(rows[z].isPrimary&&isFirstTablePk){$(this.jqRows[z]).addClass('primaryKey');primaryRowCount++}else{isFirstTablePk=false;}
if(rows[z].isVirtual)$(this.jqRows[z]).addClass('virtualField');}
this.setBracketHeight(primaryRowCount);});K.oo('method',"populateCell",function(colIdx,rowIdx){var row=this.data.rows[rowIdx];var fieldId=row[1];var val=row[colIdx];if(colIdx==0||colIdx==6||(!row.isStandard&&colIdx==8)){this.matrix[rowIdx][colIdx].innerHTML=val;return;}
_super(this,colIdx,rowIdx);});K.oo('method',"setBracketHeight",function(primaryRowCount){var lineHeight=18;var h=24*primaryRowCount;this.jqBracket.find('.text').css('top',(h-lineHeight)/2);this.jqBracket.find('img').height(h);});})(Page.Developer.FieldsGrid.BodyView,Page.Developer.FieldsGrid);Page.Developer.oo('setHTMLCache',{"main":function(){return"<div class='details'><ul class='table'><li class='reference'><span class='key'>Table Reference:<\/span><span class='value'><\/span><\/li><li class='id'><span class='key'>Table ID:<\/span><span class='value'><\/span><\/li><\/ul><\/div><div class='fields'><div class='subjectIndicator'><img src='\/images\/grid0\/bracket.gif' width='10' \/><div class='text'>Subject<\/div><\/div><div class='fieldsGrid'><\/div><\/div>"}});JS2.OO.createClass("Page.Develop");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function($root,options){this.$root=$root;this.options=options;this.url="/tables/main/"+this.options.dataset.key+"/develop_notes";this.$root.html(this.parseTemplate(this.$root.html()));this.initHTML();});K.oo('method',"initHTML",function(){this.$edit=$(this.htmlCache.edit());this.$root.append(this.$edit);this.$editForm=this.$edit.first('.form');this.$editButton=this.$edit.first('.editButton>.edit');this.$cancelButton=this.$edit.first('.cancel');this.$saveButton=this.$edit.first('.save');this.$htmlTextarea=this.$edit.first('textarea.html');this.toggleEdit();this.registerEvents();});K.oo('method',"toggleEdit",function(){if(sci.auth.isAdmin()){this.$editButton.show();}else{this.$editButton.hide();}
this.$editForm.hide();});K.oo('method',"registerEvents",function(){this.$editButton.click((function(self){return function(){self.showForm();}})(this));this.$cancelButton.click((function(self){return function(){self.hideForm();}})(this));this.$saveButton.click((function(self){return function(){self.save();}})(this));});K.oo('method',"showForm",function(){this.$editForm.show();this.$editButton.hide();this.loadHtml();});K.oo('method',"loadHtml",function(){this.$htmlTextarea.val('loading...');AJAX.get(this.url,{},(function(self){return function(html){self.fillForm(html);}})(this));});K.oo('method',"fillForm",function(html){this.$htmlTextarea.val(html);});K.oo('method',"hideForm",function(){this.$editForm.hide();this.$editButton.show();});K.oo('method',"save",function(){var template=this.$htmlTextarea.val();this.$htmlTextarea.val('submitting...');AJAX.post(this.url,{develop_notes:template},(function(self){return function(html){self.$root.html(self.parseTemplate(html));self.initHTML();}})(this));});K.oo('method',"parseTemplate",function(html){return html.replace(/\$tableKey/g,this.options.dataset.key);});})(Page.Develop,Page);Page.Develop.oo('setHTMLCache',{"edit":function(){return"<div class='edit'><div class='editButton'><button class='edit'>edit<\/button><\/div><div class='form'><textarea class='html'><\/textarea><div class='buttons'><button class='save'>save<\/button><button class='cancel'>cancel<\/button><\/div><\/div><\/div>"}});JS2.OO.createClass("Page.Release");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function($root,options){this.$root=$root;this.options=options;this.url="/tables/main/"+this.options.dataset.key+"/release_notes";this.initHTML();});K.oo('method',"initHTML",function(){this.$edit=$(this.htmlCache.edit());this.$root.append(this.$edit);this.$editForm=this.$edit.first('.form');this.$editButton=this.$edit.first('.editButton>.edit');this.$cancelButton=this.$edit.first('.cancel');this.$saveButton=this.$edit.first('.save');this.$htmlTextarea=this.$edit.first('textarea.html');this.toggleEdit();this.registerEvents();});K.oo('method',"toggleEdit",function(){if(sci.auth.isAdmin()){this.$editButton.show();}else{this.$editButton.hide();}
this.$editForm.hide();});K.oo('method',"registerEvents",function(){this.$editButton.click((function(self){return function(){self.showForm();}})(this));this.$cancelButton.click((function(self){return function(){self.hideForm();}})(this));this.$saveButton.click((function(self){return function(){self.save();}})(this));});K.oo('method',"showForm",function(){this.$editForm.show();this.$editButton.hide();this.loadHtml();});K.oo('method',"loadHtml",function(){this.$htmlTextarea.val('loading...');AJAX.get(this.url,{},(function(self){return function(html){self.fillForm(html);}})(this));});K.oo('method',"fillForm",function(html){this.$htmlTextarea.val(html);});K.oo('method',"hideForm",function(){this.$editForm.hide();this.$editButton.show();});K.oo('method',"save",function(){var template=this.$htmlTextarea.val();this.$htmlTextarea.val('submitting...');AJAX.post(this.url,{release_notes:template},(function(self){return function(html){self.$root.html(html);self.initHTML();}})(this));});})(Page.Release,Page);Page.Release.oo('setHTMLCache',{"edit":function(){return"<div class='edit'><div class='editButton'><button class='edit'>edit<\/button><\/div><div class='form'><textarea class='html'><\/textarea><div class='buttons'><button class='save'>save<\/button><button class='cancel'>cancel<\/button><\/div><\/div><\/div>"}});JS2.OO.createClass("Share.Main");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('method',"initialize",function(grid,options){this.options=options;this.grid=grid;this.initHTML();this.registerEvents();});K.oo('method',"initHTML",function(){this.jq=$('#share');var jqLinks=this.jq.first('.links');this.jqHrefLink=jqLinks.first('.share-href-link');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"hreflink",this.jqHrefLink,null);this.jqEmailLink=jqLinks.first('.share-email-link');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"sharelink",this.jqEmailLink,null);this.jqEmbedLink=jqLinks.first('.share-embed-link').hide();var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"embedlink",this.jqEmbedLink,null);this.jqDialogContainer=this.jq.first('.share-dialog');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"sharedialog",this.jqDialogContainer,null);this.jqClose=this.jqDialogContainer.first('.close');this.jqHrefDialog=this.jqDialogContainer.first('.share-href');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"hrefdialog",this.jqHrefDialog,null);this.jqEmailDialog=this.jqDialogContainer.first('.share-email');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"emaildialog",this.jqEmailDialog,null);this.jqEmbedDialog=this.jqDialogContainer.first('.share-embed');var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"embeddialog",this.jqEmbedDialog,null);this.jqStateUrl=this.jq.find('input.stateUrl');this.jqEmailInput=this.jqEmailDialog.find('input.recipients');this.jqEmailValMsg=this.jqEmailDialog.find('.emailValidationMessage');this.jqEmailSubmit=this.jqEmailDialog.find("input[type=submit]").prop('disabled',true);this.jqEmailSubject=this.jqEmailDialog.find("input.subject");var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"sharesubject",this.jqEmailSubject,null);this.jqUrl=this.jqEmailDialog.find(".url");var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"stateurl",this.jqUrl,null);this.jqEmailMessage=this.jqEmailDialog.find("textarea.message");this.jqUserName=this.jqEmailDialog.find("span.sender");var TMP_SEL_MARKER=this.SEL_MARKER||JS2.SEL_MARKER;TMP_SEL_MARKER.addVal(TMP_SEL_MARKER.getRealClassScope(this),"sender",this.jqUserName,null);this.jqStateNameDiv=this.jqHrefDialog.first('div.saveName');this.jqStateName=this.jqHrefDialog.first('input.name');this.jqSaveName=this.jqHrefDialog.first('a[name=Submit]');this.dialogs={'href':this.jqHrefDialog,'email':this.jqEmailDialog,'embed':this.jqEmbedDialog};this.showLinks();});K.oo('method',"registerEvents",function(){var self=this;this.jqHrefLink.click(function(){self.showDialog('href');});this.jqEmailLink.click(function(){self.showDialog('email');});this.jqEmbedLink.click(function(){self.showDialog('embed');});this.jqClose.click(function(){self.close();});this.jqEmailInput.keyup(function(){self.validateEmails();});this.jqEmailSubmit.click(function(){self.sendEmail();});this.jqSaveName.click(function(){self.saveName();});this.jqStateUrl.changable();this.jq.clickoff((function(self){return function(){self.close();}})(this));});K.oo('method',"close",function(){this.jqStateNameDiv.hide();this.hide();});K.oo('method',"saveName",function(){var stateName=this.jqStateName.val();if(stateName.length>0){var url='/tables/main/save_state_name';var params={};params.key=this.stateKey;params.name=stateName;AJAX.post(url,params);}});K.oo('method',"showLinks",function(){if(this.jqEmbedDialog[0]){var syndicated=new Sharing.Syndicated(this.jqEmbedDialog,this.options);}});K.oo('method',"showNameEditing",function(name){if(this.options.isAdmin()){this.jqStateNameDiv.show();this.jqHrefDialog.first('input.name').val(name);}else{this.jqStateNameDiv.hide();}});K.oo('method',"e_userLoggedIn",function(){this.jqUserName.html(this.options.getUsername());this.showLinks();});K.oo('method',"showDialog",function(name){var lastDialog=this.showingDialog;this.hide();if(lastDialog==name)return;if(name=='email'){if(this.grid.auth.requireLogin(this,name))return;this.setMailUrl();}else if(name=='href'){this.setHrefUrl();}
this.showingDialog=name;this.dialogs[name].show();this.jqDialogContainer.show();});K.oo('method',"hide",function(){if(this.showingDialog){if(this.showingDialog=='email'){this.resetEmailDialog();}
this.dialogs[this.showingDialog].hide();this.showingDialog=null;}
this.jqDialogContainer.hide();});K.oo('method',"resetEmailDialog",function(){this.jqEmailInput.attr('value','');this.jqEmailMessage.attr('value','');this.jqEmailValMsg.removeClass('pass').removeClass('error');this.jqEmailSubmit.prop('disabled',true);});K.oo('method',"setHrefUrl",function(){var self=this;self.jqStateUrl.val('loading...');this.grid.data.share_state(function(id,name){self.stateKey=id;self.jqStateUrl.val(self.options.getBaseUrl()+"/ts/"+id);self.showNameEditing(name);});});K.oo('method',"setMailUrl",function(){var self=this;self.jqUrl.html('loading...');this.grid.data.share_state(function(id){self.jqUrl.html(self.options.getBaseUrl()+"/ts/"+id);});});K.oo('method',"validateEmails",function(){var emails=$.trim(this.jqEmailInput.val());if(emails==''){this.showEmailError();return false;}
var mails=emails.split(/,\s*/);var emailValidator=new Validator.Email();for(var it203=0,email,it203__arr=mails,it203__len=it203__arr.length;(email=it203__arr[it203])||it203<it203__len;it203++){if(email=='')continue;if(!emailValidator.valid(email)){this.showEmailError();return false;}}
this.jqEmailValMsg.removeClass('error').addClass('pass');this.jqEmailSubmit.prop('disabled',this.jq.find('.messaging.error').length>0);return true;});K.oo('method',"showEmailError",function(){this.jqEmailValMsg.removeClass('pass').addClass('error');this.jqEmailSubmit.prop('disabled',true);});K.oo('method',"enableEmailDialog",function(){this.jqEmailInput.prop('disabled',false);this.jqEmailSubject.prop('disabled',false);this.jqEmailMessage.prop('disabled',false);this.jqEmailSubmit.prop('disabled',false);});K.oo('method',"disableEmailDialog",function(){this.jqEmailInput.prop('disabled',true);this.jqEmailSubject.prop('disabled',true);this.jqEmailMessage.prop('disabled',true);this.jqEmailSubmit.prop('disabled',true);});K.oo('method',"sendEmail",function(){this.disableEmailDialog();var self=this;var complete=function(){self.enableEmailDialog();self.resetEmailDialog();self.hide();};var params={from:this.options.getUserEmail(),to:this.jqEmailInput.val(),subject:this.jqEmailSubject.val(),description:this.jqUserName.html()+" sent you this Factual table:\n"+this.jqUrl.html()+"\n"+this.jqEmailMessage.val(),onError:complete};params.dataset_id=this.options.dataset.key;params._event="EmailTable";params._event_params=JSON.stringify({recipients:params.to,message:params.description});sci.ajax.post('/tables/publish/share_by_email',params,complete);});})(Share.Main,Share);JS2.OO.createClass("Sharing.Syndicated");(function(K,Package){var self=K;var _super=JS2.OO['super'];K.oo('member','SYNDICATE_CODE','<!-- Factual Table --><iframe frameborder="0" marginwidth="0" marginheight="0" border="0" style="border:0;margin:0;width:#WIDTH#px;height:#HEIGHT#px;" src="#URI#" scrolling="no" allowtransparency="true"></iframe>');K.oo('method',"initialize",function(seed,options){this.baseURI='http://'+location.host+options.dataset.seoUrl.replace(/^\/t\//,'/s/');this.jq=seed;if(this.jq.length==0)return;this.buildColorSchemes();this.initHTML();this.registerEvents();});K.oo('method',"buildColorSchemes",function(){this.colorSchemes={scheme0:{pkhbg:'2B1C0C',pkcbg:'72390A',pkabg:'B2601C',fhbg:'F1CCAE',fcbg:'F4e7dc',fabg:'F1CCAE'},scheme1:{pkhbg:'c34e13',pkcbg:'e97605',pkabg:'f2b34c',fhbg:'ecceb0',fcbg:'ffffff',fabg:'f4e8dc'},scheme2:{pkhbg:'26361c',pkcbg:'476432',pkabg:'709c4f',fhbg:'c8e2ab',fcbg:'ffffff',fabg:'e4f2cf'},scheme3:{pkhbg:'2c2b2c',pkcbg:'5f6162',pkabg:'909292',fhbg:'c7c9cb',fcbg:'ffffff',fabg:'e7e8e9'},scheme4:{pkhbg:'370707',pkcbg:'850a0a',pkabg:'8e4e4e',fhbg:'e0c9c9',fcbg:'ffffff',fabg:'f4e9e9'}};});K.oo('method',"initHTML",function(){this.jqDimensionSelector=this.jq.first('.dimensionSelector');this.jqSyndicatedCodeArea=this.jq.first('.syndicateCodeArea');this.jqColorList=this.jq.first('.colorList');this.jqPreview=this.jq.first('.preview');this.buildDimSelector();this.buildColorList();this.setColorParams('scheme3');this.setDimensions();});K.oo('method',"buildDimSelector",function(){});K.oo('method',"buildColorList",function(){var listHTML=[];for(var s in this.colorSchemes){listHTML.push('<li idx="')
listHTML.push(s)
listHTML.push('"><div style="background-color: #');listHTML.push(this.colorSchemes[s]['pkcbg']);listHTML.push('"></div></li>');}
this.jqColorList.html(listHTML.join(''));});K.oo('method',"registerEvents",function(){var self=this;this.jqDimensionSelector.change(function(){self.setDimensions();});this.jqColorList.children('li').click(function(){self.setColorParams(self.getColorSchemeKey(this));});this.jqPreview.click(function(){self.preview();});this.jqSyndicatedCodeArea.focus(function(){this.select();});});K.oo('method',"populateSyndicatedCodeArea",function(){var val=this.SYNDICATE_CODE.replace('#WIDTH#',this.width).replace('#HEIGHT#',this.height).replace('#URI#',this.url);this.jqSyndicatedCodeArea.val(val);});K.oo('method',"getColorSchemeKey",function(ele){var jq=$(ele);for(i=0;i<2;i++){if(jq.is('li')){return jq.attr('idx');}else{jq=jq.parent();}}});K.oo('method',"setColorParams",function(key){this.jqColorList.children('li').removeClass('selected');this.jqColorList.first('[idx='+key+']').addClass('selected');var params=[]
for(var c in this.colorSchemes[key]){var param=c+'='+this.colorSchemes[key][c];params.push(param);}
this.url=this.baseURI;if(params.length>0)this.url+='?'+params.join('&');this.populateSyndicatedCodeArea();});K.oo('method',"setDimensions",function(){var dimensionVal=this.jqDimensionSelector.val();if(!dimensionVal){dimensionVal=this.jqDimensionSelector[0].options[0].value;this.jqDimensionSelector[0].options[0].selected=true;}
var dimension=dimensionVal.split(':');this.width=dimension[0];this.height=dimension[1];this.populateSyndicatedCodeArea();});K.oo('method',"preview",function(){var openWindow=window.open();openWindow.document.write(this.jqSyndicatedCodeArea.val());openWindow.document.close();});})(Sharing.Syndicated,Sharing);Share.Main.oo('setHTMLCache',{"embed":function(){return"<div class='share-embed'><\/div>"},"email":function(){return"<div class='share-email'><form><table><tr class='field' datatype='Email' required='required' valid='on:keyup'><td class='share-email-label'>recipient(s):<\/td><td><input class='recipients textField' onblur='s.blur(this)' onfocus='s.focus(this)' \/><\/td><td class='messaging'><\/td><\/tr><tr class='field'><td class='share-email-label'>subject:<\/td><td><input class='subject textField' onblur='s.blur(this)' onfocus='s.focus(this)' \/><\/td><td class='messaging'><\/td><\/tr><tr class='field'><td class='share-email-label'><\/td><td colspan='2'><span class='username'><\/span>sent you this Factual table:<a class='url'><\/a><\/td><\/tr><tr class='field'><td class='share-email-label'>your message:<\/td><td colspan='2'><textarea class='message textArea' onblur='s.blur(this)' onfocus='s.focus(this)'><\/textarea><\/td><\/tr><tr><td class='share-email-label'><\/td><td colspan='2'><input class=' submitButton' name='Send' type='submit' value='Send' \/><\/td><\/tr><\/table><\/form><\/div>"}});